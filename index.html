
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Studio DeVitto - Sistema de Gestão</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Firebase 8 -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    <!-- jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <style>
        /* Todos os estilos CSS anteriores permanecem aqui */
        :root {
            --primary-color: #26196b;
            --secondary-color: #ffd700;
            --accent-color: #4a3a9c;
            --light-bg: #f8f9fa;
        }
        
        /* CORREÇÃO DO ESPAÇO NO TOPO */
html, body {
    margin: 0 !important;
    padding: 0 !important;
    overflow-x: hidden;
}

#mainScreen {
    margin: 0;
    padding: 0;
}

.navbar {
    position: relative;
    top: 0;
    left: 0;
    width: 100%;
    z-index: 1000;
}

.container-fluid {
    padding: 0 !important;
}
        
        body {
            background-color: var(--light-bg);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow-x: hidden;
            height: 100vh;
            position: relative;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        
        .navbar {
            background-color: var(--primary-color);
        }
        
        .sidebar {
            background-color: white;
            min-height: calc(100vh - 56px);
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
        }
        
        .sidebar .nav-link {
            color: #333;
            padding: 12px 20px;
            border-radius: 8px;
            margin-bottom: 5px;
            transition: all 0.3s;
        }
        
        .sidebar .nav-link:hover, .sidebar .nav-link.active {
            background-color: var(--primary-color);
            color: white;
        }
        
        .sidebar .nav-link i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }
        
        .card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            transition: transform 0.3s;
        }
        
        .card:hover {
            transform: translateY(-2px);
        }
        
        .card-header {
            background-color: var(--primary-color);
            color: white;
            border-radius: 12px 12px 0 0 !important;
            font-weight: 600;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .btn-primary:hover {
            background-color: var(--accent-color);
            border-color: var(--accent-color);
        }
        
        .btn-outline-primary {
            color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .btn-outline-primary:hover {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
        }
        
        .table th {
            background-color: var(--primary-color);
            color: white;
        }
        
        .badge-custom {
            background-color: var(--secondary-color);
            color: #000;
        }
        
        .dashboard-card {
            border-left: 4px solid var(--primary-color);
        }
        
        .dashboard-card .card-body {
            padding: 1.5rem;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.25rem rgba(38, 25, 107, 0.25);
        }
        
        .login-container {
            max-width: 400px;
            margin: 100px auto;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            background-color: white;
        }
        
        .login-logo {
            text-align: center;
            margin-bottom: 30px;
            color: var(--primary-color);
        }
        
        .hidden {
            display: none !important;
        }
        
        .service-item {
            border-left: 4px solid var(--primary-color);
            padding-left: 15px;
            margin-bottom: 10px;
            background: white;
            padding: 10px;
            border-radius: 8px;
        }
        
        .stats-number {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .stats-label {
            font-size: 0.9rem;
            color: #6c757d;
        }
        
        .service-row {
            border-bottom: 1px solid #eee;
            padding: 10px 0;
        }
        
        .birthday-item {
            display: flex;
            justify-content: between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .package-completed {
            background-color: #d4edda !important;
            border-color: #c3e6cb !important;
        }
        
        .package-pending {
            background-color: #f8d7da !important;
            border-color: #f5c6cb !important;
        }
        
        .package-finished {
            background-color: #e2e3e5 !important;
            border-color: #d6d8db !important;
            color: #6c757d !important;
        }
        
        .date-status-completed {
            color: #28a745;
            font-weight: bold;
        }
        
        .date-status-pending {
            color: #dc3545;
            font-weight: bold;
        }
        
        .client-card {
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .client-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.1);
        }
        
        .client-card.selected {
            border: 2px solid var(--primary-color);
        }
        
        .client-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            margin: 0 auto 10px;
        }
        
        .low-stock {
            background-color: #f8d7da !important;
            border-color: #f5c6cb !important;
            color: #721c24;
        }
        
        .low-stock-warning {
            color: #dc3545;
            font-weight: bold;
        }
        
        .stock-alert {
            border-left: 4px solid #dc3545 !important;
        }
        
        .mobile-menu {
            display: none;
        }
        
        .floating-menu-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            cursor: pointer;
        }
        
        .mobile-menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 999;
            display: none;
        }
        
        .mobile-menu-content {
            position: fixed;
            top: 0;
            left: 0;
            width: 80%;
            max-width: 300px;
            height: 100%;
            background-color: white;
            z-index: 1000;
            overflow-y: auto;
            transform: translateX(-100%);
            transition: transform 0.3s ease;
        }
        
        .mobile-menu-content.show {
            transform: translateX(0);
        }
        
        .mobile-menu-header {
            padding: 15px;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .mobile-menu-body {
            padding: 0;
        }
        
        .mobile-menu .nav-link {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
        }
        
        .mobile-menu .nav-link i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }
        
        .mobile-back-btn {
            display: none;
        }
        
        .mobile-cards-container {
            display: none;
            padding: 15px;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--light-bg);
            z-index: 1;
            overflow-y: auto;
        }
        
        .mobile-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            border-left: 4px solid var(--primary-color);
            height: 100%;
        }
        
        .mobile-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.1);
        }
        
        .mobile-card i {
            font-size: 2rem;
            color: var(--primary-color);
            margin-bottom: 10px;
        }
        
        .mobile-card h5 {
            color: var(--primary-color);
            margin-bottom: 5px;
            font-size: 0.95rem;
            line-height: 1.2;
        }
        
        .mobile-card p {
            color: #6c757d;
            font-size: 0.8rem;
            margin-bottom: 0;
        }
        
        .floating-back-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: var(--accent-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            cursor: pointer;
            display: none;
        }
        
        .section-container {
            position: relative;
            width: 100%;
            height: 100%;
        }
        
        .section {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow-y: auto;
            background-color: var(--light-bg);
            z-index: 2;
            padding: 15px;
        }
        
        .section.active {
            display: block;
        }
        
        .main-content-container {
            overflow-x: hidden;
        }
        
        .client-record-mobile {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 90%;
            background-color: white;
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            box-shadow: 0 -5px 15px rgba(0,0,0,0.2);
            z-index: 1001;
            transform: translateY(100%);
            transition: transform 0.3s ease-out;
            overflow-y: auto;
            padding: 20px;
        }
        
        .client-record-mobile.active {
            transform: translateY(0);
        }
        
        .client-record-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            display: none;
        }
        
        .client-record-overlay.active {
            display: block;
        }
        
        .client-record-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .client-record-close {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--primary-color);
            cursor: pointer;
        }
        
        .low-stock-alert-compact {
            cursor: pointer;
        }
        
        .low-stock-details {
            display: none;
            margin-top: 10px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 8px;
        }
        
        .low-stock-details.active {
            display: block;
        }
        
        .datetime-display {
            color: white;
            font-size: 0.9rem;
            margin: 0 15px;
        }
        
        .floating-home-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            cursor: pointer;
            transition: all 0.3s ease;
            user-select: none;
        }
        
        .floating-home-btn:hover {
            transform: scale(1.1);
        }
        
        .floating-home-btn.dragging {
            opacity: 0.8;
            transform: scale(1.05);
        }
        
        .logo-upload-container {
            margin: 15px 0;
            text-align: center;
        }
        
        .logo-preview {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--primary-color);
            margin: 10px auto;
            display: none;
        }
        
        .logo-placeholder {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background-color: #f8f9fa;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 10px auto;
            color: var(--primary-color);
            font-size: 24px;
        }
        
        .business-hours-container {
            margin-top: 20px;
        }
        
        .business-hours-day {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .business-hours-day:last-child {
            border-bottom: none;
        }
        
        .business-hours-inputs {
            display: flex;
            gap: 10px;
        }
        
        .business-hours-inputs input {
            width: 100px;
        }
        
        .business-closed {
            background-color: #f8f9fa;
            color: #6c757d;
        }
        
        /* Scroll personalizado */
        .agenda-slots-container::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        .agenda-slots-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        .agenda-slots-container::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }
        
        .agenda-slots-container::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        
        .agenda-professionals::-webkit-scrollbar {
            height: 8px;
        }
        
        .agenda-professionals::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        .agenda-professionals::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }
        
        .agenda-professionals::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        
        /* Estilos para campos de busca dinâmica */
        .autocomplete-container {
            position: relative;
        }
        
        .autocomplete-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            z-index: 1000;
            max-height: 200px;
            overflow-y: auto;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: none;
        }
        
        .autocomplete-list.active {
            display: block;
        }
        
        .autocomplete-item {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid #f1f1f1;
        }
        
        .autocomplete-item:hover {
            background-color: #f8f9fa;
        }
        
        .autocomplete-item.selected {
            background-color: var(--primary-color);
            color: white;
        }
        
        /* Estilos para Dashboard melhorado */
        .dashboard-chart-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            height: 300px;
        }
        
        .products-stats-card {
            border-left: 4px solid #17a2b8;
        }
        
        .products-stats-card .card-body {
            padding: 1.5rem;
        }
        
        /* Estilo para destaque de aniversariante do dia */
        .birthday-today {
            background: linear-gradient(135deg, #fff9e6, #fff3cd) !important;
            border-left: 4px solid #ffd700 !important;
            border: 2px solid #ffd700 !important;
        }
        
        .birthday-today-badge {
            background-color: #ffd700 !important;
            color: #000 !important;
            font-weight: bold;
        }
        
        /* ESTILOS DA NOVA AGENDA */
        .agenda-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            height: calc(100vh - 180px);
            display: flex;
            flex-direction: column;
            position: relative;
        }
        
        .agenda-header {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            border-bottom: 1px solid #eee;
            background: white;
            border-radius: 12px 12px 0 0;
            z-index: 10;
        }
        
        .agenda-menu-btn {
            background: none;
            border: none;
            font-size: 20px;
            color: var(--primary-color);
            margin-right: 15px;
            cursor: pointer;
        }
        
        .agenda-date-display {
            flex-grow: 1;
            font-size: 18px;
            font-weight: 600;
            color: var(--primary-color);
            cursor: pointer;
            display: flex;
            align-items: center;
        }
        
        .agenda-view-options {
            display: flex;
            gap: 5px;
        }
        
        .agenda-view-btn {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 20px;
            padding: 5px 15px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .agenda-view-btn:hover {
            background: #e9ecef;
        }
        
        .agenda-view-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        /* PROFISSIONAIS - Layout melhorado */
        .agenda-professionals {
            display: flex;
            padding: 15px 10px;
            border-bottom: 2px solid #eee;
            background: linear-gradient(to bottom, #f8f9fa, white);
            overflow-x: auto;
            scrollbar-width: thin;
            justify-content: center;
            gap: 15px;
        }
        
        /* Quando há muitos profissionais, alinhar à esquerda com scroll */
        .agenda-professionals.scrollable {
            justify-content: flex-start;
        }
        
        .agenda-professional {
            flex: 0 0 auto;
            min-width: 80px;
            max-width: 100px;
            text-align: center;
            padding: 5px 10px;
            cursor: pointer;
            border-radius: 12px;
            transition: all 0.3s ease;
        }
        
        .agenda-professional:hover {
            background: rgba(38, 25, 107, 0.05);
        }
        
        .agenda-professional.selected {
            background: rgba(38, 25, 107, 0.1);
        }
        
        .agenda-professional-photo {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            margin: 0 auto 5px;
            border: 3px solid transparent;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .agenda-professional-photo:hover {
            border-color: var(--primary-color);
            transform: scale(1.05);
        }
        
        .agenda-professional.selected .agenda-professional-photo {
            border-color: var(--primary-color);
        }
        
        .agenda-professional-name {
            font-size: 12px;
            color: #333;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .agenda-content {
            flex: 1;
            overflow: auto;
            display: flex;
            position: relative;
        }
        
        /* LAYOUT AGENDA CORRIGIDO - Coluna de horários 5% */
        .agenda-time-column {
            width: 5%;
            min-width: 50px;
            max-width: 60px;
            flex-shrink: 0;
            background: #f8f9fa;
            position: sticky;
            left: 0;
            z-index: 5;
        }
        
        .agenda-time-slot {
            height: 60px;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding: 5px 4px;
            font-size: 11px;
            color: #6c757d;
            font-weight: 500;
        }
        
        .agenda-slots-container {
            flex: 1;
            overflow-x: auto;
            overflow-y: auto;
            position: relative;
        }
        
        .agenda-grid {
            display: flex;
            min-width: 100%;
        }
        
        /* Colaboradores - máximo 3 visíveis, scroll para 4+ */
        .agenda-day-column {
            flex: 1;
            min-width: 200px;
            max-width: 33.33%;
            border-right: 1px solid #eee;
        }
        
        /* Quando há 4 ou mais colaboradores, permitir scroll horizontal */
        .agenda-grid.scrollable .agenda-day-column {
            flex: 0 0 auto;
            min-width: 250px;
            max-width: none;
        }
        
        .agenda-day-header {
            height: 40px;
            border-bottom: 1px solid #eee;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: #f8f9fa;
        }
        
        .agenda-day-name {
            font-size: 12px;
            color: #6c757d;
        }
        
        .agenda-day-number {
            font-size: 16px;
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .agenda-slot {
            height: 60px;
            border-bottom: 1px solid #eee;
            position: relative;
            cursor: pointer;
            transition: background-color 0.15s ease;
        }
        
        .agenda-slot:hover {
            background: rgba(38, 25, 107, 0.05);
        }
        
        /* MELHORIA - Slots de 15 minutos mais claros e interativos */
        .agenda-slot-quarter {
            height: 15px;
            border-bottom: 1px dotted #e0e0e0;
            transition: background-color 0.1s ease;
            position: relative;
        }
        
        .agenda-slot-quarter:hover {
            background: rgba(38, 25, 107, 0.1);
        }
        
        .agenda-slot-quarter:hover::after {
            content: '+';
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--primary-color);
            font-size: 14px;
            font-weight: bold;
            opacity: 0.7;
        }
        
        .agenda-appointment {
            position: absolute;
            left: 2px;
            right: 2px;
            background: var(--primary-color);
            color: white;
            border-radius: 4px;
            padding: 5px 8px;
            font-size: 12px;
            overflow: hidden;
            cursor: pointer;
            z-index: 2;
        }
        
        .agenda-appointment:hover {
            opacity: 0.9;
        }
        
        /* MELHORIA - Overlay de seleção mais visível e intuitivo */
        .agenda-selection-overlay {
            position: absolute;
            background: linear-gradient(135deg, rgba(38, 25, 107, 0.3), rgba(74, 58, 156, 0.3));
            border: 3px solid var(--primary-color);
            border-radius: 8px;
            pointer-events: none;
            z-index: 50;
            box-shadow: 0 4px 15px rgba(38, 25, 107, 0.3);
            animation: pulse-selection 1s ease-in-out infinite alternate;
        }
        
        @keyframes pulse-selection {
            0% { box-shadow: 0 4px 15px rgba(38, 25, 107, 0.3); }
            100% { box-shadow: 0 4px 25px rgba(38, 25, 107, 0.5); }
        }
        
        /* Modal de seleção de data */
        .date-picker-modal {
            position: fixed;
            top: 10%;
            left: 5%;
            right: 5%;
            bottom: 10%;
            background: white;
            border-radius: 20px;
            z-index: 1050;
            display: none;
            flex-direction: column;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        
        .date-picker-modal.active {
            display: flex;
        }
        
        .date-picker-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .date-picker-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        
        .date-picker-month {
            margin-bottom: 30px;
        }
        
        .date-picker-month-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 15px;
            text-align: center;
        }
        
        .date-picker-days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
        }
        
        .date-picker-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .date-picker-day:hover {
            background: #f8f9fa;
        }
        
        .date-picker-day.selected {
            background: var(--primary-color);
            color: white;
        }
        
        .date-picker-day.today {
            border: 2px solid var(--primary-color);
        }
        
        /* Tela de seleção de cliente */
        .client-selection-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: white;
            z-index: 1060;
            display: none;
            flex-direction: column;
        }
        
        .client-selection-modal.active {
            display: flex;
        }
        
        .client-selection-header {
            padding: 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .client-search-input {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 25px;
            font-size: 16px;
        }
        
        .client-selection-body {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }
        
        .client-option {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }
        
        .client-option:hover {
            background: #f8f9fa;
        }
        
        .client-option-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            margin-right: 15px;
        }
        
        .client-option-info {
            flex: 1;
        }
        
        .client-option-name {
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .client-option-phone {
            color: #6c757d;
            font-size: 14px;
        }
        
        .quick-options {
            padding: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .quick-option {
            display: flex;
            align-items: center;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 10px;
        }
        
        .quick-option:hover {
            background: #f8f9fa;
        }
        
        .quick-option-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #f8f9fa;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            color: var(--primary-color);
            font-size: 18px;
        }
        
        /* Tela de seleção de serviços */
        .service-selection-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: white;
            z-index: 1070;
            display: none;
            flex-direction: column;
        }
        
        .service-selection-modal.active {
            display: flex;
        }
        
        .service-search-input {
            margin: 15px;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 25px;
            font-size: 16px;
        }
        
        .recent-services {
            padding: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .recent-services-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--primary-color);
        }
        
        .recent-services-scroll {
            display: flex;
            overflow-x: auto;
            gap: 10px;
            padding-bottom: 5px;
        }
        
        .recent-service-card {
            flex: 0 0 auto;
            width: 200px;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 12px;
            cursor: pointer;
        }
        
        .recent-service-card:hover {
            background: #e9ecef;
        }
        
        .service-name {
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .service-date {
            font-size: 12px;
            color: #6c757d;
            margin-bottom: 3px;
        }
        
        .service-price {
            font-size: 14px;
            color: var(--primary-color);
            font-weight: 600;
        }
        
        .all-services-list {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }
        
        .service-item-card {
            display: flex;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }
        
        .service-item-card:hover {
            background: #f8f9fa;
        }
        
        .service-color-bar {
            width: 4px;
            height: 30px;
            background: var(--primary-color);
            margin-right: 15px;
            border-radius: 2px;
        }
        
        .service-item-info {
            flex: 1;
        }
        
        .service-item-name {
            font-weight: 600;
            margin-bottom: 3px;
        }
        
        .service-item-price {
            color: var(--primary-color);
            font-weight: 600;
        }
        
        /* Tela de salvar agendamento */
        .appointment-save-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: white;
            z-index: 1080;
            display: none;
            flex-direction: column;
        }
        
        .appointment-save-modal.active {
            display: flex;
        }
        
        .appointment-save-header {
            padding: 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .appointment-save-body {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }
        
        .calendar-preview {
            height: 150px;
            background: #f8f9fa;
            border-radius: 12px;
            margin-bottom: 15px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        
        .selected-date-display {
            font-size: 20px;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 10px;
        }
        
        .selected-time-display {
            font-size: 16px;
            color: #6c757d;
        }
        
        .client-card-appointment {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .client-card-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .client-avatar-appointment {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            margin-right: 15px;
        }
        
        .client-info-appointment {
            flex: 1;
        }
        
        .client-name-appointment {
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .client-contact-appointment {
            color: #6c757d;
            font-size: 14px;
        }
        
        .client-actions {
            display: flex;
            gap: 10px;
        }
        
        .client-action-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: #f8f9fa;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-color);
            cursor: pointer;
        }
        
        .client-action-btn:hover {
            background: #e9ecef;
        }
        
        .appointment-details-card {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .appointment-details-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--primary-color);
        }
        
        .selected-services-list {
            margin-top: 15px;
        }
        
        .selected-service-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .add-service-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px;
            background: #f8f9fa;
            border: 1px dashed #ddd;
            border-radius: 8px;
            color: var(--primary-color);
            cursor: pointer;
            margin-top: 10px;
        }
        
        .add-service-btn:hover {
            background: #e9ecef;
        }
        
        .appointment-footer {
            background: white;
            border-top: 1px solid #eee;
            padding: 15px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }
        
        .appointment-total {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .total-label {
            font-size: 18px;
            font-weight: 600;
        }
        
        .total-value {
            font-size: 20px;
            font-weight: 700;
            color: var(--primary-color);
        }
        
        .footer-actions {
            display: flex;
            gap: 10px;
            justify-content: space-between;
        }
        
        .footer-action-btn {
            padding: 12px 24px;
            border-radius: 25px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .footer-action-btn.primary {
            background: var(--primary-color);
            color: white;
        }
        
        .footer-action-btn.primary:hover {
            background: var(--accent-color);
        }
        
        .footer-action-btn.secondary {
            background: #6c757d;
            color: white;
        }
        
        .footer-action-btn.secondary:hover {
            background: #5a6268;
        }
        
        .footer-action-btn.icon {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: #f8f9fa;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .footer-action-btn.icon:hover {
            background: #e9ecef;
        }
        
        .confirmation-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 12px;
            padding: 30px;
            z-index: 1100;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            max-width: 400px;
            width: 90%;
            display: none;
        }
        
        .confirmation-popup.active {
            display: block;
        }
        
        .confirmation-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--primary-color);
        }
        
        .confirmation-text {
            margin-bottom: 20px;
            line-height: 1.5;
        }
        
        .confirmation-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        
        @media (max-width: 768px) {
            .sidebar {
                display: none;
            }
            
            .mobile-menu {
                display: block;
            }
            
            .mobile-back-btn {
                display: none;
            }
            
            .mobile-cards-container {
                display: block;
            }
            
            .floating-back-btn {
                display: none;
            }
            
            .mobile-card h5 {
                font-size: 0.9rem;
            }
            
            .container-fluid {
                padding: 0;
            }
            
            .col-md-9.col-lg-10.p-4 {
                padding: 0 !important;
                height: calc(100vh - 56px);
                position: relative;
            }
            
            .card-body {
                padding: 1rem;
            }
            
            .stats-number {
                font-size: 1.5rem;
            }
            
            .client-record-desktop {
                display: none;
            }
            
            .datetime-display {
                display: none;
            }
            
            .floating-mobile-btn {
                display: flex;
            }
            
            .agenda-mobile-view {
                display: block !important;
            }
            
            .agenda-container {
                height: auto;
                min-height: calc(100vh - 120px);
                box-shadow: none;
                border-radius: 0;
            }
            
            .agenda-mobile-day {
                margin-bottom: 10px;
                border-radius: 0;
                box-shadow: none;
                border-bottom: 1px solid #eee;
            }
            
            .agenda-mobile-day-header {
                border-radius: 0;
            }
            
            .agenda-mobile-appointment {
                flex-direction: column;
                align-items: flex-start;
                padding: 10px;
            }
            
            .agenda-mobile-appointment-time {
                margin-bottom: 5px;
                width: 100%;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            
            .agenda-mobile-appointment-details {
                margin-left: 0;
                width: 100%;
            }
            
            .agenda-mobile-add-btn {
                bottom: 90px;
                right: 20px;
            }
            
            .dashboard-chart-container {
                height: 250px;
            }
            
            .agenda-header {
                padding: 10px 15px;
            }
            
            .agenda-view-btn {
                padding: 4px 10px;
                font-size: 12px;
            }
            
            .agenda-professional {
                width: 70px;
            }
            
            .agenda-professional-photo {
                width: 40px;
                height: 40px;
            }
            
            .date-picker-modal {
                top: 5%;
                left: 2%;
                right: 2%;
                bottom: 5%;
            }
            
            .footer-actions {
                flex-wrap: wrap;
            }
            
            .footer-action-btn {
                flex: 1;
                min-width: 120px;
            }
            
            .footer-action-btn.icon {
                flex: 0 0 48px;
            }
        }
        
        @media (min-width: 769px) {
            .mobile-cards-container {
                display: none !important;
            }
            
            .floating-back-btn {
                display: none !important;
            }
            
            .section {
                display: block;
                position: static;
                height: auto;
                overflow: visible;
            }
            
            .client-record-mobile {
                display: none;
            }
            
            .client-record-desktop {
                display: block;
            }
            
            .floating-mobile-btn {
                display: none !important;
            }
            
            .agenda-mobile-view {
                display: none !important;
            }
            
            .agenda-container {
                max-height: 800px;
            }
        }

        /* Estilos para Controle Financeiro */
        .finance-card {
            border-left: 4px solid #28a745;
        }
        
        .finance-card.negative {
            border-left: 4px solid #dc3545;
        }
        
        .expense-item {
            border-left: 4px solid #dc3545;
            padding-left: 15px;
            margin-bottom: 10px;
            background: white;
            padding: 10px;
            border-radius: 8px;
        }
        
        .salary-item {
            border-left: 4px solid #ffc107;
            padding-left: 15px;
            margin-bottom: 10px;
            background: white;
            padding: 10px;
            border-radius: 8px;
        }
        
        .financial-summary {
            background: linear-gradient(135deg, #26196b, #4a3a9c);
            color: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .financial-summary h3 {
            color: white;
            margin-bottom: 20px;
        }
        
        .summary-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
        }
        
        .summary-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: white;
        }
        
        .summary-label {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.8);
        }
        
        .positive-value {
            color: #28a745;
        }
        
        .negative-value {
            color: #dc3545;
        }
        
        .status-paid {
            background-color: #d4edda;
            color: #155724;
            padding: 3px 10px;
            border-radius: 4px;
            font-size: 0.8rem;
        }
        
        .status-pending {
            background-color: #fff3cd;
            color: #856404;
            padding: 3px 10px;
            border-radius: 4px;
            font-size: 0.8rem;
        }
        
        .status-overdue {
            background-color: #f8d7da;
            color: #721c24;
            padding: 3px 10px;
            border-radius: 4px;
            font-size: 0.8rem;
        }
        
        .chart-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .month-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            align-items: center;
        }
        
        .month-selector select {
            flex: 1;
        }
        
        .due-soon {
            background-color: #fff3cd !important;
            border-color: #ffeaa7 !important;
        }
        
        .overdue {
            background-color: #f8d7da !important;
            border-color: #f5c6cb !important;
        }
        
        .paid {
            background-color: #d4edda !important;
            border-color: #c3e6cb !important;
        }
        
        /* Melhorias para resumo financeiro */
        .cash-status {
            font-size: 1.8rem;
            font-weight: bold;
            margin-top: 10px;
        }
        
        .cash-status.positive {
            color: #28a745;
        }
        
        .cash-status.negative {
            color: #dc3545;
        }
        
        .final-cash-display {
            font-size: 2rem;
            font-weight: bold;
            margin: 15px 0;
            text-align: center;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            border: 2px dashed rgba(255, 255, 255, 0.3);
        }
        
        .calculation-steps {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }
        
        .calculation-step {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px dashed rgba(255, 255, 255, 0.1);
        }
        
        .calculation-step:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        
        .calculation-step.total {
            font-weight: bold;
            font-size: 1.1rem;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 2px solid rgba(255, 255, 255, 0.3);
        }
        
        /* NOVOS ESTILOS PARA CONTROLE FINANCEIRO SEPARADO */
        .financial-cash-box {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }
        
        .financial-cash-box.services {
            border-color: #28a745;
        }
        
        .financial-cash-box.products {
            border-color: #17a2b8;
        }
        
        .cash-box-title {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 10px;
            color: white;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .cash-box-title i {
            font-size: 1.5rem;
        }
        
        .cash-box-values {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .cash-box-value {
            text-align: center;
            padding: 10px;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 6px;
        }
        
        .cash-box-label {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 5px;
        }
        
        .cash-box-amount {
            font-size: 1.2rem;
            font-weight: bold;
        }
        
        .expense-recurring-icon {
            color: #ffc107;
            margin-left: 5px;
            font-size: 0.9rem;
        }
        
        .recurring-expense-note {
            font-size: 0.8rem;
            color: #ffc107;
            font-style: italic;
            margin-top: 5px;
        }
        
        /* Estilos para a seção de agenda no menu */
        .sidebar .nav-link[data-section="agenda"] {
            display: flex !important;
        }
        
        /* ESTILOS MODERNOS PARA ANIVERSÁRIOS */
.birthday-card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    transition: all 0.3s ease;
    overflow: hidden;
}

.birthday-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0,0,0,0.12);
}

.birthday-today-card {
    background: linear-gradient(135deg, #fff9e6 0%, #fff3cd 100%);
    border: 2px solid #ffd700;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.4); }
    70% { box-shadow: 0 0 0 10px rgba(255, 215, 0, 0); }
    100% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0); }
}

.birthday-upcoming-card {
    border-left: 4px solid #26196b;
}

.birthday-avatar {
    position: relative;
    width: 60px;
    height: 60px;
}

.birthday-avatar .avatar-inner {
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, #26196b 0%, #4a3a9c 100%);
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    font-weight: bold;
}

.birthday-today-avatar .avatar-inner {
    background: linear-gradient(135deg, #ff6b6b 0%, #ff8e53 100%);
    box-shadow: 0 0 15px rgba(255, 107, 107, 0.4);
}

.birthday-sparkle {
    position: absolute;
    top: -5px;
    right: -5px;
    background: #ffd700;
    color: #000;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    animation: sparkle 1.5s infinite alternate;
}

@keyframes sparkle {
    0% { transform: scale(1); opacity: 1; }
    100% { transform: scale(1.2); opacity: 0.8; }
}

.birthday-details {
    margin-top: 8px;
    display: flex;
    flex-wrap: wrap;
    gap: 5px;
}

.birthday-actions {
    display: flex;
    gap: 5px;
}

.birthdays-header {
    background: linear-gradient(135deg, #26196b 0%, #4a3a9c 100%);
    color: white;
    padding: 20px;
    border-radius: 12px;
    margin-bottom: 20px;
}

.birthdays-header h4 {
    color: white;
    margin: 0;
}

.client-avatar-large {
    background: linear-gradient(135deg, #26196b 0%, #4a3a9c 100%);
    box-shadow: 0 4px 15px rgba(38, 25, 107, 0.3);
}

/* Badges modernos */
.badge {
    padding: 6px 12px;
    border-radius: 20px;
    font-weight: 500;
}

/* Botões modernos */
.btn-success {
    background: linear-gradient(135deg, #25D366 0%, #1da851 100%);
    border: none;
    transition: all 0.3s;
}

.btn-success:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(37, 211, 102, 0.3);
}

.btn-warning {
    background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
    border: none;
    color: #000;
}

/* Responsividade */
@media (max-width: 768px) {
    .birthday-card {
        padding: 15px;
    }
    
    .birthday-avatar {
        width: 50px;
        height: 50px;
    }
    
    .birthday-avatar .avatar-inner {
        font-size: 20px;
    }
    
    .birthday-details {
        flex-direction: column;
        align-items: flex-start;
    }
}
    </style>
</head>
<body>
    <!-- Tela de Login -->
    <div id="loginScreen" class="container">
        <div class="login-container">
            <div class="login-logo">
                <h2><i class="fas fa-scissors"></i> Studio DeVitto</h2>
                <p class="text-muted">Sistema de Gestão</p>
            </div>
            
            <!-- Formulário de Login -->
            <div id="loginFormContainer">
                <form id="loginForm">
                    <div class="mb-3">
                        <label for="loginEmail" class="form-label">E-mail</label>
                        <input type="email" class="form-control" id="loginEmail" required>
                    </div>
                    <div class="mb-3">
                        <label for="loginPassword" class="form-label">Senha</label>
                        <input type="password" class="form-control" id="loginPassword" required>
                    </div>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary">Entrar</button>
                    </div>
                </form>
                <div class="text-center mt-3">
                    <a href="#" id="showRegister">Não tem conta? Cadastre-se</a>
                </div>
            </div>
            
            <!-- Formulário de Registro -->
            <div id="registerFormContainer" class="hidden">
                <form id="registerForm">
                    <div class="mb-3">
                        <label for="registerName" class="form-label">Seu Nome</label>
                        <input type="text" class="form-control" id="registerName" required>
                    </div>
                    <div class="mb-3">
                        <label for="registerEmail" class="form-label">E-mail</label>
                        <input type="email" class="form-control" id="registerEmail" required>
                    </div>
                    <div class="mb-3">
                        <label for="registerPassword" class="form-label">Senha</label>
                        <input type="password" class="form-control" id="registerPassword" required minlength="6">
                    </div>
                    <div class="mb-3">
                        <label for="registerConfirmPassword" class="form-label">Confirmar Senha</label>
                        <input type="password" class="form-control" id="registerConfirmPassword" required>
                    </div>
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary">Cadastrar</button>
                        <button type="button" class="btn btn-secondary" id="showLogin">Voltar para Login</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Tela Principal (após login) -->
    <div id="mainScreen" class="hidden">
        <!-- Navbar -->
        <nav class="navbar navbar-expand-lg navbar-dark">
            <div class="container-fluid">
                <a class="navbar-brand" href="#" id="businessLogo">
                    <i class="fas fa-scissors me-2" id="businessLogoIcon"></i><span id="businessName">Studio DeVitto</span>
                </a>
                
                <!-- Data e Hora -->
                <div class="datetime-display">
                    <span id="currentDateTime"></span>
                </div>
                
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav ms-auto">
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown">
                                <i class="fas fa-user-circle me-1"></i> <span id="userName">Usuário</span>
                            </a>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#" id="changeBusinessSettings"><i class="fas fa-cog me-2"></i>Configurar Estabelecimento</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="#" id="logoutBtn"><i class="fas fa-sign-out-alt me-2"></i>Sair</a></li>
                            </ul>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>

        <div class="container-fluid">
            <div class="row">
                <!-- Sidebar -->
<div class="col-md-3 col-lg-2 sidebar p-0">
    <nav class="nav flex-column p-3">
        <a class="nav-link active" href="#" data-section="agenda">
            <i class="fas fa-calendar-alt"></i> Agenda
        </a>
        <a class="nav-link" href="#" data-section="dashboard">
            <i class="fas fa-tachometer-alt"></i> Dashboard
        </a>
        <a class="nav-link" href="#" data-section="cashier">
            <i class="fas fa-cash-register"></i> Caixa
        </a>
        <a class="nav-link" href="#" data-section="inventory">
            <i class="fas fa-boxes"></i> Estoque
        </a>
        <a class="nav-link" href="#" data-section="clients">
            <i class="fas fa-users"></i> Clientes
        </a>
        <a class="nav-link" href="#" data-section="client-records">
            <i class="fas fa-address-book"></i> Registros de Clientes
        </a>
        <a class="nav-link" href="#" data-section="collaborators">
            <i class="fas fa-user-friends"></i> Colaboradores
        </a>
        <a class="nav-link" href="#" data-section="packages">
            <i class="fas fa-box"></i> Pacotes
        </a>
        <a class="nav-link" href="#" data-section="financial-control">
            <i class="fas fa-chart-line"></i> Controle Financeiro
        </a>
        <a class="nav-link" href="#" data-section="business-profile">
            <i class="fas fa-building"></i> Perfil da Empresa
        </a>
        <a class="nav-link" href="#" data-section="reports">
            <i class="fas fa-chart-bar"></i> Relatórios
        </a>
        <a class="nav-link" href="#" data-section="birthdays">
            <i class="fas fa-birthday-cake"></i> Aniversários
        </a>
    </nav>
</div>

                <!-- Conteúdo Principal -->
                <div class="col-md-9 col-lg-10 p-4 main-content-container">
                    <!-- Container para conteúdo mobile -->
                    <div class="section-container">
                        <!-- Menu de Cards para Mobile -->
                        <div id="mobileCards" class="mobile-cards-container active">
                            <div class="row">
                                <div class="col-6">
                                    <div class="mobile-card" data-section="dashboard">
                                        <i class="fas fa-tachometer-alt"></i>
                                        <h5>Dashboard</h5>
                                        <p>Visão geral</p>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="mobile-card" data-section="cashier">
                                        <i class="fas fa-cash-register"></i>
                                        <h5>Caixa</h5>
                                        <p>Controle de vendas</p>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="mobile-card" data-section="inventory">
                                        <i class="fas fa-boxes"></i>
                                        <h5>Estoque</h5>
                                        <p>Gerenciar produtos</p>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="mobile-card" data-section="clients">
                                        <i class="fas fa-users"></i>
                                        <h5>Clientes</h5>
                                        <p>Cadastro</p>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="mobile-card" data-section="client-records">
                                        <i class="fas fa-address-book"></i>
                                        <h5>Registros</h5>
                                        <p>Fichas</p>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="mobile-card" data-section="collaborators">
                                        <i class="fas fa-user-friends"></i>
                                        <h5>Colabor.</h5>
                                        <p>Equipe</p>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="mobile-card" data-section="packages">
                                        <i class="fas fa-box"></i>
                                        <h5>Pacotes</h5>
                                        <p>Serviços</p>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="mobile-card" data-section="agenda">
                                        <i class="fas fa-calendar-alt"></i>
                                        <h5>Agenda</h5>
                                        <p>Agendamentos</p>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="mobile-card" data-section="financial-control">
                                        <i class="fas fa-chart-line"></i>
                                        <h5>Financeiro</h5>
                                        <p>Controle</p>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="mobile-card" data-section="business-profile">
                                        <i class="fas fa-building"></i>
                                        <h5>Empresa</h5>
                                        <p>Perfil</p>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="mobile-card" data-section="reports">
                                        <i class="fas fa-chart-bar"></i>
                                        <h5>Relatórios</h5>
                                        <p>Sistema</p>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="mobile-card" data-section="birthdays">
                                        <i class="fas fa-birthday-cake"></i>
                                        <h5>Anivers.</h5>
                                        <p>Aniversariantes</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Dashboard -->
                        <div id="dashboard" class="section">
                            <h2 class="mb-4">Dashboard</h2>
                            <div class="row">
                                <div class="col-md-3 mb-4">
                                    <div class="card dashboard-card">
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <h5 class="card-title">Caixa Atual</h5>
                                                    <h3 class="stats-number" id="currentCash">€ 0,00</h3>
                                                </div>
                                                <i class="fas fa-cash-register fa-2x text-primary"></i>
                                            </div>
                                            <div class="mt-3">
                                                <button class="btn btn-sm btn-outline-primary w-100" id="openCashierBtn">Abrir Caixa</button>
                                                <button class="btn btn-sm btn-outline-primary w-100 mt-2" id="closeCashierBtn" disabled>Fechar Caixa</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3 mb-4">
                                    <div class="card dashboard-card">
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <h5 class="card-title">Vendas Hoje</h5>
                                                    <h3 class="stats-number text-success" id="todaySales">€ 0,00</h3>
                                                    <p class="stats-label" id="todayServices">0 serviços</p>
                                                </div>
                                                <i class="fas fa-calendar-day fa-2x text-success"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3 mb-4">
                                    <div class="card dashboard-card">
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <h5 class="card-title">Produtos Hoje</h5>
                                                    <h3 class="stats-number text-info" id="todayProducts">€ 0,00</h3>
                                                    <p class="stats-label" id="todayProductsCount">0 produtos</p>
                                                </div>
                                                <i class="fas fa-shopping-bag fa-2x text-info"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3 mb-4">
                                    <div class="card dashboard-card">
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <h5 class="card-title">Vendas Semana</h5>
                                                    <h3 class="stats-number text-warning" id="weekSales">€ 0,00</h3>
                                                    <p class="stats-label" id="weekServices">0 serviços</p>
                                                </div>
                                                <i class="fas fa-calendar-week fa-2x text-warning"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-3 mb-4">
                                    <div class="card dashboard-card">
                                        <div class="card-body text-center">
                                            <h5 class="card-title">Vendas Mês</h5>
                                            <h3 class="stats-number text-warning" id="monthSales">€ 0,00</h3>
                                            <p class="stats-label" id="monthServices">0 serviços</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3 mb-4">
                                    <div class="card dashboard-card">
                                        <div class="card-body text-center">
                                            <h5 class="card-title">Aniversários</h5>
                                            <h3 class="stats-number text-danger" id="upcomingBirthdays">0</h3>
                                            <p class="stats-label">Próximos 7 dias</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3 mb-4">
                                    <div class="card dashboard-card">
                                        <div class="card-body text-center">
                                            <h5 class="card-title">Colaboradores</h5>
                                            <h3 class="stats-number text-primary" id="totalCollaborators">0</h3>
                                            <p class="stats-label">Ativos</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3 mb-4">
                                    <div class="card dashboard-card">
                                        <div class="card-body text-center">
                                            <h5 class="card-title">Clientes</h5>
                                            <h3 class="stats-number text-success" id="totalClients">0</h3>
                                            <p class="stats-label">Cadastrados</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- NOVO: Seção de Produtos Vendidos -->
                            <div class="row">
                                <div class="col-md-6 mb-4">
                                    <div class="card products-stats-card">
                                        <div class="card-header">
                                            <h5 class="mb-0">Produtos Vendidos (Mês)</h5>
                                        </div>
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-6 text-center">
                                                    <h3 class="stats-number text-info" id="monthProductsCount">0</h3>
                                                    <p class="stats-label">Quantidade Total</p>
                                                </div>
                                                <div class="col-6 text-center">
                                                    <h3 class="stats-number text-success" id="monthProductsValue">€ 0,00</h3>
                                                    <p class="stats-label">Valor Total</p>
                                                </div>
                                            </div>
                                            <div class="mt-3">
                                                <small class="text-muted">*Apenas produtos vendidos este mês</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-4">
                                    <div class="card products-stats-card">
                                        <div class="card-header">
                                            <h5 class="mb-0">Produtos Vendidos (Total)</h5>
                                        </div>
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-6 text-center">
                                                    <h3 class="stats-number text-info" id="totalProductsSoldCount">0</h3>
                                                    <p class="stats-label">Quantidade Total</p>
                                                </div>
                                                <div class="col-6 text-center">
                                                    <h3 class="stats-number text-success" id="totalProductsSoldValue">€ 0,00</h3>
                                                    <p class="stats-label">Valor Total</p>
                                                </div>
                                            </div>
                                            <div class="mt-3">
                                                <small class="text-muted">*Todos os produtos vendidos</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- NOVO: Gráfico de Vendas Mensais -->
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="dashboard-chart-container">
                                        <h5>Vendas Mensais - Serviços vs Produtos</h5>
                                        <canvas id="monthlySalesChart"></canvas>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Alertas de Estoque Baixo -->
                            <div class="row" id="lowStockAlertsContainer" style="display: none;">
                                <div class="col-12">
                                    <div class="card stock-alert low-stock-alert-compact" id="lowStockAlertCard">
                                        <div class="card-header bg-danger text-white d-flex justify-content-between align-items-center">
                                            <h5 class="mb-0"><i class="fas fa-exclamation-triangle me-2"></i>Produtos com Estoque Baixo</h5>
                                            <i class="fas fa-chevron-down" id="lowStockToggleIcon"></i>
                                        </div>
                                        <div class="card-body">
                                            <div id="lowStockAlerts">
                                                <!-- Alertas serão preenchidos dinamicamente -->
                                            </div>
                                            <div class="low-stock-details" id="lowStockDetails">
                                                <!-- Detalhes dos produtos com estoque baixo -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <h5 class="mb-0">Serviços Recentes</h5>
                                        </div>
                                        <div class="card-body">
                                            <div id="recentServicesList">
                                                <p class="text-muted">Nenhum serviço hoje.</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <h5 class="mb-0">Próximos Aniversários</h5>
                                        </div>
                                        <div class="card-body">
                                            <div id="upcomingBirthdaysList">
                                                <p class="text-muted">Nenhum aniversário próximo.</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Caixa -->
                        <div id="cashier" class="section">
                            <h2 class="mb-4">Caixa</h2>
                            <div class="row">
                                <div class="col-md-8">
                                    <div class="card">
                                        <div class="card-header d-flex justify-content-between align-items-center">
                                            <h5 class="mb-0">Nova Venda</h5>
                                            <span class="badge bg-danger" id="cashierStatus">Fechado</span>
                                        </div>
                                        <div class="card-body">
                                            <ul class="nav nav-tabs" id="saleTypeTabs" role="tablist">
                                                <li class="nav-item" role="presentation">
                                                    <button class="nav-link active" id="service-tab" data-bs-toggle="tab" data-bs-target="#service" type="button" role="tab">Serviço</button>
                                                </li>
                                                <li class="nav-item" role="presentation">
                                                    <button class="nav-link" id="product-tab" data-bs-toggle="tab" data-bs-target="#product" type="button" role="tab">Produto</button>
                                                </li>
                                            </ul>
                                            <div class="tab-content mt-3">
                                                <!-- Aba de Serviços -->
                                                <div class="tab-pane fade show active" id="service" role="tabpanel">
                                                    <form id="serviceForm">
                                                        <div class="row">
                                                            <div class="col-md-6 mb-3">
                                                                <label for="clientSelect" class="form-label">Cliente</label>
                                                                <div class="autocomplete-container">
                                                                    <input type="text" class="form-control" id="clientSelect" placeholder="Digite para buscar cliente..." required disabled>
                                                                    <div class="autocomplete-list" id="clientAutocompleteList"></div>
                                                                </div>
                                                                <input type="hidden" id="selectedClientId">
                                                                <div class="form-text">
                                                                    <a href="#" id="addNewClientLink">Adicionar novo cliente</a>
                                                                </div>
                                                            </div>
                                                            <div class="col-md-6 mb-3">
                                                                <label for="collaboratorSelect" class="form-label">Colaborador</label>
                                                                <select class="form-select" id="collaboratorSelect" required disabled>
                                                                    <option value="">Selecione um colaborador</option>
                                                                </select>
                                                            </div>
                                                        </div>
                                                        <div class="row">
                                                            <div class="col-md-6 mb-3">
                                                                <label for="serviceType" class="form-label">Tipo de Serviço</label>
                                                                <select class="form-select" id="serviceType" required disabled>
                                                                    <option value="">Selecione o tipo</option>
                                                                    <option value="manual">Manual (Corte, Brushing, etc.)</option>
                                                                    <option value="product">Com Produtos (Madeixas, Coloração, etc.)</option>
                                                                </select>
                                                            </div>
                                                            <div class="col-md-6 mb-3">
                                                                <label for="serviceValue" class="form-label">Valor do Serviço (€)</label>
                                                                <input type="number" class="form-control" id="serviceValue" step="0.01" min="0" required disabled>
                                                            </div>
                                                        </div>
                                                        <div class="mb-3">
                                                            <label for="serviceDescription" class="form-label">Descrição do Serviço</label>
                                                            <textarea class="form-control" id="serviceDescription" rows="2" disabled></textarea>
                                                        </div>
                                                        <div class="d-grid gap-2">
                                                            <button type="submit" class="btn btn-primary" id="addServiceBtn" disabled>Adicionar Serviço</button>
                                                            <button type="button" class="btn btn-outline-primary" id="addAnotherServiceBtn" disabled>Adicionar Outro Serviço</button>
                                                        </div>
                                                    </form>
                                                </div>
                                                
                                                <!-- Aba de Produtos -->
                                                <div class="tab-pane fade" id="product" role="tabpanel">
                                                    <form id="productSaleForm">
                                                        <div class="row">
                                                            <div class="col-md-6 mb-3">
                                                                <label for="productSaleSelect" class="form-label">Produto</label>
                                                                <div class="autocomplete-container">
                                                                    <input type="text" class="form-control" id="productSaleSelect" placeholder="Digite para buscar produto..." required disabled>
                                                                    <div class="autocomplete-list" id="productAutocompleteList"></div>
                                                                </div>
                                                                <input type="hidden" id="selectedProductId">
                                                            </div>
                                                            <div class="col-md-6 mb-3">
                                                                <label for="productSaleQuantity" class="form-label">Quantidade</label>
                                                                <input type="number" class="form-control" id="productSaleQuantity" min="1" required disabled>
                                                            </div>
                                                        </div>
                                                        <div class="mb-3">
                                                            <label for="productSaleClient" class="form-label">Cliente (Opcional)</label>
                                                            <div class="autocomplete-container">
                                                                <input type="text" class="form-control" id="productSaleClient" placeholder="Digite para buscar cliente..." disabled>
                                                                <div class="autocomplete-list" id="productClientAutocompleteList"></div>
                                                            </div>
                                                            <input type="hidden" id="selectedProductClientId">
                                                        </div>
                                                        <div class="d-grid gap-2">
                                                            <button type="submit" class="btn btn-primary" id="addProductSaleBtn" disabled>Adicionar Venda de Produto</button>
                                                        </div>
                                                    </form>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="card mt-4">
                                        <div class="card-header d-flex justify-content-between align-items-center">
                                            <h5 class="mb-0">Vendas do Dia</h5>
                                            <button class="btn btn-sm btn-primary" id="refreshTodaySales">
                                                <i class="fas fa-sync-alt me-1"></i> Atualizar
                                            </button>
                                        </div>
                                        <div class="card-body">
                                            <div class="mb-3">
                                                <input type="text" class="form-control" id="todaySalesSearch" placeholder="Buscar por cliente, colaborador ou produto...">
                                            </div>
                                            <div id="todaySalesList">
                                                <p class="text-muted">Nenhuma venda registrada hoje.</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card">
                                        <div class="card-header">
                                            <h5 class="mb-0">Resumo do Dia</h5>
                                        </div>
                                        <div class="card-body">
                                            <div class="mb-3">
                                                <strong>Total de Serviços:</strong> <span id="totalServicesCount">0</span>
                                            </div>
                                            <div class="mb-3">
                                                <strong>Valor Serviços:</strong> <span id="totalServicesValue">€ 0,00</span>
                                            </div>
                                            <div class="mb-3">
                                                <strong>Total de Produtos:</strong> <span id="totalProductsCount">0</span>
                                            </div>
                                            <div class="mb-3">
                                                <strong>Valor Produtos:</strong> <span id="totalProductsValue">€ 0,00</span>
                                            </div>
                                            <div class="mb-3">
                                                <strong>Valor Total:</strong> <span id="totalSalesValue">€ 0,00</span>
                                            </div>
                                            <div class="mb-3">
                                                <strong>Valor para Colaboradores:</strong> <span id="totalCollaboratorsValue">€ 0,00</span>
                                            </div>
                                            <div class="mb-3">
                                                <strong>Valor para o Caixa:</strong> <span id="totalCashierValue">€ 0,00</span>
                                            </div>
                                            <hr>
                                            <div id="collaboratorBreakdown">
                                                <p class="text-muted">Nenhum serviço registrado.</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Estoque -->
                        <div id="inventory" class="section">
                            <h2 class="mb-4">Estoque</h2>
                            <div class="row">
                                <div class="col-md-8">
                                    <div class="card">
                                        <div class="card-header d-flex justify-content-between align-items-center">
                                            <h5 class="mb-0">Produtos em Estoque</h5>
                                            <div>
                                                <input type="text" class="form-control me-2 d-inline-block" id="inventorySearch" placeholder="Buscar produto..." style="width: 200px;">
                                                <button class="btn btn-primary" id="addProductBtn">
                                                    <i class="fas fa-plus me-1"></i> Adicionar Produto
                                                </button>
                                            </div>
                                        </div>
                                        <div class="card-body">
                                            <div class="table-responsive">
                                                <table class="table table-hover">
                                                    <thead>
                                                        <tr>
                                                            <th>Produto</th>
                                                            <th>Quantidade</th>
                                                            <th>Mínimo</th>
                                                            <th>Valor Compra</th>
                                                            <th>Valor Venda</th>
                                                            <th>Status</th>
                                                            <th>Ações</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="inventoryTable">
                                                        <tr>
                                                            <td colspan="7" class="text-center text-muted">Nenhum produto cadastrado.</td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card">
                                        <div class="card-header">
                                            <h5 class="mb-0">Resumo do Estoque</h5>
                                        </div>
                                        <div class="card-body">
                                            <div class="mb-3">
                                                <strong>Total de Produtos:</strong> <span id="totalProducts">0</span>
                                            </div>
                                            <div class="mb-3">
                                                <strong>Produtos com Estoque Baixo:</strong> <span id="lowStockProducts" class="low-stock-warning">0</span>
                                            </div>
                                            <div class="mb-3">
                                                <strong>Valor Total em Estoque:</strong> <span id="totalInventoryValue">€ 0,00</span>
                                            </div>
                                            <div class="mb-3">
                                                <strong>Investimento Total:</strong> <span id="totalInvestment">€ 0,00</span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="card mt-4">
                                        <div class="card-header">
                                            <h5 class="mb-0">Alertas de Estoque Baixo</h5>
                                        </div>
                                        <div class="card-body">
                                            <div id="inventoryAlerts">
                                                <p class="text-muted">Nenhum alerta no momento.</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Clientes -->
                        <div id="clients" class="section">
                            <h2 class="mb-4">Clientes</h2>
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0">Lista de Clientes</h5>
                                    <button class="btn btn-primary" id="addClientBtn">
                                        <i class="fas fa-plus me-1"></i> Adicionar Cliente
                                    </button>
                                </div>
                                <div class="card-body">
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <input type="text" class="form-control" id="clientSearch" placeholder="Buscar cliente...">
                                        </div>
                                    </div>
                                    <div class="table-responsive">
                                        <table class="table table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Nome</th>
                                                    <th>Data Nasc.</th>
                                                    <th>Contato</th>
                                                    <th>E-mail</th>
                                                    <th>Ações</th>
                                                </tr>
                                            </thead>
                                            <tbody id="clientsTable">
                                                <tr>
                                                    <td colspan="5" class="text-center text-muted">Nenhum cliente cadastrado.</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Registros de Clientes -->
                        <div id="client-records" class="section">
                            <h2 class="mb-4">Registros de Clientes</h2>
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="card">
                                        <div class="card-header">
                                            <h5 class="mb-0">Lista de Clientes</h5>
                                        </div>
                                        <div class="card-body">
                                            <div class="mb-3">
                                                <input type="text" class="form-control" id="clientRecordsSearch" placeholder="Buscar cliente...">
                                            </div>
                                            <div id="clientCardsList" class="d-flex flex-column gap-2" style="max-height: 600px; overflow-y: auto;">
                                                <p class="text-muted text-center">Nenhum cliente cadastrado.</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-8 client-record-desktop">
                                    <div class="card">
                                        <div class="card-header">
                                            <h5 class="mb-0" id="clientRecordTitle">Ficha do Cliente</h5>
                                        </div>
                                        <div class="card-body">
                                            <div id="clientRecordContent" class="text-center text-muted">
                                                <p>Selecione um cliente para visualizar sua ficha completa</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Ficha do cliente para dispositivos móveis -->
                            <div class="client-record-overlay" id="clientRecordOverlay"></div>
                            <div class="client-record-mobile" id="clientRecordMobile">
                                <div class="client-record-header">
                                    <h5 id="clientRecordMobileTitle">Ficha do Cliente</h5>
                                    <button class="client-record-close" id="clientRecordClose">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                                <div id="clientRecordMobileContent">
                                    <!-- Conteúdo será preenchido dinamicamente -->
                                </div>
                            </div>
                        </div>

                        <!-- Colaboradores -->
                        <div id="collaborators" class="section">
                            <h2 class="mb-4">Colaboradores</h2>
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0">Lista de Colaboradores</h5>
                                    <button class="btn btn-primary" id="addCollaboratorBtn">
                                        <i class="fas fa-plus me-1"></i> Adicionar Colaborador
                                    </button>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Foto</th>
                                                    <th>Nome</th>
                                                    <th>Especialidade</th>
                                                    <th>Contato</th>
                                                    <th>% Manual</th>
                                                    <th>% Produtos</th>
                                                    <th>Salário Base</th>
                                                    <th>Status</th>
                                                    <th>Ações</th>
                                                </tr>
                                            </thead>
                                            <tbody id="collaboratorsTable">
                                                <tr>
                                                    <td colspan="9" class="text-center text-muted">Nenhum colaborador cadastrado.</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Pacotes -->
                        <div id="packages" class="section">
                            <h2 class="mb-4">Pacotes</h2>
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="card">
                                        <div class="card-header">
                                            <h5 class="mb-0">Resumo de Pacotes</h5>
                                        </div>
                                        <div class="card-body">
                                            <div class="mb-3">
                                                <strong>Total de Pacotes Ativos:</strong> <span id="totalActivePackages">0</span>
                                            </div>
                                            <div class="mb-3">
                                                <strong>Valor Total em Pacotes:</strong> <span id="totalPackagesValue">€ 0,00</span>
                                            </div>
                                            <div class="mb-3">
                                                <strong>Próximos Procedimentos:</strong> <span id="nextProceduresCount">0</span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="card mt-4">
                                        <div class="card-header">
                                            <h5 class="mb-0">Adicionar/Editar Pacote</h5>
                                        </div>
                                        <div class="card-body">
                                            <form id="packageForm">
                                                <input type="hidden" id="packageId">
                                                <div class="mb-3">
                                                    <label for="packageClientSelect" class="form-label">Cliente</label>
                                                    <select class="form-select" id="packageClientSelect" required>
                                                        <option value="">Selecione um cliente</option>
                                                    </select>
                                                </div>
                                                <div class="mb-3">
                                                    <label for="packageProcedures" class="form-label">Quantidade de Procedimentos</label>
                                                    <input type="number" class="form-control" id="packageProcedures" min="1" max="52" required>
                                                </div>
                                                <div class="mb-3">
                                                    <label for="packageFrequency" class="form-label">Frequência por Semana</label>
                                                    <select class="form-select" id="packageFrequency" required>
                                                        <option value="1">1 vez por semana</option>
                                                        <option value="2">2 vezes por semana</option>
                                                        <option value="3">3 vezes por semana</option>
                                                        <option value="4">4 vezes por semana</option>
                                                        <option value="5">5 vezes por semana</option>
                                                        <option value="6">6 vezes por semana</option>
                                                        <option value="7">7 vezes por semana</option>
                                                    </select>
                                                </div>
                                                <div id="daysSelection" style="display: none;">
                                                    <div class="mb-3">
                                                        <label class="form-label">Selecionar Dias da Semana</label>
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="checkbox" id="mondayCheck">
                                                            <label class="form-check-label" for="mondayCheck">Segunda-feira</label>
                                                        </div>
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="checkbox" id="tuesdayCheck">
                                                            <label class="form-check-label" for="tuesdayCheck">Terça-feira</label>
                                                        </div>
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="checkbox" id="wednesdayCheck">
                                                            <label class="form-check-label" for="wednesdayCheck">Quarta-feira</label>
                                                        </div>
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="checkbox" id="thursdayCheck">
                                                            <label class="form-check-label" for="thursdayCheck">Quinta-feira</label>
                                                        </div>
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="checkbox" id="fridayCheck">
                                                            <label class="form-check-label" for="fridayCheck">Sexta-feira</label>
                                                        </div>
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="checkbox" id="saturdayCheck">
                                                            <label class="form-check-label" for="saturdayCheck">Sábado</label>
                                                        </div>
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="checkbox" id="sundayCheck">
                                                            <label class="form-check-label" for="sundayCheck">Domingo</label>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="mb-3">
                                                    <label for="packageStartDate" class="form-label">Data do Primeiro Procedimento</label>
                                                    <input type="date" class="form-control" id="packageStartDate" required>
                                                </div>
                                                <div class="mb-3">
                                                    <label for="packageValue" class="form-label">Valor do Pacote (€)</label>
                                                    <input type="number" class="form-control" id="packageValue" step="0.01" min="0" required>
                                                </div>
                                                <div class="mb-3">
                                                    <label for="packageDescription" class="form-label">Descrição do Pacote</label>
                                                    <textarea class="form-control" id="packageDescription" rows="2"></textarea>
                                                </div>
                                                <div class="d-grid gap-2">
                                                    <button type="submit" class="btn btn-primary" id="savePackageBtn">Criar Pacote</button>
                                                    <button type="button" class="btn btn-secondary" id="cancelPackageEditBtn" style="display: none;">Cancelar Edição</button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-8">
                                    <div class="card">
                                        <div class="card-header d-flex justify-content-between align-items-center">
                                            <h5 class="mb-0">Pacotes Ativos</h5>
                                        </div>
                                        <div class="card-body">
                                            <div id="packagesList">
                                                <p class="text-muted">Nenhum pacote ativo.</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- AGENDA -->
                        <div id="agenda" class="section">
                            <h2 class="mb-4">Agenda</h2>
                            <div class="agenda-container">
                                <!-- Cabeçalho da Agenda -->
                                <div class="agenda-header">
                                    <button class="agenda-menu-btn" id="agendaMenuBtn">
                                        <i class="fas fa-bars"></i>
                                    </button>
                                    <div class="agenda-date-display" id="agendaDateDisplay">
                                        quinta 22 jan ↓
                                    </div>
                                    <div class="agenda-view-options">
                                        <button class="agenda-view-btn active" data-view="day">Dia</button>
                                        <button class="agenda-view-btn" data-view="3days">3 dias</button>
                                        <button class="agenda-view-btn" data-view="week">Semana</button>
                                        <button class="agenda-view-btn" data-view="month">Mês</button>
                                    </div>
                                </div>

                                <!-- Lista de Colaboradores -->
                                <div class="agenda-professionals" id="agendaProfessionals">
                                    <!-- Colaboradores serão preenchidos dinamicamente -->
                                </div>

                                <!-- Conteúdo da Agenda -->
                                <div class="agenda-content">
                                    <!-- Coluna de horários -->
                                    <div class="agenda-time-column" id="agendaTimeColumn">
                                        <!-- Horários serão preenchidos dinamicamente -->
                                    </div>
                                    
                                    <!-- Grade de agendamentos -->
                                    <div class="agenda-slots-container" id="agendaSlotsContainer">
                                        <div class="agenda-grid" id="agendaGrid">
                                            <!-- Grade será preenchida dinamicamente -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Controle Financeiro -->
                        <div id="financial-control" class="section">
                            <h2 class="mb-4">Controle Financeiro</h2>
                            
                            <!-- Resumo Financeiro MELHORADO COM DOIS CAIXAS SEPARADOS -->
                            <div class="financial-summary">
                                <h3>Resumo Financeiro - Mês Atual</h3>
                                
                                <!-- CAIXA DE SERVIÇOS PRESTADOS -->
                                <div class="financial-cash-box services">
                                    <div class="cash-box-title">
                                        <i class="fas fa-scissors"></i> Caixa de Serviços Prestados
                                    </div>
                                    <div class="cash-box-values">
                                        <div class="cash-box-value">
                                            <div class="cash-box-label">Receita Serviços</div>
                                            <div class="cash-box-amount positive-value" id="servicesRevenue">€ 0,00</div>
                                        </div>
                                        <div class="cash-box-value">
                                            <div class="cash-box-label">Despesas Pagas</div>
                                            <div class="cash-box-amount negative-value" id="servicesExpenses">€ 0,00</div>
                                        </div>
                                        <div class="cash-box-value">
                                            <div class="cash-box-label">Despesas Pendentes</div>
                                            <div class="cash-box-amount negative-value" id="servicesPendingExpenses">€ 0,00</div>
                                        </div>
                                        <div class="cash-box-value">
                                            <div class="cash-box-label">Saldo Final Serviços</div>
                                            <div class="cash-box-amount" id="servicesFinalCash">€ 0,00</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- CAIXA DE PRODUTOS VENDIDOS -->
                                <div class="financial-cash-box products">
                                    <div class="cash-box-title">
                                        <i class="fas fa-shopping-bag"></i> Caixa de Produtos Vendidos
                                    </div>
                                    <div class="cash-box-values">
                                        <div class="cash-box-value">
                                            <div class="cash-box-label">Receita Produtos</div>
                                            <div class="cash-box-amount positive-value" id="productsRevenue">€ 0,00</div>
                                        </div>
                                        <div class="cash-box-value">
                                            <div class="cash-box-label">Custo Produtos Vendidos</div>
                                            <div class="cash-box-amount negative-value" id="productsCost">€ 0,00</div>
                                        </div>
                                        <div class="cash-box-value">
                                            <div class="cash-box-label">Lucro Produtos</div>
                                            <div class="cash-box-amount positive-value" id="productsProfit">€ 0,00</div>
                                        </div>
                                        <div class="cash-box-value">
                                            <div class="cash-box-label">Saldo Final Produtos</div>
                                            <div class="cash-box-amount" id="productsFinalCash">€ 0,00</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- RESUMO GERAL -->
                                <div class="row mt-4">
                                    <div class="col-md-3">
                                        <div class="summary-item">
                                            <div class="summary-label">Receita Total</div>
                                            <div class="summary-value positive-value" id="totalRevenue">€ 0,00</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="summary-item">
                                            <div class="summary-label">Despesas Totais</div>
                                            <div class="summary-value negative-value" id="totalExpenses">€ 0,00</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="summary-item">
                                            <div class="summary-label">Lucro Total</div>
                                            <div class="summary-value" id="totalProfit">€ 0,00</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="summary-item">
                                            <div class="summary-label">Caixa Total</div>
                                            <div class="summary-value" id="totalFinalCash">€ 0,00</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- CÁLCULO DETALHADO -->
                                <div class="row mt-4">
                                    <div class="col-md-12">
                                        <div class="final-cash-display" id="finalCashDisplay">
                                            Caixa Total Final: € 0,00
                                        </div>
                                        <div class="calculation-steps">
                                            <div class="calculation-step">
                                                <span>Receita Serviços:</span>
                                                <span id="calculationServicesRevenue">€ 0,00</span>
                                            </div>
                                            <div class="calculation-step">
                                                <span>- Despesas Pagas Serviços:</span>
                                                <span id="calculationServicesExpenses">€ 0,00</span>
                                            </div>
                                            <div class="calculation-step">
                                                <span>= Saldo Serviços:</span>
                                                <span id="calculationServicesBalance">€ 0,00</span>
                                            </div>
                                            <div class="calculation-step">
                                                <span>Receita Produtos:</span>
                                                <span id="calculationProductsRevenue">€ 0,00</span>
                                            </div>
                                            <div class="calculation-step">
                                                <span>- Custo Produtos:</span>
                                                <span id="calculationProductsCost">€ 0,00</span>
                                            </div>
                                            <div class="calculation-step">
                                                <span>= Saldo Produtos:</span>
                                                <span id="calculationProductsBalance">€ 0,00</span>
                                            </div>
                                            <div class="calculation-step total">
                                                <span>= Caixa Total:</span>
                                                <span id="calculationTotalCash">€ 0,00</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row mt-3">
                                    <div class="col-md-4">
                                        <div class="summary-item">
                                            <div class="summary-label">Despesas Pendentes</div>
                                            <div class="summary-value negative-value" id="pendingExpenses">€ 0,00</div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="summary-item">
                                            <div class="summary-label">Despesas Recorrentes</div>
                                            <div class="summary-value" id="recurringExpenses">€ 0,00</div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="summary-item">
                                            <div class="summary-label">Lucro Líquido</div>
                                            <div class="summary-value positive-value" id="netProfit">€ 0,00</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-8">
                                    <!-- Abas para Despesas e Salários -->
                                    <ul class="nav nav-tabs" id="financialTabs" role="tablist">
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link active" id="expenses-tab" data-bs-toggle="tab" data-bs-target="#expenses" type="button" role="tab">Despesas</button>
                                        </li>
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link" id="salaries-tab" data-bs-toggle="tab" data-bs-target="#salaries" type="button" role="tab">Salários</button>
                                        </li>
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link" id="add-tab" data-bs-toggle="tab" data-bs-target="#add" type="button" role="tab">Adicionar</button>
                                        </li>
                                    </ul>
                                    
                                    <div class="tab-content mt-3">
                                        <!-- Tab Despesas -->
                                        <div class="tab-pane fade show active" id="expenses" role="tabpanel">
                                            <div class="card">
                                                <div class="card-header d-flex justify-content-between align-items-center">
                                                    <h5 class="mb-0">Despesas do Mês</h5>
                                                    <div class="month-selector">
                                                        <select class="form-select" id="expensesMonth" style="width: auto;">
                                                            <!-- Opções serão preenchidas dinamicamente -->
                                                        </select>
                                                    </div>
                                                </div>
                                                <div class="card-body">
                                                    <div id="expensesList">
                                                        <p class="text-muted">Nenhuma despesa registrada.</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Tab Salários -->
                                        <div class="tab-pane fade" id="salaries" role="tabpanel">
                                            <div class="card">
                                                <div class="card-header d-flex justify-content-between align-items-center">
                                                    <h5 class="mb-0">Folha de Pagamento</h5>
                                                    <div class="month-selector">
                                                        <select class="form-select" id="salariesMonth" style="width: auto;">
                                                            <!-- Opções serão preenchidas dinamicamente -->
                                                        </select>
                                                    </div>
                                                </div>
                                                <div class="card-body">
                                                    <div id="salariesList">
                                                        <p class="text-muted">Nenhum pagamento de salário registrado.</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Tab Adicionar -->
                                        <div class="tab-pane fade" id="add" role="tabpanel">
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <div class="card">
                                                        <div class="card-header">
                                                            <h5 class="mb-0">Nova Despesa</h5>
                                                        </div>
                                                        <div class="card-body">
                                                            <form id="expenseForm">
                                                                <div class="mb-3">
                                                                    <label for="expenseDescription" class="form-label">Descrição da Despesa</label>
                                                                    <input type="text" class="form-control" id="expenseDescription" required>
                                                                </div>
                                                                <div class="mb-3">
                                                                    <label for="expenseCategory" class="form-label">Categoria</label>
                                                                    <select class="form-select" id="expenseCategory" required>
                                                                        <option value="">Selecione uma categoria</option>
                                                                        <option value="aluguel">Aluguel</option>
                                                                        <option value="energia">Energia</option>
                                                                        <option value="agua">Água</option>
                                                                        <option value="internet">Internet</option>
                                                                        <option value="produtos">Produtos/Estoque</option>
                                                                        <option value="manutencao">Manutenção</option>
                                                                        <option value="marketing">Marketing</option>
                                                                        <option value="impostos">Impostos</option>
                                                                        <option value="outros">Outros</option>
                                                                    </select>
                                                                </div>
                                                                <div class="row">
                                                                    <div class="col-md-6 mb-3">
                                                                        <label for="expenseValue" class="form-label">Valor (€)</label>
                                                                        <input type="number" class="form-control" id="expenseValue" step="0.01" min="0" required>
                                                                    </div>
                                                                    <div class="col-md-6 mb-3">
                                                                        <label for="expenseDueDate" class="form-label">Data de Vencimento</label>
                                                                        <input type="date" class="form-control" id="expenseDueDate" required>
                                                                    </div>
                                                                </div>
                                                                <div class="mb-3">
                                                                    <label for="expenseNotes" class="form-label">Observações</label>
                                                                    <textarea class="form-control" id="expenseNotes" rows="2"></textarea>
                                                                </div>
                                                                <div class="mb-3 form-check">
                                                                    <input type="checkbox" class="form-check-input" id="expenseRecurring">
                                                                    <label class="form-check-label" for="expenseRecurring">Despesa Recorrente (Mensal)</label>
                                                                </div>
                                                                <button type="submit" class="btn btn-primary">Registrar Despesa</button>
                                                            </form>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="card">
                                                        <div class="card-header">
                                                            <h5 class="mb-0">Registrar Pagamento de Salário</h5>
                                                        </div>
                                                        <div class="card-body">
                                                            <form id="salaryPaymentForm">
                                                                <div class="mb-3">
                                                                    <label for="salaryCollaborator" class="form-label">Colaborador</label>
                                                                    <select class="form-select" id="salaryCollaborator" required>
                                                                        <option value="">Selecione um colaborador</option>
                                                                    </select>
                                                                </div>
                                                                <div class="mb-3">
                                                                    <label for="salaryMonth" class="form-label">Mês de Referência</label>
                                                                    <input type="month" class="form-control" id="salaryMonth" required>
                                                                </div>
                                                                <div class="mb-3">
                                                                    <label for="salaryBaseValue" class="form-label">Salário Base (€)</label>
                                                                    <input type="number" class="form-control" id="salaryBaseValue" step="0.01" min="0" required>
                                                                </div>
                                                                <div class="mb-3">
                                                                    <label for="salaryBonus" class="form-label">Bônus/Comissões (€)</label>
                                                                    <input type="number" class="form-control" id="salaryBonus" step="0.01" min="0" value="0">
                                                                </div>
                                                                <div class="mb-3">
                                                                    <label for="salaryDeductions" class="form-label">Descontos (€)</label>
                                                                    <input type="number" class="form-control" id="salaryDeductions" step="0.01" min="0" value="0">
                                                                </div>
                                                                <div class="mb-3">
                                                                    <label for="salaryPaymentDate" class="form-label">Data do Pagamento</label>
                                                                    <input type="date" class="form-control" id="salaryPaymentDate" required>
                                                                </div>
                                                                <div class="mb-3">
                                                                    <label for="salaryPaymentMethod" class="form-label">Método de Pagamento</label>
                                                                    <select class="form-select" id="salaryPaymentMethod" required>
                                                                        <option value="dinheiro">Dinheiro</option>
                                                                        <option value="transferencia">Transferência</option>
                                                                        <option value="cheque">Cheque</option>
                                                                    </select>
                                                                </div>
                                                                <div class="mb-3">
                                                                    <label for="salaryNotes" class="form-label">Observações</label>
                                                                    <textarea class="form-control" id="salaryNotes" rows="2"></textarea>
                                                                </div>
                                                                <button type="submit" class="btn btn-primary">Registrar Pagamento</button>
                                                            </form>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-4">
                                    <!-- Próximos Vencimentos -->
                                    <div class="card mb-4">
                                        <div class="card-header">
                                            <h5 class="mb-0">Próximos Vencimentos</h5>
                                        </div>
                                        <div class="card-body">
                                            <div id="upcomingDueList">
                                                <p class="text-muted">Nenhum vencimento próximo.</p>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Gráfico de Despesas por Categoria -->
                                    <div class="card">
                                        <div class="card-header">
                                            <h5 class="mb-0">Despesas por Categoria</h5>
                                        </div>
                                        <div class="card-body">
                                            <div id="expenseChartContainer">
                                                <canvas id="expenseChart" width="100%" height="200"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Perfil da Empresa -->
                        <div id="business-profile" class="section">
                            <h2 class="mb-4">Perfil da Empresa</h2>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <h5 class="mb-0">Informações da Empresa</h5>
                                        </div>
                                        <div class="card-body">
                                            <form id="businessProfileForm">
                                                <div class="mb-3">
                                                    <label for="businessName" class="form-label">Nome da Empresa</label>
                                                    <input type="text" class="form-control" id="businessName" value="Studio DeVitto">
                                                </div>
                                                <div class="mb-3">
                                                    <label for="businessEmail" class="form-label">E-mail</label>
                                                    <input type="email" class="form-control" id="businessEmail">
                                                </div>
                                                <div class="mb-3">
                                                    <label for="businessPhone" class="form-label">Telefone</label>
                                                    <input type="text" class="form-control" id="businessPhone" placeholder="+351">
                                                </div>
                                                <div class="mb-3">
                                                    <label for="businessAddress" class="form-label">Endereço</label>
                                                    <textarea class="form-control" id="businessAddress" rows="2"></textarea>
                                                </div>
                                                <div class="mb-3">
                                                    <label for="businessDescription" class="form-label">Descrição</label>
                                                    <textarea class="form-control" id="businessDescription" rows="3" placeholder="Breve descrição sobre o seu negócio..."></textarea>
                                                </div>
                                                <button type="submit" class="btn btn-primary">Salvar Informações</button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <h5 class="mb-0">Horário de Funcionamento</h5>
                                        </div>
                                        <div class="card-body">
                                            <div class="business-hours-container">
                                                <div class="business-hours-day">
                                                    <span>Segunda-feira</span>
                                                    <div class="business-hours-inputs">
                                                        <input type="time" class="form-control" id="mondayOpen" value="09:00">
                                                        <span>às</span>
                                                        <input type="time" class="form-control" id="mondayClose" value="18:00">
                                                    </div>
                                                </div>
                                                <div class="business-hours-day">
                                                    <span>Terça-feira</span>
                                                    <div class="business-hours-inputs">
                                                        <input type="time" class="form-control" id="tuesdayOpen" value="09:00">
                                                        <span>às</span>
                                                        <input type="time" class="form-control" id="tuesdayClose" value="18:00">
                                                    </div>
                                                </div>
                                                <div class="business-hours-day">
                                                    <span>Quarta-feira</span>
                                                    <div class="business-hours-inputs">
                                                        <input type="time" class="form-control" id="wednesdayOpen" value="09:00">
                                                        <span>às</span>
                                                        <input type="time" class="form-control" id="wednesdayClose" value="18:00">
                                                    </div>
                                                </div>
                                                <div class="business-hours-day">
                                                    <span>Quinta-feira</span>
                                                    <div class="business-hours-inputs">
                                                        <input type="time" class="form-control" id="thursdayOpen" value="09:00">
                                                        <span>às</span>
                                                        <input type="time" class="form-control" id="thursdayClose" value="18:00">
                                                    </div>
                                                </div>
                                                <div class="business-hours-day">
                                                    <span>Sexta-feira</span>
                                                    <div class="business-hours-inputs">
                                                        <input type="time" class="form-control" id="fridayOpen" value="09:00">
                                                        <span>às</span>
                                                        <input type="time" class="form-control" id="fridayClose" value="18:00">
                                                    </div>
                                                </div>
                                                <div class="business-hours-day">
                                                    <span>Sábado</span>
                                                    <div class="business-hours-inputs">
                                                        <input type="time" class="form-control" id="saturdayOpen" value="09:00">
                                                        <span>às</span>
                                                        <input type="time" class="form-control" id="saturdayClose" value="13:00">
                                                    </div>
                                                </div>
                                                <div class="business-hours-day business-closed">
                                                    <span>Domingo</span>
                                                    <div>
                                                        <span class="text-muted">Fechado</span>
                                                    </div>
                                                </div>
                                            </div>
                                            <button class="btn btn-primary mt-3" id="saveBusinessHours">Salvar Horários</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Relatórios -->
                        <div id="reports" class="section">
                            <h2 class="mb-4">Relatórios</h2>
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">Gerar Relatório</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row mb-3">
                                        <div class="col-md-3">
                                            <label for="reportType" class="form-label">Tipo de Relatório</label>
                                            <select class="form-select" id="reportType">
                                                <option value="daily">Diário</option>
                                                <option value="weekly">Semanal</option>
                                                <option value="monthly">Mensal</option>
                                                <option value="yearly">Anual</option>
                                                <option value="collaborator">Por Colaborador</option>
                                                <option value="inventory">Estoque</option>
                                                <option value="financial">Financeiro</option>
                                            </select>
                                        </div>
                                        <div class="col-md-3">
                                            <label for="reportDate" class="form-label">Data</label>
                                            <input type="date" class="form-control" id="reportDate">
                                        </div>
                                        <div class="col-md-3">
                                            <label for="reportCollaborator" class="form-label">Colaborador</label>
                                            <select class="form-select" id="reportCollaborator">
                                                <option value="all">Todos</option>
                                            </select>
                                        </div>
                                        <div class="col-md-3 d-flex align-items-end">
                                            <button class="btn btn-primary w-100" id="generateReportBtn">
                                                <i class="fas fa-download me-1"></i> Gerar PDF
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Aniversários -->
                        <div id="birthdays" class="section">
                            <h2 class="mb-4">Aniversários</h2>
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">Próximos Aniversários</h5>
                                </div>
                                <div class="card-body">
                                    <div id="birthdaysList">
                                        <p class="text-muted">Nenhum aniversário próximo encontrado.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Botão Flutuante para Dispositivos Móveis -->
    <div class="floating-mobile-btn" id="floatingMobileBtn">
        <i class="fas fa-home"></i>
    </div>
    
    <!-- Botão Home para Dispositivos Móveis -->
    <div class="floating-home-btn" id="floatingHomeBtn" style="display: none;">
        <i class="fas fa-home"></i>
    </div>

    <!-- Modal para Adicionar/Editar Cliente -->
    <div class="modal fade" id="clientModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="clientModalTitle">Adicionar Cliente</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="clientForm">
                        <input type="hidden" id="clientId">
                        <div class="mb-3">
                            <label for="clientName" class="form-label">Nome Completo</label>
                            <input type="text" class="form-control" id="clientName" required>
                        </div>
                        <div class="mb-3">
                            <label for="clientBirthdate" class="form-label">Data de Nascimento</label>
                            <input type="date" class="form-control" id="clientBirthdate" required>
                        </div>
                        <div class="mb-3">
                            <label for="clientPhone" class="form-label">Telefone/WhatsApp (+351)</label>
                            <input type="text" class="form-control" id="clientPhone" placeholder="+351" required>
                        </div>
                        <div class="mb-3">
                            <label for="clientEmail" class="form-label">E-mail</label>
                            <input type="email" class="form-control" id="clientEmail">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="saveClientBtn">Salvar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Adicionar/Editar Colaborador -->
    <div class="modal fade" id="collaboratorModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="collaboratorModalTitle">Adicionar Colaborador</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="collaboratorForm">
                        <input type="hidden" id="collaboratorId">
                        <div class="collaborator-photo-container">
                            <div class="collaborator-photo-placeholder" id="collaboratorPhotoPlaceholder">
                                <i class="fas fa-user"></i>
                            </div>
                            <img id="collaboratorPhotoPreview" class="collaborator-photo" src="" alt="Preview da foto" style="display: none;">
                            <input type="file" class="form-control mt-2" id="collaboratorPhotoUpload" accept="image/*">
                        </div>
                        <div class="mb-3">
                            <label for="collaboratorName" class="form-label">Nome Completo</label>
                            <input type="text" class="form-control" id="collaboratorName" required>
                        </div>
                        <div class="mb-3">
                            <label for="collaboratorContact" class="form-label">Contato</label>
                            <input type="text" class="form-control" id="collaboratorContact" placeholder="+351">
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="collaboratorManualPercent" class="form-label">% Serviços Manuais</label>
                                <input type="number" class="form-control" id="collaboratorManualPercent" min="0" max="100" step="0.1" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="collaboratorProductPercent" class="form-label">% Serviços com Produtos</label>
                                <input type="number" class="form-control" id="collaboratorProductPercent" min="0" max="100" step="0.1" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="collaboratorBaseSalary" class="form-label">Salário Base (€)</label>
                                <input type="number" class="form-control" id="collaboratorBaseSalary" step="0.01" min="0" value="0">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="collaboratorPaymentDay" class="form-label">Dia do Pagamento</label>
                                <input type="number" class="form-control" id="collaboratorPaymentDay" min="1" max="31" value="5">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="collaboratorSpecialty" class="form-label">Especialidade</label>
                            <input type="text" class="form-control" id="collaboratorSpecialty" placeholder="Ex: Corte, Coloração, etc." required>
                        </div>
                        <div class="mb-3">
                            <label for="collaboratorDescription" class="form-label">Descrição</label>
                            <textarea class="form-control" id="collaboratorDescription" rows="3" placeholder="Breve descrição sobre o colaborador..."></textarea>
                        </div>
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="collaboratorActive" checked>
                            <label class="form-check-label" for="collaboratorActive">Ativo</label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="saveCollaboratorBtn">Salvar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Visualizar Perfil do Colaborador -->
    <div class="modal fade" id="collaboratorProfileModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="collaboratorProfileModalTitle">Perfil do Colaborador</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="collaborator-profile">
                        <img id="collaboratorProfileImage" class="collaborator-profile-img" src="" alt="Foto do colaborador">
                        <h4 id="collaboratorProfileName"></h4>
                        <p class="text-muted" id="collaboratorProfileSpecialty"></p>
                        <p id="collaboratorProfileDescription"></p>
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <p><strong>Contato:</strong> <span id="collaboratorProfileContact"></span></p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>% Serviços Manuais:</strong> <span id="collaboratorProfileManualPercent"></span>%</p>
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-md-6">
                                <p><strong>% Serviços com Produtos:</strong> <span id="collaboratorProfileProductPercent"></span>%</p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>Salário Base:</strong> <span id="collaboratorProfileBaseSalary"></span></p>
                            </div>
                        </div>
                        <p class="mt-3"><strong>Status:</strong> <span id="collaboratorProfileStatus" class="badge bg-success">Ativo</span></p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Adicionar/Editar Produto -->
    <div class="modal fade" id="productModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="productModalTitle">Adicionar Produto</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="productForm">
                        <input type="hidden" id="productId">
                        <div class="mb-3">
                            <label for="productName" class="form-label">Nome do Produto</label>
                            <input type="text" class="form-control" id="productName" required>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="productQuantity" class="form-label">Quantidade em Estoque</label>
                                <input type="number" class="form-control" id="productQuantity" min="0" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="productMinQuantity" class="form-label">Quantidade Mínima</label>
                                <input type="number" class="form-control" id="productMinQuantity" min="1" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="productPurchasePrice" class="form-label">Preço de Compra (€)</label>
                                <input type="number" class="form-control" id="productPurchasePrice" step="0.01" min="0" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="productSalePrice" class="form-label">Preço de Venda (€)</label>
                                <input type="number" class="form-control" id="productSalePrice" step="0.01" min="0" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="productDescription" class="form-label">Descrição</label>
                            <textarea class="form-control" id="productDescription" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="productCategory" class="form-label">Categoria</label>
                            <select class="form-select" id="productCategory">
                                <option value="cabelo">Cabelo</option>
                                <option value="pele">Pele</option>
                                <option value="maquiagem">Maquiagem</option>
                                <option value="acessorios">Acessórios</option>
                                <option value="outros">Outros</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="saveProductBtn">Salvar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Configurar Estabelecimento -->
    <div class="modal fade" id="businessSettingsModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Configurar Estabelecimento</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="businessSettingsForm">
                        <div class="mb-3">
                            <label for="businessNameInput" class="form-label">Nome do Estabelecimento</label>
                            <input type="text" class="form-control" id="businessNameInput" required>
                        </div>
                        <div class="mb-3">
                            <label for="businessLogoType" class="form-label">Tipo de Logo</label>
                            <select class="form-select" id="businessLogoType">
                                <option value="scissors">Tesoura (Padrão)</option>
                                <option value="store">Loja</option>
                                <option value="spa">SPA</option>
                                <option value="salon">Salão</option>
                                <option value="barber">Barbearia</option>
                                <option value="custom">Upload de Imagem</option>
                            </select>
                        </div>
                        <div class="logo-upload-container" id="logoUploadContainer" style="display: none;">
                            <label for="logoUpload" class="form-label">Upload de Logo</label>
                            <input type="file" class="form-control" id="logoUpload" accept="image/*">
                            <div class="logo-preview-container mt-2">
                                <div class="logo-placeholder" id="logoPlaceholder">
                                    <i class="fas fa-image"></i>
                                </div>
                                <img id="logoPreview" class="logo-preview" src="" alt="Preview da logo">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="saveBusinessSettingsBtn">Salvar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Resumo do Cliente -->
    <div class="modal fade" id="clientSummaryModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="clientSummaryModalTitle">Resumo do Cliente</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="clientSummaryContent">
                        <!-- Conteúdo será preenchido dinamicamente -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Notas do Cliente -->
    <div class="modal fade" id="clientNotesModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="clientNotesModalTitle">Notas do Cliente</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="clientNotesForm">
                        <input type="hidden" id="clientNotesId">
                        <div class="mb-3">
                            <label for="clientNotes" class="form-label">Notas e Observações</label>
                            <textarea class="form-control" id="clientNotes" rows="6" placeholder="Ex: Tintas que usa na coloração, preferências, alergias, etc."></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="saveClientNotesBtn">Salvar Notas</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAIS DA NOVA AGENDA -->

    <!-- Modal de Seleção de Data -->
    <div class="date-picker-modal" id="datePickerModal">
        <div class="date-picker-header">
            <h5 class="mb-0">Selecionar Data</h5>
            <button type="button" class="btn-close" id="datePickerClose"></button>
        </div>
        <div class="date-picker-body" id="datePickerBody">
            <!-- Conteúdo será preenchido dinamicamente -->
        </div>
    </div>

    <!-- Tela de Seleção de Cliente -->
    <div class="client-selection-modal" id="clientSelectionModal">
        <div class="client-selection-header">
            <button type="button" class="btn btn-back" id="clientSelectionBack">
                <i class="fas fa-arrow-left"></i>
            </button>
            <input type="text" class="client-search-input" id="clientSearchInput" placeholder="Buscar cliente...">
        </div>
        <div class="quick-options">
            <div class="quick-option" id="addNewClientOption">
                <div class="quick-option-icon">
                    <i class="fas fa-plus"></i>
                </div>
                <div>Cadastrar cliente</div>
            </div>
            <div class="quick-option" id="noReservationOption">
                <div class="quick-option-icon">
                    <i class="fas fa-user"></i>
                </div>
                <div>Sem reserva</div>
            </div>
        </div>
        <div class="client-selection-body" id="clientSelectionBody">
            <!-- Lista de clientes será preenchida dinamicamente -->
        </div>
    </div>

    <!-- Tela de Seleção de Serviços -->
    <div class="service-selection-modal" id="serviceSelectionModal">
        <div class="client-selection-header">
            <button type="button" class="btn btn-back" id="serviceSelectionBack">
                <i class="fas fa-arrow-left"></i>
            </button>
            <h5 class="mb-0">Selecionar Serviço</h5>
        </div>
        <input type="text" class="service-search-input" id="serviceSearchInput" placeholder="Buscar serviço...">
        
        <div class="recent-services">
            <div class="recent-services-title">Serviços Recentes</div>
            <div class="recent-services-scroll" id="recentServicesScroll">
                <!-- Cards de serviços recentes serão preenchidos dinamicamente -->
            </div>
        </div>
        
        <div class="all-services-list" id="allServicesList">
            <!-- Lista de todos os serviços será preenchida dinamicamente -->
        </div>
    </div>

    <!-- Tela de Salvar Agendamento -->
    <div class="appointment-save-modal" id="appointmentSaveModal">
        <div class="appointment-save-header">
            <button type="button" class="btn btn-back" id="appointmentSaveBack">
                <i class="fas fa-arrow-left"></i>
            </button>
            <h5 class="mb-0">Salvar Agendamento</h5>
            <button type="button" class="btn-close" id="appointmentSaveClose"></button>
        </div>
        
        <div class="appointment-save-body">
            <div class="calendar-preview" id="calendarPreview">
                <!-- Calendário será preenchido dinamicamente -->
            </div>
            
            <div class="client-card-appointment" id="clientCardAppointment">
                <!-- Card do cliente será preenchido dinamicamente -->
            </div>
            
            <div class="appointment-details-card">
                <div class="appointment-details-title">Data e Hora</div>
                <div id="appointmentDateTimeDisplay">
                    <!-- Data e hora serão preenchidas dinamicamente -->
                </div>
            </div>
            
            <div class="appointment-details-card">
                <div class="appointment-details-title">Serviços Selecionados</div>
                <div class="selected-services-list" id="selectedServicesList">
                    <!-- Lista de serviços selecionados será preenchida dinamicamente -->
                </div>
                <div class="add-service-btn" id="addServiceBtnModal">
                    <i class="fas fa-plus me-2"></i> Adicionar serviço
                </div>
            </div>
        </div>
        
        <div class="appointment-footer">
            <div class="appointment-total">
                <div class="total-label">Total</div>
                <div class="total-value" id="appointmentTotalValue">€ 0,00</div>
            </div>
            
            <div class="footer-actions">
                <button class="footer-action-btn icon" id="moreOptionsBtn">
                    <i class="fas fa-ellipsis-v"></i>
                </button>
                <button class="footer-action-btn secondary" id="checkoutBtn">
                    Checkout
                </button>
                <button class="footer-action-btn primary" id="saveAppointmentBtn">
                    Salvar agendamento
                </button>
            </div>
        </div>
    </div>

    <!-- Popup de Confirmação -->
    <div class="confirmation-popup" id="confirmationPopup">
        <div class="confirmation-title">Notificação de Confirmação</div>
        <div class="confirmation-text">
            Deseja enviar uma notificação de confirmação ao cliente 24 horas antes do horário marcado?
        </div>
        <div class="confirmation-actions">
            <button class="btn btn-secondary" id="confirmationCancel">Não</button>
            <button class="btn btn-primary" id="confirmationConfirm">Sim, enviar</button>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Configuração do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyC5ezGCOS5d-Vy2l-Gimkl_V9VmwDLZzKc",
            authDomain: "studio-devitto-152400.firebaseapp.com",
            projectId: "studio-devitto-152400",
            storageBucket: "studio-devitto-152400.appspot.com",
            messagingSenderId: "138996544906",
            appId: "1:138996544906:web:6569bf954a00e2f7944473",
            measurementId: "G-FCC5T13QW8"
        };

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();

        // Variáveis globais
        let currentUser = null;
        let currentCashier = null;
        let todayServices = [];
        let todayProductSales = [];
        let allServices = [];
        let allProductSales = [];
        let clients = [];
        let collaborators = [];
        let packages = [];
        let products = [];
        let selectedClientId = null;
        let clientNotes = {};
        
        // Controle Financeiro
        let expenses = [];
        let salaryPayments = [];
        let expenseChart = null;
        
        // Configurações
        let businessSettings = {
            name: "Studio DeVitto",
            logoType: "scissors",
            customLogo: null
        };
        
        // Perfil da Empresa
        let businessProfile = {
            name: "Studio DeVitto",
            email: "",
            phone: "",
            address: "",
            description: ""
        };
        
        let businessHours = {
            monday: { open: "09:00", close: "18:00" },
            tuesday: { open: "09:00", close: "18:00" },
            wednesday: { open: "09:00", close: "18:00" },
            thursday: { open: "09:00", close: "18:00" },
            friday: { open: "09:00", close: "18:00" },
            saturday: { open: "09:00", close: "13:00" },
            sunday: { open: null, close: null }
        };
        
        // Controle de navegação mobile
        let currentSection = 'dashboard';
        let isMobileView = false;
        
        // Variáveis para autocomplete
        let filteredClients = [];
        let filteredProducts = [];

        // VARIÁVEIS DA NOVA AGENDA
        let appointments = [];
        let currentAgendaDate = new Date();
        let currentAgendaView = 'day';
        let isSelectingTime = false;
        let selectionStartTime = null;
        let selectionEndTime = null;
        let selectedCollaboratorId = null;
        let selectedDate = null;
        let selectedTime = null;
        let selectedClient = null;
        let selectedServices = [];
        let availableServices = [
            { id: 1, name: "Corte Masculino", duration: 30, price: 15, color: "#26196b" },
            { id: 2, name: "Corte Feminino", duration: 45, price: 25, color: "#4a3a9c" },
            { id: 3, name: "Coloração", duration: 90, price: 45, color: "#ff6b6b" },
            { id: 4, name: "Hidratação", duration: 60, price: 35, color: "#4ecdc4" },
            { id: 5, name: "Escova", duration: 45, price: 20, color: "#45b7d1" },
            { id: 6, name: "Manicure", duration: 30, price: 15, color: "#96ceb4" },
            { id: 7, name: "Pedicure", duration: 45, price: 20, color: "#feca57" },
            { id: 8, name: "Maquiagem", duration: 60, price: 40, color: "#ff9ff3" },
            { id: 9, name: "Depilação", duration: 30, price: 25, color: "#54a0ff" },
            { id: 10, name: "Massagem", duration: 60, price: 50, color: "#5f27cd" }
        ];

        // Inicialização quando o DOM estiver carregado
        document.addEventListener('DOMContentLoaded', function() {
            // Configurar listeners antes de verificar autenticação
            setupEventListeners();
            
            // Inicializar data e hora
            updateDateTime();
            setInterval(updateDateTime, 1000);
            
            // Carregar configurações locais do estabelecimento (não requerem auth)
            loadBusinessSettings();
            
            // Verificar se há um usuário logado - CRÍTICO: onAuthStateChanged deve ser configurado PRIMEIRO
            auth.onAuthStateChanged(user => {
                if (user) {
                    currentUser = user;
                    showMainScreen();
                    loadInitialData();
                    // Inicializar agenda SOMENTE após autenticação confirmada
                    setTimeout(() => {
                        checkMobileDevice();
                        if (typeof initAgenda === 'function') {
                            initAgenda();
                        }
                    }, 100);
                } else {
                    currentUser = null;
                    showLoginScreen();
                }
            });
        });

        function setupEventListeners() {
            // Login
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('showRegister').addEventListener('click', showRegisterForm);
            document.getElementById('showLogin').addEventListener('click', showLoginForm);
            
            // Registro
            document.getElementById('registerForm').addEventListener('submit', handleRegister);
            
            // Logout
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
            
            // Navegação - MENU DESKTOP CORRIGIDO
            document.querySelectorAll('.sidebar .nav-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const section = this.getAttribute('data-section');
                    
                    // Remover classe ativa de TODOS os links do sidebar
                    document.querySelectorAll('.sidebar .nav-link').forEach(item => {
                        item.classList.remove('active');
                    });
                    
                    // Adicionar classe ativa apenas ao link clicado
                    this.classList.add('active');
                    
                    // Mostrar a seção correspondente
                    showSection(section);
                });
            });
            
            // Navegação - MENU MOBILE SEPARADO
            document.querySelectorAll('.mobile-menu .nav-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const section = this.getAttribute('data-section');
                    
                    // Remover classe ativa de TODOS os links do mobile menu
                    document.querySelectorAll('.mobile-menu .nav-link').forEach(item => {
                        item.classList.remove('active');
                    });
                    
                    // Adicionar classe ativa apenas ao link clicado
                    this.classList.add('active');
                    
                    // Mostrar a seção correspondente
                    showSection(section);
                });
            });

            // Cards mobile
            document.querySelectorAll('.mobile-card').forEach(card => {
                card.addEventListener('click', function() {
                    const section = this.getAttribute('data-section');
                    showSection(section);
                });
            });

            // Caixa - NOVO: Eventos para autocomplete
            document.getElementById('clientSelect').addEventListener('input', filterClientsAutocomplete);
            document.getElementById('productSaleSelect').addEventListener('input', filterProductsAutocomplete);
            document.getElementById('productSaleClient').addEventListener('input', filterProductClientsAutocomplete);
            
            // Fechar autocomplete quando clicar fora
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.autocomplete-container')) {
                    closeAllAutocompleteLists();
                }
            });
            
            // Caixa - eventos existentes
            document.getElementById('openCashierBtn').addEventListener('click', openCashier);
            document.getElementById('closeCashierBtn').addEventListener('click', closeCashier);
            document.getElementById('serviceForm').addEventListener('submit', addService);
            document.getElementById('addAnotherServiceBtn').addEventListener('click', addAnotherService);
            document.getElementById('productSaleForm').addEventListener('submit', addProductSale);
            
            // Clientes
            document.getElementById('addClientBtn').addEventListener('click', showAddClientModal);
            document.getElementById('saveClientBtn').addEventListener('click', saveClient);
            document.getElementById('clientSearch').addEventListener('input', searchClients);
            document.getElementById('addNewClientLink').addEventListener('click', function(e) {
                e.preventDefault();
                showAddClientModal();
            });
            
            // Colaboradores
            document.getElementById('addCollaboratorBtn').addEventListener('click', showAddCollaboratorModal);
            document.getElementById('saveCollaboratorBtn').addEventListener('click', saveCollaborator);
            document.getElementById('collaboratorPhotoUpload').addEventListener('change', handleCollaboratorPhotoUpload);
            
            // Produtos
            document.getElementById('addProductBtn').addEventListener('click', showAddProductModal);
            document.getElementById('saveProductBtn').addEventListener('click', saveProduct);
            
            // Pacotes
            document.getElementById('packageForm').addEventListener('submit', savePackage);
            document.getElementById('packageFrequency').addEventListener('change', toggleDaysSelection);
            document.getElementById('cancelPackageEditBtn').addEventListener('click', cancelPackageEdit);
            
            // Controle Financeiro
            document.getElementById('expenseForm').addEventListener('submit', saveExpense);
            document.getElementById('salaryPaymentForm').addEventListener('submit', saveSalaryPayment);
            document.getElementById('expensesMonth').addEventListener('change', loadExpensesByMonth);
            document.getElementById('salariesMonth').addEventListener('change', loadSalariesByMonth);
            
            // Relatórios
            document.getElementById('generateReportBtn').addEventListener('click', generateReport);
            
            // Registros de Clientes
            document.getElementById('clientRecordsSearch').addEventListener('input', searchClientRecords);
            document.getElementById('saveClientNotesBtn').addEventListener('click', saveClientNotes);
            
            // Eventos para funcionalidades adicionadas
            document.getElementById('lowStockAlertCard').addEventListener('click', toggleLowStockDetails);
            document.getElementById('refreshTodaySales').addEventListener('click', refreshTodaySales);
            document.getElementById('todaySalesSearch').addEventListener('input', filterTodaySales);
            document.getElementById('inventorySearch').addEventListener('input', filterInventory);
            document.getElementById('clientRecordClose').addEventListener('click', closeMobileClientRecord);
            document.getElementById('clientRecordOverlay').addEventListener('click', closeMobileClientRecord);
            
            // Eventos para Configurações do Estabelecimento
            document.getElementById('changeBusinessSettings').addEventListener('click', showBusinessSettingsModal);
            document.getElementById('saveBusinessSettingsBtn').addEventListener('click', saveBusinessSettings);
            document.getElementById('businessLogoType').addEventListener('change', toggleLogoUpload);
            document.getElementById('logoUpload').addEventListener('change', handleLogoUpload);
            
            // Evento para botão flutuante móvel
            document.getElementById('floatingMobileBtn').addEventListener('click', showMobileCards);
            
            // Eventos para Perfil da Empresa
            document.getElementById('businessProfileForm').addEventListener('submit', saveBusinessProfile);
            document.getElementById('saveBusinessHours').addEventListener('click', saveBusinessHours);
            
            // Evento para botão home mobile
            document.getElementById('floatingHomeBtn').addEventListener('click', showMobileCards);
            
            // Evento para redimensionamento da janela
            window.addEventListener('resize', handleResize);
            
            // NOVO: Eventos da Agenda
            document.getElementById('agendaMenuBtn').addEventListener('click', toggleAgendaMenu);
            document.getElementById('agendaDateDisplay').addEventListener('click', showDatePicker);
            document.querySelectorAll('.agenda-view-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    changeAgendaView(this.getAttribute('data-view'));
                });
            });
            document.getElementById('datePickerClose').addEventListener('click', closeDatePicker);
            document.getElementById('clientSelectionBack').addEventListener('click', closeClientSelection);
            document.getElementById('serviceSelectionBack').addEventListener('click', closeServiceSelection);
            document.getElementById('appointmentSaveBack').addEventListener('click', closeAppointmentSave);
            document.getElementById('appointmentSaveClose').addEventListener('click', closeAppointmentSave);
            document.getElementById('addNewClientOption').addEventListener('click', showAddClientModalFromAgenda);
            document.getElementById('noReservationOption').addEventListener('click', selectNoReservation);
            document.getElementById('clientSearchInput').addEventListener('input', searchClientsForAgenda);
            document.getElementById('serviceSearchInput').addEventListener('input', searchServicesForAgenda);
            document.getElementById('addServiceBtnModal').addEventListener('click', addAnotherServiceToAppointment);
            document.getElementById('moreOptionsBtn').addEventListener('click', showMoreOptions);
            document.getElementById('checkoutBtn').addEventListener('click', checkoutAppointment);
            document.getElementById('saveAppointmentBtn').addEventListener('click', saveAppointment);
            document.getElementById('confirmationCancel').addEventListener('click', cancelConfirmation);
            document.getElementById('confirmationConfirm').addEventListener('click', confirmConfirmation);
        }

        // FUNÇÕES DA NOVA AGENDA

        function initAgenda() {
            // Verificar se elementos da agenda existem antes de inicializar
            if (!document.getElementById('agendaDateDisplay')) {
                console.log('Elementos da agenda não encontrados, pulando inicialização');
                return;
            }
            loadAppointments();
            updateAgendaDisplay();
        }
        
        function renderAgenda() {
            // Função de compatibilidade - chama renderAgendaGrid
            if (typeof renderAgendaGrid === 'function') {
                renderAgendaGrid();
            }
        }

        function loadAppointments() {
            if (!currentUser) return;
            
            db.collection('appointments')
                .where('userId', '==', currentUser.uid)
                .get()
                .then((querySnapshot) => {
                    appointments = [];
                    querySnapshot.forEach((doc) => {
                        appointments.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    renderAgenda();
                })
                .catch((error) => {
                    console.error("Erro ao carregar agendamentos: ", error);
                });
        }

        function updateAgendaDisplay() {
            const dateDisplay = document.getElementById('agendaDateDisplay');
            if (!dateDisplay) return; // Proteção se elemento não existe
            
            const options = { weekday: 'short', day: 'numeric', month: 'short' };
            const dateString = currentAgendaDate.toLocaleDateString('pt-PT', options);
            dateDisplay.innerHTML = `${dateString} <i class="fas fa-chevron-down"></i>`;
            
            updateAgendaProfessionals();
            renderTimeColumn();
            renderAgendaGrid();
        }

        function updateAgendaProfessionals() {
            const container = document.getElementById('agendaProfessionals');
            if (!container) return;
            container.innerHTML = '';
            
            const activeCollaborators = collaborators.filter(c => c.active);
            
            // Se não há colaboradores, mostrar placeholder
            if (activeCollaborators.length === 0) {
                container.innerHTML = '<div class="text-muted text-center p-3">Nenhum colaborador ativo</div>';
                container.classList.remove('scrollable');
                return;
            }
            
            // Adicionar classe scrollable se 4+ colaboradores
            if (activeCollaborators.length > 3) {
                container.classList.add('scrollable');
            } else {
                container.classList.remove('scrollable');
            }
            
            activeCollaborators.forEach((collaborator, index) => {
                const div = document.createElement('div');
                div.className = 'agenda-professional';
                div.setAttribute('data-collaborator-id', collaborator.id);
                
                // Marcar primeiro como selecionado por padrão
                if (index === 0 && !selectedCollaboratorId) {
                    selectedCollaboratorId = collaborator.id;
                    div.classList.add('selected');
                } else if (selectedCollaboratorId === collaborator.id) {
                    div.classList.add('selected');
                }
                
                // Criar foto ou placeholder
                const photoUrl = collaborator.photoUrl || '';
                const initials = collaborator.name.charAt(0).toUpperCase();
                
                div.innerHTML = `
                    <div class="agenda-professional-photo-container" style="display: flex; justify-content: center; align-items: center; margin-bottom: 5px;">
                        ${photoUrl ? 
                            `<img src="${photoUrl}" class="agenda-professional-photo" 
                                 onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" 
                                 alt="${collaborator.name}"
                                 data-id="${collaborator.id}"
                                 style="margin: 0 auto;">
                             <div class="agenda-professional-placeholder" 
                                  data-id="${collaborator.id}"
                                  style="display: none; width: 50px; height: 50px; border-radius: 50%; background: linear-gradient(135deg, #26196b 0%, #4a3a9c 100%); color: white; font-size: 20px; align-items: center; justify-content: center; cursor: pointer; margin: 0 auto; box-shadow: 0 2px 8px rgba(0,0,0,0.2);">
                                 ${initials}
                             </div>` :
                            `<div class="agenda-professional-placeholder" 
                                  data-id="${collaborator.id}"
                                  style="width: 50px; height: 50px; border-radius: 50%; background: linear-gradient(135deg, #26196b 0%, #4a3a9c 100%); color: white; font-size: 20px; display: flex; align-items: center; justify-content: center; cursor: pointer; margin: 0 auto; box-shadow: 0 2px 8px rgba(0,0,0,0.2);">
                                 ${initials}
                             </div>`
                        }
                    </div>
                    <div class="agenda-professional-name">${collaborator.name}</div>
                `;
                
                // Evento de clique no card do profissional
                div.addEventListener('click', function() {
                    // Remover seleção de todos
                    document.querySelectorAll('.agenda-professional').forEach(p => p.classList.remove('selected'));
                    // Adicionar seleção ao clicado
                    this.classList.add('selected');
                    selectedCollaboratorId = collaborator.id;
                });
                
                container.appendChild(div);
            });
            
            // Adicionar evento de clique nas fotos/placeholders para ver perfil
            container.querySelectorAll('.agenda-professional-photo, .agenda-professional-placeholder').forEach(photo => {
                photo.addEventListener('dblclick', function(e) {
                    e.stopPropagation();
                    const collaboratorId = this.getAttribute('data-id');
                    if (collaboratorId) {
                        showCollaboratorProfile(collaboratorId);
                    }
                });
            });
        }

        function renderTimeColumn() {
            const container = document.getElementById('agendaTimeColumn');
            if (!container) return;
            container.innerHTML = '';
            
            const now = new Date();
            const currentHour = now.getHours();
            const currentMinute = now.getMinutes();
            const currentTimeStr = `${currentHour.toString().padStart(2, '0')}:${currentMinute.toString().padStart(2, '0')}`;
            
            for (let hour = 0; hour < 24; hour++) {
                const slot = document.createElement('div');
                slot.className = 'agenda-time-slot';
                slot.style.position = 'relative';
                slot.textContent = `${hour.toString().padStart(2, '0')}:00`;
                
                // Adicionar linha vermelha do horário atual - CORRIGIDA para atravessar toda a tela
                if (hour === currentHour) {
                    const linePosition = (currentMinute / 60) * 100;
                    
                    // Limpar linha anterior se existir
                    const existingLine = document.querySelector('.current-time-line-global');
                    if (existingLine) existingLine.remove();
                    
                    slot.innerHTML = `
                        <div style="
                            position: absolute;
                            left: -5px;
                            top: ${linePosition}%;
                            display: flex;
                            align-items: center;
                            z-index: 100;
                            pointer-events: none;
                        ">
                            <div style="
                                background-color: #dc3545;
                                color: white;
                                padding: 2px 6px;
                                border-radius: 4px;
                                font-size: 10px;
                                font-weight: bold;
                                white-space: nowrap;
                            ">${currentTimeStr}</div>
                        </div>
                    `;
                    
                    // Adicionar linha que atravessa toda a agenda
                    const agendaContent = document.querySelector('.agenda-content');
                    if (agendaContent) {
                        const globalLine = document.createElement('div');
                        globalLine.className = 'current-time-line-global';
                        globalLine.style.cssText = `
                            position: absolute;
                            left: 0;
                            right: 0;
                            top: calc(${(hour * 60 + currentMinute)}px + 0px);
                            height: 2px;
                            background: linear-gradient(90deg, #dc3545, #dc3545 70%, transparent 100%);
                            z-index: 50;
                            pointer-events: none;
                        `;
                        agendaContent.style.position = 'relative';
                        
                        // Calcular posição baseada na altura dos slots (60px por hora)
                        const topPosition = (hour * 60) + (currentMinute);
                        globalLine.style.top = `${topPosition}px`;
                        
                        agendaContent.appendChild(globalLine);
                    }
                }
                
                container.appendChild(slot);
            }
            
            // Atualizar linha do horário atual a cada minuto
            if (!window.currentTimeInterval) {
                window.currentTimeInterval = setInterval(() => {
                    // Remover linha global antiga
                    const existingLine = document.querySelector('.current-time-line-global');
                    if (existingLine) existingLine.remove();
                    renderTimeColumn();
                }, 60000);
            }
        }

        function renderAgendaGrid() {
            const container = document.getElementById('agendaGrid');
            if (!container) return; // Proteção se elemento não existe
            container.innerHTML = '';
            
            const days = getDaysForView();
            
            // Verificar se precisa scroll horizontal (4+ colaboradores)
            const activeCollaborators = collaborators.filter(c => c.active);
            if (activeCollaborators.length > 3) {
                container.classList.add('scrollable');
            } else {
                container.classList.remove('scrollable');
            }
            
            days.forEach(day => {
                const dayColumn = document.createElement('div');
                dayColumn.className = 'agenda-day-column';
                dayColumn.setAttribute('data-date', day.toISOString().split('T')[0]);
                
                // Cabeçalho do dia
                const header = document.createElement('div');
                header.className = 'agenda-day-header';
                
                // Verificar se é hoje para destacar
                const isToday = day.toDateString() === new Date().toDateString();
                if (isToday) {
                    header.style.background = 'linear-gradient(135deg, #26196b 0%, #4a3a9c 100%)';
                    header.style.color = 'white';
                }
                
                header.innerHTML = `
                    <div class="agenda-day-name" style="${isToday ? 'color: rgba(255,255,255,0.8);' : ''}">${day.toLocaleDateString('pt-PT', { weekday: 'short' })}</div>
                    <div class="agenda-day-number" style="${isToday ? 'color: white;' : ''}">${day.getDate()}</div>
                `;
                dayColumn.appendChild(header);
                
                // Slots de horário com feedback visual melhorado
                for (let hour = 0; hour < 24; hour++) {
                    for (let quarter = 0; quarter < 4; quarter++) {
                        const slot = document.createElement('div');
                        slot.className = 'agenda-slot-quarter';
                        slot.setAttribute('data-hour', hour);
                        slot.setAttribute('data-quarter', quarter);
                        slot.setAttribute('data-date', day.toISOString().split('T')[0]);
                        
                        // Adicionar indicador de hora cheia
                        if (quarter === 0) {
                            slot.style.borderTop = '1px solid #ddd';
                        }
                        
                        slot.addEventListener('mousedown', startTimeSelection);
                        slot.addEventListener('touchstart', startTimeSelection);
                        slot.addEventListener('mouseenter', updateTimeSelection);
                        slot.addEventListener('touchmove', updateTimeSelection);
                        slot.addEventListener('mouseup', endTimeSelection);
                        slot.addEventListener('touchend', endTimeSelection);
                        
                        dayColumn.appendChild(slot);
                    }
                }
                
                container.appendChild(dayColumn);
            });
            
            // Renderizar agendamentos existentes
            renderAppointments();
            
            // Adicionar overlay de seleção
            addSelectionOverlay();
        }

        function getDaysForView() {
            const days = [];
            const startDate = new Date(currentAgendaDate);
            
            switch(currentAgendaView) {
                case 'day':
                    days.push(startDate);
                    break;
                case '3days':
                    for (let i = 0; i < 3; i++) {
                        const date = new Date(startDate);
                        date.setDate(startDate.getDate() + i);
                        days.push(date);
                    }
                    break;
                case 'week':
                    // Ajustar para começar na segunda-feira
                    const dayOfWeek = startDate.getDay();
                    const diffToMonday = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
                    startDate.setDate(startDate.getDate() + diffToMonday);
                    
                    for (let i = 0; i < 7; i++) {
                        const date = new Date(startDate);
                        date.setDate(startDate.getDate() + i);
                        days.push(date);
                    }
                    break;
                case 'month':
                    // Mostrar primeiros 30 dias do mês
                    startDate.setDate(1);
                    for (let i = 0; i < 30; i++) {
                        const date = new Date(startDate);
                        date.setDate(startDate.getDate() + i);
                        days.push(date);
                    }
                    break;
            }
            
            return days;
        }

        function renderAppointments() {
            // Limpar agendamentos existentes
            document.querySelectorAll('.agenda-appointment').forEach(el => el.remove());
            
            appointments.forEach(appointment => {
                const appointmentDate = new Date(appointment.date);
                const dayColumn = document.querySelector(`.agenda-day-column[data-date="${appointment.date}"]`);
                
                if (!dayColumn) return;
                
                const startHour = parseInt(appointment.startTime.split(':')[0]);
                const startMinute = parseInt(appointment.startTime.split(':')[1]);
                const duration = appointment.duration || 60; // minutos
                
                const startPosition = (startHour * 60 + startMinute) / 15; // cada slot = 15 minutos
                const heightSlots = duration / 15;
                
                const appointmentEl = document.createElement('div');
                appointmentEl.className = 'agenda-appointment';
                appointmentEl.style.top = `${startPosition * 15}px`;
                appointmentEl.style.height = `${heightSlots * 15}px`;
                appointmentEl.style.backgroundColor = appointment.color || '#26196b';
                appointmentEl.innerHTML = `
                    <strong>${appointment.clientName || 'Cliente'}</strong><br>
                    <small>${appointment.serviceName || 'Serviço'}</small>
                `;
                
                appointmentEl.addEventListener('click', () => {
                    showAppointmentDetails(appointment.id);
                });
                
                dayColumn.appendChild(appointmentEl);
            });
        }

        function addSelectionOverlay() {
            let overlay = document.getElementById('agendaSelectionOverlay');
            if (!overlay) {
                overlay = document.createElement('div');
                overlay.id = 'agendaSelectionOverlay';
                overlay.className = 'agenda-selection-overlay';
                overlay.style.display = 'none';
                document.getElementById('agendaSlotsContainer').appendChild(overlay);
            }
            return overlay;
        }

        // Variáveis para controle de toque longo
        let longPressTimer = null;
        let isLongPress = false;
        let touchStartY = 0;
        let lastTouchY = 0;
        
        function startTimeSelection(e) {
            const slot = e.target.closest('.agenda-slot-quarter');
            if (!slot) return;
            
            const date = slot.getAttribute('data-date');
            const hour = parseInt(slot.getAttribute('data-hour'));
            const quarter = parseInt(slot.getAttribute('data-quarter'));
            
            // Para eventos de mouse, iniciar seleção diretamente
            if (e.type === 'mousedown') {
                e.preventDefault();
                isSelectingTime = true;
                isLongPress = true;
                selectionStartTime = { date, hour, quarter };
                selectionEndTime = { date, hour, quarter };
                updateSelectionOverlay();
                return;
            }
            
            // Para eventos de toque, verificar toque longo
            if (e.type === 'touchstart') {
                touchStartY = e.touches[0].clientY;
                lastTouchY = touchStartY;
                isLongPress = false;
                
                // Iniciar timer para toque longo (500ms)
                longPressTimer = setTimeout(() => {
                    isLongPress = true;
                    isSelectingTime = true;
                    selectionStartTime = { date, hour, quarter };
                    selectionEndTime = { date, hour, quarter };
                    updateSelectionOverlay();
                    
                    // Feedback visual/háptico
                    if (navigator.vibrate) {
                        navigator.vibrate(50);
                    }
                }, 500);
            }
        }

        function updateTimeSelection(e) {
            // Para scroll normal no touch, não fazer nada
            if (e.type === 'touchmove') {
                const currentY = e.touches[0].clientY;
                const deltaY = Math.abs(currentY - touchStartY);
                
                // Se moveu muito sem toque longo, cancelar timer e permitir scroll
                if (!isLongPress && deltaY > 10) {
                    if (longPressTimer) {
                        clearTimeout(longPressTimer);
                        longPressTimer = null;
                    }
                    return;
                }
                
                // Se é toque longo, prevenir scroll e atualizar seleção
                if (isLongPress && isSelectingTime) {
                    e.preventDefault();
                    lastTouchY = currentY;
                    
                    // Encontrar o slot sob o dedo
                    const touch = e.touches[0];
                    const element = document.elementFromPoint(touch.clientX, touch.clientY);
                    const slot = element ? element.closest('.agenda-slot-quarter') : null;
                    
                    if (slot) {
                        const hour = parseInt(slot.getAttribute('data-hour'));
                        const quarter = parseInt(slot.getAttribute('data-quarter'));
                        const date = slot.getAttribute('data-date');
                        
                        if (date === selectionStartTime.date) {
                            selectionEndTime = { date, hour, quarter };
                            updateSelectionOverlay();
                        }
                    }
                }
                return;
            }
            
            // Para mouse, atualizar normalmente
            if (!isSelectingTime || e.type !== 'mouseenter') return;
            
            const slot = e.target.closest('.agenda-slot-quarter');
            if (!slot) return;
            
            const date = slot.getAttribute('data-date');
            const hour = parseInt(slot.getAttribute('data-hour'));
            const quarter = parseInt(slot.getAttribute('data-quarter'));
            
            if (date === selectionStartTime.date) {
                selectionEndTime = { date, hour, quarter };
                updateSelectionOverlay();
            }
        }
        
        function endTimeSelection(e) {
            // Limpar timer de toque longo
            if (longPressTimer) {
                clearTimeout(longPressTimer);
                longPressTimer = null;
            }
            
            if (!isSelectingTime) {
                isLongPress = false;
                return;
            }
            
            if (e.type === 'touchend' && isLongPress && selectionStartTime && selectionEndTime) {
                e.preventDefault();
            }
            
            isSelectingTime = false;
            
            if (selectionStartTime && selectionEndTime) {
                // Calcular hora selecionada
                const startTotal = selectionStartTime.hour * 60 + selectionStartTime.quarter * 15;
                const endTotal = selectionEndTime.hour * 60 + selectionEndTime.quarter * 15;
                
                const minTotal = Math.min(startTotal, endTotal);
                const hour = Math.floor(minTotal / 60);
                const minute = minTotal % 60;
                
                selectedDate = selectionStartTime.date;
                selectedTime = { hour, minute };
                
                // Mostrar seleção de cliente
                showClientSelection();
            }
            
            // Limpar overlay
            const overlay = document.getElementById('agendaSelectionOverlay');
            if (overlay) {
                overlay.style.display = 'none';
            }
            
            selectionStartTime = null;
            selectionEndTime = null;
            isLongPress = false;
        }

        function updateSelectionOverlay() {
            if (!selectionStartTime || !selectionEndTime) return;
            
            const overlay = document.getElementById('agendaSelectionOverlay');
            if (!overlay) return;
            
            const startTotal = selectionStartTime.hour * 4 + selectionStartTime.quarter;
            const endTotal = selectionEndTime.hour * 4 + selectionEndTime.quarter;
            
            const minPos = Math.min(startTotal, endTotal);
            const maxPos = Math.max(startTotal, endTotal);
            
            overlay.style.display = 'block';
            overlay.style.top = `${minPos * 15}px`;
            overlay.style.height = `${(maxPos - minPos + 1) * 15}px`;
            overlay.style.left = '0';
            overlay.style.right = '0';
            
            // Mostrar hora selecionada
            const startHour = Math.floor(minPos / 4);
            const startMin = (minPos % 4) * 15;
            const endHour = Math.floor((maxPos + 1) / 4);
            const endMin = ((maxPos + 1) % 4) * 15;
            
            overlay.innerHTML = `
                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
                            background: rgba(38, 25, 107, 0.9); color: white; padding: 5px 10px; 
                            border-radius: 4px; font-size: 12px; font-weight: bold;">
                    ${startHour.toString().padStart(2, '0')}:${startMin.toString().padStart(2, '0')} - 
                    ${endHour.toString().padStart(2, '0')}:${endMin.toString().padStart(2, '0')}
                </div>
            `;
        }

        function endTimeSelection(e) {
            if (!isSelectingTime) return;
            
            e.preventDefault();
            isSelectingTime = false;
            
            // Verificar se há uma seleção válida
            if (selectionStartTime && selectionEndTime) {
                const startMinutes = selectionStartTime.hour * 60 + selectionStartTime.quarter * 15;
                const endMinutes = selectionEndTime.hour * 60 + selectionEndTime.quarter * 15;
                
                const duration = Math.abs(endMinutes - startMinutes);
                if (duration >= 15) { // Mínimo 15 minutos
                    selectedDate = selectionStartTime.date;
                    selectedTime = {
                        hour: Math.min(selectionStartTime.hour, selectionEndTime.hour),
                        minute: Math.min(selectionStartTime.quarter, selectionEndTime.quarter) * 15
                    };
                    
                    showClientSelection();
                }
            }
            
            // Limpar overlay
            const overlay = document.getElementById('agendaSelectionOverlay');
            if (overlay) {
                overlay.style.display = 'none';
            }
            
            selectionStartTime = null;
            selectionEndTime = null;
        }

        function updateSelectionOverlay() {
            if (!selectionStartTime || !selectionEndTime) return;
            
            const overlay = document.getElementById('agendaSelectionOverlay');
            if (!overlay) return;
            
            // Calcular posições
            const startDate = selectionStartTime.date;
            const endDate = selectionEndTime.date;
            
            // Para simplificar, vamos considerar apenas seleções no mesmo dia
            if (startDate !== endDate) return;
            
            const dayColumn = document.querySelector(`.agenda-day-column[data-date="${startDate}"]`);
            if (!dayColumn) return;
            
            const startMinutes = selectionStartTime.hour * 60 + selectionStartTime.quarter * 15;
            const endMinutes = selectionEndTime.hour * 60 + selectionEndTime.quarter * 15;
            
            const top = Math.min(startMinutes, endMinutes);
            const height = Math.abs(endMinutes - startMinutes);
            
            const columnRect = dayColumn.getBoundingClientRect();
            const containerRect = dayColumn.parentElement.getBoundingClientRect();
            
            overlay.style.display = 'block';
            overlay.style.left = `${columnRect.left - containerRect.left}px`;
            overlay.style.top = `${top}px`;
            overlay.style.width = `${columnRect.width}px`;
            overlay.style.height = `${height}px`;
        }

        function toggleAgendaMenu() {
            // Implementar menu de opções da agenda
            showSuccess('Menu da agenda em desenvolvimento');
        }

        function showDatePicker() {
            const modal = document.getElementById('datePickerModal');
            const body = document.getElementById('datePickerBody');
            
            body.innerHTML = '';
            
            // Gerar calendário para 12 meses
            const today = new Date();
            for (let m = 0; m < 12; m++) {
                const monthDate = new Date(today.getFullYear(), today.getMonth() + m, 1);
                const monthDiv = document.createElement('div');
                monthDiv.className = 'date-picker-month';
                
                const title = document.createElement('div');
                title.className = 'date-picker-month-title';
                title.textContent = monthDate.toLocaleDateString('pt-PT', { month: 'long', year: 'numeric' });
                monthDiv.appendChild(title);
                
                const daysGrid = document.createElement('div');
                daysGrid.className = 'date-picker-days';
                
                // Dias da semana
                const weekdays = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'];
                weekdays.forEach(day => {
                    const dayEl = document.createElement('div');
                    dayEl.className = 'date-picker-day';
                    dayEl.style.fontWeight = 'bold';
                    dayEl.textContent = day;
                    daysGrid.appendChild(dayEl);
                });
                
                // Dias vazios no início
                const firstDay = monthDate.getDay();
                for (let i = 0; i < firstDay; i++) {
                    const emptyDay = document.createElement('div');
                    daysGrid.appendChild(emptyDay);
                }
                
                // Dias do mês
                const daysInMonth = new Date(monthDate.getFullYear(), monthDate.getMonth() + 1, 0).getDate();
                for (let d = 1; d <= daysInMonth; d++) {
                    const dayDate = new Date(monthDate.getFullYear(), monthDate.getMonth(), d);
                    const dayEl = document.createElement('div');
                    dayEl.className = 'date-picker-day';
                    dayEl.textContent = d;
                    
                    // Marcar hoje
                    if (dayDate.toDateString() === new Date().toDateString()) {
                        dayEl.classList.add('today');
                    }
                    
                    // Marcar selecionado
                    if (dayDate.toDateString() === currentAgendaDate.toDateString()) {
                        dayEl.classList.add('selected');
                    }
                    
                    dayEl.addEventListener('click', () => {
                        currentAgendaDate = dayDate;
                        updateAgendaDisplay();
                        modal.classList.remove('active');
                    });
                    
                    daysGrid.appendChild(dayEl);
                }
                
                monthDiv.appendChild(daysGrid);
                body.appendChild(monthDiv);
            }
            
            modal.classList.add('active');
        }

        function closeDatePicker() {
            document.getElementById('datePickerModal').classList.remove('active');
        }

        function changeAgendaView(view) {
            currentAgendaView = view;
            
            // Atualizar botões ativos
            document.querySelectorAll('.agenda-view-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.getAttribute('data-view') === view) {
                    btn.classList.add('active');
                }
            });
            
            updateAgendaDisplay();
        }

        function showClientSelection() {
            const modal = document.getElementById('clientSelectionModal');
            modal.classList.add('active');
            
            loadClientsForSelection();
        }

        function closeClientSelection() {
            document.getElementById('clientSelectionModal').classList.remove('active');
            selectedClient = null;
        }

        function loadClientsForSelection() {
            const container = document.getElementById('clientSelectionBody');
            container.innerHTML = '';
            
            clients.forEach(client => {
                const option = document.createElement('div');
                option.className = 'client-option';
                option.innerHTML = `
                    <div class="client-option-avatar">
                        ${client.name.charAt(0).toUpperCase()}
                    </div>
                    <div class="client-option-info">
                        <div class="client-option-name">${client.name}</div>
                        <div class="client-option-phone">${client.phone || 'Sem telefone'}</div>
                    </div>
                `;
                
                option.addEventListener('click', () => {
                    selectedClient = client;
                    showServiceSelection();
                });
                
                container.appendChild(option);
            });
        }

        function searchClientsForAgenda() {
            const searchTerm = document.getElementById('clientSearchInput').value.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, "");
            const container = document.getElementById('clientSelectionBody');
            const options = container.querySelectorAll('.client-option');
            
            options.forEach(option => {
                const name = option.querySelector('.client-option-name').textContent.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, "");
                const phone = option.querySelector('.client-option-phone').textContent.toLowerCase();
                
                if (name.includes(searchTerm) || phone.includes(searchTerm)) {
                    option.style.display = 'flex';
                } else {
                    option.style.display = 'none';
                }
            });
        }

        function showAddClientModalFromAgenda() {
            closeClientSelection();
            showAddClientModal();
        }

        function selectNoReservation() {
            selectedClient = {
                id: null,
                name: 'Cliente sem reserva',
                phone: ''
            };
            showServiceSelection();
        }

        function showServiceSelection() {
            closeClientSelection();
            
            const modal = document.getElementById('serviceSelectionModal');
            modal.classList.add('active');
            
            loadRecentServices();
            loadAllServicesForSelection();
        }

        function closeServiceSelection() {
            document.getElementById('serviceSelectionModal').classList.remove('active');
        }

        function loadRecentServices() {
            const container = document.getElementById('recentServicesScroll');
            container.innerHTML = '';
            
            if (!selectedClient || !selectedClient.id) return;
            
            // Filtrar serviços recentes do cliente
            const clientServices = allServices
                .filter(service => service.clientId === selectedClient.id)
                .slice(0, 5);
            
            clientServices.forEach(service => {
                const card = document.createElement('div');
                card.className = 'recent-service-card';
                
                const serviceDate = service.timestamp.toDate ? service.timestamp.toDate() : new Date(service.timestamp);
                const collaborator = collaborators.find(c => c.id === service.collaboratorId);
                
                card.innerHTML = `
                    <div class="service-name">${service.description || 'Serviço'}</div>
                    <div class="service-date">${formatDate(serviceDate)} - ${collaborator?.name || 'Colaborador'}</div>
                    <div class="service-price">${formatCurrency(service.value)}</div>
                `;
                
                card.addEventListener('click', () => {
                    selectService({
                        id: service.id,
                        name: service.description,
                        price: parseFloat(service.value),
                        duration: 60
                    });
                });
                
                container.appendChild(card);
            });
        }

        function loadAllServicesForSelection() {
            const container = document.getElementById('allServicesList');
            container.innerHTML = '';
            
            availableServices.forEach(service => {
                const item = document.createElement('div');
                item.className = 'service-item-card';
                item.innerHTML = `
                    <div class="service-color-bar" style="background-color: ${service.color}"></div>
                    <div class="service-item-info">
                        <div class="service-item-name">${service.name}</div>
                    </div>
                    <div class="service-item-price">${formatCurrency(service.price)}</div>
                `;
                
                item.addEventListener('click', () => {
                    selectService(service);
                });
                
                container.appendChild(item);
            });
        }

        function searchServicesForAgenda() {
            const searchTerm = document.getElementById('serviceSearchInput').value.toLowerCase();
            const container = document.getElementById('allServicesList');
            const items = container.querySelectorAll('.service-item-card');
            
            items.forEach(item => {
                const name = item.querySelector('.service-item-name').textContent.toLowerCase();
                if (name.includes(searchTerm)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        function selectService(service) {
            selectedServices.push(service);
            showAppointmentSave();
        }

        function showAppointmentSave() {
            closeServiceSelection();
            
            const modal = document.getElementById('appointmentSaveModal');
            modal.classList.add('active');
            
            updateAppointmentPreview();
            updateClientCard();
            updateAppointmentDateTime();
            updateSelectedServicesList();
            updateAppointmentTotal();
        }

        function closeAppointmentSave() {
            document.getElementById('appointmentSaveModal').classList.remove('active');
            selectedServices = [];
        }

        function updateAppointmentPreview() {
            const container = document.getElementById('calendarPreview');
            if (!selectedDate) return;
            
            const date = new Date(selectedDate);
            const options = { weekday: 'long', day: 'numeric', month: 'long' };
            const dateString = date.toLocaleDateString('pt-PT', options);
            
            container.innerHTML = `
                <div class="selected-date-display">${dateString} <i class="fas fa-chevron-down"></i></div>
                <div class="selected-time-display">${selectedTime.hour.toString().padStart(2, '0')}:${selectedTime.minute.toString().padStart(2, '0')}</div>
            `;
        }

        function updateClientCard() {
            const container = document.getElementById('clientCardAppointment');
            if (!selectedClient) return;
            
            container.innerHTML = `
                <div class="client-card-header">
                    <div class="client-avatar-appointment">
                        ${selectedClient.name.charAt(0).toUpperCase()}
                    </div>
                    <div class="client-info-appointment">
                        <div class="client-name-appointment">${selectedClient.name}</div>
                        <div class="client-contact-appointment">${selectedClient.phone || 'Sem contato'}</div>
                    </div>
                    <div class="client-actions">
                        ${selectedClient.phone ? `
                            <button class="client-action-btn" onclick="callClient('${selectedClient.phone}')">
                                <i class="fas fa-phone"></i>
                            </button>
                            <button class="client-action-btn" onclick="whatsappClient('${selectedClient.phone}')">
                                <i class="fab fa-whatsapp"></i>
                            </button>
                        ` : ''}
                        <button class="client-action-btn" onclick="requestGoogleReview()">
                            <i class="fab fa-google"></i>
                        </button>
                    </div>
                </div>
            `;
        }

        function updateAppointmentDateTime() {
            const container = document.getElementById('appointmentDateTimeDisplay');
            if (!selectedDate || !selectedTime) return;
            
            const date = new Date(selectedDate);
            const dateString = date.toLocaleDateString('pt-PT', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
            const timeString = `${selectedTime.hour.toString().padStart(2, '0')}:${selectedTime.minute.toString().padStart(2, '0')}`;
            
            container.innerHTML = `
                <div style="font-weight: 600;">${dateString}</div>
                <div style="color: #6c757d;">${timeString}</div>
            `;
        }

        function updateSelectedServicesList() {
            const container = document.getElementById('selectedServicesList');
            container.innerHTML = '';
            
            selectedServices.forEach((service, index) => {
                const item = document.createElement('div');
                item.className = 'selected-service-item';
                item.innerHTML = `
                    <div>
                        <div style="font-weight: 600;">${service.name}</div>
                        <div style="font-size: 14px; color: #6c757d;">${service.duration} minutos</div>
                    </div>
                    <div style="font-weight: 600; color: var(--primary-color);">
                        ${formatCurrency(service.price)}
                        <button class="btn btn-sm btn-danger ms-2" onclick="removeService(${index})">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
                container.appendChild(item);
            });
        }

        function updateAppointmentTotal() {
            const total = selectedServices.reduce((sum, service) => sum + service.price, 0);
            document.getElementById('appointmentTotalValue').textContent = formatCurrency(total);
        }

        function addAnotherServiceToAppointment() {
            closeAppointmentSave();
            showServiceSelection();
        }

        function removeService(index) {
            selectedServices.splice(index, 1);
            updateSelectedServicesList();
            updateAppointmentTotal();
        }

        function showMoreOptions() {
            Swal.fire({
                title: 'Ações Rápidas',
                html: `
                    <button class="btn btn-outline-primary w-100 mb-2" onclick="addNoteToAppointment()">
                        <i class="fas fa-sticky-note me-2"></i> Adicionar nota
                    </button>
                    <button class="btn btn-outline-primary w-100" onclick="addPaymentPolicy()">
                        <i class="fas fa-money-bill-wave me-2"></i> Adicionar política de pagamento
                    </button>
                `,
                showConfirmButton: false,
                showCloseButton: true
            });
        }

        function addNoteToAppointment() {
            Swal.fire({
                title: 'Adicionar Nota',
                input: 'textarea',
                inputPlaceholder: 'Digite sua nota aqui...',
                showCancelButton: true,
                confirmButtonText: 'Salvar',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed && result.value) {
                    showSuccess('Nota adicionada com sucesso!');
                }
            });
        }

        function addPaymentPolicy() {
            Swal.fire({
                title: 'Política de Pagamento',
                html: `
                    <div class="mb-3">
                        <label class="form-label">Tipo de Pagamento</label>
                        <select class="form-select" id="paymentType">
                            <option value="deposit">Depósito</option>
                            <option value="full">Pagamento Total</option>
                            <option value="installments">Parcelado</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Valor</label>
                        <input type="number" class="form-control" id="paymentValue" step="0.01" min="0">
                    </div>
                `,
                showCancelButton: true,
                confirmButtonText: 'Salvar',
                cancelButtonText: 'Cancelar',
                preConfirm: () => {
                    const type = document.getElementById('paymentType').value;
                    const value = document.getElementById('paymentValue').value;
                    return { type, value };
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    showSuccess('Política de pagamento adicionada!');
                }
            });
        }

        function checkoutAppointment() {
            showError('Funcionalidade de checkout em desenvolvimento');
        }

        function saveAppointment() {
            if (!selectedClient || selectedServices.length === 0 || !selectedDate || !selectedTime) {
                showError('Preencha todos os campos obrigatórios');
                return;
            }
            
            // Calcular duração total dos serviços
            const totalDuration = selectedServices.reduce((sum, s) => sum + (s.duration || 30), 0);
            
            // Calcular hora de término
            const startMinutes = selectedTime.hour * 60 + selectedTime.minute;
            const endMinutes = startMinutes + totalDuration;
            const endHour = Math.floor(endMinutes / 60);
            const endMinute = endMinutes % 60;
            
            const appointmentData = {
                clientId: selectedClient.id,
                clientName: selectedClient.name,
                clientPhone: selectedClient.phone || '',
                date: selectedDate,
                startTime: `${selectedTime.hour.toString().padStart(2, '0')}:${selectedTime.minute.toString().padStart(2, '0')}`,
                endTime: `${endHour.toString().padStart(2, '0')}:${endMinute.toString().padStart(2, '0')}`,
                duration: totalDuration,
                services: selectedServices.map(s => ({
                    id: s.id,
                    name: s.name,
                    price: s.price,
                    duration: s.duration || 30
                })),
                serviceName: selectedServices.map(s => s.name).join(', '),
                total: selectedServices.reduce((sum, s) => sum + s.price, 0),
                userId: currentUser.uid,
                collaboratorId: selectedCollaboratorId || (collaborators.length > 0 ? collaborators[0].id : null),
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                status: 'scheduled',
                reminder24h: true
            };
            
            showLoading('Salvando agendamento...');
            
            db.collection('appointments').add(appointmentData)
                .then((docRef) => {
                    Swal.close();
                    
                    // Recarregar agenda
                    loadAppointments();
                    closeAppointmentSave();
                    
                    // Limpar seleção
                    const savedClient = { ...selectedClient };
                    const savedData = { ...appointmentData };
                    selectedClient = null;
                    selectedServices = [];
                    selectedDate = null;
                    selectedTime = null;
                    
                    // Mostrar popup de confirmação OBRIGATÓRIO
                    showReminderPopup(savedClient, savedData);
                })
                .catch((error) => {
                    showError('Erro ao salvar agendamento: ' + error.message);
                });
        }
        
        // POPUP OBRIGATÓRIO - Notificação 24h antes
        function showReminderPopup(client, appointmentData) {
            const date = new Date(appointmentData.date);
            const dateString = date.toLocaleDateString('pt-PT', { weekday: 'long', day: 'numeric', month: 'long' });
            const servicesText = appointmentData.serviceName || 'Serviço';
            
            Swal.fire({
                title: 'Notificação de Confirmação',
                html: `
                    <p>Deseja enviar uma notificação de confirmação ao cliente <strong>${client.name}</strong> 24 horas antes do horário marcado?</p>
                    <p class="text-muted small">Agendamento: ${dateString} às ${appointmentData.startTime}</p>
                    <p class="text-muted small">Serviço: ${servicesText}</p>
                `,
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#26196b',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'Sim, enviar notificação',
                cancelButtonText: 'Não',
                allowOutsideClick: false,
                allowEscapeKey: false
            }).then((result) => {
                if (result.isConfirmed) {
                    showSuccess('Notificação programada para 24 horas antes!');
                }
                
                // Abrir WhatsApp com mensagem de confirmação
                if (client.phone) {
                    openWhatsAppConfirmation(client, appointmentData);
                } else {
                    showSuccess('Agendamento salvo com sucesso!');
                }
            });
        }
        
        // Abrir WhatsApp com mensagem de confirmação
        function openWhatsAppConfirmation(client, appointmentData) {
            const date = new Date(appointmentData.date);
            const dateString = date.toLocaleDateString('pt-PT', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
            const servicesText = appointmentData.serviceName || 'Serviço';
            const totalValue = formatCurrency(appointmentData.total);
            
            const message = `Olá ${client.name}! 🎉\n\n` +
                `Seu agendamento foi realizado com sucesso!\n\n` +
                `📅 *Data:* ${dateString}\n` +
                `⏰ *Horário:* ${appointmentData.startTime}\n` +
                `💇 *Serviço:* ${servicesText}\n` +
                `💰 *Valor:* ${totalValue}\n\n` +
                `Agradecemos a preferência!\n` +
                `Studio DeVitto`;
            
            const phone = client.phone.replace(/\D/g, '');
            const whatsappUrl = `https://wa.me/${phone}?text=${encodeURIComponent(message)}`;
            
            Swal.fire({
                title: 'Enviar confirmação via WhatsApp?',
                text: 'Deseja abrir o WhatsApp para enviar a confirmação ao cliente?',
                icon: 'success',
                showCancelButton: true,
                confirmButtonColor: '#25d366',
                cancelButtonColor: '#6c757d',
                confirmButtonText: '<i class="fab fa-whatsapp"></i> Abrir WhatsApp',
                cancelButtonText: 'Não enviar'
            }).then((result) => {
                if (result.isConfirmed) {
                    window.open(whatsappUrl, '_blank');
                }
                showSuccess('Agendamento salvo com sucesso!');
            });
        }

        function sendAppointmentConfirmation(appointmentData) {
            // Função mantida para compatibilidade
            console.log('Agendamento salvo:', appointmentData);
        }

        function showConfirmationPopup() {
            // Função substituída por showReminderPopup
        }

        function cancelConfirmation() {
            document.getElementById('confirmationPopup').classList.remove('active');
        }

        function confirmConfirmation() {
            document.getElementById('confirmationPopup').classList.remove('active');
            showSuccess('Notificação programada para 24 horas antes do horário marcado!');
        }

        function callClient(phone) {
            window.open(`tel:${phone}`, '_blank');
        }

        function whatsappClient(phone) {
            const message = `Olá! Aqui é do Studio DeVitto. Como podemos ajudá-lo hoje?`;
            window.open(`https://wa.me/${phone.replace(/\D/g, '')}?text=${encodeURIComponent(message)}`, '_blank');
        }

        function requestGoogleReview() {
            const reviewUrl = 'https://search.google.com/local/writereview?placeid=';
            window.open(reviewUrl, '_blank');
        }

        function showAppointmentDetails(appointmentId) {
            const appointment = appointments.find(a => a.id === appointmentId);
            if (!appointment) return;
            
            Swal.fire({
                title: 'Detalhes do Agendamento',
                html: `
                    <div class="text-start">
                        <p><strong>Cliente:</strong> ${appointment.clientName}</p>
                        <p><strong>Data:</strong> ${formatDate(appointment.date)}</p>
                        <p><strong>Hora:</strong> ${appointment.startTime}</p>
                        <p><strong>Serviços:</strong> ${appointment.services?.map(s => s.name).join(', ') || 'Nenhum'}</p>
                        <p><strong>Total:</strong> ${formatCurrency(appointment.total)}</p>
                        <p><strong>Status:</strong> <span class="badge bg-success">${appointment.status}</span></p>
                    </div>
                `,
                showCancelButton: true,
                confirmButtonText: 'Editar',
                cancelButtonText: 'Fechar'
            }).then((result) => {
                if (result.isConfirmed) {
                    // Implementar edição do agendamento
                    showError('Edição de agendamento em desenvolvimento');
                }
            });
        }

        // FIM DAS FUNÇÕES DA NOVA AGENDA

        function handleResize() {
            checkMobileDevice();
        }

        function updateDateTime() {
            const now = new Date();
            const dateTimeString = now.toLocaleDateString('pt-PT') + ' ' + now.toLocaleTimeString('pt-PT');
            document.getElementById('currentDateTime').textContent = dateTimeString;
        }

        // NOVO: Funções para autocomplete
        function filterClientsAutocomplete() {
            const searchTerm = document.getElementById('clientSelect').value.toLowerCase();
            const list = document.getElementById('clientAutocompleteList');
            
            if (searchTerm.length < 1) {
                list.classList.remove('active');
                return;
            }
            
            filteredClients = clients.filter(client => 
                client.name.toLowerCase().includes(searchTerm) ||
                client.phone.includes(searchTerm) ||
                (client.email && client.email.toLowerCase().includes(searchTerm))
            );
            
            let html = '';
            filteredClients.slice(0, 10).forEach(client => {
                html += `<div class="autocomplete-item" data-id="${client.id}" data-name="${client.name}">${client.name} (${client.phone})</div>`;
            });
            
            if (html === '') {
                html = '<div class="autocomplete-item">Nenhum cliente encontrado</div>';
            }
            
            list.innerHTML = html;
            list.classList.add('active');
            
            // Adicionar eventos aos itens
            list.querySelectorAll('.autocomplete-item').forEach(item => {
                item.addEventListener('click', function() {
                    const clientId = this.getAttribute('data-id');
                    const clientName = this.getAttribute('data-name');
                    document.getElementById('clientSelect').value = clientName;
                    document.getElementById('selectedClientId').value = clientId;
                    list.classList.remove('active');
                });
            });
        }
        
        function filterProductsAutocomplete() {
            const searchTerm = document.getElementById('productSaleSelect').value.toLowerCase();
            const list = document.getElementById('productAutocompleteList');
            
            if (searchTerm.length < 1) {
                list.classList.remove('active');
                return;
            }
            
            filteredProducts = products.filter(product => 
                product.name.toLowerCase().includes(searchTerm) ||
                product.description.toLowerCase().includes(searchTerm)
            );
            
            let html = '';
            filteredProducts.slice(0, 10).forEach(product => {
                const stockInfo = product.quantity > 0 ? `(${product.quantity} disponíveis)` : '(ESGOTADO)';
                html += `<div class="autocomplete-item" data-id="${product.id}" data-name="${product.name}" data-price="${product.salePrice}" data-stock="${product.quantity}">${product.name} ${stockInfo} - ${formatCurrency(product.salePrice)}</div>`;
            });
            
            if (html === '') {
                html = '<div class="autocomplete-item">Nenhum produto encontrado</div>';
            }
            
            list.innerHTML = html;
            list.classList.add('active');
            
            // Adicionar eventos aos itens
            list.querySelectorAll('.autocomplete-item').forEach(item => {
                item.addEventListener('click', function() {
                    const productId = this.getAttribute('data-id');
                    const productName = this.getAttribute('data-name');
                    const productPrice = this.getAttribute('data-price');
                    const productStock = this.getAttribute('data-stock');
                    
                    document.getElementById('productSaleSelect').value = productName;
                    document.getElementById('selectedProductId').value = productId;
                    
                    // Atualizar quantidade máxima disponível
                    document.getElementById('productSaleQuantity').max = productStock;
                    document.getElementById('productSaleQuantity').value = 1;
                    
                    list.classList.remove('active');
                });
            });
        }
        
        function filterProductClientsAutocomplete() {
            const searchTerm = document.getElementById('productSaleClient').value.toLowerCase();
            const list = document.getElementById('productClientAutocompleteList');
            
            if (searchTerm.length < 1) {
                list.classList.remove('active');
                return;
            }
            
            const filtered = clients.filter(client => 
                client.name.toLowerCase().includes(searchTerm) ||
                client.phone.includes(searchTerm)
            );
            
            let html = '';
            filtered.slice(0, 10).forEach(client => {
                html += `<div class="autocomplete-item" data-id="${client.id}" data-name="${client.name}">${client.name} (${client.phone})</div>`;
            });
            
            // Adicionar opção para venda avulsa
            html += '<div class="autocomplete-item" data-id="" data-name="Venda Avulsa">Venda Avulsa (sem cliente)</div>';
            
            list.innerHTML = html;
            list.classList.add('active');
            
            // Adicionar eventos aos itens
            list.querySelectorAll('.autocomplete-item').forEach(item => {
                item.addEventListener('click', function() {
                    const clientId = this.getAttribute('data-id');
                    const clientName = this.getAttribute('data-name');
                    document.getElementById('productSaleClient').value = clientName;
                    document.getElementById('selectedProductClientId').value = clientId;
                    list.classList.remove('active');
                });
            });
        }
        
        function closeAllAutocompleteLists() {
            document.querySelectorAll('.autocomplete-list').forEach(list => {
                list.classList.remove('active');
            });
        }

        function showLoginForm() {
            document.getElementById('loginFormContainer').classList.remove('hidden');
            document.getElementById('registerFormContainer').classList.add('hidden');
        }

        function showRegisterForm() {
            document.getElementById('loginFormContainer').classList.add('hidden');
            document.getElementById('registerFormContainer').classList.remove('hidden');
        }

        function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            showLoading('Entrando...');
            
            auth.signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    currentUser = userCredential.user;
                    showMainScreen();
                    loadInitialData();
                    showSuccess('Login realizado com sucesso!');
                })
                .catch((error) => {
                    let errorMessage = 'Erro no login. Tente novamente.';
                    switch(error.code) {
                        case 'auth/user-not-found':
                            errorMessage = 'Usuário não encontrado.';
                            break;
                        case 'auth/wrong-password':
                            errorMessage = 'Senha incorreta.';
                            break;
                        case 'auth/invalid-email':
                            errorMessage = 'E-mail inválido.';
                            break;
                        case 'auth/too-many-requests':
                            errorMessage = 'Muitas tentativas de login. Tente novamente mais tarde.';
                            break;
                        case 'auth/network-request-failed':
                            errorMessage = 'Erro de conexão. Verifique sua internet.';
                            break;
                        default:
                            errorMessage = 'Erro: ' + error.message;
                    }
                    showError(errorMessage);
                })
                .finally(() => {
                    // Sempre limpar o formulário de login
                    document.getElementById('loginEmail').value = '';
                    document.getElementById('loginPassword').value = '';
                });
        }

        function handleRegister(e) {
            e.preventDefault();
            const name = document.getElementById('registerName').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('registerConfirmPassword').value;

            // Validações
            if (password !== confirmPassword) {
                showError('As senhas não coincidem.');
                return;
            }

            if (password.length < 6) {
                showError('A senha deve ter pelo menos 6 caracteres.');
                return;
            }

            showLoading('Criando conta...');

            auth.createUserWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    currentUser = userCredential.user;
                    
                    // Salvar informações adicionais do usuário
                    return db.collection('users').doc(currentUser.uid).set({
                        name: name,
                        email: email,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                })
                .then(() => {
                    showMainScreen();
                    loadInitialData();
                    showSuccess('Conta criada com sucesso!');
                })
                .catch((error) => {
                    let errorMessage = 'Erro ao criar conta. Tente novamente.';
                    switch(error.code) {
                        case 'auth/email-already-in-use':
                            errorMessage = 'Este e-mail já está em uso.';
                            break;
                        case 'auth/invalid-email':
                            errorMessage = 'E-mail inválido.';
                            break;
                        case 'auth/weak-password':
                            errorMessage = 'Senha muito fraca. Use pelo menos 6 caracteres.';
                            break;
                        default:
                            errorMessage = 'Erro: ' + error.message;
                    }
                    showError(errorMessage);
                })
                .finally(() => {
                    // Limpar formulário de registro
                    document.getElementById('registerForm').reset();
                });
        }

        function handleLogout() {
            Swal.fire({
                title: 'Tem certeza?',
                text: "Você será desconectado do sistema.",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Sim, sair!',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    auth.signOut().then(() => {
                        currentUser = null;
                        showLoginScreen();
                        showSuccess('Logout realizado com sucesso!');
                    }).catch((error) => {
                        showError('Erro ao fazer logout: ' + error.message);
                    });
                }
            });
        }

        function showLoginScreen() {
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('mainScreen').classList.add('hidden');
            document.getElementById('loginForm').reset();
            showLoginForm();
        }

        function showMainScreen() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainScreen').classList.remove('hidden');
        }

        function loadInitialData() {
            if (currentUser) {
                document.getElementById('userName').textContent = currentUser.email;
                loadUserData();
                loadCashierStatus();
                loadAllServices();
                loadAllProductSales();
                loadClients();
                loadCollaborators();
                loadPackages();
                loadProducts();
                loadClientNotes();
                loadFinancialData();
                
                // Carregar dados do perfil da empresa do Firestore
                loadBusinessProfileFromFirestore();
                loadBusinessHoursFromFirestore();
                
                // Inicializar agenda
                initAgenda();
            }
        }

        function loadUserData() {
            db.collection('users').doc(currentUser.uid).get()
                .then((doc) => {
                    if (doc.exists) {
                        const userData = doc.data();
                        document.getElementById('userName').textContent = userData.name || currentUser.email;
                    }
                })
                .catch((error) => {
                    console.error("Erro ao carregar dados do usuário:", error);
                });
        }

        // Função para carregar dados financeiros
        function loadFinancialData() {
            loadExpenses();
            loadSalaryPayments();
        }

        // Função para carregar despesas
        function loadExpenses() {
            if (!currentUser) return;
            
            db.collection('expenses')
                .where('userId', '==', currentUser.uid)
                .get()
                .then((querySnapshot) => {
                    expenses = [];
                    querySnapshot.forEach((doc) => {
                        expenses.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    
                    updateExpensesUI();
                    updateFinancialSummary();
                    updateExpenseChart();
                    loadUpcomingDueExpenses();
                })
                .catch((error) => {
                    console.error("Erro ao carregar despesas: ", error);
                });
        }

        // Função para carregar pagamentos de salário
        function loadSalaryPayments() {
            if (!currentUser) return;
            
            db.collection('salaryPayments')
                .where('userId', '==', currentUser.uid)
                .get()
                .then((querySnapshot) => {
                    salaryPayments = [];
                    querySnapshot.forEach((doc) => {
                        salaryPayments.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    
                    updateSalariesUI();
                    updateFinancialSummary();
                })
                .catch((error) => {
                    console.error("Erro ao carregar pagamentos de salário: ", error);
                });
        }

        // Função para carregar perfil da empresa do Firestore
        function loadBusinessProfileFromFirestore() {
            if (!currentUser) return;
            
            db.collection('businessProfile').doc(currentUser.uid).get()
                .then((doc) => {
                    if (doc.exists) {
                        const firestoreProfile = doc.data();
                        businessProfile = { ...businessProfile, ...firestoreProfile };
                        updateBusinessProfileUI();
                    }
                })
                .catch((error) => {
                    console.error('Erro ao carregar perfil do banco de dados:', error);
                });
        }

        // Função para carregar horários da empresa do Firestore
        function loadBusinessHoursFromFirestore() {
            if (!currentUser) return;
            
            db.collection('businessHours').doc(currentUser.uid).get()
                .then((doc) => {
                    if (doc.exists) {
                        const firestoreHours = doc.data();
                        businessHours = { ...businessHours, ...firestoreHours };
                        updateBusinessHoursUI();
                    }
                })
                .catch((error) => {
                    console.error('Erro ao carregar horários do banco de dados:', error);
                });
        }

        function loadCashierStatus() {
            const today = new Date().toISOString().split('T')[0];
            
            db.collection('cashiers')
                .where('date', '==', today)
                .where('userId', '==', currentUser.uid)
                .where('status', '==', 'open')
                .get()
                .then((querySnapshot) => {
                    if (!querySnapshot.empty) {
                        currentCashier = querySnapshot.docs[0].data();
                        currentCashier.id = querySnapshot.docs[0].id;
                        updateCashierUI(true);
                    } else {
                        currentCashier = null;
                        updateCashierUI(false);
                    }
                })
                .catch((error) => {
                    console.error("Erro ao carregar status do caixa: ", error);
                });
        }

        function loadAllServices() {
            // Sem ordenação para evitar necessidade de índices
            db.collection('services')
                .where('userId', '==', currentUser.uid)
                .get()
                .then((querySnapshot) => {
                    allServices = [];
                    todayServices = [];
                    const today = new Date().toISOString().split('T')[0];
                    
                    querySnapshot.forEach((doc) => {
                        const service = {
                            id: doc.id,
                            ...doc.data()
                        };
                        allServices.push(service);
                        
                        // Separar serviços de hoje
                        if (service.date === today) {
                            todayServices.push(service);
                        }
                    });
                    
                    // Ordenar localmente por timestamp
                    allServices.sort((a, b) => {
                        const dateA = a.timestamp.toDate ? a.timestamp.toDate() : new Date(a.timestamp);
                        const dateB = b.timestamp.toDate ? b.timestamp.toDate() : new Date(b.timestamp);
                        return dateB - dateA;
                    });
                    
                    todayServices.sort((a, b) => {
                        const dateA = a.timestamp.toDate ? a.timestamp.toDate() : new Date(a.timestamp);
                        const dateB = b.timestamp.toDate ? b.timestamp.toDate() : new Date(b.timestamp);
                        return dateB - dateA;
                    });
                    
                    updateTodaySalesUI();
                    updateDashboard();
                    calculatePeriodSales();
                    updateMonthlySalesChart();
                })
                .catch((error) => {
                    console.error("Erro ao carregar serviços: ", error);
                });
        }

        function loadAllProductSales() {
            db.collection('productSales')
                .where('userId', '==', currentUser.uid)
                .get()
                .then((querySnapshot) => {
                    allProductSales = [];
                    todayProductSales = [];
                    const today = new Date().toISOString().split('T')[0];
                    
                    querySnapshot.forEach((doc) => {
                        const sale = {
                            id: doc.id,
                            ...doc.data()
                        };
                        allProductSales.push(sale);
                        
                        // Separar vendas de hoje
                        if (sale.date === today) {
                            todayProductSales.push(sale);
                        }
                    });
                    
                    updateTodaySalesUI();
                    updateDashboard();
                    updateMonthlySalesChart();
                    updateProductsSoldStats();
                })
                .catch((error) => {
                    console.error("Erro ao carregar vendas de produtos: ", error);
                });
        }

        function loadClients() {
            console.log("Carregando clientes...");
            // Sem ordenação para evitar necessidade de índices
            db.collection('clients')
                .where('userId', '==', currentUser.uid)
                .get()
                .then((querySnapshot) => {
                    clients = [];
                    querySnapshot.forEach((doc) => {
                        console.log("Cliente encontrado:", doc.data());
                        clients.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    
                    // Ordenar localmente por nome
                    clients.sort((a, b) => a.name.localeCompare(b.name, 'pt-PT'));
                    
                    console.log("Total de clientes carregados:", clients.length);
                    updateClientsUI();
                    updatePackageClientSelect();
                    document.getElementById('totalClients').textContent = clients.length;
                    
                    // CORREÇÃO: Atualizar lista de clientes em Registros
                    updateClientRecordsList();
                    
                    // Atualizar aniversários
                    loadUpcomingBirthdays();
                })
                .catch((error) => {
                    console.error("Erro ao carregar clientes: ", error);
                    showError('Erro ao carregar clientes: ' + error.message);
                });
        }

        function loadCollaborators() {
            console.log("Carregando colaboradores...");
            // Sem ordenação para evitar necessidade de índices
            db.collection('collaborators')
                .where('userId', '==', currentUser.uid)
                .get()
                .then((querySnapshot) => {
                    collaborators = [];
                    querySnapshot.forEach((doc) => {
                        console.log("Colaborador encontrado:", doc.data());
                        collaborators.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    
                    // Ordenar localmente por nome
                    collaborators.sort((a, b) => a.name.localeCompare(b.name, 'pt-PT'));
                    
                    console.log("Total de colaboradores carregados:", collaborators.length);
                    updateCollaboratorsUI();
                    updateCollaboratorSelect();
                    updateReportCollaboratorSelect();
                    updateSalaryCollaboratorSelect();
                })
                .catch((error) => {
                    console.error("Erro ao carregar colaboradores: ", error);
                    showError('Erro ao carregar colaboradores: ' + error.message);
                });
        }

        function loadProducts() {
            console.log("Carregando produtos...");
            db.collection('products')
                .where('userId', '==', currentUser.uid)
                .get()
                .then((querySnapshot) => {
                    products = [];
                    querySnapshot.forEach((doc) => {
                        console.log("Produto encontrado:", doc.data());
                        products.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    
                    // Ordenar produtos por ordem alfabética
                    products.sort((a, b) => a.name.localeCompare(b.name, 'pt-PT'));
                    
                    updateInventoryUI();
                    checkLowStock();
                })
                .catch((error) => {
                    console.error("Erro ao carregar produtos: ", error);
                    showError('Erro ao carregar produtos: ' + error.message);
                });
        }

        function loadPackages() {
            console.log("Carregando pacotes...");
            // Sem ordenação para evitar necessidade de índices
            db.collection('packages')
                .where('userId', '==', currentUser.uid)
                .get()
                .then((querySnapshot) => {
                    packages = [];
                    querySnapshot.forEach((doc) => {
                        console.log("Pacote encontrado:", doc.data());
                        packages.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    
                    updatePackagesUI();
                })
                .catch((error) => {
                    console.error("Erro ao carregar pacotes: ", error);
                    showError('Erro ao carregar pacotes: ' + error.message);
                });
        }

        function loadClientNotes() {
            db.collection('clientNotes')
                .where('userId', '==', currentUser.uid)
                .get()
                .then((querySnapshot) => {
                    clientNotes = {};
                    querySnapshot.forEach((doc) => {
                        const noteData = doc.data();
                        clientNotes[noteData.clientId] = {
                            id: doc.id,
                            notes: noteData.notes
                        };
                    });
                })
                .catch((error) => {
                    console.error("Erro ao carregar notas dos clientes: ", error);
                });
        }

        // NOVO: Função para atualizar estatísticas de produtos vendidos
        function updateProductsSoldStats() {
            const today = new Date();
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();
            
            // Produtos vendidos este mês
            const monthProductSales = allProductSales.filter(sale => {
                const saleDate = sale.timestamp.toDate ? sale.timestamp.toDate() : new Date(sale.timestamp);
                return saleDate.getMonth() === currentMonth && saleDate.getFullYear() === currentYear;
            });
            
            const monthProductsCount = monthProductSales.reduce((sum, sale) => sum + sale.quantity, 0);
            const monthProductsValue = monthProductSales.reduce((sum, sale) => sum + parseFloat(sale.totalValue), 0);
            
            // Produtos vendidos no total
            const totalProductsCount = allProductSales.reduce((sum, sale) => sum + sale.quantity, 0);
            const totalProductsValue = allProductSales.reduce((sum, sale) => sum + parseFloat(sale.totalValue), 0);
            
            document.getElementById('monthProductsCount').textContent = monthProductsCount;
            document.getElementById('monthProductsValue').textContent = formatCurrency(monthProductsValue);
            document.getElementById('totalProductsSoldCount').textContent = totalProductsCount;
            document.getElementById('totalProductsSoldValue').textContent = formatCurrency(totalProductsValue);
        }

        // NOVO: Função para atualizar gráfico de vendas mensais
        function updateMonthlySalesChart() {
            const today = new Date();
            const currentYear = today.getFullYear();
            
            // Preparar dados para os últimos 6 meses
            const months = [];
            const servicesData = [];
            const productsData = [];
            
            for (let i = 5; i >= 0; i--) {
                const monthDate = new Date(currentYear, today.getMonth() - i, 1);
                const monthName = monthDate.toLocaleDateString('pt-PT', { month: 'short' });
                months.push(monthName);
                
                // Calcular vendas de serviços para este mês
                const monthServices = allServices.filter(service => {
                    const serviceDate = service.timestamp.toDate ? service.timestamp.toDate() : new Date(service.timestamp);
                    return serviceDate.getMonth() === monthDate.getMonth() && 
                           serviceDate.getFullYear() === monthDate.getFullYear();
                });
                
                const servicesValue = monthServices.reduce((sum, service) => sum + parseFloat(service.value), 0);
                servicesData.push(servicesValue);
                
                // Calcular vendas de produtos para este mês
                const monthProducts = allProductSales.filter(sale => {
                    const saleDate = sale.timestamp.toDate ? sale.timestamp.toDate() : new Date(sale.timestamp);
                    return saleDate.getMonth() === monthDate.getMonth() && 
                           saleDate.getFullYear() === monthDate.getFullYear();
                });
                
                const productsValue = monthProducts.reduce((sum, sale) => sum + parseFloat(sale.totalValue), 0);
                productsData.push(productsValue);
            }
            
            // Destruir gráfico anterior se existir
            const existingChart = Chart.getChart('monthlySalesChart');
            if (existingChart) {
                existingChart.destroy();
            }
            
            // Criar novo gráfico
            const ctx = document.getElementById('monthlySalesChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: months,
                    datasets: [
                        {
                            label: 'Serviços',
                            data: servicesData,
                            backgroundColor: '#26196b',
                            borderColor: '#26196b',
                            borderWidth: 1
                        },
                        {
                            label: 'Produtos',
                            data: productsData,
                            backgroundColor: '#17a2b8',
                            borderColor: '#17a2b8',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + formatCurrency(context.raw);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '€' + value;
                                }
                            }
                        }
                    }
                }
            });
        }

        function calculatePeriodSales() {
            const today = new Date();
            const startOfWeek = new Date(today);
            // CORREÇÃO: Iniciar a semana na segunda-feira
            const dayOfWeek = today.getDay();
            const diffToMonday = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
            startOfWeek.setDate(today.getDate() + diffToMonday);
            startOfWeek.setHours(0, 0, 0, 0);
            
            const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            
            let weekSales = 0;
            let weekServiceCount = 0;
            let monthSales = 0;
            let monthServiceCount = 0;
            
            allServices.forEach(service => {
                const serviceDate = service.timestamp.toDate ? service.timestamp.toDate() : new Date(service.timestamp);
                const serviceValue = parseFloat(service.value);
                
                // Vendas da semana (segunda a domingo)
                if (serviceDate >= startOfWeek) {
                    weekSales += serviceValue;
                    weekServiceCount++;
                }
                
                // Vendas do mês
                if (serviceDate >= startOfMonth) {
                    monthSales += serviceValue;
                    monthServiceCount++;
                }
            });
            
            document.getElementById('weekSales').textContent = formatCurrency(weekSales);
            document.getElementById('weekServices').textContent = `${weekServiceCount} serviços`;
            document.getElementById('monthSales').textContent = formatCurrency(monthSales);
            document.getElementById('monthServices').textContent = `${monthServiceCount} serviços`;
            document.getElementById('totalServices').textContent = allServices.length;
        }

        function updateCashierUI(isOpen) {
            const statusElement = document.getElementById('cashierStatus');
            const openBtn = document.getElementById('openCashierBtn');
            const closeBtn = document.getElementById('closeCashierBtn');
            const serviceForm = document.getElementById('serviceForm');
            const productSaleForm = document.getElementById('productSaleForm');
            
            if (isOpen) {
                statusElement.textContent = 'Aberto';
                statusElement.className = 'badge bg-success';
                openBtn.disabled = true;
                closeBtn.disabled = false;
                
                // Habilitar formulários
                serviceForm.querySelectorAll('input, select, textarea, button').forEach(element => {
                    element.disabled = false;
                });
                productSaleForm.querySelectorAll('input, select, textarea, button').forEach(element => {
                    element.disabled = false;
                });
                
                // Calcular valor atual do caixa
                const todayServicesValue = todayServices.reduce((total, service) => total + parseFloat(service.value), 0);
                const todayProductsValue = todayProductSales.reduce((total, sale) => total + parseFloat(sale.totalValue), 0);
                const currentCashValue = (currentCashier.initialValue || 0) + todayServicesValue + todayProductsValue;
                document.getElementById('currentCash').textContent = formatCurrency(currentCashValue);
            } else {
                statusElement.textContent = 'Fechado';
                statusElement.className = 'badge bg-danger';
                openBtn.disabled = false;
                closeBtn.disabled = true;
                
                // Desabilitar formulários
                serviceForm.querySelectorAll('input, select, textarea, button').forEach(element => {
                    if (element.id !== 'openCashierBtn') {
                        element.disabled = true;
                    }
                });
                productSaleForm.querySelectorAll('input, select, textarea, button').forEach(element => {
                    element.disabled = true;
                });
                
                document.getElementById('currentCash').textContent = '€ 0,00';
            }
        }

        function updateTodaySalesUI() {
            const container = document.getElementById('todaySalesList');
            
            if (todayServices.length === 0 && todayProductSales.length === 0) {
                container.innerHTML = '<p class="text-muted">Nenhuma venda registrada hoje.</p>';
                updateSummaryUI();
                return;
            }
            
            let html = '';
            let totalServicesValue = 0;
            let totalProductsValue = 0;
            let totalForCollaborators = 0;
            let collaboratorBreakdown = {};
            
            // Serviços
            todayServices.forEach(service => {
                const client = clients.find(c => c.id === service.clientId) || { name: 'Cliente não encontrado' };
                const collaborator = collaborators.find(c => c.id === service.collaboratorId) || { name: 'Colaborador não encontrado' };
                
                const serviceValue = parseFloat(service.value);
                totalServicesValue += serviceValue;
                
                let collaboratorPercent = 0;
                if (service.type === 'manual') {
                    collaboratorPercent = parseFloat(collaborator.manualPercent) || 0;
                } else if (service.type === 'product') {
                    collaboratorPercent = parseFloat(collaborator.productPercent) || 0;
                }
                
                const collaboratorValue = serviceValue * (collaboratorPercent / 100);
                totalForCollaborators += collaboratorValue;
                
                // Atualizar breakdown
                if (!collaboratorBreakdown[collaborator.id]) {
                    collaboratorBreakdown[collaborator.id] = {
                        name: collaborator.name,
                        total: 0,
                        toReceive: 0
                    };
                }
                collaboratorBreakdown[collaborator.id].total += serviceValue;
                collaboratorBreakdown[collaborator.id].toReceive += collaboratorValue;
                
                html += `
                    <div class="service-item mb-2">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="mb-1">${service.description}</h6>
                                <p class="mb-1 text-muted small">
                                    Cliente: ${client.name} | 
                                    Colaborador: ${collaborator.name} |
                                    Tipo: ${service.type === 'manual' ? 'Manual' : 'Com Produtos'}
                                </p>
                            </div>
                            <div class="text-end">
                                <strong class="text-success">${formatCurrency(serviceValue)}</strong>
                                <div>
                                    <small class="text-muted">Serviço</small>
                                    <button class="btn btn-sm btn-danger mt-1" onclick="deleteService('${service.id}')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            // Vendas de produtos
            todayProductSales.forEach(sale => {
                const product = products.find(p => p.id === sale.productId) || { name: 'Produto não encontrado' };
                const client = sale.clientId ? clients.find(c => c.id === sale.clientId) : null;
                
                const saleValue = parseFloat(sale.totalValue);
                totalProductsValue += saleValue;
                
                html += `
                    <div class="service-item mb-2">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="mb-1">${product.name}</h6>
                                <p class="mb-1 text-muted small">
                                    ${client ? `Cliente: ${client.name} | ` : ''}
                                    Quantidade: ${sale.quantity}
                                </p>
                            </div>
                            <div class="text-end">
                                <strong class="text-info">${formatCurrency(saleValue)}</strong>
                                <div>
                                    <small class="text-muted">Produto</small>
                                    <button class="btn btn-sm btn-danger mt-1" onclick="deleteProductSale('${sale.id}')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            updateSummaryUI(totalServicesValue, totalProductsValue, totalForCollaborators, collaboratorBreakdown);
            
            // Atualizar dashboard
            document.getElementById('todaySales').textContent = formatCurrency(totalServicesValue);
            document.getElementById('todayServices').textContent = `${todayServices.length} serviços`;
            document.getElementById('todayProducts').textContent = formatCurrency(totalProductsValue);
            document.getElementById('todayProductsCount').textContent = `${todayProductSales.length} produtos`;
        }

        function updateSummaryUI(totalServicesValue = 0, totalProductsValue = 0, totalForCollaborators = 0, collaboratorBreakdown = {}) {
            const totalSalesValue = totalServicesValue + totalProductsValue;
            
            document.getElementById('totalServicesCount').textContent = todayServices.length;
            document.getElementById('totalServicesValue').textContent = formatCurrency(totalServicesValue);
            document.getElementById('totalProductsCount').textContent = todayProductSales.length;
            document.getElementById('totalProductsValue').textContent = formatCurrency(totalProductsValue);
            document.getElementById('totalSalesValue').textContent = formatCurrency(totalSalesValue);
            document.getElementById('totalCollaboratorsValue').textContent = formatCurrency(totalForCollaborators);
            document.getElementById('totalCashierValue').textContent = formatCurrency(totalSalesValue - totalForCollaborators);
            
            const breakdownElement = document.getElementById('collaboratorBreakdown');
            if (Object.keys(collaboratorBreakdown).length === 0) {
                breakdownElement.innerHTML = '<p class="text-muted">Nenhum serviço registrado.</p>';
            } else {
                let html = '<strong>Detalhamento por Colaborador:</strong>';
                for (const collaboratorId in collaboratorBreakdown) {
                    const breakdown = collaboratorBreakdown[collaboratorId];
                    html += `
                        <div class="mt-2 p-2 bg-light rounded">
                            <div class="d-flex justify-content-between">
                                <span>${breakdown.name}:</span>
                                <span>${formatCurrency(breakdown.toReceive)}</span>
                            </div>
                        </div>
                    `;
                }
                breakdownElement.innerHTML = html;
            }
        }

        function updateDashboard() {
            const todayServicesValue = todayServices.reduce((total, service) => total + parseFloat(service.value), 0);
            const todayProductsValue = todayProductSales.reduce((total, sale) => total + parseFloat(sale.totalValue), 0);
            
            document.getElementById('totalCollaborators').textContent = collaborators.filter(c => c.active).length;
            
            // Atualizar serviços recentes
            const recentContainer = document.getElementById('recentServicesList');
            if (todayServices.length === 0) {
                recentContainer.innerHTML = '<p class="text-muted">Nenhum serviço hoje.</p>';
            } else {
                let html = '';
                const recentServices = todayServices.slice(0, 5);
                recentServices.forEach(service => {
                    const client = clients.find(c => c.id === service.clientId) || { name: 'Cliente não encontrado' };
                    const collaborator = collaborators.find(c => c.id === service.collaboratorId) || { name: 'Colaborador não encontrado' };
                    
                    // Verificar se todos os campos obrigatórios estão preenchidos
                    const missingFields = [];
                    if (!service.clientId) missingFields.push('cliente');
                    if (!service.collaboratorId) missingFields.push('colaborador');
                    if (!service.value) missingFields.push('valor');
                    
                    let warningHtml = '';
                    if (missingFields.length > 0) {
                        warningHtml = `<div class="alert alert-warning p-1 mt-1"><small><i class="fas fa-exclamation-triangle me-1"></i>Faltam dados: ${missingFields.join(', ')}</small></div>`;
                    }
                    
                    html += `
                        <div class="service-item mb-2">
                            <div class="d-flex justify-content-between">
                                <span>${client.name}</span>
                                <span class="text-success">${formatCurrency(service.value)}</span>
                            </div>
                            <small class="text-muted">${service.description} - ${collaborator.name}</small>
                            ${warningHtml}
                        </div>
                    `;
                });
                recentContainer.innerHTML = html;
            }
            
            // Carregar aniversários próximos (incluindo hoje)
            loadUpcomingBirthdays();
        }

        function updateInventoryUI() {
            const tbody = document.getElementById('inventoryTable');
            
            if (products.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">Nenhum produto cadastrado.</td></tr>';
                updateInventorySummary();
                return;
            }
            
            let html = '';
            let totalValue = 0;
            let totalInvestment = 0;
            let lowStockCount = 0;
            
            products.forEach(product => {
                const isLowStock = product.quantity <= product.minQuantity;
                const stockValue = product.quantity * parseFloat(product.salePrice);
                const investmentValue = product.quantity * parseFloat(product.purchasePrice);
                
                totalValue += stockValue;
                totalInvestment += investmentValue;
                
                if (isLowStock) {
                    lowStockCount++;
                }
                
                html += `
                    <tr class="${isLowStock ? 'low-stock' : ''}">
                        <td>${product.name}</td>
                        <td>${product.quantity}</td>
                        <td>${product.minQuantity}</td>
                        <td>${formatCurrency(product.purchasePrice)}</td>
                        <td>${formatCurrency(product.salePrice)}</td>
                        <td>
                            <span class="badge ${isLowStock ? 'bg-danger' : 'bg-success'}">
                                ${isLowStock ? 'Estoque Baixo' : 'Normal'}
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-primary me-1" onclick="editProduct('${product.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteProduct('${product.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
            updateInventorySummary(products.length, lowStockCount, totalValue, totalInvestment);
        }

        function updateInventorySummary(totalProducts, lowStockCount, totalValue, totalInvestment) {
            document.getElementById('totalProducts').textContent = totalProducts;
            document.getElementById('lowStockProducts').textContent = lowStockCount;
            document.getElementById('totalInventoryValue').textContent = formatCurrency(totalValue);
            document.getElementById('totalInvestment').textContent = formatCurrency(totalInvestment);
            
            // Atualizar alertas
            const alertsContainer = document.getElementById('inventoryAlerts');
            if (lowStockCount === 0) {
                alertsContainer.innerHTML = '<p class="text-muted">Nenhum alerta no momento.</p>';
            } else {
                let html = '';
                products.filter(p => p.quantity <= p.minQuantity).forEach(product => {
                    html += `
                        <div class="alert alert-warning p-2 mb-2">
                            <div class="d-flex justify-content-between align-items-center">
                                <span>${product.name}</span>
                                <span class="badge bg-danger">${product.quantity} restantes</span>
                            </div>
                        </div>
                    `;
                });
                alertsContainer.innerHTML = html;
            }
        }

        function checkLowStock() {
            const lowStockProducts = products.filter(p => p.quantity <= p.minQuantity);
            
            if (lowStockProducts.length > 0) {
                // Mostrar alerta no dashboard
                document.getElementById('lowStockAlertsContainer').style.display = 'block';
                
                // Alerta compacto - apenas contagem
                let html = `
                    <p class="mb-0"><strong>${lowStockProducts.length} produto(s) com estoque baixo</strong></p>
                    <p class="mb-0 text-muted small">Toque para ver detalhes</p>
                `;
                document.getElementById('lowStockAlerts').innerHTML = html;
                
                // Detalhes dos produtos com estoque baixo
                let detailsHtml = '';
                lowStockProducts.forEach(product => {
                    detailsHtml += `
                        <div class="alert alert-danger p-2 mb-2">
                            <div class="d-flex justify-content-between align-items-center">
                                <span><i class="fas fa-exclamation-triangle me-2"></i>${product.name}</span>
                                <span class="badge bg-dark">${product.quantity} restantes (mínimo: ${product.minQuantity})</span>
                            </div>
                        </div>
                    `;
                });
                document.getElementById('lowStockDetails').innerHTML = detailsHtml;
                
                // Mostrar alerta popup se for a primeira vez que verifica hoje
                const today = new Date().toISOString().split('T')[0];
                const lastAlert = localStorage.getItem('lastStockAlert');
                
                if (lastAlert !== today) {
                    showError(`ATENÇÃO: ${lowStockProducts.length} produto(s) com estoque baixo! Verifique a aba de Estoque.`);
                    localStorage.setItem('lastStockAlert', today);
                }
            } else {
                document.getElementById('lowStockAlertsContainer').style.display = 'none';
            }
        }

        function updateClientsUI() {
            const tbody = document.getElementById('clientsTable');
            
            if (clients.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Nenhum cliente cadastrado.</td></tr>';
                return;
            }
            
            let html = '';
            clients.forEach(client => {
                html += `
                    <tr>
                        <td>${client.name}</td>
                        <td>${formatDate(client.birthdate)}</td>
                        <td>${client.phone}</td>
                        <td>${client.email || '-'}</td>
                        <td>
                            <button class="btn btn-sm btn-primary me-1" onclick="editClient('${client.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteClient('${client.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            tbody.innerHTML = html;
        }

        function updateCollaboratorsUI() {
            const tbody = document.getElementById('collaboratorsTable');
            
            if (collaborators.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted">Nenhum colaborador cadastrado.</td></tr>';
                return;
            }
            
            let html = '';
            collaborators.forEach(collaborator => {
                const photoUrl = collaborator.photoUrl || '';
                const photoHtml = photoUrl ? 
                    `<img src="${photoUrl}" class="rounded-circle" width="40" height="40" alt="${collaborator.name}">` :
                    `<div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">${collaborator.name.charAt(0).toUpperCase()}</div>`;
                
                html += `
                    <tr>
                        <td>${photoHtml}</td>
                        <td>${collaborator.name}</td>
                        <td>${collaborator.specialty || 'Não informado'}</td>
                        <td>${collaborator.contact || 'Não informado'}</td>
                        <td>${collaborator.manualPercent}%</td>
                        <td>${collaborator.productPercent}%</td>
                        <td>${formatCurrency(collaborator.baseSalary || 0)}</td>
                        <td>
                            <span class="badge ${collaborator.active ? 'bg-success' : 'bg-secondary'}">
                                ${collaborator.active ? 'Ativo' : 'Inativo'}
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-info me-1" onclick="showCollaboratorProfile('${collaborator.id}')">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-primary me-1" onclick="editCollaborator('${collaborator.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteCollaborator('${collaborator.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
            
            document.getElementById('totalCollaborators').textContent = collaborators.filter(c => c.active).length;
        }

        function updatePackagesUI() {
            const container = document.getElementById('packagesList');
            const activePackages = packages.filter(p => p.status !== 'finished');
            const totalValue = activePackages.reduce((sum, pkg) => sum + parseFloat(pkg.value), 0);
            
            // Atualizar resumo
            document.getElementById('totalActivePackages').textContent = activePackages.length;
            document.getElementById('totalPackagesValue').textContent = formatCurrency(totalValue);
            
            // Contar próximos procedimentos (datas futuras não realizadas)
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            let nextProcedures = 0;
            
            activePackages.forEach(pkg => {
                if (pkg.procedureDates) {
                    pkg.procedureDates.forEach(dateObj => {
                        const procedureDate = new Date(dateObj.date);
                        procedureDate.setHours(0, 0, 0, 0);
                        if (!dateObj.completed && procedureDate >= today) {
                            nextProcedures++;
                        }
                    });
                }
            });
            
            document.getElementById('nextProceduresCount').textContent = nextProcedures;
            
            if (activePackages.length === 0) {
                container.innerHTML = '<p class="text-muted">Nenhum pacote ativo.</p>';
                return;
            }
            
            let html = '';
            activePackages.forEach(pkg => {
                const client = clients.find(c => c.id === pkg.clientId) || { name: 'Cliente não encontrado' };
                const completedProcedures = pkg.procedureDates ? pkg.procedureDates.filter(d => d.completed).length : 0;
                const totalProcedures = pkg.totalProcedures || 0;
                const progress = totalProcedures > 0 ? (completedProcedures / totalProcedures) * 100 : 0;
                
                let statusClass = 'package-pending';
                if (pkg.status === 'finished') {
                    statusClass = 'package-finished';
                } else if (completedProcedures === totalProcedures) {
                    statusClass = 'package-completed';
                }
                
                html += `
                    <div class="service-item ${statusClass} mb-3">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <h6 class="mb-1">${client.name} - ${pkg.description || 'Pacote'}</h6>
                                <p class="mb-1"><strong>Valor:</strong> ${formatCurrency(pkg.value)}</p>
                                <p class="mb-1"><strong>Progresso:</strong> ${completedProcedures}/${totalProcedures} procedimentos</p>
                                <div class="progress mb-2" style="height: 8px;">
                                    <div class="progress-bar" role="progressbar" style="width: ${progress}%"></div>
                                </div>
                                ${pkg.procedureDates ? `
                                    <div class="procedure-dates">
                                        <strong>Datas dos Procedimentos:</strong>
                                        <div class="mt-1">
                                            ${pkg.procedureDates.map((dateObj, index) => {
                                                const date = new Date(dateObj.date);
                                                const isCompleted = dateObj.completed;
                                                const isToday = new Date().toDateString() === date.toDateString();
                                                const statusClass = isCompleted ? 'date-status-completed' : 'date-status-pending';
                                                const statusText = isCompleted ? '✓ Realizado' : (isToday ? 'Hoje' : 'Pendente');
                                                return `
                                                    <small class="d-block ${statusClass}">
                                                        ${formatDate(dateObj.date)} - ${statusText}
                                                    </small>
                                                `;
                                            }).join('')}
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                            <div class="text-end">
                                <button class="btn btn-sm btn-success mb-1" onclick="markProcedureDone('${pkg.id}')">
                                    <i class="fas fa-check me-1"></i> Procedimento
                                </button>
                                <button class="btn btn-sm btn-warning mb-1" onclick="editPackage('${pkg.id}')">
                                    <i class="fas fa-edit me-1"></i> Editar
                                </button>
                                <button class="btn btn-sm btn-info mb-1" onclick="finishPackage('${pkg.id}', '${client.name}')">
                                    <i class="fas fa-flag-checkered me-1"></i> Finalizar
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deletePackage('${pkg.id}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function updateCollaboratorSelect() {
            const select = document.getElementById('collaboratorSelect');
            select.innerHTML = '<option value="">Selecione um colaborador</option>';
            
            collaborators.filter(c => c.active).forEach(collaborator => {
                const option = document.createElement('option');
                option.value = collaborator.id;
                option.textContent = collaborator.name;
                select.appendChild(option);
            });
        }

        function updateSalaryCollaboratorSelect() {
            const select = document.getElementById('salaryCollaborator');
            select.innerHTML = '<option value="">Selecione um colaborador</option>';
            
            collaborators.filter(c => c.active).forEach(collaborator => {
                const option = document.createElement('option');
                option.value = collaborator.id;
                option.textContent = collaborator.name;
                select.appendChild(option);
            });
        }

        function updateReportCollaboratorSelect() {
            const select = document.getElementById('reportCollaborator');
            select.innerHTML = '<option value="all">Todos</option>';
            
            collaborators.filter(c => c.active).forEach(collaborator => {
                const option = document.createElement('option');
                option.value = collaborator.id;
                option.textContent = collaborator.name;
                select.appendChild(option);
            });
        }

        // ============================================================
        // FUNÇÕES DO CONTROLE FINANCEIRO - VERSÃO 3.0 (SEPARADO POR CAIXAS)
        // ============================================================

        // Função para atualizar interface de despesas
        function updateExpensesUI() {
            // Popular seletor de meses
            updateMonthSelector('expensesMonth');
            
            // Carregar despesas do mês atual
            loadExpensesByMonth();
        }

        // Função para atualizar interface de salários
        function updateSalariesUI() {
            // Popular seletor de meses
            updateMonthSelector('salariesMonth');
            
            // Carregar salários do mês atual
            loadSalariesByMonth();
        }

        // Função para atualizar seletor de meses
        function updateMonthSelector(selectorId) {
            const select = document.getElementById(selectorId);
            select.innerHTML = '';
            
            const today = new Date();
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();
            
            // Adicionar 12 meses (6 passados e 6 futuros)
            for (let i = -6; i <= 6; i++) {
                const month = new Date(currentYear, currentMonth + i, 1);
                const monthValue = month.getFullYear() + '-' + String(month.getMonth() + 1).padStart(2, '0');
                const monthName = month.toLocaleDateString('pt-PT', { month: 'long', year: 'numeric' });
                const option = document.createElement('option');
                option.value = monthValue;
                option.textContent = monthName.charAt(0).toUpperCase() + monthName.slice(1);
                
                if (i === 0) {
                    option.selected = true;
                }
                
                select.appendChild(option);
            }
        }

        // Função para carregar despesas por mês
        function loadExpensesByMonth() {
            const monthValue = document.getElementById('expensesMonth').value;
            const [year, month] = monthValue.split('-').map(Number);
            
            const startDate = new Date(year, month - 1, 1);
            const endDate = new Date(year, month, 0);
            
            const monthExpenses = expenses.filter(expense => {
                const expenseDate = new Date(expense.dueDate);
                return expenseDate >= startDate && expenseDate <= endDate;
            });
            
            displayExpenses(monthExpenses);
        }

        // Função para carregar salários por mês
        function loadSalariesByMonth() {
            const monthValue = document.getElementById('salariesMonth').value;
            const [year, month] = monthValue.split('-').map(Number);
            
            const monthSalaries = salaryPayments.filter(salary => {
                const salaryMonth = salary.month;
                const [salaryYear, salaryMonthNum] = salaryMonth.split('-').map(Number);
                return salaryYear === year && salaryMonthNum === month;
            });
            
            displaySalaries(monthSalaries);
        }

        // Função para exibir despesas
        function displayExpenses(monthExpenses) {
            const container = document.getElementById('expensesList');
            
            if (monthExpenses.length === 0) {
                container.innerHTML = '<p class="text-muted">Nenhuma despesa registrada para este mês.</p>';
                return;
            }
            
            // Ordenar por data de vencimento
            monthExpenses.sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));
            
            let html = '';
            monthExpenses.forEach(expense => {
                const dueDate = new Date(expense.dueDate);
                const today = new Date();
                const daysDiff = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
                
                let statusClass = '';
                let statusText = '';
                
                if (expense.paid) {
                    statusClass = 'paid';
                    statusText = '<span class="status-paid">PAGO</span>';
                } else if (dueDate < today) {
                    statusClass = 'overdue';
                    statusText = '<span class="status-overdue">VENCIDO</span>';
                } else if (daysDiff <= 3) {
                    statusClass = 'due-soon';
                    statusText = '<span class="status-pending">A VENCER</span>';
                } else {
                    statusClass = '';
                    statusText = '<span class="status-pending">PENDENTE</span>';
                }
                
                html += `
                    <div class="expense-item ${statusClass} mb-2">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <h6 class="mb-1">${expense.description}</h6>
                                <p class="mb-1 text-muted small">
                                    Categoria: ${getExpenseCategoryName(expense.category)} | 
                                    Vencimento: ${formatDate(expense.dueDate)}
                                    ${expense.recurring ? ' <i class="fas fa-redo-alt expense-recurring-icon"></i> Recorrente' : ''}
                                </p>
                                ${expense.notes ? `<p class="mb-1 small">${expense.notes}</p>` : ''}
                            </div>
                            <div class="text-end">
                                <strong class="text-danger">${formatCurrency(expense.value)}</strong>
                                <div class="mt-1">
                                    ${statusText}
                                    ${!expense.paid ? `
                                        <button class="btn btn-sm btn-success ms-2" onclick="markExpenseAsPaid('${expense.id}')">
                                            <i class="fas fa-check"></i>
                                        </button>
                                    ` : ''}
                                    <button class="btn btn-sm btn-danger ms-1" onclick="deleteExpense('${expense.id}')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // Função para exibir salários
        function displaySalaries(monthSalaries) {
            const container = document.getElementById('salariesList');
            
            if (monthSalaries.length === 0) {
                container.innerHTML = '<p class="text-muted">Nenhum pagamento de salário registrado para este mês.</p>';
                return;
            }
            
            let html = '';
            let totalSalaries = 0;
            
            monthSalaries.forEach(salary => {
                const collaborator = collaborators.find(c => c.id === salary.collaboratorId) || { name: 'Colaborador não encontrado' };
                const total = (parseFloat(salary.baseValue) || 0) + (parseFloat(salary.bonus) || 0) - (parseFloat(salary.deductions) || 0);
                totalSalaries += total;
                
                html += `
                    <div class="salary-item mb-2">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <h6 class="mb-1">${collaborator.name}</h6>
                                <p class="mb-1 text-muted small">
                                    Mês: ${salary.month} | 
                                    Pagamento: ${formatDate(salary.paymentDate)} | 
                                    Método: ${getPaymentMethodName(salary.paymentMethod)}
                                </p>
                                <p class="mb-1 small">
                                    Base: ${formatCurrency(salary.baseValue)} | 
                                    Bônus: ${formatCurrency(salary.bonus || 0)} | 
                                    Descontos: ${formatCurrency(salary.deductions || 0)}
                                </p>
                                ${salary.notes ? `<p class="mb-1 small">${salary.notes}</p>` : ''}
                            </div>
                            <div class="text-end">
                                <strong class="text-warning">${formatCurrency(total)}</strong>
                                <div class="mt-1">
                                    <span class="status-paid">PAGO</span>
                                    <button class="btn btn-sm btn-danger ms-1" onclick="deleteSalaryPayment('${salary.id}')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            // Adicionar total
            html += `
                <div class="mt-3 pt-2 border-top">
                    <div class="d-flex justify-content-between">
                        <strong>Total da Folha:</strong>
                        <strong class="text-warning">${formatCurrency(totalSalaries)}</strong>
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }

        // Função para obter nome da categoria de despesa
        function getExpenseCategoryName(category) {
            const categories = {
                'aluguel': 'Aluguel',
                'energia': 'Energia',
                'agua': 'Água',
                'internet': 'Internet',
                'produtos': 'Produtos/Estoque',
                'manutencao': 'Manutenção',
                'marketing': 'Marketing',
                'impostos': 'Impostos',
                'outros': 'Outros'
            };
            return categories[category] || category;
        }

        // Função para obter nome do método de pagamento
        function getPaymentMethodName(method) {
            const methods = {
                'dinheiro': 'Dinheiro',
                'transferencia': 'Transferência',
                'cheque': 'Cheque'
            };
            return methods[method] || method;
        }

        // ============================================================
        // FUNÇÃO PRINCIPAL DO RESUMO FINANCEIRO - VERSÃO 3.0
        // ============================================================

        function updateFinancialSummary() {
            const today = new Date();
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();
            
            // 1. CALCULAR RECEITA DE SERVIÇOS (apenas serviços prestados)
            const monthServicesRevenue = allServices
                .filter(service => {
                    const serviceDate = service.timestamp.toDate ? service.timestamp.toDate() : new Date(service.timestamp);
                    return serviceDate.getMonth() === currentMonth && serviceDate.getFullYear() === currentYear;
                })
                .reduce((sum, service) => sum + parseFloat(service.value), 0);
            
            // 2. CALCULAR RECEITA DE PRODUTOS (apenas produtos vendidos)
            const monthProductsRevenue = allProductSales
                .filter(sale => {
                    const saleDate = sale.timestamp.toDate ? sale.timestamp.toDate() : new Date(sale.timestamp);
                    return saleDate.getMonth() === currentMonth && saleDate.getFullYear() === currentYear;
                })
                .reduce((sum, sale) => sum + parseFloat(sale.totalValue), 0);
            
            // 3. CALCULAR CUSTO DOS PRODUTOS VENDIDOS
            const monthProductsCost = allProductSales
                .filter(sale => {
                    const saleDate = sale.timestamp.toDate ? sale.timestamp.toDate() : new Date(sale.timestamp);
                    return saleDate.getMonth() === currentMonth && saleDate.getFullYear() === currentYear;
                })
                .reduce((sum, sale) => {
                    const product = products.find(p => p.id === sale.productId);
                    if (product) {
                        // Custo = quantidade vendida * preço de compra
                        return sum + (sale.quantity * parseFloat(product.purchasePrice));
                    }
                    return sum;
                }, 0);
            
            // 4. CALCULAR DESPESAS PAGAS (somente afetam o caixa de serviços)
            const monthServicesExpenses = expenses
                .filter(expense => {
                    const expenseDate = new Date(expense.dueDate);
                    return expenseDate.getMonth() === currentMonth && 
                           expenseDate.getFullYear() === currentYear && 
                           expense.paid;
                })
                .reduce((sum, expense) => sum + parseFloat(expense.value), 0);
            
            // 5. CALCULAR DESPESAS PENDENTES (não afetam o caixa final, apenas são mostradas como compromisso)
            const monthServicesPendingExpenses = expenses
                .filter(expense => {
                    const expenseDate = new Date(expense.dueDate);
                    return expenseDate.getMonth() === currentMonth && 
                           expenseDate.getFullYear() === currentYear && 
                           !expense.paid;
                })
                .reduce((sum, expense) => sum + parseFloat(expense.value), 0);
            
            // 6. CALCULAR FOLHA DE PAGAMENTO (afeta apenas o caixa de serviços)
            const monthServicesSalaries = salaryPayments
                .filter(salary => {
                    const [year, month] = salary.month.split('-').map(Number);
                    return month === currentMonth + 1 && year === currentYear;
                })
                .reduce((sum, salary) => {
                    const base = parseFloat(salary.baseValue) || 0;
                    const bonus = parseFloat(salary.bonus) || 0;
                    const deductions = parseFloat(salary.deductions) || 0;
                    return sum + base + bonus - deductions;
                }, 0);
            
            // 7. CALCULAR DESPESAS RECORRENTES (independente de pagamento)
            const recurringExpensesTotal = expenses
                .filter(expense => expense.recurring)
                .reduce((sum, expense) => sum + parseFloat(expense.value), 0);
            
            // 8. CALCULAR LUCRO DOS PRODUTOS (Receita - Custo)
            const monthProductsProfit = monthProductsRevenue - monthProductsCost;
            
            // 9. CALCULAR SALDO FINAL DE SERVIÇOS (Receita - Despesas Pagas - Salários)
            const servicesFinalCash = monthServicesRevenue - monthServicesExpenses - monthServicesSalaries;
            
            // 10. CALCULAR SALDO FINAL DE PRODUTOS (Lucro dos Produtos)
            const productsFinalCash = monthProductsProfit;
            
            // 11. CALCULAR TOTAL GERAL
            const totalRevenue = monthServicesRevenue + monthProductsRevenue;
            const totalExpenses = monthServicesExpenses + monthServicesSalaries;
            const totalProfit = servicesFinalCash + productsFinalCash;
            const totalFinalCash = servicesFinalCash + productsFinalCash;
            
            // ============================================================
            // ATUALIZAR A INTERFACE DO USUÁRIO
            // ============================================================
            
            // Caixa de Serviços
            document.getElementById('servicesRevenue').textContent = formatCurrency(monthServicesRevenue);
            document.getElementById('servicesExpenses').textContent = formatCurrency(monthServicesExpenses);
            document.getElementById('servicesPendingExpenses').textContent = formatCurrency(monthServicesPendingExpenses);
            document.getElementById('servicesFinalCash').textContent = formatCurrency(servicesFinalCash);
            document.getElementById('servicesFinalCash').className = servicesFinalCash >= 0 ? 'cash-box-amount positive-value' : 'cash-box-amount negative-value';
            
            // Caixa de Produtos
            document.getElementById('productsRevenue').textContent = formatCurrency(monthProductsRevenue);
            document.getElementById('productsCost').textContent = formatCurrency(monthProductsCost);
            document.getElementById('productsProfit').textContent = formatCurrency(monthProductsProfit);
            document.getElementById('productsProfit').className = monthProductsProfit >= 0 ? 'cash-box-amount positive-value' : 'cash-box-amount negative-value';
            document.getElementById('productsFinalCash').textContent = formatCurrency(productsFinalCash);
            document.getElementById('productsFinalCash').className = productsFinalCash >= 0 ? 'cash-box-amount positive-value' : 'cash-box-amount negative-value';
            
            // Resumo Geral
            document.getElementById('totalRevenue').textContent = formatCurrency(totalRevenue);
            document.getElementById('totalExpenses').textContent = formatCurrency(totalExpenses);
            document.getElementById('totalProfit').textContent = formatCurrency(totalProfit);
            document.getElementById('totalProfit').className = totalProfit >= 0 ? 'summary-value positive-value' : 'summary-value negative-value';
            document.getElementById('totalFinalCash').textContent = formatCurrency(totalFinalCash);
            document.getElementById('totalFinalCash').className = totalFinalCash >= 0 ? 'summary-value positive-value' : 'summary-value negative-value';
            
            // Cálculo Detalhado
            document.getElementById('calculationServicesRevenue').textContent = formatCurrency(monthServicesRevenue);
            document.getElementById('calculationServicesExpenses').textContent = formatCurrency(monthServicesExpenses);
            document.getElementById('calculationServicesBalance').textContent = formatCurrency(servicesFinalCash);
            document.getElementById('calculationServicesBalance').className = servicesFinalCash >= 0 ? 'positive-value' : 'negative-value';
            
            document.getElementById('calculationProductsRevenue').textContent = formatCurrency(monthProductsRevenue);
            document.getElementById('calculationProductsCost').textContent = formatCurrency(monthProductsCost);
            document.getElementById('calculationProductsBalance').textContent = formatCurrency(productsFinalCash);
            document.getElementById('calculationProductsBalance').className = productsFinalCash >= 0 ? 'positive-value' : 'negative-value';
            
            document.getElementById('calculationTotalCash').textContent = formatCurrency(totalFinalCash);
            document.getElementById('calculationTotalCash').className = totalFinalCash >= 0 ? 'positive-value' : 'negative-value';
            
            // Caixa Final Display
            document.getElementById('finalCashDisplay').textContent = `Caixa Total Final: ${formatCurrency(totalFinalCash)}`;
            document.getElementById('finalCashDisplay').className = totalFinalCash >= 0 ? 'final-cash-display positive-value' : 'final-cash-display negative-value';
            
            // Outros indicadores
            document.getElementById('pendingExpenses').textContent = formatCurrency(monthServicesPendingExpenses);
            document.getElementById('recurringExpenses').textContent = formatCurrency(recurringExpensesTotal);
            document.getElementById('netProfit').textContent = formatCurrency(totalProfit);
            document.getElementById('netProfit').className = totalProfit >= 0 ? 'summary-value positive-value' : 'summary-value negative-value';
            
            // Atualizar gráfico de despesas
            updateExpenseChart();
            
            // Atualizar próximos vencimentos
            loadUpcomingDueExpenses();
        }

        // Função para atualizar gráfico de despesas
        function updateExpenseChart() {
            const ctx = document.getElementById('expenseChart').getContext('2d');
            
            // Agrupar despesas por categoria (apenas as pagas)
            const categories = {};
            expenses.forEach(expense => {
                if (expense.paid) {
                    const category = getExpenseCategoryName(expense.category);
                    if (!categories[category]) {
                        categories[category] = 0;
                    }
                    categories[category] += parseFloat(expense.value);
                }
            });
            
            // Preparar dados para o gráfico
            const labels = Object.keys(categories);
            const data = Object.values(categories);
            
            // Cores para as categorias
            const backgroundColors = [
                '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', 
                '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF'
            ];
            
            // Destruir gráfico anterior se existir
            if (expenseChart) {
                expenseChart.destroy();
            }
            
            // Criar novo gráfico
            expenseChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: backgroundColors.slice(0, labels.length),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                boxWidth: 12,
                                padding: 15
                            }
                        }
                    }
                }
            });
        }

        // Função para carregar próximos vencimentos
        function loadUpcomingDueExpenses() {
            const container = document.getElementById('upcomingDueList');
            const today = new Date();
            const nextWeek = new Date();
            nextWeek.setDate(today.getDate() + 7);
            
            const upcomingExpenses = expenses
                .filter(expense => !expense.paid)
                .filter(expense => {
                    const dueDate = new Date(expense.dueDate);
                    return dueDate >= today && dueDate <= nextWeek;
                })
                .sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate))
                .slice(0, 5); // Limitar a 5 despesas
            
            if (upcomingExpenses.length === 0) {
                container.innerHTML = '<p class="text-muted">Nenhum vencimento próximo.</p>';
                return;
            }
            
            let html = '';
            upcomingExpenses.forEach(expense => {
                const dueDate = new Date(expense.dueDate);
                const daysDiff = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
                
                let statusClass = daysDiff <= 1 ? 'status-overdue' : 'status-pending';
                let statusText = daysDiff <= 1 ? 'AMANHÃ' : `EM ${daysDiff} DIAS`;
                
                html += `
                    <div class="mb-2 p-2 border rounded">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <small><strong>${expense.description}</strong></small><br>
                                <small class="text-muted">${formatDate(expense.dueDate)}</small>
                                ${expense.recurring ? '<br><small class="recurring-expense-note"><i class="fas fa-redo-alt"></i> Recorrente</small>' : ''}
                            </div>
                            <div class="text-end">
                                <small class="text-danger">${formatCurrency(expense.value)}</small><br>
                                <small class="${statusClass}">${statusText}</small>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // ============================================================
        // FUNÇÕES PARA SALVAR DADOS FINANCEIROS
        // ============================================================

        // Função para salvar despesa
        function saveExpense(e) {
            e.preventDefault();
            
            const description = document.getElementById('expenseDescription').value;
            const category = document.getElementById('expenseCategory').value;
            const value = parseFloat(document.getElementById('expenseValue').value);
            const dueDate = document.getElementById('expenseDueDate').value;
            const notes = document.getElementById('expenseNotes').value;
            const recurring = document.getElementById('expenseRecurring').checked;
            
            if (!description || !category || !value || !dueDate) {
                showError('Por favor, preencha todos os campos obrigatórios.');
                return;
            }
            
            const expenseData = {
                description: description,
                category: category,
                value: value,
                dueDate: dueDate,
                notes: notes,
                recurring: recurring,
                paid: false, // Sempre começa como pendente
                userId: currentUser.uid,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            showLoading('Salvando despesa...');
            
            db.collection('expenses').add(expenseData)
                .then(() => {
                    document.getElementById('expenseForm').reset();
                    loadExpenses(); // Recarregar todas as despesas
                    showSuccess('Despesa registrada com sucesso!');
                })
                .catch((error) => {
                    console.error('Erro ao salvar despesa:', error);
                    showError('Erro ao salvar despesa: ' + error.message);
                });
        }

        // Função para salvar pagamento de salário
        function saveSalaryPayment(e) {
            e.preventDefault();
            
            const collaboratorId = document.getElementById('salaryCollaborator').value;
            const month = document.getElementById('salaryMonth').value;
            const baseValue = parseFloat(document.getElementById('salaryBaseValue').value);
            const bonus = parseFloat(document.getElementById('salaryBonus').value) || 0;
            const deductions = parseFloat(document.getElementById('salaryDeductions').value) || 0;
            const paymentDate = document.getElementById('salaryPaymentDate').value;
            const paymentMethod = document.getElementById('salaryPaymentMethod').value;
            const notes = document.getElementById('salaryNotes').value;
            
            if (!collaboratorId || !month || !baseValue || !paymentDate || !paymentMethod) {
                showError('Por favor, preencha todos os campos obrigatórios.');
                return;
            }
            
            const salaryData = {
                collaboratorId: collaboratorId,
                month: month,
                baseValue: baseValue,
                bonus: bonus,
                deductions: deductions,
                paymentDate: paymentDate,
                paymentMethod: paymentMethod,
                notes: notes,
                totalValue: baseValue + bonus - deductions,
                userId: currentUser.uid,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            showLoading('Registrando pagamento de salário...');
            
            db.collection('salaryPayments').add(salaryData)
                .then(() => {
                    document.getElementById('salaryPaymentForm').reset();
                    loadSalaryPayments(); // Recarregar todos os salários
                    showSuccess('Pagamento de salário registrado com sucesso!');
                })
                .catch((error) => {
                    console.error('Erro ao salvar pagamento de salário:', error);
                    showError('Erro ao salvar pagamento de salário: ' + error.message);
                });
        }

        // Função para marcar despesa como paga (automaticamente deduz do caixa de serviços)
        function markExpenseAsPaid(expenseId) {
            db.collection('expenses').doc(expenseId).update({
                paid: true,
                paidAt: firebase.firestore.FieldValue.serverTimestamp()
            })
            .then(() => {
                loadExpenses(); // Recarregar para atualizar o resumo financeiro
                showSuccess('Despesa marcada como paga! O valor foi deduzido do caixa de serviços.');
            })
            .catch((error) => {
                console.error('Erro ao marcar despesa como paga:', error);
                showError('Erro ao marcar despesa como paga: ' + error.message);
            });
        }

        // Função para excluir despesa
        function deleteExpense(expenseId) {
            Swal.fire({
                title: 'Tem certeza?',
                text: "Esta ação não pode ser desfeita!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Sim, excluir!',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    db.collection('expenses').doc(expenseId).delete()
                        .then(() => {
                            loadExpenses();
                            showSuccess('Despesa excluída com sucesso!');
                        })
                        .catch((error) => {
                            showError('Erro ao excluir despesa: ' + error.message);
                        });
                }
            });
        }

        // Função para excluir pagamento de salário
        function deleteSalaryPayment(salaryId) {
            Swal.fire({
                title: 'Tem certeza?',
                text: "Esta ação não pode ser desfeita!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Sim, excluir!',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    db.collection('salaryPayments').doc(salaryId).delete()
                        .then(() => {
                            loadSalaryPayments();
                            showSuccess('Pagamento de salário excluído com sucesso!');
                        })
                        .catch((error) => {
                            showError('Erro ao excluir pagamento de salário: ' + error.message);
                        });
                }
            });
        }

        // ============================================================
        // FUNÇÕES AUXILIARES DO SISTEMA (PERMANECEM IGUAIS)
        // ============================================================

        function handleCollaboratorPhotoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!file.type.match('image.*')) {
                showError('Por favor, selecione uma imagem válida.');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const preview = document.getElementById('collaboratorPhotoPreview');
                const placeholder = document.getElementById('collaboratorPhotoPlaceholder');
                
                preview.src = e.target.result;
                preview.style.display = 'block';
                placeholder.style.display = 'none';
            };
            reader.readAsDataURL(file);
        }

        function showCollaboratorProfile(collaboratorId) {
            const collaborator = collaborators.find(c => c.id === collaboratorId);
            if (!collaborator) return;
            
            document.getElementById('collaboratorProfileName').textContent = collaborator.name;
            document.getElementById('collaboratorProfileSpecialty').textContent = collaborator.specialty || 'Sem especialidade definida';
            document.getElementById('collaboratorProfileDescription').textContent = collaborator.description || 'Sem descrição';
            document.getElementById('collaboratorProfileContact').textContent = collaborator.contact || 'Não informado';
            document.getElementById('collaboratorProfileManualPercent').textContent = collaborator.manualPercent;
            document.getElementById('collaboratorProfileProductPercent').textContent = collaborator.productPercent;
            document.getElementById('collaboratorProfileBaseSalary').textContent = formatCurrency(collaborator.baseSalary || 0);
            
            const statusElement = document.getElementById('collaboratorProfileStatus');
            statusElement.textContent = collaborator.active ? 'Ativo' : 'Inativo';
            statusElement.className = collaborator.active ? 'badge bg-success' : 'badge bg-secondary';
            
            const profileImage = document.getElementById('collaboratorProfileImage');
            if (collaborator.photoUrl) {
                profileImage.src = collaborator.photoUrl;
                profileImage.style.display = 'block';
            } else {
                profileImage.style.display = 'none';
            }
            
            const modal = new bootstrap.Modal(document.getElementById('collaboratorProfileModal'));
            modal.show();
        }

        function editPackage(packageId) {
            const pkg = packages.find(p => p.id === packageId);
            if (!pkg) return;
            
            document.getElementById('packageId').value = pkg.id;
            document.getElementById('packageClientSelect').value = pkg.clientId;
            document.getElementById('packageProcedures').value = pkg.totalProcedures;
            document.getElementById('packageFrequency').value = pkg.frequency;
            document.getElementById('packageStartDate').value = pkg.startDate;
            document.getElementById('packageValue').value = pkg.value;
            document.getElementById('packageDescription').value = pkg.description || '';
            
            // Configurar seleção de dias
            if (pkg.frequency > 1 && pkg.selectedDays) {
                document.getElementById('daysSelection').style.display = 'block';
                pkg.selectedDays.forEach(day => {
                    const checkbox = document.getElementById(`${day}Check`);
                    if (checkbox) {
                        checkbox.checked = true;
                    }
                });
            } else {
                document.getElementById('daysSelection').style.display = 'none';
            }
            
            // Atualizar botão
            document.getElementById('savePackageBtn').textContent = 'Atualizar Pacote';
            document.getElementById('cancelPackageEditBtn').style.display = 'block';
            
            showSuccess('Preencha os campos que deseja alterar e clique em "Atualizar Pacote"');
        }

        function cancelPackageEdit() {
            document.getElementById('packageForm').reset();
            document.getElementById('packageId').value = '';
            document.getElementById('daysSelection').style.display = 'none';
            document.getElementById('savePackageBtn').textContent = 'Criar Pacote';
            document.getElementById('cancelPackageEditBtn').style.display = 'none';
        }

        function savePackage(e) {
            e.preventDefault();
            
            const packageId = document.getElementById('packageId').value;
            const clientId = document.getElementById('packageClientSelect').value;
            const totalProcedures = parseInt(document.getElementById('packageProcedures').value);
            const frequency = parseInt(document.getElementById('packageFrequency').value);
            const startDate = document.getElementById('packageStartDate').value;
            const value = parseFloat(document.getElementById('packageValue').value);
            const description = document.getElementById('packageDescription').value;
            
            if (!clientId || !totalProcedures || !startDate || !value) {
                showError('Por favor, preencha todos os campos obrigatórios.');
                return;
            }
            
            // Verificar seleção de dias se frequência for maior que 1
            let selectedDays = [];
            if (frequency > 1) {
                const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
                selectedDays = days.filter(day => document.getElementById(`${day}Check`).checked);
                
                if (selectedDays.length !== frequency) {
                    showError(`Selecione exatamente ${frequency} dias da semana.`);
                    return;
                }
            }
            
            let promise;
            
            if (packageId) {
                // Atualizar pacote existente
                const packageData = {
                    clientId: clientId,
                    totalProcedures: totalProcedures,
                    frequency: frequency,
                    selectedDays: selectedDays,
                    startDate: startDate,
                    value: value,
                    description: description,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                promise = db.collection('packages').doc(packageId).update(packageData);
            } else {
                // Criar novo pacote
                // Gerar datas dos procedimentos
                const procedureDates = [];
                const start = new Date(startDate);
                
                if (frequency === 1) {
                    // Uma vez por semana
                    for (let i = 0; i < totalProcedures; i++) {
                        const procedureDate = new Date(start);
                        procedureDate.setDate(start.getDate() + (i * 7)); // Adiciona 7 dias para cada procedimento
                        procedureDates.push({
                            date: procedureDate.toISOString().split('T')[0],
                            completed: false
                        });
                    }
                } else {
                    // Múltiplas vezes por semana
                    let procedureCount = 0;
                    let currentDate = new Date(start);
                    
                    while (procedureCount < totalProcedures) {
                        const dayOfWeek = currentDate.getDay();
                        const dayNames = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
                        const currentDayName = dayNames[dayOfWeek];
                        
                        if (selectedDays.includes(currentDayName)) {
                            procedureDates.push({
                                date: currentDate.toISOString().split('T')[0],
                                completed: false
                            });
                            procedureCount++;
                        }
                        
                        currentDate.setDate(currentDate.getDate() + 1);
                        
                        // Limitar a um máximo de 365 dias para evitar loops infinitos
                        if (procedureCount >= totalProcedures || (currentDate - start) / (1000 * 60 * 60 * 24) > 365) {
                            break;
                        }
                    }
                }
                
                const packageData = {
                    clientId: clientId,
                    totalProcedures: totalProcedures,
                    frequency: frequency,
                    selectedDays: selectedDays,
                    startDate: startDate,
                    value: value,
                    description: description,
                    procedureDates: procedureDates,
                    status: 'active',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    userId: currentUser.uid
                };
                
                promise = db.collection('packages').add(packageData);
            }
            
            showLoading(packageId ? 'Atualizando pacote...' : 'Criando pacote...');
            
            promise
                .then(() => {
                    document.getElementById('packageForm').reset();
                    document.getElementById('daysSelection').style.display = 'none';
                    document.getElementById('packageId').value = '';
                    document.getElementById('savePackageBtn').textContent = 'Criar Pacote';
                    document.getElementById('cancelPackageEditBtn').style.display = 'none';
                    loadPackages();
                    showSuccess(packageId ? 'Pacote atualizado com sucesso!' : 'Pacote criado com sucesso!');
                })
                .catch((error) => {
                    console.error('Erro ao salvar pacote:', error);
                    showError('Erro ao salvar pacote: ' + error.message);
                });
        }

        function openCashier() {
            Swal.fire({
                title: 'Abrir Caixa',
                html: `
                    <input type="number" id="initialValue" class="swal2-input" placeholder="Valor inicial (€)" step="0.01" min="0" value="0">
                `,
                showCancelButton: true,
                confirmButtonText: 'Abrir',
                cancelButtonText: 'Cancelar',
                preConfirm: () => {
                    const initialValue = parseFloat(document.getElementById('initialValue').value);
                    if (isNaN(initialValue) || initialValue < 0) {
                        Swal.showValidationMessage('Digite um valor válido');
                    }
                    return initialValue;
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    const initialValue = result.value;
                    
                    const cashierData = {
                        date: new Date().toISOString().split('T')[0],
                        initialValue: initialValue,
                        openedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        userId: currentUser.uid,
                        status: 'open'
                    };
                    
                    db.collection('cashiers').add(cashierData)
                        .then((docRef) => {
                            currentCashier = {
                                id: docRef.id,
                                ...cashierData
                            };
                            updateCashierUI(true);
                            showSuccess('Caixa aberto com sucesso!');
                        })
                        .catch((error) => {
                            showError('Erro ao abrir caixa: ' + error.message);
                        });
                }
            });
        }

        function closeCashier() {
            if (!currentCashier) return;
            
            const totalServicesValue = todayServices.reduce((total, service) => total + parseFloat(service.value), 0);
            const totalProductsValue = todayProductSales.reduce((total, sale) => total + parseFloat(sale.totalValue), 0);
            const totalSales = totalServicesValue + totalProductsValue;
            const finalValue = currentCashier.initialValue + totalSales;
            
            db.collection('cashiers').doc(currentCashier.id).update({
                closedAt: firebase.firestore.FieldValue.serverTimestamp(),
                finalValue: finalValue,
                totalServices: totalServicesValue,
                totalProducts: totalProductsValue,
                servicesCount: todayServices.length,
                productsCount: todayProductSales.length,
                status: 'closed'
            })
            .then(() => {
                showSuccess('Caixa fechado com sucesso!');
                currentCashier = null;
                updateCashierUI(false);
            })
            .catch((error) => {
                showError('Erro ao fechar caixa: ' + error.message);
            });
        }

        function addService(e) {
            e.preventDefault();
            saveService(true);
        }

        function addAnotherService() {
            saveService(false);
        }

        function saveService(clearForm = true) {
            if (!currentCashier) {
                showError('É necessário abrir o caixa antes de adicionar serviços.');
                return;
            }
            
            const clientId = document.getElementById('selectedClientId').value;
            const collaboratorId = document.getElementById('collaboratorSelect').value;
            const serviceType = document.getElementById('serviceType').value;
            const serviceValue = parseFloat(document.getElementById('serviceValue').value);
            const serviceDescription = document.getElementById('serviceDescription').value;
            
            if (!clientId || !collaboratorId || !serviceType || !serviceValue) {
                showError('Por favor, preencha todos os campos obrigatórios.');
                return;
            }
            
            const serviceData = {
                clientId: clientId,
                collaboratorId: collaboratorId,
                type: serviceType,
                value: serviceValue,
                description: serviceDescription,
                date: new Date().toISOString().split('T')[0],
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                userId: currentUser.uid
            };
            
            db.collection('services').add(serviceData)
                .then(() => {
                    if (clearForm) {
                        document.getElementById('serviceForm').reset();
                        document.getElementById('selectedClientId').value = '';
                    }
                    loadAllServices();
                    showSuccess('Serviço adicionado com sucesso!');
                })
                .catch((error) => {
                    showError('Erro ao adicionar serviço: ' + error.message);
                });
        }

        function addProductSale(e) {
            e.preventDefault();
            
            if (!currentCashier) {
                showError('É necessário abrir o caixa antes de adicionar vendas de produtos.');
                return;
            }
            
            const productId = document.getElementById('selectedProductId').value;
            const quantity = parseInt(document.getElementById('productSaleQuantity').value);
            const clientId = document.getElementById('selectedProductClientId').value || null;
            
            if (!productId || !quantity) {
                showError('Por favor, preencha todos os campos obrigatórios.');
                return;
            }
            
            const product = products.find(p => p.id === productId);
            if (!product) {
                showError('Produto não encontrado.');
                return;
            }
            
            if (product.quantity < quantity) {
                showError(`Quantidade insuficiente em estoque. Disponível: ${product.quantity}`);
                return;
            }
            
            const totalValue = quantity * parseFloat(product.salePrice);
            
            const saleData = {
                productId: productId,
                productName: product.name,
                quantity: quantity,
                unitPrice: product.salePrice,
                totalValue: totalValue,
                clientId: clientId,
                date: new Date().toISOString().split('T')[0],
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                userId: currentUser.uid
            };
            
            // Atualizar estoque
            const newQuantity = product.quantity - quantity;
            
            db.collection('products').doc(productId).update({
                quantity: newQuantity
            })
            .then(() => {
                return db.collection('productSales').add(saleData);
            })
            .then(() => {
                document.getElementById('productSaleForm').reset();
                document.getElementById('selectedProductId').value = '';
                document.getElementById('selectedProductClientId').value = '';
                loadProducts();
                loadAllProductSales();
                showSuccess('Venda de produto registrada com sucesso!');
            })
            .catch((error) => {
                showError('Erro ao registrar venda de produto: ' + error.message);
            });
        }

        function deleteService(serviceId) {
            Swal.fire({
                title: 'Tem certeza?',
                text: "Esta ação não pode ser desfeita!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Sim, excluir!',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    db.collection('services').doc(serviceId).delete()
                        .then(() => {
                            loadAllServices();
                            showSuccess('Serviço excluído com sucesso!');
                        })
                        .catch((error) => {
                            showError('Erro ao excluir serviço: ' + error.message);
                        });
                }
            });
        }

        function deleteProductSale(saleId) {
            Swal.fire({
                title: 'Tem certeza?',
                text: "Esta ação não pode ser desfeita!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Sim, excluir!',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    // Primeiro, buscar os dados da venda para restaurar o estoque
                    db.collection('productSales').doc(saleId).get()
                        .then((doc) => {
                            if (doc.exists) {
                                const saleData = doc.data();
                                const productId = saleData.productId;
                                const quantity = saleData.quantity;
                                
                                // Restaurar estoque
                                return db.collection('products').doc(productId).get()
                                    .then((productDoc) => {
                                        if (productDoc.exists) {
                                            const currentQuantity = productDoc.data().quantity;
                                            return db.collection('products').doc(productId).update({
                                                quantity: currentQuantity + quantity
                                            });
                                        }
                                    })
                                    .then(() => {
                                        // Agora excluir a venda
                                        return db.collection('productSales').doc(saleId).delete();
                                    });
                            }
                        })
                        .then(() => {
                            loadProducts();
                            loadAllProductSales();
                            showSuccess('Venda de produto excluída com sucesso!');
                        })
                        .catch((error) => {
                            showError('Erro ao excluir venda de produto: ' + error.message);
                        });
                }
            });
        }

        // Funções para Produtos
        function showAddProductModal() {
            document.getElementById('productModalTitle').textContent = 'Adicionar Produto';
            document.getElementById('productForm').reset();
            document.getElementById('productId').value = '';
            
            const modal = new bootstrap.Modal(document.getElementById('productModal'));
            modal.show();
        }

        function editProduct(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;
            
            document.getElementById('productModalTitle').textContent = 'Editar Produto';
            document.getElementById('productId').value = product.id;
            document.getElementById('productName').value = product.name;
            document.getElementById('productQuantity').value = product.quantity;
            document.getElementById('productMinQuantity').value = product.minQuantity;
            document.getElementById('productPurchasePrice').value = product.purchasePrice;
            document.getElementById('productSalePrice').value = product.salePrice;
            document.getElementById('productDescription').value = product.description || '';
            document.getElementById('productCategory').value = product.category || 'outros';
            
            const modal = new bootstrap.Modal(document.getElementById('productModal'));
            modal.show();
        }

        function saveProduct() {
            const productId = document.getElementById('productId').value;
            const name = document.getElementById('productName').value;
            const quantity = parseInt(document.getElementById('productQuantity').value);
            const minQuantity = parseInt(document.getElementById('productMinQuantity').value);
            const purchasePrice = parseFloat(document.getElementById('productPurchasePrice').value);
            const salePrice = parseFloat(document.getElementById('productSalePrice').value);
            const description = document.getElementById('productDescription').value;
            const category = document.getElementById('productCategory').value;
            
            const productData = {
                name: name,
                quantity: quantity,
                minQuantity: minQuantity,
                purchasePrice: purchasePrice,
                salePrice: salePrice,
                description: description,
                category: category,
                userId: currentUser.uid,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            let promise;
            
            if (productId) {
                // Atualizar produto existente
                promise = db.collection('products').doc(productId).update(productData);
            } else {
                // Adicionar novo produto
                productData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                promise = db.collection('products').add(productData);
            }
            
            showLoading('Salvando produto...');
            
            promise
                .then(() => {
                    const modal = bootstrap.Modal.getInstance(document.getElementById('productModal'));
                    modal.hide();
                    loadProducts();
                    showSuccess(productId ? 'Produto atualizado com sucesso!' : 'Produto adicionado com sucesso!');
                })
                .catch((error) => {
                    console.error('Erro ao salvar produto:', error);
                    showError('Erro ao salvar produto: ' + error.message);
                });
        }

        function deleteProduct(productId) {
            Swal.fire({
                title: 'Tem certeza?',
                text: "Esta ação não pode ser desfeita!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Sim, excluir!',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    db.collection('products').doc(productId).delete()
                        .then(() => {
                            loadProducts();
                            showSuccess('Produto excluído com sucesso!');
                        })
                        .catch((error) => {
                            showError('Erro ao excluir produto: ' + error.message);
                        });
                }
            });
        }

        // Funções auxiliares (mantidas do código original)
        function showSection(section) {
            // Esconder todas as seções
            document.querySelectorAll('.section').forEach(el => {
                el.classList.remove('active');
            });
            
            // Esconder cards mobile
            document.getElementById('mobileCards').classList.remove('active');
            
            // CORREÇÃO MENU DESKTOP: Atualizar estado ativo dos links do sidebar
            document.querySelectorAll('.sidebar .nav-link').forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('data-section') === section) {
                    link.classList.add('active');
                }
            });
            
            // Mostrar a seção selecionada
            const sectionEl = document.getElementById(section);
            if (sectionEl) {
                sectionEl.classList.add('active');
                currentSection = section;
                
                // CORREÇÃO: Mostrar botão Home em TODAS as seções no mobile, incluindo dashboard
                const floatingHomeBtn = document.getElementById('floatingHomeBtn');
                if (floatingHomeBtn) {
                    if (isMobileView) {
                        floatingHomeBtn.style.display = 'flex';
                    } else {
                        floatingHomeBtn.style.display = 'none';
                    }
                }
                
                // Mostrar/ocultar botão voltar mobile
                const mobileBackBtn = document.getElementById('mobileBackBtn');
                if (mobileBackBtn) {
                    if (isMobileView && section !== 'dashboard') {
                        mobileBackBtn.style.display = 'block';
                    } else {
                        mobileBackBtn.style.display = 'none';
                    }
                }
                
                // CORREÇÃO: Atualizar colaboradores quando entrar na agenda
                if (section === 'agenda') {
                    setTimeout(() => {
                        updateAgendaProfessionals();
                        renderTimeColumn();
                        renderAgendaGrid();
                    }, 100);
                }
                
                // CORREÇÃO: Atualizar lista de clientes quando entrar em Registros
                if (section === 'client-records') {
                    updateClientRecordsList();
                }
            }
        }

        function showMobileCards() {
            // Esconder todas as seções
            document.querySelectorAll('.section').forEach(el => {
                el.classList.remove('active');
            });
            
            // Mostrar cards mobile
            document.getElementById('mobileCards').classList.add('active');
            
            // CORREÇÃO: Ocultar botão flutuante home na tela de cards
            const floatingHomeBtn = document.getElementById('floatingHomeBtn');
            if (floatingHomeBtn) {
                floatingHomeBtn.style.display = 'none';
            }
        }

        function checkMobileDevice() {
            isMobileView = window.innerWidth <= 768;
            
            if (isMobileView) {
                // Mostrar cards mobile inicialmente
                showMobileCards();
                
                // Ocultar botão flutuante home inicialmente (mostrará quando entrar em seção)
                const floatingHomeBtn = document.getElementById('floatingHomeBtn');
                if (floatingHomeBtn) {
                    floatingHomeBtn.style.display = 'none';
                }
                
                // Mostrar botão flutuante mobile
                const floatingMobileBtn = document.getElementById('floatingMobileBtn');
                if (floatingMobileBtn) {
                    floatingMobileBtn.style.display = 'flex';
                }
            } else {
                // Mostrar dashboard inicialmente
                showSection('dashboard');
                
                // Ocultar botões flutuantes mobile
                const floatingMobileBtn = document.getElementById('floatingMobileBtn');
                const floatingHomeBtn = document.getElementById('floatingHomeBtn');
                if (floatingMobileBtn) floatingMobileBtn.style.display = 'none';
                if (floatingHomeBtn) floatingHomeBtn.style.display = 'none';
            }
        }
        
        // NOVA FUNÇÃO: Atualizar lista de clientes em Registros
        function updateClientRecordsList() {
            const container = document.getElementById('clientCardsList');
            if (!container) return;
            
            if (clients.length === 0) {
                container.innerHTML = '<p class="text-muted text-center">Nenhum cliente cadastrado.</p>';
                return;
            }
            
            let html = '';
            clients.forEach(client => {
                const recentServices = allServices
                    .filter(service => service.clientId === client.id)
                    .sort((a, b) => {
                        const dateA = a.timestamp && a.timestamp.toDate ? a.timestamp.toDate() : new Date(a.timestamp || 0);
                        const dateB = b.timestamp && b.timestamp.toDate ? b.timestamp.toDate() : new Date(b.timestamp || 0);
                        return dateB - dateA;
                    })
                    .slice(0, 3);
                
                html += `
                    <div class="client-card card mb-2" onclick="showClientRecord('${client.id}')" style="cursor: pointer;">
                        <div class="card-body py-2">
                            <div class="d-flex align-items-center">
                                <div class="client-avatar me-3" style="width: 40px; height: 40px; font-size: 16px;">
                                    ${client.name.charAt(0).toUpperCase()}
                                </div>
                                <div class="flex-grow-1">
                                    <h6 class="mb-0">${client.name}</h6>
                                    <p class="text-muted small mb-0">${client.phone || 'Sem telefone'}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function formatCurrency(value) {
            if (typeof value !== 'number') {
                value = parseFloat(value) || 0;
            }
            return '€ ' + value.toFixed(2).replace('.', ',');
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('pt-PT');
        }

        function showLoading(message) {
            Swal.fire({
                title: message,
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
        }

        function showSuccess(message) {
            Swal.fire({
                icon: 'success',
                title: 'Sucesso!',
                text: message,
                timer: 2000,
                showConfirmButton: false
            });
        }

        function showError(message) {
            Swal.fire({
                icon: 'error',
                title: 'Erro!',
                text: message,
                timer: 3000,
                showConfirmButton: true
            });
        }


        // Funções auxiliares para a agenda
        function loadBusinessSettings() {
            const savedSettings = localStorage.getItem('businessSettings');
            if (savedSettings) {
                businessSettings = JSON.parse(savedSettings);
                updateBusinessLogo();
            }
        }

        function updateBusinessLogo() {
            const logoIcon = document.getElementById('businessLogoIcon');
            const businessNameSpan = document.getElementById('businessName');
            
            if (businessSettings.customLogo) {
                logoIcon.style.display = 'none';
                const logoImg = document.getElementById('businessLogoImg');
                if (!logoImg) {
                    const img = document.createElement('img');
                    img.id = 'businessLogoImg';
                    img.src = businessSettings.customLogo;
                    img.style.height = '30px';
                    img.style.marginRight = '10px';
                    document.getElementById('businessLogo').prepend(img);
                }
            } else {
                const logoImg = document.getElementById('businessLogoImg');
                if (logoImg) logoImg.remove();
                logoIcon.style.display = 'inline-block';
                
                const icons = {
                    'scissors': 'fa-scissors',
                    'store': 'fa-store',
                    'spa': 'fa-spa',
                    'salon': 'fa-cut',
                    'barber': 'fa-user-md'
                };
                logoIcon.className = `fas ${icons[businessSettings.logoType] || 'fa-scissors'} me-2`;
            }
            
            businessNameSpan.textContent = businessSettings.name || 'Studio DeVitto';
        }

        function showBusinessSettingsModal() {
            document.getElementById('businessNameInput').value = businessSettings.name;
            document.getElementById('businessLogoType').value = businessSettings.logoType;
            
            if (businessSettings.customLogo) {
                document.getElementById('logoPreview').src = businessSettings.customLogo;
                document.getElementById('logoPreview').style.display = 'block';
                document.getElementById('logoPlaceholder').style.display = 'none';
            }
            
            toggleLogoUpload();
            new bootstrap.Modal(document.getElementById('businessSettingsModal')).show();
        }

        function toggleLogoUpload() {
            const logoType = document.getElementById('businessLogoType').value;
            const uploadContainer = document.getElementById('logoUploadContainer');
            if (logoType === 'custom') {
                uploadContainer.style.display = 'block';
            } else {
                uploadContainer.style.display = 'none';
            }
        }

        function handleLogoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('logoPreview').src = e.target.result;
                document.getElementById('logoPreview').style.display = 'block';
                document.getElementById('logoPlaceholder').style.display = 'none';
            };
            reader.readAsDataURL(file);
        }

        function saveBusinessSettings() {
            businessSettings.name = document.getElementById('businessNameInput').value;
            businessSettings.logoType = document.getElementById('businessLogoType').value;
            
            if (businessSettings.logoType === 'custom') {
                const logoPreview = document.getElementById('logoPreview');
                if (logoPreview.src && !logoPreview.src.includes('data:')) {
                    businessSettings.customLogo = logoPreview.src;
                }
            } else {
                businessSettings.customLogo = null;
            }
            
            localStorage.setItem('businessSettings', JSON.stringify(businessSettings));
            updateBusinessLogo();
            
            bootstrap.Modal.getInstance(document.getElementById('businessSettingsModal')).hide();
            showSuccess('Configurações salvas com sucesso!');
        }

        // Carregar configurações ao iniciar
        loadBusinessSettings();

        // Funções para perfil da empresa
        function loadBusinessProfile() {
            const savedProfile = localStorage.getItem('businessProfile');
            if (savedProfile) {
                businessProfile = JSON.parse(savedProfile);
                updateBusinessProfileUI();
            }
        }

        function updateBusinessProfileUI() {
            document.getElementById('businessName').value = businessProfile.name;
            document.getElementById('businessEmail').value = businessProfile.email;
            document.getElementById('businessPhone').value = businessProfile.phone;
            document.getElementById('businessAddress').value = businessProfile.address;
            document.getElementById('businessDescription').value = businessProfile.description;
        }

        function saveBusinessProfile(e) {
            e.preventDefault();
            
            businessProfile = {
                name: document.getElementById('businessName').value,
                email: document.getElementById('businessEmail').value,
                phone: document.getElementById('businessPhone').value,
                address: document.getElementById('businessAddress').value,
                description: document.getElementById('businessDescription').value
            };
            
            localStorage.setItem('businessProfile', JSON.stringify(businessProfile));
            
            if (currentUser) {
                db.collection('businessProfile').doc(currentUser.uid).set(businessProfile)
                    .then(() => console.log('Perfil salvo no Firebase'))
                    .catch(error => console.error('Erro ao salvar perfil:', error));
            }
            
            showSuccess('Perfil da empresa salvo com sucesso!');
        }

        function updateBusinessHoursUI() {
            document.getElementById('mondayOpen').value = businessHours.monday.open;
            document.getElementById('mondayClose').value = businessHours.monday.close;
            document.getElementById('tuesdayOpen').value = businessHours.tuesday.open;
            document.getElementById('tuesdayClose').value = businessHours.tuesday.close;
            document.getElementById('wednesdayOpen').value = businessHours.wednesday.open;
            document.getElementById('wednesdayClose').value = businessHours.wednesday.close;
            document.getElementById('thursdayOpen').value = businessHours.thursday.open;
            document.getElementById('thursdayClose').value = businessHours.thursday.close;
            document.getElementById('fridayOpen').value = businessHours.friday.open;
            document.getElementById('fridayClose').value = businessHours.friday.close;
            document.getElementById('saturdayOpen').value = businessHours.saturday.open;
            document.getElementById('saturdayClose').value = businessHours.saturday.close;
        }

        function saveBusinessHours() {
            businessHours = {
                monday: {
                    open: document.getElementById('mondayOpen').value,
                    close: document.getElementById('mondayClose').value
                },
                tuesday: {
                    open: document.getElementById('tuesdayOpen').value,
                    close: document.getElementById('tuesdayClose').value
                },
                wednesday: {
                    open: document.getElementById('wednesdayOpen').value,
                    close: document.getElementById('wednesdayClose').value
                },
                thursday: {
                    open: document.getElementById('thursdayOpen').value,
                    close: document.getElementById('thursdayClose').value
                },
                friday: {
                    open: document.getElementById('fridayOpen').value,
                    close: document.getElementById('fridayClose').value
                },
                saturday: {
                    open: document.getElementById('saturdayOpen').value,
                    close: document.getElementById('saturdayClose').value
                },
                sunday: {
                    open: null,
                    close: null
                }
            };
            
            localStorage.setItem('businessHours', JSON.stringify(businessHours));
            
            if (currentUser) {
                db.collection('businessHours').doc(currentUser.uid).set(businessHours)
                    .then(() => console.log('Horários salvos no Firebase'))
                    .catch(error => console.error('Erro ao salvar horários:', error));
            }
            
            showSuccess('Horários de funcionamento salvos com sucesso!');
        }

        function loadUpcomingBirthdays() {
    const container = document.getElementById('upcomingBirthdaysList');
    const birthdaysContainer = document.getElementById('birthdaysList');
    
    if (clients.length === 0) {
        container.innerHTML = '<div class="text-center py-4"><i class="fas fa-birthday-cake fa-3x text-muted mb-3"></i><p class="text-muted">Nenhum aniversário próximo.</p></div>';
        if (birthdaysContainer) {
            birthdaysContainer.innerHTML = '<div class="text-center py-5"><i class="fas fa-birthday-cake fa-4x text-muted mb-4"></i><h5 class="text-muted">Nenhum aniversário próximo encontrado.</h5></div>';
        }
        return;
    }
    
    const today = new Date();
    const todayMonth = today.getMonth();
    const todayDay = today.getDate();
    
    const upcomingBirthdays = clients
        .filter(client => {
            if (!client.birthdate) return false;
            
            const birthdate = new Date(client.birthdate);
            const birthMonth = birthdate.getMonth();
            const birthDay = birthdate.getDate();
            
            // Verifica se é HOJE
            if (birthMonth === todayMonth && birthDay === todayDay) {
                return true;
            }
            
            // Verifica se é nos próximos 7 dias
            const currentYear = today.getFullYear();
            const nextBirthday = new Date(currentYear, birthMonth, birthDay);
            
            if (nextBirthday < today) {
                nextBirthday.setFullYear(currentYear + 1);
            }
            
            const daysDiff = Math.ceil((nextBirthday - today) / (1000 * 60 * 60 * 24));
            return daysDiff <= 7 && daysDiff > 0;
        })
        .sort((a, b) => {
            const dateA = new Date(a.birthdate);
            const dateB = new Date(b.birthdate);
            const currentYear = today.getFullYear();
            
            const birthMonthA = dateA.getMonth();
            const birthDayA = dateA.getDate();
            const birthMonthB = dateB.getMonth();
            const birthDayB = dateB.getDate();
            
            // Hoje primeiro
            const isAToday = birthMonthA === todayMonth && birthDayA === todayDay;
            const isBToday = birthMonthB === todayMonth && birthDayB === todayDay;
            
            if (isAToday && !isBToday) return -1;
            if (isBToday && !isAToday) return 1;
            
            // Depois ordena por data mais próxima
            const nextA = new Date(currentYear, birthMonthA, birthDayA);
            const nextB = new Date(currentYear, birthMonthB, birthDayB);
            
            if (nextA < today) nextA.setFullYear(currentYear + 1);
            if (nextB < today) nextB.setFullYear(currentYear + 1);
            
            return nextA - nextB;
        });
    
    // Atualizar contador no dashboard
    document.getElementById('upcomingBirthdays').textContent = upcomingBirthdays.length;
    
    if (upcomingBirthdays.length === 0) {
        container.innerHTML = '<div class="text-center py-4"><i class="fas fa-birthday-cake fa-3x text-muted mb-3"></i><p class="text-muted">Nenhum aniversário próximo.</p></div>';
        if (birthdaysContainer) {
            birthdaysContainer.innerHTML = '<div class="text-center py-5"><i class="fas fa-birthday-cake fa-4x text-muted mb-4"></i><h5 class="text-muted">Nenhum aniversário próximo encontrado.</h5></div>';
        }
        return;
    }
    
    let html = '';
    upcomingBirthdays.forEach(client => {
        const birthdate = new Date(client.birthdate);
        const birthMonth = birthdate.getMonth();
        const birthDay = birthdate.getDate();
        const currentYear = today.getFullYear();
        
        // Verifica se é HOJE
        const isToday = (birthMonth === todayMonth && birthDay === todayDay);
        
        let daysDiff;
        let nextBirthday;
        
        if (isToday) {
            daysDiff = 0;
            nextBirthday = today;
        } else {
            nextBirthday = new Date(currentYear, birthMonth, birthDay);
            if (nextBirthday < today) {
                nextBirthday.setFullYear(currentYear + 1);
            }
            daysDiff = Math.ceil((nextBirthday - today) / (1000 * 60 * 60 * 24));
        }
        
        const age = currentYear - birthdate.getFullYear();
        
        // Layout moderno e elegante
        html += `
            <div class="birthday-card ${isToday ? 'birthday-today-card' : 'birthday-upcoming-card'} mb-3">
                <div class="d-flex align-items-center p-3">
                    <div class="birthday-avatar ${isToday ? 'birthday-today-avatar' : ''} me-3">
                        <div class="avatar-inner">
                            ${client.name.charAt(0).toUpperCase()}
                            ${isToday ? '<div class="birthday-sparkle"><i class="fas fa-sparkle"></i></div>' : ''}
                        </div>
                    </div>
                    <div class="flex-grow-1">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="mb-1 fw-bold ${isToday ? 'text-primary' : ''}">${client.name}</h6>
                                <div class="birthday-details">
                                    <span class="badge bg-light text-dark me-2">
                                        <i class="fas fa-cake-candles me-1"></i>${formatDate(client.birthdate)}
                                    </span>
                                    <span class="badge bg-light text-dark me-2">
                                        <i class="fas fa-candle me-1"></i>${age} anos
                                    </span>
                                    ${isToday ? 
                                        '<span class="badge bg-danger text-white"><i class="fas fa-star me-1"></i>HOJE!</span>' : 
                                        `<span class="badge ${daysDiff <= 3 ? 'bg-warning' : 'bg-info'} text-white">
                                            <i class="fas fa-calendar-day me-1"></i>${daysDiff === 1 ? 'Amanhã' : `Em ${daysDiff} dias`}
                                        </span>`
                                    }
                                </div>
                            </div>
                            <div class="birthday-actions">
                                ${client.phone ? `
                                    <button class="btn btn-sm ${isToday ? 'btn-success' : 'btn-outline-primary'} me-2" 
                                            onclick="sendBirthdayWish('${client.id}', '${client.name}', '${client.phone}', ${isToday})"
                                            title="${isToday ? 'Enviar parabéns!' : 'Lembrar do aniversário'}">
                                        <i class="fab fa-whatsapp"></i>
                                        ${isToday ? 'Parabéns!' : 'Lembrar'}
                                    </button>
                                ` : ''}
                                <button class="btn btn-sm ${isToday ? 'btn-warning' : 'btn-outline-secondary'}" 
                                        onclick="showClientDetails('${client.id}')"
                                        title="Ver detalhes">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>
                        ${isToday ? `
                            <div class="mt-2">
                                <div class="alert alert-success py-2 mb-0">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-gift me-2"></i>
                                        <div>
                                            <strong>🎉 Hoje é o grande dia!</strong> 
                                            <small class="d-block">Não se esqueça de parabenizar ${client.name}!</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
    
    // Atualizar também a página de aniversários
    if (birthdaysContainer) {
        birthdaysContainer.innerHTML = `
            <div class="birthdays-header mb-4">
                <div class="d-flex justify-content-between align-items-center">
                    <h4><i class="fas fa-birthday-cake text-primary me-2"></i>Aniversariantes</h4>
                    <span class="badge bg-primary">${upcomingBirthdays.length} aniversário(s)</span>
                </div>
                <p class="text-muted mb-0">Gerencie os aniversários dos seus clientes</p>
            </div>
            ${html}
        `;
    }
}

// NOVA FUNÇÃO PARA ENVIAR PARABÉNS VIA WHATSAPP (MODERNA)
function sendBirthdayWish(clientId, clientName, clientPhone, isToday) {
    // Formata o telefone (remove tudo que não é número)
    const phone = clientPhone.replace(/\D/g, '');
    
    // Mensagem personalizada baseada se é hoje ou futuro
    let message;
    if (isToday) {
        message = `🎂 *FELIZ ANIVERSÁRIO, ${clientName.toUpperCase()}!* 🎉

Que este dia seja tão incrível quanto você! 🎈

Desejamos muita saúde, alegria, prosperidade e muitos momentos felizes! 

Que todos os seus sonhos se realizem e que este novo ano de vida seja repleto de conquistas e realizações! ✨

Um grande abraço da equipe ${businessSettings.name || 'Studio DeVitto'}! ❤️

*P.S.: Como presente de aniversário estamos lhe dando uma *Hidrata;ão dos Cabelos com Vapor de Ozônio.!
(obs: presente valido para os proximos 7 dias, não acompanha o brushing.);* 🎁`

    } else {
        // Mensagem para lembrar do aniversário futuro
        message = `Olá! 👋

Só passando para lembrar que em breve é o aniversário do(a) ${clientName}! 🎂

Que tal preparar uma surpresa ou já ir pensando nos parabéns? 

Equipe ${businessSettings.name || 'Studio DeVitto'}`;
    }
    
    // URL do WhatsApp
    const whatsappUrl = `https://wa.me/${phone}?text=${encodeURIComponent(message)}`;
    
    // Modal elegante para confirmação
    Swal.fire({
        title: isToday ? '🎉 Enviar Parabéns!' : '📅 Lembrar do Aniversário',
        html: `
            <div class="text-center">
                <div class="mb-3">
                    <i class="fab fa-whatsapp fa-3x text-success"></i>
                </div>
                <p>${isToday ? 
                    `Deseja enviar uma mensagem de <strong>Feliz Aniversário</strong> para <strong>${clientName}</strong>?` : 
                    `Deseja lembrar ${clientName} sobre o aniversário que será em breve?`
                }</p>
                <div class="message-preview p-3 bg-light rounded text-start mt-3">
                    <small class="text-muted">Pré-visualização da mensagem:</small>
                    <p class="mt-2 mb-0 small">${message.substring(0, 150)}...</p>
                </div>
            </div>
        `,
        showCancelButton: true,
        confirmButtonText: isToday ? '<i class="fab fa-whatsapp"></i> Enviar Parabéns!' : '<i class="fab fa-whatsapp"></i> Enviar Lembrete',
        cancelButtonText: 'Cancelar',
        confirmButtonColor: '#25D366',
        cancelButtonColor: '#6c757d',
        customClass: {
            confirmButton: 'btn btn-success',
            cancelButton: 'btn btn-secondary'
        },
        buttonsStyling: false,
        width: '500px'
    }).then((result) => {
        if (result.isConfirmed) {
            // Abre o WhatsApp
            window.open(whatsappUrl, '_blank');
            
            // Mostra confirmação
            Swal.fire({
                title: '✅ Pronto!',
                text: `${isToday ? 'Parabéns enviados!' : 'Lembrete enviado!'} O WhatsApp foi aberto.`,
                icon: 'success',
                timer: 2000,
                showConfirmButton: false
            });
            
            // Registra o envio (opcional - para histórico)
            if (currentUser) {
                const logData = {
                    clientId: clientId,
                    clientName: clientName,
                    type: isToday ? 'birthday_wish' : 'birthday_reminder',
                    sentAt: firebase.firestore.FieldValue.serverTimestamp(),
                    userId: currentUser.uid
                };
                
                db.collection('birthdayLogs').add(logData)
                    .catch(error => console.error('Erro ao registrar envio:', error));
            }
        }
    });
}

// Função auxiliar para mostrar detalhes do cliente
function showClientDetails(clientId) {
    const client = clients.find(c => c.id === clientId);
    if (!client) return;
    
    Swal.fire({
        title: `👤 ${client.name}`,
        html: `
            <div class="text-start">
                <div class="row mb-3">
                    <div class="col-4">
                        <div class="client-avatar-large bg-primary text-white rounded-circle d-flex align-items-center justify-content-center mx-auto" style="width: 80px; height: 80px; font-size: 32px;">
                            ${client.name.charAt(0).toUpperCase()}
                        </div>
                    </div>
                    <div class="col-8">
                        <p><strong><i class="fas fa-phone me-2"></i>Telefone:</strong><br>${client.phone || 'Não informado'}</p>
                        <p><strong><i class="fas fa-envelope me-2"></i>E-mail:</strong><br>${client.email || 'Não informado'}</p>
                    </div>
                </div>
                <div class="alert alert-info">
                    <p><strong><i class="fas fa-cake-candles me-2"></i>Aniversário:</strong> ${formatDate(client.birthdate)}</p>
                    ${client.phone ? `
                        <button class="btn btn-success w-100 mt-2" onclick="sendBirthdayWish('${client.id}', '${client.name}', '${client.phone}', true)">
                            <i class="fab fa-whatsapp me-2"></i>Enviar Parabéns Agora
                        </button>
                    ` : ''}
                </div>
            </div>
        `,
        showConfirmButton: false,
        showCloseButton: true,
        width: '600px'
    });
}
        // Funções para registros de clientes
        function searchClientRecords() {
            const searchTerm = document.getElementById('clientRecordsSearch').value.toLowerCase();
            const container = document.getElementById('clientCardsList');
            
            let filteredClients = clients;
            if (searchTerm) {
                filteredClients = clients.filter(client =>
                    client.name.toLowerCase().includes(searchTerm) ||
                    (client.phone && client.phone.includes(searchTerm))
                );
            }
            
            if (filteredClients.length === 0) {
                container.innerHTML = '<p class="text-muted text-center">Nenhum cliente encontrado.</p>';
                return;
            }
            
            let html = '';
            filteredClients.forEach(client => {
                const recentServices = allServices
                    .filter(service => service.clientId === client.id)
                    .sort((a, b) => {
                        const dateA = a.timestamp.toDate ? a.timestamp.toDate() : new Date(a.timestamp);
                        const dateB = b.timestamp.toDate ? b.timestamp.toDate() : new Date(b.timestamp);
                        return dateB - dateA;
                    })
                    .slice(0, 3);
                
                html += `
                    <div class="client-card card" onclick="showClientRecord('${client.id}')">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="client-avatar me-3">
                                    ${client.name.charAt(0).toUpperCase()}
                                </div>
                                <div class="flex-grow-1">
                                    <h6 class="mb-1">${client.name}</h6>
                                    <p class="text-muted small mb-1">${client.phone || 'Sem telefone'}</p>
                                    ${recentServices.length > 0 ? `
                                        <div class="small">
                                            <strong>Últimos serviços:</strong>
                                            <ul class="mb-0 ps-3">
                                                ${recentServices.map(service => `
                                                    <li>${service.description} (${formatCurrency(service.value)})</li>
                                                `).join('')}
                                            </ul>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function showClientRecord(clientId) {
            const client = clients.find(c => c.id === clientId);
            if (!client) return;
            
            // Carregar todos os serviços do cliente
            const clientServices = allServices.filter(service => service.clientId === client.id)
                .sort((a, b) => {
                    const dateA = a.timestamp.toDate ? a.timestamp.toDate() : new Date(a.timestamp);
                    const dateB = b.timestamp.toDate ? b.timestamp.toDate() : new Date(b.timestamp);
                    return dateB - dateA;
                });
            
            // Calcular valor total gasto
            const totalSpent = clientServices.reduce((sum, service) => sum + parseFloat(service.value), 0);
            
            // Carregar notas do cliente
            const clientNote = clientNotes[client.id] || { notes: '' };
            
            // Desktop
            const desktopContent = document.getElementById('clientRecordContent');
            desktopContent.innerHTML = `
                <div class="text-start">
                    <div class="text-center mb-4">
                        <div class="client-avatar mx-auto mb-3">
                            ${client.name.charAt(0).toUpperCase()}
                        </div>
                        <h4>${client.name}</h4>
                        <p class="text-muted">${client.phone || 'Sem telefone'}</p>
                        <p class="text-muted">${client.email || 'Sem e-mail'}</p>
                        <p class="text-muted">${client.birthdate ? `Nascimento: ${formatDate(client.birthdate)}` : ''}</p>
                    </div>
                    
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">Resumo</h6>
                                </div>
                                <div class="card-body">
                                    <p><strong>Total de Serviços:</strong> ${clientServices.length}</p>
                                    <p><strong>Valor Total Gasto:</strong> ${formatCurrency(totalSpent)}</p>
                                    <p><strong>Última Visita:</strong> ${clientServices.length > 0 ? 
                                        formatDate(clientServices[0].timestamp.toDate ? 
                                            clientServices[0].timestamp.toDate() : 
                                            new Date(clientServices[0].timestamp)) : 
                                        'Nunca'}</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0">Notas</h6>
                                    <button class="btn btn-sm btn-primary" onclick="editClientNotes('${client.id}')">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                </div>
                                <div class="card-body">
                                    ${clientNote.notes ? `
                                        <div style="white-space: pre-wrap;">${clientNote.notes}</div>
                                    ` : `
                                        <p class="text-muted">Nenhuma nota cadastrada.</p>
                                    `}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">Histórico de Serviços</h6>
                        </div>
                        <div class="card-body">
                            ${clientServices.length > 0 ? `
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>Data</th>
                                                <th>Serviço</th>
                                                <th>Colaborador</th>
                                                <th>Valor</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${clientServices.map(service => {
                                                const collaborator = collaborators.find(c => c.id === service.collaboratorId) || { name: 'Não informado' };
                                                const serviceDate = service.timestamp.toDate ? service.timestamp.toDate() : new Date(service.timestamp);
                                                return `
                                                    <tr>
                                                        <td>${formatDate(serviceDate)}</td>
                                                        <td>${service.description}</td>
                                                        <td>${collaborator.name}</td>
                                                        <td>${formatCurrency(service.value)}</td>
                                                    </tr>
                                                `;
                                            }).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            ` : `
                                <p class="text-muted">Nenhum serviço registrado.</p>
                            `}
                        </div>
                    </div>
                </div>
            `;
            
            // Mobile
            const mobileContent = document.getElementById('clientRecordMobileContent');
            mobileContent.innerHTML = desktopContent.innerHTML;
            
            document.getElementById('clientRecordTitle').textContent = client.name;
            document.getElementById('clientRecordMobileTitle').textContent = client.name;
            
            if (window.innerWidth <= 768) {
                document.getElementById('clientRecordMobile').classList.add('active');
                document.getElementById('clientRecordOverlay').classList.add('active');
            }
        }

        function closeMobileClientRecord() {
            document.getElementById('clientRecordMobile').classList.remove('active');
            document.getElementById('clientRecordOverlay').classList.remove('active');
        }

        function editClientNotes(clientId) {
            const client = clients.find(c => c.id === clientId);
            if (!client) return;
            
            const clientNote = clientNotes[client.id] || { notes: '' };
            
            document.getElementById('clientNotesModalTitle').textContent = `Notas - ${client.name}`;
            document.getElementById('clientNotesId').value = client.id;
            document.getElementById('clientNotes').value = clientNote.notes;
            
            new bootstrap.Modal(document.getElementById('clientNotesModal')).show();
        }

        function saveClientNotes() {
            const clientId = document.getElementById('clientNotesId').value;
            const notes = document.getElementById('clientNotes').value;
            
            if (!clientId) return;
            
            const noteData = {
                clientId: clientId,
                notes: notes,
                userId: currentUser.uid,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            let promise;
            
            if (clientNotes[clientId] && clientNotes[clientId].id) {
                // Atualizar notas existentes
                promise = db.collection('clientNotes').doc(clientNotes[clientId].id).update(noteData);
            } else {
                // Criar novas notas
                noteData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                promise = db.collection('clientNotes').add(noteData);
            }
            
            showLoading('Salvando notas...');
            
            promise
                .then(() => {
                    bootstrap.Modal.getInstance(document.getElementById('clientNotesModal')).hide();
                    loadClientNotes();
                    showSuccess('Notas salvas com sucesso!');
                })
                .catch((error) => {
                    showError('Erro ao salvar notas: ' + error.message);
                });
        }

        // Funções para relatórios - VERSÃO MELHORADA
        function generateReport() {
            const reportType = document.getElementById('reportType').value;
            const reportDate = document.getElementById('reportDate').value;
            const collaboratorId = document.getElementById('reportCollaborator').value;
            
            // Validação
            if (!reportType) {
                showError('Selecione um tipo de relatório');
                return;
            }
            
            if ((reportType === 'daily' || reportType === 'weekly' || reportType === 'monthly') && !reportDate) {
                showError('Selecione uma data para o relatório');
                return;
            }
            
            if (reportType === 'collaborator' && collaboratorId === 'all') {
                showError('Selecione um colaborador para o relatório por colaborador');
                return;
            }
            
            showLoading('Gerando relatório...');
            
            let filteredServices = [];
            let filteredProducts = [];
            let reportPeriod = '';
            
            try {
                if (reportType === 'daily' && reportDate) {
                    const selectedDate = new Date(reportDate);
                    const selectedDateStr = selectedDate.toISOString().split('T')[0];
                    reportPeriod = `Data: ${formatDate(selectedDate)}`;
                    
                    filteredServices = allServices.filter(service => {
                        const serviceDate = service.date || (service.timestamp && service.timestamp.toDate ? 
                            service.timestamp.toDate().toISOString().split('T')[0] : '');
                        return serviceDate === selectedDateStr;
                    });
                    filteredProducts = allProductSales.filter(sale => {
                        const saleDate = sale.date || (sale.timestamp && sale.timestamp.toDate ? 
                            sale.timestamp.toDate().toISOString().split('T')[0] : '');
                        return saleDate === selectedDateStr;
                    });
                } else if (reportType === 'weekly') {
                    const today = new Date(reportDate || new Date());
                    const startOfWeek = new Date(today);
                    const dayOfWeek = today.getDay();
                    const diffToMonday = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
                    startOfWeek.setDate(today.getDate() + diffToMonday);
                    startOfWeek.setHours(0, 0, 0, 0);
                    
                    const endOfWeek = new Date(startOfWeek);
                    endOfWeek.setDate(startOfWeek.getDate() + 6);
                    endOfWeek.setHours(23, 59, 59, 999);
                    
                    reportPeriod = `Semana: ${formatDate(startOfWeek)} a ${formatDate(endOfWeek)}`;
                    
                    filteredServices = allServices.filter(service => {
                        const serviceDate = service.timestamp && service.timestamp.toDate ? 
                            service.timestamp.toDate() : new Date(service.timestamp || service.date);
                        return serviceDate >= startOfWeek && serviceDate <= endOfWeek;
                    });
                    
                    filteredProducts = allProductSales.filter(sale => {
                        const saleDate = sale.timestamp && sale.timestamp.toDate ? 
                            sale.timestamp.toDate() : new Date(sale.timestamp || sale.date);
                        return saleDate >= startOfWeek && saleDate <= endOfWeek;
                    });
                } else if (reportType === 'monthly') {
                    const selectedDate = new Date(reportDate || new Date());
                    const month = selectedDate.getMonth();
                    const year = selectedDate.getFullYear();
                    const monthName = selectedDate.toLocaleDateString('pt-PT', { month: 'long', year: 'numeric' });
                    reportPeriod = `Mês: ${monthName.charAt(0).toUpperCase() + monthName.slice(1)}`;
                    
                    filteredServices = allServices.filter(service => {
                        const serviceDate = service.timestamp && service.timestamp.toDate ? 
                            service.timestamp.toDate() : new Date(service.timestamp || service.date);
                        return serviceDate.getMonth() === month && serviceDate.getFullYear() === year;
                    });
                    
                    filteredProducts = allProductSales.filter(sale => {
                        const saleDate = sale.timestamp && sale.timestamp.toDate ? 
                            sale.timestamp.toDate() : new Date(sale.timestamp || sale.date);
                        return saleDate.getMonth() === month && saleDate.getFullYear() === year;
                    });
                } else if (reportType === 'annual') {
                    const selectedDate = new Date(reportDate || new Date());
                    const year = selectedDate.getFullYear();
                    reportPeriod = `Ano: ${year}`;
                    
                    filteredServices = allServices.filter(service => {
                        const serviceDate = service.timestamp && service.timestamp.toDate ? 
                            service.timestamp.toDate() : new Date(service.timestamp || service.date);
                        return serviceDate.getFullYear() === year;
                    });
                    
                    filteredProducts = allProductSales.filter(sale => {
                        const saleDate = sale.timestamp && sale.timestamp.toDate ? 
                            sale.timestamp.toDate() : new Date(sale.timestamp || sale.date);
                        return saleDate.getFullYear() === year;
                    });
                } else if (reportType === 'collaborator' && collaboratorId !== 'all') {
                    const collaborator = collaborators.find(c => c.id === collaboratorId);
                    reportPeriod = `Colaborador: ${collaborator ? collaborator.name : 'Não encontrado'}`;
                    
                    filteredServices = allServices.filter(service => service.collaboratorId === collaboratorId);
                    filteredProducts = allProductSales.filter(sale => sale.collaboratorId === collaboratorId);
                } else if (reportType === 'inventory') {
                    reportPeriod = 'Relatório de Estoque';
                    // Para relatório de estoque, usamos os produtos em vez de serviços
                    generateInventoryReport();
                    return;
                } else if (reportType === 'financial') {
                    reportPeriod = 'Relatório Financeiro';
                    generateFinancialReport();
                    return;
                } else {
                    filteredServices = [...allServices];
                    filteredProducts = [...allProductSales];
                    reportPeriod = 'Todos os registros';
                }
                
                // Aplicar filtro de colaborador adicional se não for relatório por colaborador
                if (reportType !== 'collaborator' && collaboratorId !== 'all') {
                    filteredServices = filteredServices.filter(service => service.collaboratorId === collaboratorId);
                    const collaborator = collaborators.find(c => c.id === collaboratorId);
                    reportPeriod += ` | Colaborador: ${collaborator ? collaborator.name : 'N/A'}`;
                }
                
                Swal.close();
                
                // Verificar se há dados
                if (filteredServices.length === 0 && filteredProducts.length === 0) {
                    showError('Nenhum registro encontrado para o período selecionado');
                    return;
                }
                
                // Gerar PDF
                generatePDFReport(filteredServices, filteredProducts, reportType, reportPeriod);
                
            } catch (error) {
                console.error('Erro ao gerar relatório:', error);
                showError('Erro ao gerar relatório: ' + error.message);
            }
        }
        
        function generatePDFReport(filteredServices, filteredProducts, reportType, reportPeriod) {
            // Criar PDF
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Cabeçalho
            doc.setFontSize(20);
            doc.setTextColor(38, 25, 107);
            doc.text(businessSettings.name || 'Studio DeVitto', 105, 15, { align: 'center' });
            
            doc.setFontSize(12);
            doc.setTextColor(128, 128, 128);
            doc.text(`Relatório ${getReportTypeName(reportType)}`, 105, 25, { align: 'center' });
            doc.text(reportPeriod, 105, 30, { align: 'center' });
            doc.text(`Gerado em: ${new Date().toLocaleDateString('pt-PT')} às ${new Date().toLocaleTimeString('pt-PT')}`, 105, 35, { align: 'center' });
            
            // Resumo
            doc.setFontSize(14);
            doc.setTextColor(0, 0, 0);
            doc.text('Resumo', 14, 50);
            
            doc.setFontSize(10);
            const totalServicesValue = filteredServices.reduce((sum, service) => sum + parseFloat(service.value || 0), 0);
            const totalProductsValue = filteredProducts.reduce((sum, sale) => sum + parseFloat(sale.totalValue || 0), 0);
            const totalValue = totalServicesValue + totalProductsValue;
            
            doc.text(`Serviços realizados: ${filteredServices.length}`, 14, 60);
            doc.text(`Vendas de produtos: ${filteredProducts.length}`, 14, 65);
            doc.text(`Valor total de serviços: ${formatCurrency(totalServicesValue)}`, 14, 70);
            doc.text(`Valor total de produtos: ${formatCurrency(totalProductsValue)}`, 14, 75);
            doc.text(`Valor total geral: ${formatCurrency(totalValue)}`, 14, 80);
            
            // Calcular comissões
            let totalCommissions = 0;
            filteredServices.forEach(service => {
                const collaborator = collaborators.find(c => c.id === service.collaboratorId);
                if (collaborator) {
                    const percent = service.type === 'manual' ? 
                        parseFloat(collaborator.manualPercent || 0) : 
                        parseFloat(collaborator.productPercent || 0);
                    totalCommissions += parseFloat(service.value || 0) * (percent / 100);
                }
            });
            
            doc.text(`Total de comissões: ${formatCurrency(totalCommissions)}`, 14, 85);
            doc.text(`Lucro líquido (serviços): ${formatCurrency(totalServicesValue - totalCommissions)}`, 14, 90);
            
            // Serviços
            if (filteredServices.length > 0) {
                doc.addPage();
                doc.setFontSize(14);
                doc.text('Serviços Realizados', 14, 20);
                
                const serviceData = filteredServices.map(service => {
                    const client = clients.find(c => c.id === service.clientId) || { name: 'Não encontrado' };
                    const collaborator = collaborators.find(c => c.id === service.collaboratorId) || { name: 'Não informado' };
                    const serviceDate = service.timestamp.toDate ? service.timestamp.toDate() : new Date(service.timestamp);
                    
                    return [
                        formatDate(serviceDate),
                        client.name,
                        service.description,
                        collaborator.name,
                        formatCurrency(service.value)
                    ];
                });
                
                doc.autoTable({
                    startY: 30,
                    head: [['Data', 'Cliente', 'Serviço', 'Colaborador', 'Valor']],
                    body: serviceData,
                    theme: 'striped',
                    headStyles: { fillColor: [38, 25, 107] }
                });
            }
            
            // Produtos
            if (filteredProducts.length > 0) {
                doc.addPage();
                doc.setFontSize(14);
                doc.text('Vendas de Produtos', 14, 20);
                
                const productData = filteredProducts.map(sale => {
                    const product = products.find(p => p.id === sale.productId) || { name: 'Não encontrado' };
                    const client = sale.clientId ? clients.find(c => c.id === sale.clientId) : null;
                    const saleDate = sale.timestamp.toDate ? sale.timestamp.toDate() : new Date(sale.timestamp);
                    
                    return [
                        formatDate(saleDate),
                        product.name,
                        sale.quantity,
                        client ? client.name : 'Venda avulsa',
                        formatCurrency(sale.totalValue)
                    ];
                });
                
                doc.autoTable({
                    startY: 30,
                    head: [['Data', 'Produto', 'Quantidade', 'Cliente', 'Valor']],
                    body: productData,
                    theme: 'striped',
                    headStyles: { fillColor: [23, 162, 184] }
                });
            }
            
            // Salvar PDF
            doc.save(`relatorio-${reportType}-${new Date().toISOString().slice(0, 10)}.pdf`);
            showSuccess('Relatório gerado com sucesso!');
        }
        
        // Relatório de Estoque
        function generateInventoryReport() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFontSize(20);
            doc.setTextColor(38, 25, 107);
            doc.text(businessSettings.name || 'Studio DeVitto', 105, 15, { align: 'center' });
            
            doc.setFontSize(12);
            doc.setTextColor(128, 128, 128);
            doc.text('Relatório de Estoque', 105, 25, { align: 'center' });
            doc.text(`Gerado em: ${new Date().toLocaleDateString('pt-PT')} às ${new Date().toLocaleTimeString('pt-PT')}`, 105, 30, { align: 'center' });
            
            // Resumo
            doc.setFontSize(14);
            doc.setTextColor(0, 0, 0);
            doc.text('Resumo do Estoque', 14, 45);
            
            const totalProducts = products.length;
            const lowStockProducts = products.filter(p => p.quantity <= p.minQuantity);
            const totalInventoryValue = products.reduce((sum, p) => sum + (p.quantity * parseFloat(p.salePrice || 0)), 0);
            const totalInvestment = products.reduce((sum, p) => sum + (p.quantity * parseFloat(p.purchasePrice || 0)), 0);
            
            doc.setFontSize(10);
            doc.text(`Total de produtos: ${totalProducts}`, 14, 55);
            doc.text(`Produtos com estoque baixo: ${lowStockProducts.length}`, 14, 60);
            doc.text(`Valor total em estoque (venda): ${formatCurrency(totalInventoryValue)}`, 14, 65);
            doc.text(`Investimento total (compra): ${formatCurrency(totalInvestment)}`, 14, 70);
            doc.text(`Lucro potencial: ${formatCurrency(totalInventoryValue - totalInvestment)}`, 14, 75);
            
            // Lista de produtos
            if (products.length > 0) {
                const productData = products.map(p => [
                    p.name,
                    p.quantity,
                    p.minQuantity,
                    formatCurrency(p.purchasePrice),
                    formatCurrency(p.salePrice),
                    p.quantity <= p.minQuantity ? 'BAIXO' : 'OK'
                ]);
                
                doc.autoTable({
                    startY: 85,
                    head: [['Produto', 'Qtd', 'Mínimo', 'Compra', 'Venda', 'Status']],
                    body: productData,
                    theme: 'striped',
                    headStyles: { fillColor: [38, 25, 107] }
                });
            }
            
            // Produtos com estoque baixo
            if (lowStockProducts.length > 0) {
                doc.addPage();
                doc.setFontSize(14);
                doc.setTextColor(220, 53, 69);
                doc.text('ALERTA: Produtos com Estoque Baixo', 14, 20);
                
                const lowStockData = lowStockProducts.map(p => [
                    p.name,
                    p.quantity,
                    p.minQuantity,
                    `Faltam ${p.minQuantity - p.quantity + 1} unidades`
                ]);
                
                doc.autoTable({
                    startY: 30,
                    head: [['Produto', 'Atual', 'Mínimo', 'Observação']],
                    body: lowStockData,
                    theme: 'striped',
                    headStyles: { fillColor: [220, 53, 69] }
                });
            }
            
            doc.save(`relatorio-estoque-${new Date().toISOString().slice(0, 10)}.pdf`);
            Swal.close();
            showSuccess('Relatório de estoque gerado com sucesso!');
        }
        
        // Relatório Financeiro
        function generateFinancialReport() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const today = new Date();
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();
            const monthName = today.toLocaleDateString('pt-PT', { month: 'long', year: 'numeric' });
            
            doc.setFontSize(20);
            doc.setTextColor(38, 25, 107);
            doc.text(businessSettings.name || 'Studio DeVitto', 105, 15, { align: 'center' });
            
            doc.setFontSize(12);
            doc.setTextColor(128, 128, 128);
            doc.text('Relatório Financeiro', 105, 25, { align: 'center' });
            doc.text(`Mês: ${monthName.charAt(0).toUpperCase() + monthName.slice(1)}`, 105, 30, { align: 'center' });
            doc.text(`Gerado em: ${new Date().toLocaleDateString('pt-PT')} às ${new Date().toLocaleTimeString('pt-PT')}`, 105, 35, { align: 'center' });
            
            // Calcular dados financeiros
            const monthServices = allServices.filter(s => {
                const d = s.timestamp && s.timestamp.toDate ? s.timestamp.toDate() : new Date(s.timestamp || s.date);
                return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
            });
            
            const monthProducts = allProductSales.filter(s => {
                const d = s.timestamp && s.timestamp.toDate ? s.timestamp.toDate() : new Date(s.timestamp || s.date);
                return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
            });
            
            const monthExpenses = expenses.filter(e => {
                const d = new Date(e.dueDate);
                return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
            });
            
            const servicesRevenue = monthServices.reduce((sum, s) => sum + parseFloat(s.value || 0), 0);
            const productsRevenue = monthProducts.reduce((sum, s) => sum + parseFloat(s.totalValue || 0), 0);
            const totalRevenue = servicesRevenue + productsRevenue;
            
            const paidExpenses = monthExpenses.filter(e => e.paid).reduce((sum, e) => sum + parseFloat(e.value || 0), 0);
            const pendingExpenses = monthExpenses.filter(e => !e.paid).reduce((sum, e) => sum + parseFloat(e.value || 0), 0);
            
            // Calcular comissões
            let totalCommissions = 0;
            monthServices.forEach(service => {
                const collaborator = collaborators.find(c => c.id === service.collaboratorId);
                if (collaborator) {
                    const percent = service.type === 'manual' ? 
                        parseFloat(collaborator.manualPercent || 0) : 
                        parseFloat(collaborator.productPercent || 0);
                    totalCommissions += parseFloat(service.value || 0) * (percent / 100);
                }
            });
            
            const netProfit = totalRevenue - paidExpenses - totalCommissions;
            
            // Resumo
            doc.setFontSize(14);
            doc.setTextColor(0, 0, 0);
            doc.text('Resumo Financeiro', 14, 50);
            
            doc.setFontSize(10);
            doc.text(`Receita de Serviços: ${formatCurrency(servicesRevenue)}`, 14, 60);
            doc.text(`Receita de Produtos: ${formatCurrency(productsRevenue)}`, 14, 65);
            doc.text(`Receita Total: ${formatCurrency(totalRevenue)}`, 14, 70);
            doc.text(`Despesas Pagas: ${formatCurrency(paidExpenses)}`, 14, 80);
            doc.text(`Despesas Pendentes: ${formatCurrency(pendingExpenses)}`, 14, 85);
            doc.text(`Comissões de Colaboradores: ${formatCurrency(totalCommissions)}`, 14, 90);
            
            doc.setFontSize(12);
            doc.setTextColor(netProfit >= 0 ? 40 : 220, netProfit >= 0 ? 167 : 53, netProfit >= 0 ? 69 : 69);
            doc.text(`Lucro Líquido: ${formatCurrency(netProfit)}`, 14, 100);
            
            // Despesas por categoria
            if (monthExpenses.length > 0) {
                doc.addPage();
                doc.setFontSize(14);
                doc.setTextColor(0, 0, 0);
                doc.text('Despesas por Categoria', 14, 20);
                
                const categories = {};
                monthExpenses.forEach(e => {
                    const cat = getExpenseCategoryName(e.category);
                    if (!categories[cat]) categories[cat] = { paid: 0, pending: 0 };
                    if (e.paid) {
                        categories[cat].paid += parseFloat(e.value || 0);
                    } else {
                        categories[cat].pending += parseFloat(e.value || 0);
                    }
                });
                
                const expenseData = Object.entries(categories).map(([cat, vals]) => [
                    cat,
                    formatCurrency(vals.paid),
                    formatCurrency(vals.pending),
                    formatCurrency(vals.paid + vals.pending)
                ]);
                
                doc.autoTable({
                    startY: 30,
                    head: [['Categoria', 'Pago', 'Pendente', 'Total']],
                    body: expenseData,
                    theme: 'striped',
                    headStyles: { fillColor: [220, 53, 69] }
                });
            }
            
            doc.save(`relatorio-financeiro-${new Date().toISOString().slice(0, 10)}.pdf`);
            Swal.close();
            showSuccess('Relatório financeiro gerado com sucesso!');
        }

        function getReportTypeName(type) {
            const names = {
                'daily': 'Diário',
                'weekly': 'Semanal',
                'monthly': 'Mensal',
                'annual': 'Anual',
                'yearly': 'Anual',
                'collaborator': 'Por Colaborador',
                'inventory': 'Estoque',
                'financial': 'Financeiro'
            };
            return names[type] || type;
        }

        // Funções para pacotes
        function updatePackageClientSelect() {
            const select = document.getElementById('packageClientSelect');
            select.innerHTML = '<option value="">Selecione um cliente</option>';
            
            clients.forEach(client => {
                const option = document.createElement('option');
                option.value = client.id;
                option.textContent = client.name;
                select.appendChild(option);
            });
        }

        function toggleDaysSelection() {
            const frequency = parseInt(document.getElementById('packageFrequency').value);
            const daysSelection = document.getElementById('daysSelection');
            
            if (frequency > 1) {
                daysSelection.style.display = 'block';
            } else {
                daysSelection.style.display = 'none';
            }
        }

        function markProcedureDone(packageId) {
            const pkg = packages.find(p => p.id === packageId);
            if (!pkg) return;
            
            Swal.fire({
                title: 'Marcar Procedimento',
                html: `
                    <p>Selecione o procedimento concluído:</p>
                    <select id="procedureSelect" class="form-select">
                        ${pkg.procedureDates ? pkg.procedureDates
                            .filter(date => !date.completed)
                            .map((date, index) => `
                                <option value="${index}">${formatDate(date.date)}</option>
                            `).join('') : ''}
                    </select>
                `,
                showCancelButton: true,
                confirmButtonText: 'Marcar como Realizado',
                cancelButtonText: 'Cancelar',
                preConfirm: () => {
                    return document.getElementById('procedureSelect').value;
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    const procedureIndex = parseInt(result.value);
                    if (pkg.procedureDates && pkg.procedureDates[procedureIndex]) {
                        pkg.procedureDates[procedureIndex].completed = true;
                        
                        db.collection('packages').doc(packageId).update({
                            procedureDates: pkg.procedureDates,
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        })
                        .then(() => {
                            loadPackages();
                            showSuccess('Procedimento marcado como realizado!');
                        })
                        .catch(error => {
                            showError('Erro ao atualizar procedimento: ' + error.message);
                        });
                    }
                }
            });
        }

        function finishPackage(packageId, clientName) {
            Swal.fire({
                title: 'Finalizar Pacote',
                text: `Tem certeza que deseja finalizar o pacote de ${clientName}?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Sim, finalizar!',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    db.collection('packages').doc(packageId).update({
                        status: 'finished',
                        finishedAt: firebase.firestore.FieldValue.serverTimestamp()
                    })
                    .then(() => {
                        loadPackages();
                        showSuccess('Pacote finalizado com sucesso!');
                    })
                    .catch(error => {
                        showError('Erro ao finalizar pacote: ' + error.message);
                    });
                }
            });
        }

        function deletePackage(packageId) {
            Swal.fire({
                title: 'Tem certeza?',
                text: "Esta ação não pode ser desfeita!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Sim, excluir!',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    db.collection('packages').doc(packageId).delete()
                        .then(() => {
                            loadPackages();
                            showSuccess('Pacote excluído com sucesso!');
                        })
                        .catch(error => {
                            showError('Erro ao excluir pacote: ' + error.message);
                        });
                }
            });
        }

        // Funções para clientes
        function showAddClientModal() {
            document.getElementById('clientModalTitle').textContent = 'Adicionar Cliente';
            document.getElementById('clientForm').reset();
            document.getElementById('clientId').value = '';
            
            new bootstrap.Modal(document.getElementById('clientModal')).show();
        }

        function editClient(clientId) {
            const client = clients.find(c => c.id === clientId);
            if (!client) return;
            
            document.getElementById('clientModalTitle').textContent = 'Editar Cliente';
            document.getElementById('clientId').value = client.id;
            document.getElementById('clientName').value = client.name;
            document.getElementById('clientBirthdate').value = client.birthdate;
            document.getElementById('clientPhone').value = client.phone;
            document.getElementById('clientEmail').value = client.email || '';
            
            new bootstrap.Modal(document.getElementById('clientModal')).show();
        }

        function saveClient() {
            const clientId = document.getElementById('clientId').value;
            const name = document.getElementById('clientName').value;
            const birthdate = document.getElementById('clientBirthdate').value;
            const phone = document.getElementById('clientPhone').value;
            const email = document.getElementById('clientEmail').value;
            
            const clientData = {
                name: name,
                birthdate: birthdate,
                phone: phone,
                email: email,
                userId: currentUser.uid,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            let promise;
            
            if (clientId) {
                promise = db.collection('clients').doc(clientId).update(clientData);
            } else {
                clientData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                promise = db.collection('clients').add(clientData);
            }
            
            showLoading('Salvando cliente...');
            
            promise
                .then(() => {
                    bootstrap.Modal.getInstance(document.getElementById('clientModal')).hide();
                    loadClients();
                    showSuccess(clientId ? 'Cliente atualizado com sucesso!' : 'Cliente adicionado com sucesso!');
                })
                .catch((error) => {
                    console.error('Erro ao salvar cliente:', error);
                    showError('Erro ao salvar cliente: ' + error.message);
                });
        }

        function searchClients() {
            const searchTerm = document.getElementById('clientSearch').value.toLowerCase();
            const tbody = document.getElementById('clientsTable');
            
            let filteredClients = clients;
            if (searchTerm) {
                filteredClients = clients.filter(client =>
                    client.name.toLowerCase().includes(searchTerm) ||
                    (client.phone && client.phone.includes(searchTerm)) ||
                    (client.email && client.email.toLowerCase().includes(searchTerm))
                );
            }
            
            if (filteredClients.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Nenhum cliente encontrado.</td></tr>';
                return;
            }
            
            let html = '';
            filteredClients.forEach(client => {
                html += `
                    <tr>
                        <td>${client.name}</td>
                        <td>${formatDate(client.birthdate)}</td>
                        <td>${client.phone}</td>
                        <td>${client.email || '-'}</td>
                        <td>
                            <button class="btn btn-sm btn-primary me-1" onclick="editClient('${client.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteClient('${client.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            tbody.innerHTML = html;
        }

        function deleteClient(clientId) {
            Swal.fire({
                title: 'Tem certeza?',
                text: "Esta ação não pode ser desfeita!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Sim, excluir!',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    // Verificar se o cliente tem serviços ou pacotes
                    const hasServices = allServices.some(service => service.clientId === clientId);
                    const hasPackages = packages.some(pkg => pkg.clientId === clientId);
                    
                    if (hasServices || hasPackages) {
                        showError('Não é possível excluir este cliente porque existem serviços ou pacotes vinculados a ele.');
                        return;
                    }
                    
                    db.collection('clients').doc(clientId).delete()
                        .then(() => {
                            loadClients();
                            showSuccess('Cliente excluído com sucesso!');
                        })
                        .catch(error => {
                            showError('Erro ao excluir cliente: ' + error.message);
                        });
                }
            });
        }

        // Funções para colaboradores
        function showAddCollaboratorModal() {
            document.getElementById('collaboratorModalTitle').textContent = 'Adicionar Colaborador';
            document.getElementById('collaboratorForm').reset();
            document.getElementById('collaboratorId').value = '';
            document.getElementById('collaboratorActive').checked = true;
            
            const preview = document.getElementById('collaboratorPhotoPreview');
            const placeholder = document.getElementById('collaboratorPhotoPlaceholder');
            preview.style.display = 'none';
            placeholder.style.display = 'flex';
            
            new bootstrap.Modal(document.getElementById('collaboratorModal')).show();
        }

        function editCollaborator(collaboratorId) {
            const collaborator = collaborators.find(c => c.id === collaboratorId);
            if (!collaborator) return;
            
            document.getElementById('collaboratorModalTitle').textContent = 'Editar Colaborador';
            document.getElementById('collaboratorId').value = collaborator.id;
            document.getElementById('collaboratorName').value = collaborator.name;
            document.getElementById('collaboratorContact').value = collaborator.contact || '';
            document.getElementById('collaboratorManualPercent').value = collaborator.manualPercent;
            document.getElementById('collaboratorProductPercent').value = collaborator.productPercent;
            document.getElementById('collaboratorBaseSalary').value = collaborator.baseSalary || 0;
            document.getElementById('collaboratorPaymentDay').value = collaborator.paymentDay || 5;
            document.getElementById('collaboratorSpecialty').value = collaborator.specialty || '';
            document.getElementById('collaboratorDescription').value = collaborator.description || '';
            document.getElementById('collaboratorActive').checked = collaborator.active !== false;
            
            const preview = document.getElementById('collaboratorPhotoPreview');
            const placeholder = document.getElementById('collaboratorPhotoPlaceholder');
            if (collaborator.photoUrl) {
                preview.src = collaborator.photoUrl;
                preview.style.display = 'block';
                placeholder.style.display = 'none';
            } else {
                preview.style.display = 'none';
                placeholder.style.display = 'flex';
            }
            
            new bootstrap.Modal(document.getElementById('collaboratorModal')).show();
        }

        function saveCollaborator() {
            const collaboratorId = document.getElementById('collaboratorId').value;
            const name = document.getElementById('collaboratorName').value;
            const contact = document.getElementById('collaboratorContact').value;
            const manualPercent = parseFloat(document.getElementById('collaboratorManualPercent').value);
            const productPercent = parseFloat(document.getElementById('collaboratorProductPercent').value);
            const baseSalary = parseFloat(document.getElementById('collaboratorBaseSalary').value) || 0;
            const paymentDay = parseInt(document.getElementById('collaboratorPaymentDay').value) || 5;
            const specialty = document.getElementById('collaboratorSpecialty').value;
            const description = document.getElementById('collaboratorDescription').value;
            const active = document.getElementById('collaboratorActive').checked;
            
            const collaboratorData = {
                name: name,
                contact: contact,
                manualPercent: manualPercent,
                productPercent: productPercent,
                baseSalary: baseSalary,
                paymentDay: paymentDay,
                specialty: specialty,
                description: description,
                active: active,
                userId: currentUser.uid,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            // Upload da foto se houver
            const photoFile = document.getElementById('collaboratorPhotoUpload').files[0];
            
            let photoUploadPromise = Promise.resolve(null);
            
            if (photoFile) {
                photoUploadPromise = new Promise((resolve, reject) => {
                    const storageRef = storage.ref();
                    const photoRef = storageRef.child(`collaborators/${currentUser.uid}/${collaboratorId || Date.now()}_${photoFile.name}`);
                    
                    photoRef.put(photoFile)
                        .then(snapshot => snapshot.ref.getDownloadURL())
                        .then(url => {
                            collaboratorData.photoUrl = url;
                            resolve(url);
                        })
                        .catch(error => {
                            console.error('Erro no upload da foto:', error);
                            resolve(null); // Continua sem foto
                        });
                });
            }
            
            photoUploadPromise.then(() => {
                let promise;
                
                if (collaboratorId) {
                    promise = db.collection('collaborators').doc(collaboratorId).update(collaboratorData);
                } else {
                    collaboratorData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                    promise = db.collection('collaborators').add(collaboratorData);
                }
                
                showLoading('Salvando colaborador...');
                
                return promise;
            })
            .then(() => {
                bootstrap.Modal.getInstance(document.getElementById('collaboratorModal')).hide();
                loadCollaborators();
                showSuccess(collaboratorId ? 'Colaborador atualizado com sucesso!' : 'Colaborador adicionado com sucesso!');
            })
            .catch(error => {
                console.error('Erro ao salvar colaborador:', error);
                showError('Erro ao salvar colaborador: ' + error.message);
            });
        }

        function deleteCollaborator(collaboratorId) {
            // Verificar se o colaborador tem serviços
            const hasServices = allServices.some(service => service.collaboratorId === collaboratorId);
            
            if (hasServices) {
                showError('Não é possível excluir este colaborador porque existem serviços vinculados a ele.');
                return;
            }
            
            Swal.fire({
                title: 'Tem certeza?',
                text: "Esta ação não pode ser desfeita!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Sim, excluir!',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    db.collection('collaborators').doc(collaboratorId).delete()
                        .then(() => {
                            loadCollaborators();
                            showSuccess('Colaborador excluído com sucesso!');
                        })
                        .catch(error => {
                            showError('Erro ao excluir colaborador: ' + error.message);
                        });
                }
            });
        }

        // Funções para estoque
        function filterInventory() {
            const searchTerm = document.getElementById('inventorySearch').value.toLowerCase();
            const tbody = document.getElementById('inventoryTable');
            
            let filteredProducts = products;
            if (searchTerm) {
                filteredProducts = products.filter(product =>
                    product.name.toLowerCase().includes(searchTerm) ||
                    (product.description && product.description.toLowerCase().includes(searchTerm))
                );
            }
            
            if (filteredProducts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">Nenhum produto encontrado.</td></tr>';
                return;
            }
            
            let html = '';
            filteredProducts.forEach(product => {
                const isLowStock = product.quantity <= product.minQuantity;
                html += `
                    <tr class="${isLowStock ? 'low-stock' : ''}">
                        <td>${product.name}</td>
                        <td>${product.quantity}</td>
                        <td>${product.minQuantity}</td>
                        <td>${formatCurrency(product.purchasePrice)}</td>
                        <td>${formatCurrency(product.salePrice)}</td>
                        <td>
                            <span class="badge ${isLowStock ? 'bg-danger' : 'bg-success'}">
                                ${isLowStock ? 'Estoque Baixo' : 'Normal'}
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-primary me-1" onclick="editProduct('${product.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteProduct('${product.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }

        function toggleLowStockDetails() {
            const details = document.getElementById('lowStockDetails');
            const icon = document.getElementById('lowStockToggleIcon');
            
            details.classList.toggle('active');
            if (details.classList.contains('active')) {
                icon.className = 'fas fa-chevron-up';
            } else {
                icon.className = 'fas fa-chevron-down';
            }
        }

        function refreshTodaySales() {
            loadAllServices();
            loadAllProductSales();
            showSuccess('Vendas atualizadas!');
        }

        function filterTodaySales() {
            const searchTerm = document.getElementById('todaySalesSearch').value.toLowerCase();
            const container = document.getElementById('todaySalesList');
            
            let html = '';
            let totalServicesValue = 0;
            let totalProductsValue = 0;
            let totalForCollaborators = 0;
            let collaboratorBreakdown = {};
            
            // Filtrar serviços
            const filteredServices = todayServices.filter(service => {
                const client = clients.find(c => c.id === service.clientId);
                const collaborator = collaborators.find(c => c.id === service.collaboratorId);
                
                return (client && client.name.toLowerCase().includes(searchTerm)) ||
                       (collaborator && collaborator.name.toLowerCase().includes(searchTerm)) ||
                       (service.description && service.description.toLowerCase().includes(searchTerm));
            });
            
            // Filtrar produtos
            const filteredProducts = todayProductSales.filter(sale => {
                const product = products.find(p => p.id === sale.productId);
                const client = sale.clientId ? clients.find(c => c.id === sale.clientId) : null;
                
                return (product && product.name.toLowerCase().includes(searchTerm)) ||
                       (client && client.name.toLowerCase().includes(searchTerm));
            });
            
            if (filteredServices.length === 0 && filteredProducts.length === 0) {
                container.innerHTML = '<p class="text-muted">Nenhuma venda encontrada.</p>';
                updateSummaryUI(0, 0, 0, {});
                return;
            }
            
            // Serviços filtrados
            filteredServices.forEach(service => {
                const client = clients.find(c => c.id === service.clientId) || { name: 'Cliente não encontrado' };
                const collaborator = collaborators.find(c => c.id === service.collaboratorId) || { name: 'Colaborador não encontrado' };
                
                const serviceValue = parseFloat(service.value);
                totalServicesValue += serviceValue;
                
                let collaboratorPercent = 0;
                if (service.type === 'manual') {
                    collaboratorPercent = parseFloat(collaborator.manualPercent) || 0;
                } else if (service.type === 'product') {
                    collaboratorPercent = parseFloat(collaborator.productPercent) || 0;
                }
                
                const collaboratorValue = serviceValue * (collaboratorPercent / 100);
                totalForCollaborators += collaboratorValue;
                
                if (!collaboratorBreakdown[collaborator.id]) {
                    collaboratorBreakdown[collaborator.id] = {
                        name: collaborator.name,
                        total: 0,
                        toReceive: 0
                    };
                }
                collaboratorBreakdown[collaborator.id].total += serviceValue;
                collaboratorBreakdown[collaborator.id].toReceive += collaboratorValue;
                
                html += `
                    <div class="service-item mb-2">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="mb-1">${service.description}</h6>
                                <p class="mb-1 text-muted small">
                                    Cliente: ${client.name} | 
                                    Colaborador: ${collaborator.name} |
                                    Tipo: ${service.type === 'manual' ? 'Manual' : 'Com Produtos'}
                                </p>
                            </div>
                            <div class="text-end">
                                <strong class="text-success">${formatCurrency(serviceValue)}</strong>
                                <div>
                                    <small class="text-muted">Serviço</small>
                                    <button class="btn btn-sm btn-danger mt-1" onclick="deleteService('${service.id}')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            // Produtos filtrados
            filteredProducts.forEach(sale => {
                const product = products.find(p => p.id === sale.productId) || { name: 'Produto não encontrado' };
                const client = sale.clientId ? clients.find(c => c.id === sale.clientId) : null;
                
                const saleValue = parseFloat(sale.totalValue);
                totalProductsValue += saleValue;
                
                html += `
                    <div class="service-item mb-2">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="mb-1">${product.name}</h6>
                                <p class="mb-1 text-muted small">
                                    ${client ? `Cliente: ${client.name} | ` : ''}
                                    Quantidade: ${sale.quantity}
                                </p>
                            </div>
                            <div class="text-end">
                                <strong class="text-info">${formatCurrency(saleValue)}</strong>
                                <div>
                                    <small class="text-muted">Produto</small>
                                    <button class="btn btn-sm btn-danger mt-1" onclick="deleteProductSale('${sale.id}')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            updateSummaryUI(totalServicesValue, totalProductsValue, totalForCollaborators, collaboratorBreakdown);
        }

        // Ajustar layout da agenda em dispositivos móveis
        window.addEventListener('resize', function() {
            if (currentUser && currentSection === 'agenda') {
                renderAgendaGrid();
            }
        });
    </script>
</body>
</html>

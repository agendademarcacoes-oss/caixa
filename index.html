<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Studio DeVitto - Sistema de Gestão</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Firebase 8 -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    <!-- jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <style>
        /* Todos os estilos CSS anteriores permanecem aqui */
        :root {
            --primary-color: #26196b;
            --secondary-color: #ffd700;
            --accent-color: #4a3a9c;
            --light-bg: #f8f9fa;
        }
        
        /* CORREÇÃO DO ESPAÇO NO TOPO */
html, body {
    margin: 0 !important;
    padding: 0 !important;
    overflow-x: hidden;
}

#mainScreen {
    margin: 0;
    padding: 0;
}

.navbar {
    position: relative;
    top: 0;
    left: 0;
    width: 100%;
    z-index: 1000;
}

.container-fluid {
    padding: 0 !important;
}
        
        body {
            background-color: var(--light-bg);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow-x: hidden;
            height: 100vh;
            position: relative;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        
        .navbar {
            background-color: var(--primary-color);
        }
        
        .sidebar {
            background-color: white;
            min-height: calc(100vh - 56px);
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
        }
        
        .sidebar .nav-link {
            color: #333;
            padding: 12px 20px;
            border-radius: 8px;
            margin-bottom: 5px;
            transition: all 0.3s;
        }
        
        .sidebar .nav-link:hover, .sidebar .nav-link.active {
            background-color: var(--primary-color);
            color: white;
        }
        
        .sidebar .nav-link i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }
        
        .card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            transition: transform 0.3s;
        }
        
        .card:hover {
            transform: translateY(-2px);
        }
        
        .card-header {
            background-color: var(--primary-color);
            color: white;
            border-radius: 12px 12px 0 0 !important;
            font-weight: 600;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .btn-primary:hover {
            background-color: var(--accent-color);
            border-color: var(--accent-color);
        }
        
        .btn-outline-primary {
            color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .btn-outline-primary:hover {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
        }
        
        .table th {
            background-color: var(--primary-color);
            color: white;
        }
        
        .badge-custom {
            background-color: var(--secondary-color);
            color: #000;
        }
        
        .dashboard-card {
            border-left: 4px solid var(--primary-color);
        }
        
        .dashboard-card .card-body {
            padding: 1.5rem;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.25rem rgba(38, 25, 107, 0.25);
        }
        
        .login-container {
            max-width: 400px;
            margin: 100px auto;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            background-color: white;
        }
        
        .login-logo {
            text-align: center;
            margin-bottom: 30px;
            color: var(--primary-color);
        }
        
        .hidden {
            display: none !important;
        }
        
        .service-item {
            border-left: 4px solid var(--primary-color);
            padding-left: 15px;
            margin-bottom: 10px;
            background: white;
            padding: 10px;
            border-radius: 8px;
        }
        
        .stats-number {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .stats-label {
            font-size: 0.9rem;
            color: #6c757d;
        }
        
        .service-row {
            border-bottom: 1px solid #eee;
            padding: 10px 0;
        }
        
        .birthday-item {
            display: flex;
            justify-content: between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .package-completed {
            background-color: #d4edda !important;
            border-color: #c3e6cb !important;
        }
        
        .package-pending {
            background-color: #f8d7da !important;
            border-color: #f5c6cb !important;
        }
        
        .package-finished {
            background-color: #e2e3e5 !important;
            border-color: #d6d8db !important;
            color: #6c757d !important;
        }
        
        .date-status-completed {
            color: #28a745;
            font-weight: bold;
        }
        
        .date-status-pending {
            color: #dc3545;
            font-weight: bold;
        }
        
        .client-card {
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .client-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.1);
        }
        
        .client-card.selected {
            border: 2px solid var(--primary-color);
        }
        
        .client-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            margin: 0 auto 10px;
        }
        
        .low-stock {
            background-color: #f8d7da !important;
            border-color: #f5c6cb !important;
            color: #721c24;
        }
        
        .low-stock-warning {
            color: #dc3545;
            font-weight: bold;
        }
        
        .stock-alert {
            border-left: 4px solid #dc3545 !important;
        }
        
        .mobile-menu {
            display: none;
        }
        
        .floating-menu-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            cursor: pointer;
        }
        
        .mobile-menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 999;
            display: none;
        }
        
        .mobile-menu-content {
            position: fixed;
            top: 0;
            left: 0;
            width: 80%;
            max-width: 300px;
            height: 100%;
            background-color: white;
            z-index: 1000;
            overflow-y: auto;
            transform: translateX(-100%);
            transition: transform 0.3s ease;
        }
        
        .mobile-menu-content.show {
            transform: translateX(0);
        }
        
        .mobile-menu-header {
            padding: 15px;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .mobile-menu-body {
            padding: 0;
        }
        
        .mobile-menu .nav-link {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
        }
        
        .mobile-menu .nav-link i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }
        
        .mobile-back-btn {
            display: none;
        }
        
        .mobile-cards-container {
            display: none;
            padding: 15px;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--light-bg);
            z-index: 1;
            overflow-y: auto;
        }
        
        .mobile-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            border-left: 4px solid var(--primary-color);
            height: 100%;
        }
        
        .mobile-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.1);
        }
        
        .mobile-card i {
            font-size: 2rem;
            color: var(--primary-color);
            margin-bottom: 10px;
        }
        
        .mobile-card h5 {
            color: var(--primary-color);
            margin-bottom: 5px;
            font-size: 0.95rem;
            line-height: 1.2;
        }
        
        .mobile-card p {
            color: #6c757d;
            font-size: 0.8rem;
            margin-bottom: 0;
        }
        
        .floating-back-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: var(--accent-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            cursor: pointer;
            display: none;
        }
        
        .section-container {
            position: relative;
            width: 100%;
            height: 100%;
        }
        
        .section {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow-y: auto;
            background-color: var(--light-bg);
            z-index: 2;
            padding: 15px;
        }
        
        .section.active {
            display: block;
        }
        
        .main-content-container {
            overflow-x: hidden;
        }
        
        .client-record-mobile {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 90%;
            background-color: white;
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            box-shadow: 0 -5px 15px rgba(0,0,0,0.2);
            z-index: 1001;
            transform: translateY(100%);
            transition: transform 0.3s ease-out;
            overflow-y: auto;
            padding: 20px;
        }
        
        .client-record-mobile.active {
            transform: translateY(0);
        }
        
        .client-record-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            display: none;
        }
        
        .client-record-overlay.active {
            display: block;
        }
        
        .client-record-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .client-record-close {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--primary-color);
            cursor: pointer;
        }
        
        .low-stock-alert-compact {
            cursor: pointer;
        }
        
        .low-stock-details {
            display: none;
            margin-top: 10px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 8px;
        }
        
        .low-stock-details.active {
            display: block;
        }
        
        .datetime-display {
            color: white;
            font-size: 0.9rem;
            margin: 0 15px;
        }
        
        .floating-home-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            cursor: pointer;
            transition: all 0.3s ease;
            user-select: none;
        }
        
        .floating-home-btn:hover {
            transform: scale(1.1);
        }
        
        .floating-home-btn.dragging {
            opacity: 0.8;
            transform: scale(1.05);
        }
        
        .logo-upload-container {
            margin: 15px 0;
            text-align: center;
        }
        
        .logo-preview {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--primary-color);
            margin: 10px auto;
            display: none;
        }
        
        .logo-placeholder {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background-color: #f8f9fa;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 10px auto;
            color: var(--primary-color);
            font-size: 24px;
        }
        
        .business-hours-container {
            margin-top: 20px;
        }
        
        .business-hours-day {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .business-hours-day:last-child {
            border-bottom: none;
        }
        
        .business-hours-inputs {
            display: flex;
            gap: 10px;
        }
        
        .business-hours-inputs input {
            width: 100px;
        }
        
        .business-closed {
            background-color: #f8f9fa;
            color: #6c757d;
        }
        
        /* Scroll personalizado */
        .agenda-slots-container::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        .agenda-slots-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        .agenda-slots-container::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }
        
        .agenda-slots-container::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        
        .agenda-professionals::-webkit-scrollbar {
            height: 8px;
        }
        
        .agenda-professionals::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        .agenda-professionals::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }
        
        .agenda-professionals::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        
        /* Estilos para campos de busca dinâmica */
        .autocomplete-container {
            position: relative;
        }
        
        .autocomplete-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            z-index: 1000;
            max-height: 200px;
            overflow-y: auto;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: none;
        }
        
        .autocomplete-list.active {
            display: block;
        }
        
        .autocomplete-item {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid #f1f1f1;
        }
        
        .autocomplete-item:hover {
            background-color: #f8f9fa;
        }
        
        .autocomplete-item.selected {
            background-color: var(--primary-color);
            color: white;
        }
        
        /* Estilos para Dashboard melhorado */
        .dashboard-chart-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            height: 300px;
        }
        
        .products-stats-card {
            border-left: 4px solid #17a2b8;
        }
        
        .products-stats-card .card-body {
            padding: 1.5rem;
        }
        
        /* Estilo para destaque de aniversariante do dia */
        .birthday-today {
            background: linear-gradient(135deg, #fff9e6, #fff3cd) !important;
            border-left: 4px solid #ffd700 !important;
            border: 2px solid #ffd700 !important;
        }
        
        .birthday-today-badge {
            background-color: #ffd700 !important;
            color: #000 !important;
            font-weight: bold;
        }
        
        @media (max-width: 768px) {
            .sidebar {
                display: none;
            }
            
            .mobile-menu {
                display: block;
            }
            
            .mobile-back-btn {
                display: none;
            }
            
            .mobile-cards-container {
                display: block;
            }
            
            .floating-back-btn {
                display: none;
            }
            
            .mobile-card h5 {
                font-size: 0.9rem;
            }
            
            .container-fluid {
                padding: 0;
            }
            
            .col-md-9.col-lg-10.p-4 {
                padding: 0 !important;
                height: calc(100vh - 56px);
                position: relative;
            }
            
            .card-body {
                padding: 1rem;
            }
            
            .stats-number {
                font-size: 1.5rem;
            }
            
            .client-record-desktop {
                display: none;
            }
            
            .datetime-display {
                display: none;
            }
            
            .floating-mobile-btn {
                display: flex;
            }
            
            .agenda-mobile-view {
                display: block !important;
            }
            
            .agenda-container {
                height: auto;
                min-height: calc(100vh - 120px);
                box-shadow: none;
                border-radius: 0;
            }
            
            .agenda-mobile-day {
                margin-bottom: 10px;
                border-radius: 0;
                box-shadow: none;
                border-bottom: 1px solid #eee;
            }
            
            .agenda-mobile-day-header {
                border-radius: 0;
            }
            
            .agenda-mobile-appointment {
                flex-direction: column;
                align-items: flex-start;
                padding: 10px;
            }
            
            .agenda-mobile-appointment-time {
                margin-bottom: 5px;
                width: 100%;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            
            .agenda-mobile-appointment-details {
                margin-left: 0;
                width: 100%;
            }
            
            .agenda-mobile-add-btn {
                bottom: 90px;
                right: 20px;
            }
            
            .dashboard-chart-container {
                height: 250px;
            }
        }
        
        @media (min-width: 769px) {
            .mobile-cards-container {
                display: none !important;
            }
            
            .floating-back-btn {
                display: none !important;
            }
            
            .section {
                display: block;
                position: static;
                height: auto;
                overflow: visible;
            }
            
            .client-record-mobile {
                display: none;
            }
            
            .client-record-desktop {
                display: block;
            }
            
            .floating-mobile-btn {
                display: none !important;
            }
            
            .agenda-mobile-view {
                display: none !important;
            }
        }

        /* Estilos para Controle Financeiro */
        .finance-card {
            border-left: 4px solid #28a745;
        }
        
        .finance-card.negative {
            border-left: 4px solid #dc3545;
        }
        
        .expense-item {
            border-left: 4px solid #dc3545;
            padding-left: 15px;
            margin-bottom: 10px;
            background: white;
            padding: 10px;
            border-radius: 8px;
        }
        
        .salary-item {
            border-left: 4px solid #ffc107;
            padding-left: 15px;
            margin-bottom: 10px;
            background: white;
            padding: 10px;
            border-radius: 8px;
        }
        
        .financial-summary {
            background: linear-gradient(135deg, #26196b, #4a3a9c);
            color: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .financial-summary h3 {
            color: white;
            margin-bottom: 20px;
        }
        
        .summary-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
        }
        
        .summary-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: white;
        }
        
        .summary-label {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.8);
        }
        
        .positive-value {
            color: #28a745;
        }
        
        .negative-value {
            color: #dc3545;
        }
        
        .status-paid {
            background-color: #d4edda;
            color: #155724;
            padding: 3px 10px;
            border-radius: 4px;
            font-size: 0.8rem;
        }
        
        .status-pending {
            background-color: #fff3cd;
            color: #856404;
            padding: 3px 10px;
            border-radius: 4px;
            font-size: 0.8rem;
        }
        
        .status-overdue {
            background-color: #f8d7da;
            color: #721c24;
            padding: 3px 10px;
            border-radius: 4px;
            font-size: 0.8rem;
        }
        
        .chart-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .month-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            align-items: center;
        }
        
        .month-selector select {
            flex: 1;
        }
        
        .due-soon {
            background-color: #fff3cd !important;
            border-color: #ffeaa7 !important;
        }
        
        .overdue {
            background-color: #f8d7da !important;
            border-color: #f5c6cb !important;
        }
        
        .paid {
            background-color: #d4edda !important;
            border-color: #c3e6cb !important;
        }
        
        /* Melhorias para resumo financeiro */
        .cash-status {
            font-size: 1.8rem;
            font-weight: bold;
            margin-top: 10px;
        }
        
        .cash-status.positive {
            color: #28a745;
        }
        
        .cash-status.negative {
            color: #dc3545;
        }
        
        .final-cash-display {
            font-size: 2rem;
            font-weight: bold;
            margin: 15px 0;
            text-align: center;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            border: 2px dashed rgba(255, 255, 255, 0.3);
        }
        
        .calculation-steps {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }
        
        .calculation-step {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px dashed rgba(255, 255, 255, 0.1);
        }
        
        .calculation-step:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        
        .calculation-step.total {
            font-weight: bold;
            font-size: 1.1rem;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 2px solid rgba(255, 255, 255, 0.3);
        }
        
        /* NOVOS ESTILOS PARA CONTROLE FINANCEIRO SEPARADO */
        .financial-cash-box {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }
        
        .financial-cash-box.services {
            border-color: #28a745;
        }
        
        .financial-cash-box.products {
            border-color: #17a2b8;
        }
        
        .cash-box-title {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 10px;
            color: white;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .cash-box-title i {
            font-size: 1.5rem;
        }
        
        .cash-box-values {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .cash-box-value {
            text-align: center;
            padding: 10px;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 6px;
        }
        
        .cash-box-label {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 5px;
        }
        
        .cash-box-amount {
            font-size: 1.2rem;
            font-weight: bold;
        }
        
        .expense-recurring-icon {
            color: #ffc107;
            margin-left: 5px;
            font-size: 0.9rem;
        }
        
        .recurring-expense-note {
            font-size: 0.8rem;
            color: #ffc107;
            font-style: italic;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <!-- Tela de Login -->
    <div id="loginScreen" class="container">
        <div class="login-container">
            <div class="login-logo">
                <h2><i class="fas fa-scissors"></i> Studio DeVitto</h2>
                <p class="text-muted">Sistema de Gestão</p>
            </div>
            
            <!-- Formulário de Login -->
            <div id="loginFormContainer">
                <form id="loginForm">
                    <div class="mb-3">
                        <label for="loginEmail" class="form-label">E-mail</label>
                        <input type="email" class="form-control" id="loginEmail" required>
                    </div>
                    <div class="mb-3">
                        <label for="loginPassword" class="form-label">Senha</label>
                        <input type="password" class="form-control" id="loginPassword" required>
                    </div>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary">Entrar</button>
                    </div>
                </form>
                <div class="text-center mt-3">
                    <a href="#" id="showRegister">Não tem conta? Cadastre-se</a>
                </div>
            </div>
            
            <!-- Formulário de Registro -->
            <div id="registerFormContainer" class="hidden">
                <form id="registerForm">
                    <div class="mb-3">
                        <label for="registerName" class="form-label">Seu Nome</label>
                        <input type="text" class="form-control" id="registerName" required>
                    </div>
                    <div class="mb-3">
                        <label for="registerEmail" class="form-label">E-mail</label>
                        <input type="email" class="form-control" id="registerEmail" required>
                    </div>
                    <div class="mb-3">
                        <label for="registerPassword" class="form-label">Senha</label>
                        <input type="password" class="form-control" id="registerPassword" required minlength="6">
                    </div>
                    <div class="mb-3">
                        <label for="registerConfirmPassword" class="form-label">Confirmar Senha</label>
                        <input type="password" class="form-control" id="registerConfirmPassword" required>
                    </div>
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary">Cadastrar</button>
                        <button type="button" class="btn btn-secondary" id="showLogin">Voltar para Login</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Tela Principal (após login) -->
    <div id="mainScreen" class="hidden">
        <!-- Navbar -->
        <nav class="navbar navbar-expand-lg navbar-dark">
            <div class="container-fluid">
                <a class="navbar-brand" href="#" id="businessLogo">
                    <i class="fas fa-scissors me-2" id="businessLogoIcon"></i><span id="businessName">Studio DeVitto</span>
                </a>
                
                <!-- Data e Hora -->
                <div class="datetime-display">
                    <span id="currentDateTime"></span>
                </div>
                
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav ms-auto">
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown">
                                <i class="fas fa-user-circle me-1"></i> <span id="userName">Usuário</span>
                            </a>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#" id="changeBusinessSettings"><i class="fas fa-cog me-2"></i>Configurar Estabelecimento</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="#" id="logoutBtn"><i class="fas fa-sign-out-alt me-2"></i>Sair</a></li>
                            </ul>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>

        <div class="container-fluid">
            <div class="row">
                <!-- Sidebar -->
<div class="col-md-3 col-lg-2 sidebar p-0">
    <nav class="nav flex-column p-3">
        <a class="nav-link active" href="#" data-section="dashboard">
            <i class="fas fa-tachometer-alt"></i> Dashboard
        </a>
        <a class="nav-link" href="#" data-section="cashier">
            <i class="fas fa-cash-register"></i> Caixa
        </a>
        <a class="nav-link" href="#" data-section="inventory">
            <i class="fas fa-boxes"></i> Estoque
        </a>
        <a class="nav-link" href="#" data-section="clients">
            <i class="fas fa-users"></i> Clientes
        </a>
        <a class="nav-link" href="#" data-section="client-records">
            <i class="fas fa-address-book"></i> Registros de Clientes
        </a>
        <a class="nav-link" href="#" data-section="collaborators">
            <i class="fas fa-user-friends"></i> Colaboradores
        </a>
        <a class="nav-link" href="#" data-section="packages">
            <i class="fas fa-box"></i> Pacotes
        </a>
        <a class="nav-link" href="#" data-section="financial-control">
            <i class="fas fa-chart-line"></i> Controle Financeiro
        </a>
        <a class="nav-link" href="#" data-section="business-profile">
            <i class="fas fa-building"></i> Perfil da Empresa
        </a>
        <a class="nav-link" href="#" data-section="reports">
            <i class="fas fa-chart-bar"></i> Relatórios
        </a>
        <a class="nav-link" href="#" data-section="birthdays">
            <i class="fas fa-birthday-cake"></i> Aniversários
        </a>
    </nav>
</div>

                <!-- Conteúdo Principal -->
                <div class="col-md-9 col-lg-10 p-4 main-content-container">
                    <!-- Container para conteúdo mobile -->
                    <div class="section-container">
                        <!-- Menu de Cards para Mobile -->
                        <div id="mobileCards" class="mobile-cards-container active">
                            <div class="row">
                                <div class="col-6">
                                    <div class="mobile-card" data-section="dashboard">
                                        <i class="fas fa-tachometer-alt"></i>
                                        <h5>Dashboard</h5>
                                        <p>Visão geral</p>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="mobile-card" data-section="cashier">
                                        <i class="fas fa-cash-register"></i>
                                        <h5>Caixa</h5>
                                        <p>Controle de vendas</p>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="mobile-card" data-section="inventory">
                                        <i class="fas fa-boxes"></i>
                                        <h5>Estoque</h5>
                                        <p>Gerenciar produtos</p>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="mobile-card" data-section="clients">
                                        <i class="fas fa-users"></i>
                                        <h5>Clientes</h5>
                                        <p>Cadastro</p>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="mobile-card" data-section="client-records">
                                        <i class="fas fa-address-book"></i>
                                        <h5>Registros</h5>
                                        <p>Fichas</p>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="mobile-card" data-section="collaborators">
                                        <i class="fas fa-user-friends"></i>
                                        <h5>Colabor.</h5>
                                        <p>Equipe</p>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="mobile-card" data-section="packages">
                                        <i class="fas fa-box"></i>
                                        <h5>Pacotes</h5>
                                        <p>Serviços</p>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="mobile-card" data-section="financial-control">
                                        <i class="fas fa-chart-line"></i>
                                        <h5>Financeiro</h5>
                                        <p>Controle</p>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="mobile-card" data-section="business-profile">
                                        <i class="fas fa-building"></i>
                                        <h5>Empresa</h5>
                                        <p>Perfil</p>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="mobile-card" data-section="reports">
                                        <i class="fas fa-chart-bar"></i>
                                        <h5>Relatórios</h5>
                                        <p>Sistema</p>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="mobile-card" data-section="birthdays">
                                        <i class="fas fa-birthday-cake"></i>
                                        <h5>Anivers.</h5>
                                        <p>Aniversariantes</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Dashboard -->
                        <div id="dashboard" class="section">
                            <h2 class="mb-4">Dashboard</h2>
                            <div class="row">
                                <div class="col-md-3 mb-4">
                                    <div class="card dashboard-card">
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <h5 class="card-title">Caixa Atual</h5>
                                                    <h3 class="stats-number" id="currentCash">€ 0,00</h3>
                                                </div>
                                                <i class="fas fa-cash-register fa-2x text-primary"></i>
                                            </div>
                                            <div class="mt-3">
                                                <button class="btn btn-sm btn-outline-primary w-100" id="openCashierBtn">Abrir Caixa</button>
                                                <button class="btn btn-sm btn-outline-primary w-100 mt-2" id="closeCashierBtn" disabled>Fechar Caixa</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3 mb-4">
                                    <div class="card dashboard-card">
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <h5 class="card-title">Vendas Hoje</h5>
                                                    <h3 class="stats-number text-success" id="todaySales">€ 0,00</h3>
                                                    <p class="stats-label" id="todayServices">0 serviços</p>
                                                </div>
                                                <i class="fas fa-calendar-day fa-2x text-success"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3 mb-4">
                                    <div class="card dashboard-card">
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <h5 class="card-title">Produtos Hoje</h5>
                                                    <h3 class="stats-number text-info" id="todayProducts">€ 0,00</h3>
                                                    <p class="stats-label" id="todayProductsCount">0 produtos</p>
                                                </div>
                                                <i class="fas fa-shopping-bag fa-2x text-info"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3 mb-4">
                                    <div class="card dashboard-card">
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <h5 class="card-title">Vendas Semana</h5>
                                                    <h3 class="stats-number text-warning" id="weekSales">€ 0,00</h3>
                                                    <p class="stats-label" id="weekServices">0 serviços</p>
                                                </div>
                                                <i class="fas fa-calendar-week fa-2x text-warning"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-3 mb-4">
                                    <div class="card dashboard-card">
                                        <div class="card-body text-center">
                                            <h5 class="card-title">Vendas Mês</h5>
                                            <h3 class="stats-number text-warning" id="monthSales">€ 0,00</h3>
                                            <p class="stats-label" id="monthServices">0 serviços</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3 mb-4">
                                    <div class="card dashboard-card">
                                        <div class="card-body text-center">
                                            <h5 class="card-title">Aniversários</h5>
                                            <h3 class="stats-number text-danger" id="upcomingBirthdays">0</h3>
                                            <p class="stats-label">Próximos 7 dias</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3 mb-4">
                                    <div class="card dashboard-card">
                                        <div class="card-body text-center">
                                            <h5 class="card-title">Colaboradores</h5>
                                            <h3 class="stats-number text-primary" id="totalCollaborators">0</h3>
                                            <p class="stats-label">Ativos</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3 mb-4">
                                    <div class="card dashboard-card">
                                        <div class="card-body text-center">
                                            <h5 class="card-title">Clientes</h5>
                                            <h3 class="stats-number text-success" id="totalClients">0</h3>
                                            <p class="stats-label">Cadastrados</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- NOVO: Seção de Produtos Vendidos -->
                            <div class="row">
                                <div class="col-md-6 mb-4">
                                    <div class="card products-stats-card">
                                        <div class="card-header">
                                            <h5 class="mb-0">Produtos Vendidos (Mês)</h5>
                                        </div>
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-6 text-center">
                                                    <h3 class="stats-number text-info" id="monthProductsCount">0</h3>
                                                    <p class="stats-label">Quantidade Total</p>
                                                </div>
                                                <div class="col-6 text-center">
                                                    <h3 class="stats-number text-success" id="monthProductsValue">€ 0,00</h3>
                                                    <p class="stats-label">Valor Total</p>
                                                </div>
                                            </div>
                                            <div class="mt-3">
                                                <small class="text-muted">*Apenas produtos vendidos este mês</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-4">
                                    <div class="card products-stats-card">
                                        <div class="card-header">
                                            <h5 class="mb-0">Produtos Vendidos (Total)</h5>
                                        </div>
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-6 text-center">
                                                    <h3 class="stats-number text-info" id="totalProductsSoldCount">0</h3>
                                                    <p class="stats-label">Quantidade Total</p>
                                                </div>
                                                <div class="col-6 text-center">
                                                    <h3 class="stats-number text-success" id="totalProductsSoldValue">€ 0,00</h3>
                                                    <p class="stats-label">Valor Total</p>
                                                </div>
                                            </div>
                                            <div class="mt-3">
                                                <small class="text-muted">*Todos os produtos vendidos</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- NOVO: Gráfico de Vendas Mensais -->
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="dashboard-chart-container">
                                        <h5>Vendas Mensais - Serviços vs Produtos</h5>
                                        <canvas id="monthlySalesChart"></canvas>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Alertas de Estoque Baixo -->
                            <div class="row" id="lowStockAlertsContainer" style="display: none;">
                                <div class="col-12">
                                    <div class="card stock-alert low-stock-alert-compact" id="lowStockAlertCard">
                                        <div class="card-header bg-danger text-white d-flex justify-content-between align-items-center">
                                            <h5 class="mb-0"><i class="fas fa-exclamation-triangle me-2"></i>Produtos com Estoque Baixo</h5>
                                            <i class="fas fa-chevron-down" id="lowStockToggleIcon"></i>
                                        </div>
                                        <div class="card-body">
                                            <div id="lowStockAlerts">
                                                <!-- Alertas serão preenchidos dinamicamente -->
                                            </div>
                                            <div class="low-stock-details" id="lowStockDetails">
                                                <!-- Detalhes dos produtos com estoque baixo -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <h5 class="mb-0">Serviços Recentes</h5>
                                        </div>
                                        <div class="card-body">
                                            <div id="recentServicesList">
                                                <p class="text-muted">Nenhum serviço hoje.</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <h5 class="mb-0">Próximos Aniversários</h5>
                                        </div>
                                        <div class="card-body">
                                            <div id="upcomingBirthdaysList">
                                                <p class="text-muted">Nenhum aniversário próximo.</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Caixa -->
                        <div id="cashier" class="section">
                            <h2 class="mb-4">Caixa</h2>
                            <div class="row">
                                <div class="col-md-8">
                                    <div class="card">
                                        <div class="card-header d-flex justify-content-between align-items-center">
                                            <h5 class="mb-0">Nova Venda</h5>
                                            <span class="badge bg-danger" id="cashierStatus">Fechado</span>
                                        </div>
                                        <div class="card-body">
                                            <ul class="nav nav-tabs" id="saleTypeTabs" role="tablist">
                                                <li class="nav-item" role="presentation">
                                                    <button class="nav-link active" id="service-tab" data-bs-toggle="tab" data-bs-target="#service" type="button" role="tab">Serviço</button>
                                                </li>
                                                <li class="nav-item" role="presentation">
                                                    <button class="nav-link" id="product-tab" data-bs-toggle="tab" data-bs-target="#product" type="button" role="tab">Produto</button>
                                                </li>
                                            </ul>
                                            <div class="tab-content mt-3">
                                                <!-- Aba de Serviços -->
                                                <div class="tab-pane fade show active" id="service" role="tabpanel">
                                                    <form id="serviceForm">
                                                        <div class="row">
                                                            <div class="col-md-6 mb-3">
                                                                <label for="clientSelect" class="form-label">Cliente</label>
                                                                <div class="autocomplete-container">
                                                                    <input type="text" class="form-control" id="clientSelect" placeholder="Digite para buscar cliente..." required disabled>
                                                                    <div class="autocomplete-list" id="clientAutocompleteList"></div>
                                                                </div>
                                                                <input type="hidden" id="selectedClientId">
                                                                <div class="form-text">
                                                                    <a href="#" id="addNewClientLink">Adicionar novo cliente</a>
                                                                </div>
                                                            </div>
                                                            <div class="col-md-6 mb-3">
                                                                <label for="collaboratorSelect" class="form-label">Colaborador</label>
                                                                <select class="form-select" id="collaboratorSelect" required disabled>
                                                                    <option value="">Selecione um colaborador</option>
                                                                </select>
                                                            </div>
                                                        </div>
                                                        <div class="row">
                                                            <div class="col-md-6 mb-3">
                                                                <label for="serviceType" class="form-label">Tipo de Serviço</label>
                                                                <select class="form-select" id="serviceType" required disabled>
                                                                    <option value="">Selecione o tipo</option>
                                                                    <option value="manual">Manual (Corte, Brushing, etc.)</option>
                                                                    <option value="product">Com Produtos (Madeixas, Coloração, etc.)</option>
                                                                </select>
                                                            </div>
                                                            <div class="col-md-6 mb-3">
                                                                <label for="serviceValue" class="form-label">Valor do Serviço (€)</label>
                                                                <input type="number" class="form-control" id="serviceValue" step="0.01" min="0" required disabled>
                                                            </div>
                                                        </div>
                                                        <div class="mb-3">
                                                            <label for="serviceDescription" class="form-label">Descrição do Serviço</label>
                                                            <textarea class="form-control" id="serviceDescription" rows="2" disabled></textarea>
                                                        </div>
                                                        <div class="d-grid gap-2">
                                                            <button type="submit" class="btn btn-primary" id="addServiceBtn" disabled>Adicionar Serviço</button>
                                                            <button type="button" class="btn btn-outline-primary" id="addAnotherServiceBtn" disabled>Adicionar Outro Serviço</button>
                                                        </div>
                                                    </form>
                                                </div>
                                                
                                                <!-- Aba de Produtos -->
                                                <div class="tab-pane fade" id="product" role="tabpanel">
                                                    <form id="productSaleForm">
                                                        <div class="row">
                                                            <div class="col-md-6 mb-3">
                                                                <label for="productSaleSelect" class="form-label">Produto</label>
                                                                <div class="autocomplete-container">
                                                                    <input type="text" class="form-control" id="productSaleSelect" placeholder="Digite para buscar produto..." required disabled>
                                                                    <div class="autocomplete-list" id="productAutocompleteList"></div>
                                                                </div>
                                                                <input type="hidden" id="selectedProductId">
                                                            </div>
                                                            <div class="col-md-6 mb-3">
                                                                <label for="productSaleQuantity" class="form-label">Quantidade</label>
                                                                <input type="number" class="form-control" id="productSaleQuantity" min="1" required disabled>
                                                            </div>
                                                        </div>
                                                        <div class="mb-3">
                                                            <label for="productSaleClient" class="form-label">Cliente (Opcional)</label>
                                                            <div class="autocomplete-container">
                                                                <input type="text" class="form-control" id="productSaleClient" placeholder="Digite para buscar cliente..." disabled>
                                                                <div class="autocomplete-list" id="productClientAutocompleteList"></div>
                                                            </div>
                                                            <input type="hidden" id="selectedProductClientId">
                                                        </div>
                                                        <div class="d-grid gap-2">
                                                            <button type="submit" class="btn btn-primary" id="addProductSaleBtn" disabled>Adicionar Venda de Produto</button>
                                                        </div>
                                                    </form>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="card mt-4">
                                        <div class="card-header d-flex justify-content-between align-items-center">
                                            <h5 class="mb-0">Vendas do Dia</h5>
                                            <button class="btn btn-sm btn-primary" id="refreshTodaySales">
                                                <i class="fas fa-sync-alt me-1"></i> Atualizar
                                            </button>
                                        </div>
                                        <div class="card-body">
                                            <div class="mb-3">
                                                <input type="text" class="form-control" id="todaySalesSearch" placeholder="Buscar por cliente, colaborador ou produto...">
                                            </div>
                                            <div id="todaySalesList">
                                                <p class="text-muted">Nenhuma venda registrada hoje.</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card">
                                        <div class="card-header">
                                            <h5 class="mb-0">Resumo do Dia</h5>
                                        </div>
                                        <div class="card-body">
                                            <div class="mb-3">
                                                <strong>Total de Serviços:</strong> <span id="totalServicesCount">0</span>
                                            </div>
                                            <div class="mb-3">
                                                <strong>Valor Serviços:</strong> <span id="totalServicesValue">€ 0,00</span>
                                            </div>
                                            <div class="mb-3">
                                                <strong>Total de Produtos:</strong> <span id="totalProductsCount">0</span>
                                            </div>
                                            <div class="mb-3">
                                                <strong>Valor Produtos:</strong> <span id="totalProductsValue">€ 0,00</span>
                                            </div>
                                            <div class="mb-3">
                                                <strong>Valor Total:</strong> <span id="totalSalesValue">€ 0,00</span>
                                            </div>
                                            <div class="mb-3">
                                                <strong>Valor para Colaboradores:</strong> <span id="totalCollaboratorsValue">€ 0,00</span>
                                            </div>
                                            <div class="mb-3">
                                                <strong>Valor para o Caixa:</strong> <span id="totalCashierValue">€ 0,00</span>
                                            </div>
                                            <hr>
                                            <div id="collaboratorBreakdown">
                                                <p class="text-muted">Nenhum serviço registrado.</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Estoque -->
                        <div id="inventory" class="section">
                            <h2 class="mb-4">Estoque</h2>
                            <div class="row">
                                <div class="col-md-8">
                                    <div class="card">
                                        <div class="card-header d-flex justify-content-between align-items-center">
                                            <h5 class="mb-0">Produtos em Estoque</h5>
                                            <div>
                                                <input type="text" class="form-control me-2 d-inline-block" id="inventorySearch" placeholder="Buscar produto..." style="width: 200px;">
                                                <button class="btn btn-primary" id="addProductBtn">
                                                    <i class="fas fa-plus me-1"></i> Adicionar Produto
                                                </button>
                                            </div>
                                        </div>
                                        <div class="card-body">
                                            <div class="table-responsive">
                                                <table class="table table-hover">
                                                    <thead>
                                                        <tr>
                                                            <th>Produto</th>
                                                            <th>Quantidade</th>
                                                            <th>Mínimo</th>
                                                            <th>Valor Compra</th>
                                                            <th>Valor Venda</th>
                                                            <th>Status</th>
                                                            <th>Ações</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="inventoryTable">
                                                        <tr>
                                                            <td colspan="7" class="text-center text-muted">Nenhum produto cadastrado.</td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card">
                                        <div class="card-header">
                                            <h5 class="mb-0">Resumo do Estoque</h5>
                                        </div>
                                        <div class="card-body">
                                            <div class="mb-3">
                                                <strong>Total de Produtos:</strong> <span id="totalProducts">0</span>
                                            </div>
                                            <div class="mb-3">
                                                <strong>Produtos com Estoque Baixo:</strong> <span id="lowStockProducts" class="low-stock-warning">0</span>
                                            </div>
                                            <div class="mb-3">
                                                <strong>Valor Total em Estoque:</strong> <span id="totalInventoryValue">€ 0,00</span>
                                            </div>
                                            <div class="mb-3">
                                                <strong>Investimento Total:</strong> <span id="totalInvestment">€ 0,00</span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="card mt-4">
                                        <div class="card-header">
                                            <h5 class="mb-0">Alertas de Estoque Baixo</h5>
                                        </div>
                                        <div class="card-body">
                                            <div id="inventoryAlerts">
                                                <p class="text-muted">Nenhum alerta no momento.</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Clientes -->
                        <div id="clients" class="section">
                            <h2 class="mb-4">Clientes</h2>
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0">Lista de Clientes</h5>
                                    <button class="btn btn-primary" id="addClientBtn">
                                        <i class="fas fa-plus me-1"></i> Adicionar Cliente
                                    </button>
                                </div>
                                <div class="card-body">
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <input type="text" class="form-control" id="clientSearch" placeholder="Buscar cliente...">
                                        </div>
                                    </div>
                                    <div class="table-responsive">
                                        <table class="table table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Nome</th>
                                                    <th>Data Nasc.</th>
                                                    <th>Contato</th>
                                                    <th>E-mail</th>
                                                    <th>Ações</th>
                                                </tr>
                                            </thead>
                                            <tbody id="clientsTable">
                                                <tr>
                                                    <td colspan="5" class="text-center text-muted">Nenhum cliente cadastrado.</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Registros de Clientes -->
                        <div id="client-records" class="section">
                            <h2 class="mb-4">Registros de Clientes</h2>
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="card">
                                        <div class="card-header">
                                            <h5 class="mb-0">Lista de Clientes</h5>
                                        </div>
                                        <div class="card-body">
                                            <div class="mb-3">
                                                <input type="text" class="form-control" id="clientRecordsSearch" placeholder="Buscar cliente...">
                                            </div>
                                            <div id="clientCardsList" class="d-flex flex-column gap-2" style="max-height: 600px; overflow-y: auto;">
                                                <p class="text-muted text-center">Nenhum cliente cadastrado.</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-8 client-record-desktop">
                                    <div class="card">
                                        <div class="card-header">
                                            <h5 class="mb-0" id="clientRecordTitle">Ficha do Cliente</h5>
                                        </div>
                                        <div class="card-body">
                                            <div id="clientRecordContent" class="text-center text-muted">
                                                <p>Selecione um cliente para visualizar sua ficha completa</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Ficha do cliente para dispositivos móveis -->
                            <div class="client-record-overlay" id="clientRecordOverlay"></div>
                            <div class="client-record-mobile" id="clientRecordMobile">
                                <div class="client-record-header">
                                    <h5 id="clientRecordMobileTitle">Ficha do Cliente</h5>
                                    <button class="client-record-close" id="clientRecordClose">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                                <div id="clientRecordMobileContent">
                                    <!-- Conteúdo será preenchido dinamicamente -->
                                </div>
                            </div>
                        </div>

                        <!-- Colaboradores -->
                        <div id="collaborators" class="section">
                            <h2 class="mb-4">Colaboradores</h2>
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0">Lista de Colaboradores</h5>
                                    <button class="btn btn-primary" id="addCollaboratorBtn">
                                        <i class="fas fa-plus me-1"></i> Adicionar Colaborador
                                    </button>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Foto</th>
                                                    <th>Nome</th>
                                                    <th>Especialidade</th>
                                                    <th>Contato</th>
                                                    <th>% Manual</th>
                                                    <th>% Produtos</th>
                                                    <th>Salário Base</th>
                                                    <th>Status</th>
                                                    <th>Ações</th>
                                                </tr>
                                            </thead>
                                            <tbody id="collaboratorsTable">
                                                <tr>
                                                    <td colspan="9" class="text-center text-muted">Nenhum colaborador cadastrado.</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Pacotes -->
                        <div id="packages" class="section">
                            <h2 class="mb-4">Pacotes</h2>
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="card">
                                        <div class="card-header">
                                            <h5 class="mb-0">Resumo de Pacotes</h5>
                                        </div>
                                        <div class="card-body">
                                            <div class="mb-3">
                                                <strong>Total de Pacotes Ativos:</strong> <span id="totalActivePackages">0</span>
                                            </div>
                                            <div class="mb-3">
                                                <strong>Valor Total em Pacotes:</strong> <span id="totalPackagesValue">€ 0,00</span>
                                            </div>
                                            <div class="mb-3">
                                                <strong>Próximos Procedimentos:</strong> <span id="nextProceduresCount">0</span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="card mt-4">
                                        <div class="card-header">
                                            <h5 class="mb-0">Adicionar/Editar Pacote</h5>
                                        </div>
                                        <div class="card-body">
                                            <form id="packageForm">
                                                <input type="hidden" id="packageId">
                                                <div class="mb-3">
                                                    <label for="packageClientSelect" class="form-label">Cliente</label>
                                                    <select class="form-select" id="packageClientSelect" required>
                                                        <option value="">Selecione um cliente</option>
                                                    </select>
                                                </div>
                                                <div class="mb-3">
                                                    <label for="packageProcedures" class="form-label">Quantidade de Procedimentos</label>
                                                    <input type="number" class="form-control" id="packageProcedures" min="1" max="52" required>
                                                </div>
                                                <div class="mb-3">
                                                    <label for="packageFrequency" class="form-label">Frequência por Semana</label>
                                                    <select class="form-select" id="packageFrequency" required>
                                                        <option value="1">1 vez por semana</option>
                                                        <option value="2">2 vezes por semana</option>
                                                        <option value="3">3 vezes por semana</option>
                                                        <option value="4">4 vezes por semana</option>
                                                        <option value="5">5 vezes por semana</option>
                                                        <option value="6">6 vezes por semana</option>
                                                        <option value="7">7 vezes por semana</option>
                                                    </select>
                                                </div>
                                                <div id="daysSelection" style="display: none;">
                                                    <div class="mb-3">
                                                        <label class="form-label">Selecionar Dias da Semana</label>
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="checkbox" id="mondayCheck">
                                                            <label class="form-check-label" for="mondayCheck">Segunda-feira</label>
                                                        </div>
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="checkbox" id="tuesdayCheck">
                                                            <label class="form-check-label" for="tuesdayCheck">Terça-feira</label>
                                                        </div>
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="checkbox" id="wednesdayCheck">
                                                            <label class="form-check-label" for="wednesdayCheck">Quarta-feira</label>
                                                        </div>
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="checkbox" id="thursdayCheck">
                                                            <label class="form-check-label" for="thursdayCheck">Quinta-feira</label>
                                                        </div>
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="checkbox" id="fridayCheck">
                                                            <label class="form-check-label" for="fridayCheck">Sexta-feira</label>
                                                        </div>
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="checkbox" id="saturdayCheck">
                                                            <label class="form-check-label" for="saturdayCheck">Sábado</label>
                                                        </div>
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="checkbox" id="sundayCheck">
                                                            <label class="form-check-label" for="sundayCheck">Domingo</label>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="mb-3">
                                                    <label for="packageStartDate" class="form-label">Data do Primeiro Procedimento</label>
                                                    <input type="date" class="form-control" id="packageStartDate" required>
                                                </div>
                                                <div class="mb-3">
                                                    <label for="packageValue" class="form-label">Valor do Pacote (€)</label>
                                                    <input type="number" class="form-control" id="packageValue" step="0.01" min="0" required>
                                                </div>
                                                <div class="mb-3">
                                                    <label for="packageDescription" class="form-label">Descrição do Pacote</label>
                                                    <textarea class="form-control" id="packageDescription" rows="2"></textarea>
                                                </div>
                                                <div class="d-grid gap-2">
                                                    <button type="submit" class="btn btn-primary" id="savePackageBtn">Criar Pacote</button>
                                                    <button type="button" class="btn btn-secondary" id="cancelPackageEditBtn" style="display: none;">Cancelar Edição</button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-8">
                                    <div class="card">
                                        <div class="card-header d-flex justify-content-between align-items-center">
                                            <h5 class="mb-0">Pacotes Ativos</h5>
                                        </div>
                                        <div class="card-body">
                                            <div id="packagesList">
                                                <p class="text-muted">Nenhum pacote ativo.</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Controle Financeiro -->
                        <div id="financial-control" class="section">
                            <h2 class="mb-4">Controle Financeiro</h2>
                            
                            <!-- Resumo Financeiro MELHORADO COM DOIS CAIXAS SEPARADOS -->
                            <div class="financial-summary">
                                <h3>Resumo Financeiro - Mês Atual</h3>
                                
                                <!-- CAIXA DE SERVIÇOS PRESTADOS -->
                                <div class="financial-cash-box services">
                                    <div class="cash-box-title">
                                        <i class="fas fa-scissors"></i> Caixa de Serviços Prestados
                                    </div>
                                    <div class="cash-box-values">
                                        <div class="cash-box-value">
                                            <div class="cash-box-label">Receita Serviços</div>
                                            <div class="cash-box-amount positive-value" id="servicesRevenue">€ 0,00</div>
                                        </div>
                                        <div class="cash-box-value">
                                            <div class="cash-box-label">Despesas Pagas</div>
                                            <div class="cash-box-amount negative-value" id="servicesExpenses">€ 0,00</div>
                                        </div>
                                        <div class="cash-box-value">
                                            <div class="cash-box-label">Despesas Pendentes</div>
                                            <div class="cash-box-amount negative-value" id="servicesPendingExpenses">€ 0,00</div>
                                        </div>
                                        <div class="cash-box-value">
                                            <div class="cash-box-label">Saldo Final Serviços</div>
                                            <div class="cash-box-amount" id="servicesFinalCash">€ 0,00</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- CAIXA DE PRODUTOS VENDIDOS -->
                                <div class="financial-cash-box products">
                                    <div class="cash-box-title">
                                        <i class="fas fa-shopping-bag"></i> Caixa de Produtos Vendidos
                                    </div>
                                    <div class="cash-box-values">
                                        <div class="cash-box-value">
                                            <div class="cash-box-label">Receita Produtos</div>
                                            <div class="cash-box-amount positive-value" id="productsRevenue">€ 0,00</div>
                                        </div>
                                        <div class="cash-box-value">
                                            <div class="cash-box-label">Custo Produtos Vendidos</div>
                                            <div class="cash-box-amount negative-value" id="productsCost">€ 0,00</div>
                                        </div>
                                        <div class="cash-box-value">
                                            <div class="cash-box-label">Lucro Produtos</div>
                                            <div class="cash-box-amount positive-value" id="productsProfit">€ 0,00</div>
                                        </div>
                                        <div class="cash-box-value">
                                            <div class="cash-box-label">Saldo Final Produtos</div>
                                            <div class="cash-box-amount" id="productsFinalCash">€ 0,00</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- RESUMO GERAL -->
                                <div class="row mt-4">
                                    <div class="col-md-3">
                                        <div class="summary-item">
                                            <div class="summary-label">Receita Total</div>
                                            <div class="summary-value positive-value" id="totalRevenue">€ 0,00</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="summary-item">
                                            <div class="summary-label">Despesas Totais</div>
                                            <div class="summary-value negative-value" id="totalExpenses">€ 0,00</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="summary-item">
                                            <div class="summary-label">Lucro Total</div>
                                            <div class="summary-value" id="totalProfit">€ 0,00</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="summary-item">
                                            <div class="summary-label">Caixa Total</div>
                                            <div class="summary-value" id="totalFinalCash">€ 0,00</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- CÁLCULO DETALHADO -->
                                <div class="row mt-4">
                                    <div class="col-md-12">
                                        <div class="final-cash-display" id="finalCashDisplay">
                                            Caixa Total Final: € 0,00
                                        </div>
                                        <div class="calculation-steps">
                                            <div class="calculation-step">
                                                <span>Receita Serviços:</span>
                                                <span id="calculationServicesRevenue">€ 0,00</span>
                                            </div>
                                            <div class="calculation-step">
                                                <span>- Despesas Pagas Serviços:</span>
                                                <span id="calculationServicesExpenses">€ 0,00</span>
                                            </div>
                                            <div class="calculation-step">
                                                <span>= Saldo Serviços:</span>
                                                <span id="calculationServicesBalance">€ 0,00</span>
                                            </div>
                                            <div class="calculation-step">
                                                <span>Receita Produtos:</span>
                                                <span id="calculationProductsRevenue">€ 0,00</span>
                                            </div>
                                            <div class="calculation-step">
                                                <span>- Custo Produtos:</span>
                                                <span id="calculationProductsCost">€ 0,00</span>
                                            </div>
                                            <div class="calculation-step">
                                                <span>= Saldo Produtos:</span>
                                                <span id="calculationProductsBalance">€ 0,00</span>
                                            </div>
                                            <div class="calculation-step total">
                                                <span>= Caixa Total:</span>
                                                <span id="calculationTotalCash">€ 0,00</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row mt-3">
                                    <div class="col-md-4">
                                        <div class="summary-item">
                                            <div class="summary-label">Despesas Pendentes</div>
                                            <div class="summary-value negative-value" id="pendingExpenses">€ 0,00</div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="summary-item">
                                            <div class="summary-label">Despesas Recorrentes</div>
                                            <div class="summary-value" id="recurringExpenses">€ 0,00</div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="summary-item">
                                            <div class="summary-label">Lucro Líquido</div>
                                            <div class="summary-value positive-value" id="netProfit">€ 0,00</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-8">
                                    <!-- Abas para Despesas e Salários -->
                                    <ul class="nav nav-tabs" id="financialTabs" role="tablist">
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link active" id="expenses-tab" data-bs-toggle="tab" data-bs-target="#expenses" type="button" role="tab">Despesas</button>
                                        </li>
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link" id="salaries-tab" data-bs-toggle="tab" data-bs-target="#salaries" type="button" role="tab">Salários</button>
                                        </li>
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link" id="add-tab" data-bs-toggle="tab" data-bs-target="#add" type="button" role="tab">Adicionar</button>
                                        </li>
                                    </ul>
                                    
                                    <div class="tab-content mt-3">
                                        <!-- Tab Despesas -->
                                        <div class="tab-pane fade show active" id="expenses" role="tabpanel">
                                            <div class="card">
                                                <div class="card-header d-flex justify-content-between align-items-center">
                                                    <h5 class="mb-0">Despesas do Mês</h5>
                                                    <div class="month-selector">
                                                        <select class="form-select" id="expensesMonth" style="width: auto;">
                                                            <!-- Opções serão preenchidas dinamicamente -->
                                                        </select>
                                                    </div>
                                                </div>
                                                <div class="card-body">
                                                    <div id="expensesList">
                                                        <p class="text-muted">Nenhuma despesa registrada.</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Tab Salários -->
                                        <div class="tab-pane fade" id="salaries" role="tabpanel">
                                            <div class="card">
                                                <div class="card-header d-flex justify-content-between align-items-center">
                                                    <h5 class="mb-0">Folha de Pagamento</h5>
                                                    <div class="month-selector">
                                                        <select class="form-select" id="salariesMonth" style="width: auto;">
                                                            <!-- Opções serão preenchidas dinamicamente -->
                                                        </select>
                                                    </div>
                                                </div>
                                                <div class="card-body">
                                                    <div id="salariesList">
                                                        <p class="text-muted">Nenhum pagamento de salário registrado.</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Tab Adicionar -->
                                        <div class="tab-pane fade" id="add" role="tabpanel">
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <div class="card">
                                                        <div class="card-header">
                                                            <h5 class="mb-0">Nova Despesa</h5>
                                                        </div>
                                                        <div class="card-body">
                                                            <form id="expenseForm">
                                                                <div class="mb-3">
                                                                    <label for="expenseDescription" class="form-label">Descrição da Despesa</label>
                                                                    <input type="text" class="form-control" id="expenseDescription" required>
                                                                </div>
                                                                <div class="mb-3">
                                                                    <label for="expenseCategory" class="form-label">Categoria</label>
                                                                    <select class="form-select" id="expenseCategory" required>
                                                                        <option value="">Selecione uma categoria</option>
                                                                        <option value="aluguel">Aluguel</option>
                                                                        <option value="energia">Energia</option>
                                                                        <option value="agua">Água</option>
                                                                        <option value="internet">Internet</option>
                                                                        <option value="produtos">Produtos/Estoque</option>
                                                                        <option value="manutencao">Manutenção</option>
                                                                        <option value="marketing">Marketing</option>
                                                                        <option value="impostos">Impostos</option>
                                                                        <option value="outros">Outros</option>
                                                                    </select>
                                                                </div>
                                                                <div class="row">
                                                                    <div class="col-md-6 mb-3">
                                                                        <label for="expenseValue" class="form-label">Valor (€)</label>
                                                                        <input type="number" class="form-control" id="expenseValue" step="0.01" min="0" required>
                                                                    </div>
                                                                    <div class="col-md-6 mb-3">
                                                                        <label for="expenseDueDate" class="form-label">Data de Vencimento</label>
                                                                        <input type="date" class="form-control" id="expenseDueDate" required>
                                                                    </div>
                                                                </div>
                                                                <div class="mb-3">
                                                                    <label for="expenseNotes" class="form-label">Observações</label>
                                                                    <textarea class="form-control" id="expenseNotes" rows="2"></textarea>
                                                                </div>
                                                                <div class="mb-3 form-check">
                                                                    <input type="checkbox" class="form-check-input" id="expenseRecurring">
                                                                    <label class="form-check-label" for="expenseRecurring">Despesa Recorrente (Mensal)</label>
                                                                </div>
                                                                <button type="submit" class="btn btn-primary">Registrar Despesa</button>
                                                            </form>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="card">
                                                        <div class="card-header">
                                                            <h5 class="mb-0">Registrar Pagamento de Salário</h5>
                                                        </div>
                                                        <div class="card-body">
                                                            <form id="salaryPaymentForm">
                                                                <div class="mb-3">
                                                                    <label for="salaryCollaborator" class="form-label">Colaborador</label>
                                                                    <select class="form-select" id="salaryCollaborator" required>
                                                                        <option value="">Selecione um colaborador</option>
                                                                    </select>
                                                                </div>
                                                                <div class="mb-3">
                                                                    <label for="salaryMonth" class="form-label">Mês de Referência</label>
                                                                    <input type="month" class="form-control" id="salaryMonth" required>
                                                                </div>
                                                                <div class="mb-3">
                                                                    <label for="salaryBaseValue" class="form-label">Salário Base (€)</label>
                                                                    <input type="number" class="form-control" id="salaryBaseValue" step="0.01" min="0" required>
                                                                </div>
                                                                <div class="mb-3">
                                                                    <label for="salaryBonus" class="form-label">Bônus/Comissões (€)</label>
                                                                    <input type="number" class="form-control" id="salaryBonus" step="0.01" min="0" value="0">
                                                                </div>
                                                                <div class="mb-3">
                                                                    <label for="salaryDeductions" class="form-label">Descontos (€)</label>
                                                                    <input type="number" class="form-control" id="salaryDeductions" step="0.01" min="0" value="0">
                                                                </div>
                                                                <div class="mb-3">
                                                                    <label for="salaryPaymentDate" class="form-label">Data do Pagamento</label>
                                                                    <input type="date" class="form-control" id="salaryPaymentDate" required>
                                                                </div>
                                                                <div class="mb-3">
                                                                    <label for="salaryPaymentMethod" class="form-label">Método de Pagamento</label>
                                                                    <select class="form-select" id="salaryPaymentMethod" required>
                                                                        <option value="dinheiro">Dinheiro</option>
                                                                        <option value="transferencia">Transferência</option>
                                                                        <option value="cheque">Cheque</option>
                                                                    </select>
                                                                </div>
                                                                <div class="mb-3">
                                                                    <label for="salaryNotes" class="form-label">Observações</label>
                                                                    <textarea class="form-control" id="salaryNotes" rows="2"></textarea>
                                                                </div>
                                                                <button type="submit" class="btn btn-primary">Registrar Pagamento</button>
                                                            </form>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-4">
                                    <!-- Próximos Vencimentos -->
                                    <div class="card mb-4">
                                        <div class="card-header">
                                            <h5 class="mb-0">Próximos Vencimentos</h5>
                                        </div>
                                        <div class="card-body">
                                            <div id="upcomingDueList">
                                                <p class="text-muted">Nenhum vencimento próximo.</p>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Gráfico de Despesas por Categoria -->
                                    <div class="card">
                                        <div class="card-header">
                                            <h5 class="mb-0">Despesas por Categoria</h5>
                                        </div>
                                        <div class="card-body">
                                            <div id="expenseChartContainer">
                                                <canvas id="expenseChart" width="100%" height="200"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Perfil da Empresa -->
                        <div id="business-profile" class="section">
                            <h2 class="mb-4">Perfil da Empresa</h2>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <h5 class="mb-0">Informações da Empresa</h5>
                                        </div>
                                        <div class="card-body">
                                            <form id="businessProfileForm">
                                                <div class="mb-3">
                                                    <label for="businessName" class="form-label">Nome da Empresa</label>
                                                    <input type="text" class="form-control" id="businessName" value="Studio DeVitto">
                                                </div>
                                                <div class="mb-3">
                                                    <label for="businessEmail" class="form-label">E-mail</label>
                                                    <input type="email" class="form-control" id="businessEmail">
                                                </div>
                                                <div class="mb-3">
                                                    <label for="businessPhone" class="form-label">Telefone</label>
                                                    <input type="text" class="form-control" id="businessPhone" placeholder="+351">
                                                </div>
                                                <div class="mb-3">
                                                    <label for="businessAddress" class="form-label">Endereço</label>
                                                    <textarea class="form-control" id="businessAddress" rows="2"></textarea>
                                                </div>
                                                <div class="mb-3">
                                                    <label for="businessDescription" class="form-label">Descrição</label>
                                                    <textarea class="form-control" id="businessDescription" rows="3" placeholder="Breve descrição sobre o seu negócio..."></textarea>
                                                </div>
                                                <button type="submit" class="btn btn-primary">Salvar Informações</button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <h5 class="mb-0">Horário de Funcionamento</h5>
                                        </div>
                                        <div class="card-body">
                                            <div class="business-hours-container">
                                                <div class="business-hours-day">
                                                    <span>Segunda-feira</span>
                                                    <div class="business-hours-inputs">
                                                        <input type="time" class="form-control" id="mondayOpen" value="09:00">
                                                        <span>às</span>
                                                        <input type="time" class="form-control" id="mondayClose" value="18:00">
                                                    </div>
                                                </div>
                                                <div class="business-hours-day">
                                                    <span>Terça-feira</span>
                                                    <div class="business-hours-inputs">
                                                        <input type="time" class="form-control" id="tuesdayOpen" value="09:00">
                                                        <span>às</span>
                                                        <input type="time" class="form-control" id="tuesdayClose" value="18:00">
                                                    </div>
                                                </div>
                                                <div class="business-hours-day">
                                                    <span>Quarta-feira</span>
                                                    <div class="business-hours-inputs">
                                                        <input type="time" class="form-control" id="wednesdayOpen" value="09:00">
                                                        <span>às</span>
                                                        <input type="time" class="form-control" id="wednesdayClose" value="18:00">
                                                    </div>
                                                </div>
                                                <div class="business-hours-day">
                                                    <span>Quinta-feira</span>
                                                    <div class="business-hours-inputs">
                                                        <input type="time" class="form-control" id="thursdayOpen" value="09:00">
                                                        <span>às</span>
                                                        <input type="time" class="form-control" id="thursdayClose" value="18:00">
                                                    </div>
                                                </div>
                                                <div class="business-hours-day">
                                                    <span>Sexta-feira</span>
                                                    <div class="business-hours-inputs">
                                                        <input type="time" class="form-control" id="fridayOpen" value="09:00">
                                                        <span>às</span>
                                                        <input type="time" class="form-control" id="fridayClose" value="18:00">
                                                    </div>
                                                </div>
                                                <div class="business-hours-day">
                                                    <span>Sábado</span>
                                                    <div class="business-hours-inputs">
                                                        <input type="time" class="form-control" id="saturdayOpen" value="09:00">
                                                        <span>às</span>
                                                        <input type="time" class="form-control" id="saturdayClose" value="13:00">
                                                    </div>
                                                </div>
                                                <div class="business-hours-day business-closed">
                                                    <span>Domingo</span>
                                                    <div>
                                                        <span class="text-muted">Fechado</span>
                                                    </div>
                                                </div>
                                            </div>
                                            <button class="btn btn-primary mt-3" id="saveBusinessHours">Salvar Horários</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Relatórios -->
                        <div id="reports" class="section">
                            <h2 class="mb-4">Relatórios</h2>
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">Gerar Relatório</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row mb-3">
                                        <div class="col-md-3">
                                            <label for="reportType" class="form-label">Tipo de Relatório</label>
                                            <select class="form-select" id="reportType">
                                                <option value="daily">Diário</option>
                                                <option value="weekly">Semanal</option>
                                                <option value="monthly">Mensal</option>
                                                <option value="yearly">Anual</option>
                                                <option value="collaborator">Por Colaborador</option>
                                                <option value="inventory">Estoque</option>
                                                <option value="financial">Financeiro</option>
                                            </select>
                                        </div>
                                        <div class="col-md-3">
                                            <label for="reportDate" class="form-label">Data</label>
                                            <input type="date" class="form-control" id="reportDate">
                                        </div>
                                        <div class="col-md-3">
                                            <label for="reportCollaborator" class="form-label">Colaborador</label>
                                            <select class="form-select" id="reportCollaborator">
                                                <option value="all">Todos</option>
                                            </select>
                                        </div>
                                        <div class="col-md-3 d-flex align-items-end">
                                            <button class="btn btn-primary w-100" id="generateReportBtn">
                                                <i class="fas fa-download me-1"></i> Gerar PDF
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Aniversários -->
                        <div id="birthdays" class="section">
                            <h2 class="mb-4">Aniversários</h2>
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">Próximos Aniversários</h5>
                                </div>
                                <div class="card-body">
                                    <div id="birthdaysList">
                                        <p class="text-muted">Nenhum aniversário próximo encontrado.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Botão Flutuante para Dispositivos Móveis -->
    <div class="floating-mobile-btn" id="floatingMobileBtn">
        <i class="fas fa-home"></i>
    </div>
    
    <!-- Botão Home para Dispositivos Móveis -->
    <div class="floating-home-btn" id="floatingHomeBtn" style="display: none;">
        <i class="fas fa-home"></i>
    </div>

    <!-- Modal para Adicionar/Editar Cliente -->
    <div class="modal fade" id="clientModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="clientModalTitle">Adicionar Cliente</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="clientForm">
                        <input type="hidden" id="clientId">
                        <div class="mb-3">
                            <label for="clientName" class="form-label">Nome Completo</label>
                            <input type="text" class="form-control" id="clientName" required>
                        </div>
                        <div class="mb-3">
                            <label for="clientBirthdate" class="form-label">Data de Nascimento</label>
                            <input type="date" class="form-control" id="clientBirthdate" required>
                        </div>
                        <div class="mb-3">
                            <label for="clientPhone" class="form-label">Telefone/WhatsApp (+351)</label>
                            <input type="text" class="form-control" id="clientPhone" placeholder="+351" required>
                        </div>
                        <div class="mb-3">
                            <label for="clientEmail" class="form-label">E-mail</label>
                            <input type="email" class="form-control" id="clientEmail">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="saveClientBtn">Salvar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Adicionar/Editar Colaborador -->
    <div class="modal fade" id="collaboratorModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="collaboratorModalTitle">Adicionar Colaborador</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="collaboratorForm">
                        <input type="hidden" id="collaboratorId">
                        <div class="collaborator-photo-container">
                            <div class="collaborator-photo-placeholder" id="collaboratorPhotoPlaceholder">
                                <i class="fas fa-user"></i>
                            </div>
                            <img id="collaboratorPhotoPreview" class="collaborator-photo" src="" alt="Preview da foto" style="display: none;">
                            <input type="file" class="form-control mt-2" id="collaboratorPhotoUpload" accept="image/*">
                        </div>
                        <div class="mb-3">
                            <label for="collaboratorName" class="form-label">Nome Completo</label>
                            <input type="text" class="form-control" id="collaboratorName" required>
                        </div>
                        <div class="mb-3">
                            <label for="collaboratorContact" class="form-label">Contato</label>
                            <input type="text" class="form-control" id="collaboratorContact" placeholder="+351">
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="collaboratorManualPercent" class="form-label">% Serviços Manuais</label>
                                <input type="number" class="form-control" id="collaboratorManualPercent" min="0" max="100" step="0.1" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="collaboratorProductPercent" class="form-label">% Serviços com Produtos</label>
                                <input type="number" class="form-control" id="collaboratorProductPercent" min="0" max="100" step="0.1" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="collaboratorBaseSalary" class="form-label">Salário Base (€)</label>
                                <input type="number" class="form-control" id="collaboratorBaseSalary" step="0.01" min="0" value="0">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="collaboratorPaymentDay" class="form-label">Dia do Pagamento</label>
                                <input type="number" class="form-control" id="collaboratorPaymentDay" min="1" max="31" value="5">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="collaboratorSpecialty" class="form-label">Especialidade</label>
                            <input type="text" class="form-control" id="collaboratorSpecialty" placeholder="Ex: Corte, Coloração, etc." required>
                        </div>
                        <div class="mb-3">
                            <label for="collaboratorDescription" class="form-label">Descrição</label>
                            <textarea class="form-control" id="collaboratorDescription" rows="3" placeholder="Breve descrição sobre o colaborador..."></textarea>
                        </div>
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="collaboratorActive" checked>
                            <label class="form-check-label" for="collaboratorActive">Ativo</label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="saveCollaboratorBtn">Salvar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Visualizar Perfil do Colaborador -->
    <div class="modal fade" id="collaboratorProfileModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="collaboratorProfileModalTitle">Perfil do Colaborador</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="collaborator-profile">
                        <img id="collaboratorProfileImage" class="collaborator-profile-img" src="" alt="Foto do colaborador">
                        <h4 id="collaboratorProfileName"></h4>
                        <p class="text-muted" id="collaboratorProfileSpecialty"></p>
                        <p id="collaboratorProfileDescription"></p>
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <p><strong>Contato:</strong> <span id="collaboratorProfileContact"></span></p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>% Serviços Manuais:</strong> <span id="collaboratorProfileManualPercent"></span>%</p>
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-md-6">
                                <p><strong>% Serviços com Produtos:</strong> <span id="collaboratorProfileProductPercent"></span>%</p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>Salário Base:</strong> <span id="collaboratorProfileBaseSalary"></span></p>
                            </div>
                        </div>
                        <p class="mt-3"><strong>Status:</strong> <span id="collaboratorProfileStatus" class="badge bg-success">Ativo</span></p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Adicionar/Editar Produto -->
    <div class="modal fade" id="productModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="productModalTitle">Adicionar Produto</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="productForm">
                        <input type="hidden" id="productId">
                        <div class="mb-3">
                            <label for="productName" class="form-label">Nome do Produto</label>
                            <input type="text" class="form-control" id="productName" required>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="productQuantity" class="form-label">Quantidade em Estoque</label>
                                <input type="number" class="form-control" id="productQuantity" min="0" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="productMinQuantity" class="form-label">Quantidade Mínima</label>
                                <input type="number" class="form-control" id="productMinQuantity" min="1" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="productPurchasePrice" class="form-label">Preço de Compra (€)</label>
                                <input type="number" class="form-control" id="productPurchasePrice" step="0.01" min="0" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="productSalePrice" class="form-label">Preço de Venda (€)</label>
                                <input type="number" class="form-control" id="productSalePrice" step="0.01" min="0" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="productDescription" class="form-label">Descrição</label>
                            <textarea class="form-control" id="productDescription" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="productCategory" class="form-label">Categoria</label>
                            <select class="form-select" id="productCategory">
                                <option value="cabelo">Cabelo</option>
                                <option value="pele">Pele</option>
                                <option value="maquiagem">Maquiagem</option>
                                <option value="acessorios">Acessórios</option>
                                <option value="outros">Outros</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="saveProductBtn">Salvar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Configurar Estabelecimento -->
    <div class="modal fade" id="businessSettingsModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Configurar Estabelecimento</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="businessSettingsForm">
                        <div class="mb-3">
                            <label for="businessNameInput" class="form-label">Nome do Estabelecimento</label>
                            <input type="text" class="form-control" id="businessNameInput" required>
                        </div>
                        <div class="mb-3">
                            <label for="businessLogoType" class="form-label">Tipo de Logo</label>
                            <select class="form-select" id="businessLogoType">
                                <option value="scissors">Tesoura (Padrão)</option>
                                <option value="store">Loja</option>
                                <option value="spa">SPA</option>
                                <option value="salon">Salão</option>
                                <option value="barber">Barbearia</option>
                                <option value="custom">Upload de Imagem</option>
                            </select>
                        </div>
                        <div class="logo-upload-container" id="logoUploadContainer" style="display: none;">
                            <label for="logoUpload" class="form-label">Upload de Logo</label>
                            <input type="file" class="form-control" id="logoUpload" accept="image/*">
                            <div class="logo-preview-container mt-2">
                                <div class="logo-placeholder" id="logoPlaceholder">
                                    <i class="fas fa-image"></i>
                                </div>
                                <img id="logoPreview" class="logo-preview" src="" alt="Preview da logo">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="saveBusinessSettingsBtn">Salvar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Resumo do Cliente -->
    <div class="modal fade" id="clientSummaryModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="clientSummaryModalTitle">Resumo do Cliente</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="clientSummaryContent">
                        <!-- Conteúdo será preenchido dinamicamente -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Notas do Cliente -->
    <div class="modal fade" id="clientNotesModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="clientNotesModalTitle">Notas do Cliente</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="clientNotesForm">
                        <input type="hidden" id="clientNotesId">
                        <div class="mb-3">
                            <label for="clientNotes" class="form-label">Notas e Observações</label>
                            <textarea class="form-control" id="clientNotes" rows="6" placeholder="Ex: Tintas que usa na coloração, preferências, alergias, etc."></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="saveClientNotesBtn">Salvar Notas</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Configuração do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyC5ezGCOS5d-Vy2l-Gimkl_V9VmwDLZzKc",
            authDomain: "studio-devitto-152400.firebaseapp.com",
            projectId: "studio-devitto-152400",
            storageBucket: "studio-devitto-152400.appspot.com",
            messagingSenderId: "138996544906",
            appId: "1:138996544906:web:6569bf954a00e2f7944473",
            measurementId: "G-FCC5T13QW8"
        };

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();

        // Variáveis globais
        let currentUser = null;
        let currentCashier = null;
        let todayServices = [];
        let todayProductSales = [];
        let allServices = [];
        let allProductSales = [];
        let clients = [];
        let collaborators = [];
        let packages = [];
        let products = [];
        let selectedClientId = null;
        let clientNotes = {};
        
        // Controle Financeiro
        let expenses = [];
        let salaryPayments = [];
        let expenseChart = null;
        
        // Configurações
        let businessSettings = {
            name: "Studio DeVitto",
            logoType: "scissors",
            customLogo: null
        };
        
        // Perfil da Empresa
        let businessProfile = {
            name: "Studio DeVitto",
            email: "",
            phone: "",
            address: "",
            description: ""
        };
        
        let businessHours = {
            monday: { open: "09:00", close: "18:00" },
            tuesday: { open: "09:00", close: "18:00" },
            wednesday: { open: "09:00", close: "18:00" },
            thursday: { open: "09:00", close: "18:00" },
            friday: { open: "09:00", close: "18:00" },
            saturday: { open: "09:00", close: "13:00" },
            sunday: { open: null, close: null }
        };
        
        // Controle de navegação mobile
        let currentSection = 'dashboard';
        let isMobileView = false;
        
        // Variáveis para autocomplete
        let filteredClients = [];
        let filteredProducts = [];

        // Inicialização quando o DOM estiver carregado
        document.addEventListener('DOMContentLoaded', function() {
            // Verificar se há um usuário logado
            auth.onAuthStateChanged(user => {
                if (user) {
                    currentUser = user;
                    showMainScreen();
                    loadInitialData();
                } else {
                    showLoginScreen();
                }
            });

            setupEventListeners();
            checkMobileDevice();
            
            // Inicializar data e hora
            updateDateTime();
            setInterval(updateDateTime, 1000);
            
            // Carregar configurações do estabelecimento
            loadBusinessSettings();
            
            // Carregar perfil da empresa
            loadBusinessProfile();
            
            // Carregar horários da empresa
            loadBusinessHours();
        });

        function setupEventListeners() {
            // Login
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('showRegister').addEventListener('click', showRegisterForm);
            document.getElementById('showLogin').addEventListener('click', showLoginForm);
            
            // Registro
            document.getElementById('registerForm').addEventListener('submit', handleRegister);
            
            // Logout
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
            
            // Navegação
            document.querySelectorAll('.sidebar .nav-link, .mobile-menu .nav-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const section = this.getAttribute('data-section');
                    showSection(section);
                    
                    document.querySelectorAll('.sidebar .nav-link, .mobile-menu .nav-link').forEach(item => {
                        item.classList.remove('active');
                    });
                    this.classList.add('active');
                });
            });

            // Cards mobile
            document.querySelectorAll('.mobile-card').forEach(card => {
                card.addEventListener('click', function() {
                    const section = this.getAttribute('data-section');
                    showSection(section);
                });
            });

            // Caixa - NOVO: Eventos para autocomplete
            document.getElementById('clientSelect').addEventListener('input', filterClientsAutocomplete);
            document.getElementById('productSaleSelect').addEventListener('input', filterProductsAutocomplete);
            document.getElementById('productSaleClient').addEventListener('input', filterProductClientsAutocomplete);
            
            // Fechar autocomplete quando clicar fora
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.autocomplete-container')) {
                    closeAllAutocompleteLists();
                }
            });
            
            // Caixa - eventos existentes
            document.getElementById('openCashierBtn').addEventListener('click', openCashier);
            document.getElementById('closeCashierBtn').addEventListener('click', closeCashier);
            document.getElementById('serviceForm').addEventListener('submit', addService);
            document.getElementById('addAnotherServiceBtn').addEventListener('click', addAnotherService);
            document.getElementById('productSaleForm').addEventListener('submit', addProductSale);
            
            // Clientes
            document.getElementById('addClientBtn').addEventListener('click', showAddClientModal);
            document.getElementById('saveClientBtn').addEventListener('click', saveClient);
            document.getElementById('clientSearch').addEventListener('input', searchClients);
            document.getElementById('addNewClientLink').addEventListener('click', function(e) {
                e.preventDefault();
                showAddClientModal();
            });
            
            // Colaboradores
            document.getElementById('addCollaboratorBtn').addEventListener('click', showAddCollaboratorModal);
            document.getElementById('saveCollaboratorBtn').addEventListener('click', saveCollaborator);
            document.getElementById('collaboratorPhotoUpload').addEventListener('change', handleCollaboratorPhotoUpload);
            
            // Produtos
            document.getElementById('addProductBtn').addEventListener('click', showAddProductModal);
            document.getElementById('saveProductBtn').addEventListener('click', saveProduct);
            
            // Pacotes
            document.getElementById('packageForm').addEventListener('submit', savePackage);
            document.getElementById('packageFrequency').addEventListener('change', toggleDaysSelection);
            document.getElementById('cancelPackageEditBtn').addEventListener('click', cancelPackageEdit);
            
            // Controle Financeiro
            document.getElementById('expenseForm').addEventListener('submit', saveExpense);
            document.getElementById('salaryPaymentForm').addEventListener('submit', saveSalaryPayment);
            document.getElementById('expensesMonth').addEventListener('change', loadExpensesByMonth);
            document.getElementById('salariesMonth').addEventListener('change', loadSalariesByMonth);
            
            // Relatórios
            document.getElementById('generateReportBtn').addEventListener('click', generateReport);
            
            // Registros de Clientes
            document.getElementById('clientRecordsSearch').addEventListener('input', searchClientRecords);
            document.getElementById('saveClientNotesBtn').addEventListener('click', saveClientNotes);
            
            // Eventos para funcionalidades adicionadas
            document.getElementById('lowStockAlertCard').addEventListener('click', toggleLowStockDetails);
            document.getElementById('refreshTodaySales').addEventListener('click', refreshTodaySales);
            document.getElementById('todaySalesSearch').addEventListener('input', filterTodaySales);
            document.getElementById('inventorySearch').addEventListener('input', filterInventory);
            document.getElementById('clientRecordClose').addEventListener('click', closeMobileClientRecord);
            document.getElementById('clientRecordOverlay').addEventListener('click', closeMobileClientRecord);
            
            // Eventos para Configurações do Estabelecimento
            document.getElementById('changeBusinessSettings').addEventListener('click', showBusinessSettingsModal);
            document.getElementById('saveBusinessSettingsBtn').addEventListener('click', saveBusinessSettings);
            document.getElementById('businessLogoType').addEventListener('change', toggleLogoUpload);
            document.getElementById('logoUpload').addEventListener('change', handleLogoUpload);
            
            // Evento para botão flutuante móvel
            document.getElementById('floatingMobileBtn').addEventListener('click', showMobileCards);
            
            // Eventos para Perfil da Empresa
            document.getElementById('businessProfileForm').addEventListener('submit', saveBusinessProfile);
            document.getElementById('saveBusinessHours').addEventListener('click', saveBusinessHours);
            
            // Evento para botão home mobile
            document.getElementById('floatingHomeBtn').addEventListener('click', showMobileCards);
            
            // Evento para redimensionamento da janela
            window.addEventListener('resize', handleResize);
        }

        function handleResize() {
            checkMobileDevice();
        }

        function updateDateTime() {
            const now = new Date();
            const dateTimeString = now.toLocaleDateString('pt-PT') + ' ' + now.toLocaleTimeString('pt-PT');
            document.getElementById('currentDateTime').textContent = dateTimeString;
        }

        // NOVO: Funções para autocomplete
        function filterClientsAutocomplete() {
            const searchTerm = document.getElementById('clientSelect').value.toLowerCase();
            const list = document.getElementById('clientAutocompleteList');
            
            if (searchTerm.length < 1) {
                list.classList.remove('active');
                return;
            }
            
            filteredClients = clients.filter(client => 
                client.name.toLowerCase().includes(searchTerm) ||
                client.phone.includes(searchTerm) ||
                (client.email && client.email.toLowerCase().includes(searchTerm))
            );
            
            let html = '';
            filteredClients.slice(0, 10).forEach(client => {
                html += `<div class="autocomplete-item" data-id="${client.id}" data-name="${client.name}">${client.name} (${client.phone})</div>`;
            });
            
            if (html === '') {
                html = '<div class="autocomplete-item">Nenhum cliente encontrado</div>';
            }
            
            list.innerHTML = html;
            list.classList.add('active');
            
            // Adicionar eventos aos itens
            list.querySelectorAll('.autocomplete-item').forEach(item => {
                item.addEventListener('click', function() {
                    const clientId = this.getAttribute('data-id');
                    const clientName = this.getAttribute('data-name');
                    document.getElementById('clientSelect').value = clientName;
                    document.getElementById('selectedClientId').value = clientId;
                    list.classList.remove('active');
                });
            });
        }
        
        function filterProductsAutocomplete() {
            const searchTerm = document.getElementById('productSaleSelect').value.toLowerCase();
            const list = document.getElementById('productAutocompleteList');
            
            if (searchTerm.length < 1) {
                list.classList.remove('active');
                return;
            }
            
            filteredProducts = products.filter(product => 
                product.name.toLowerCase().includes(searchTerm) ||
                product.description.toLowerCase().includes(searchTerm)
            );
            
            let html = '';
            filteredProducts.slice(0, 10).forEach(product => {
                const stockInfo = product.quantity > 0 ? `(${product.quantity} disponíveis)` : '(ESGOTADO)';
                html += `<div class="autocomplete-item" data-id="${product.id}" data-name="${product.name}" data-price="${product.salePrice}" data-stock="${product.quantity}">${product.name} ${stockInfo} - ${formatCurrency(product.salePrice)}</div>`;
            });
            
            if (html === '') {
                html = '<div class="autocomplete-item">Nenhum produto encontrado</div>';
            }
            
            list.innerHTML = html;
            list.classList.add('active');
            
            // Adicionar eventos aos itens
            list.querySelectorAll('.autocomplete-item').forEach(item => {
                item.addEventListener('click', function() {
                    const productId = this.getAttribute('data-id');
                    const productName = this.getAttribute('data-name');
                    const productPrice = this.getAttribute('data-price');
                    const productStock = this.getAttribute('data-stock');
                    
                    document.getElementById('productSaleSelect').value = productName;
                    document.getElementById('selectedProductId').value = productId;
                    
                    // Atualizar quantidade máxima disponível
                    document.getElementById('productSaleQuantity').max = productStock;
                    document.getElementById('productSaleQuantity').value = 1;
                    
                    list.classList.remove('active');
                });
            });
        }
        
        function filterProductClientsAutocomplete() {
            const searchTerm = document.getElementById('productSaleClient').value.toLowerCase();
            const list = document.getElementById('productClientAutocompleteList');
            
            if (searchTerm.length < 1) {
                list.classList.remove('active');
                return;
            }
            
            const filtered = clients.filter(client => 
                client.name.toLowerCase().includes(searchTerm) ||
                client.phone.includes(searchTerm)
            );
            
            let html = '';
            filtered.slice(0, 10).forEach(client => {
                html += `<div class="autocomplete-item" data-id="${client.id}" data-name="${client.name}">${client.name} (${client.phone})</div>`;
            });
            
            // Adicionar opção para venda avulsa
            html += '<div class="autocomplete-item" data-id="" data-name="Venda Avulsa">Venda Avulsa (sem cliente)</div>';
            
            list.innerHTML = html;
            list.classList.add('active');
            
            // Adicionar eventos aos itens
            list.querySelectorAll('.autocomplete-item').forEach(item => {
                item.addEventListener('click', function() {
                    const clientId = this.getAttribute('data-id');
                    const clientName = this.getAttribute('data-name');
                    document.getElementById('productSaleClient').value = clientName;
                    document.getElementById('selectedProductClientId').value = clientId;
                    list.classList.remove('active');
                });
            });
        }
        
        function closeAllAutocompleteLists() {
            document.querySelectorAll('.autocomplete-list').forEach(list => {
                list.classList.remove('active');
            });
        }

        function showLoginForm() {
            document.getElementById('loginFormContainer').classList.remove('hidden');
            document.getElementById('registerFormContainer').classList.add('hidden');
        }

        function showRegisterForm() {
            document.getElementById('loginFormContainer').classList.add('hidden');
            document.getElementById('registerFormContainer').classList.remove('hidden');
        }

        function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            showLoading('Entrando...');
            
            auth.signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    currentUser = userCredential.user;
                    showMainScreen();
                    loadInitialData();
                    showSuccess('Login realizado com sucesso!');
                })
                .catch((error) => {
                    let errorMessage = 'Erro no login. Tente novamente.';
                    switch(error.code) {
                        case 'auth/user-not-found':
                            errorMessage = 'Usuário não encontrado.';
                            break;
                        case 'auth/wrong-password':
                            errorMessage = 'Senha incorreta.';
                            break;
                        case 'auth/invalid-email':
                            errorMessage = 'E-mail inválido.';
                            break;
                        case 'auth/too-many-requests':
                            errorMessage = 'Muitas tentativas de login. Tente novamente mais tarde.';
                            break;
                        case 'auth/network-request-failed':
                            errorMessage = 'Erro de conexão. Verifique sua internet.';
                            break;
                        default:
                            errorMessage = 'Erro: ' + error.message;
                    }
                    showError(errorMessage);
                })
                .finally(() => {
                    // Sempre limpar o formulário de login
                    document.getElementById('loginEmail').value = '';
                    document.getElementById('loginPassword').value = '';
                });
        }

        function handleRegister(e) {
            e.preventDefault();
            const name = document.getElementById('registerName').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('registerConfirmPassword').value;

            // Validações
            if (password !== confirmPassword) {
                showError('As senhas não coincidem.');
                return;
            }

            if (password.length < 6) {
                showError('A senha deve ter pelo menos 6 caracteres.');
                return;
            }

            showLoading('Criando conta...');

            auth.createUserWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    currentUser = userCredential.user;
                    
                    // Salvar informações adicionais do usuário
                    return db.collection('users').doc(currentUser.uid).set({
                        name: name,
                        email: email,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                })
                .then(() => {
                    showMainScreen();
                    loadInitialData();
                    showSuccess('Conta criada com sucesso!');
                })
                .catch((error) => {
                    let errorMessage = 'Erro ao criar conta. Tente novamente.';
                    switch(error.code) {
                        case 'auth/email-already-in-use':
                            errorMessage = 'Este e-mail já está em uso.';
                            break;
                        case 'auth/invalid-email':
                            errorMessage = 'E-mail inválido.';
                            break;
                        case 'auth/weak-password':
                            errorMessage = 'Senha muito fraca. Use pelo menos 6 caracteres.';
                            break;
                        default:
                            errorMessage = 'Erro: ' + error.message;
                    }
                    showError(errorMessage);
                })
                .finally(() => {
                    // Limpar formulário de registro
                    document.getElementById('registerForm').reset();
                });
        }

        function handleLogout() {
            Swal.fire({
                title: 'Tem certeza?',
                text: "Você será desconectado do sistema.",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Sim, sair!',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    auth.signOut().then(() => {
                        currentUser = null;
                        showLoginScreen();
                        showSuccess('Logout realizado com sucesso!');
                    }).catch((error) => {
                        showError('Erro ao fazer logout: ' + error.message);
                    });
                }
            });
        }

        function showLoginScreen() {
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('mainScreen').classList.add('hidden');
            document.getElementById('loginForm').reset();
            showLoginForm();
        }

        function showMainScreen() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainScreen').classList.remove('hidden');
        }

        function loadInitialData() {
            if (currentUser) {
                document.getElementById('userName').textContent = currentUser.email;
                loadUserData();
                loadCashierStatus();
                loadAllServices();
                loadAllProductSales();
                loadClients();
                loadCollaborators();
                loadPackages();
                loadProducts();
                loadClientNotes();
                loadFinancialData();
                
                // Carregar dados do perfil da empresa do Firestore
                loadBusinessProfileFromFirestore();
                loadBusinessHoursFromFirestore();
            }
        }

        function loadUserData() {
            db.collection('users').doc(currentUser.uid).get()
                .then((doc) => {
                    if (doc.exists) {
                        const userData = doc.data();
                        document.getElementById('userName').textContent = userData.name || currentUser.email;
                    }
                })
                .catch((error) => {
                    console.error("Erro ao carregar dados do usuário:", error);
                });
        }

        // Função para carregar dados financeiros
        function loadFinancialData() {
            loadExpenses();
            loadSalaryPayments();
        }

        // Função para carregar despesas
        function loadExpenses() {
            if (!currentUser) return;
            
            db.collection('expenses')
                .where('userId', '==', currentUser.uid)
                .get()
                .then((querySnapshot) => {
                    expenses = [];
                    querySnapshot.forEach((doc) => {
                        expenses.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    
                    updateExpensesUI();
                    updateFinancialSummary();
                    updateExpenseChart();
                    loadUpcomingDueExpenses();
                })
                .catch((error) => {
                    console.error("Erro ao carregar despesas: ", error);
                });
        }

        // Função para carregar pagamentos de salário
        function loadSalaryPayments() {
            if (!currentUser) return;
            
            db.collection('salaryPayments')
                .where('userId', '==', currentUser.uid)
                .get()
                .then((querySnapshot) => {
                    salaryPayments = [];
                    querySnapshot.forEach((doc) => {
                        salaryPayments.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    
                    updateSalariesUI();
                    updateFinancialSummary();
                })
                .catch((error) => {
                    console.error("Erro ao carregar pagamentos de salário: ", error);
                });
        }

        // Função para carregar perfil da empresa do Firestore
        function loadBusinessProfileFromFirestore() {
            if (!currentUser) return;
            
            db.collection('businessProfile').doc(currentUser.uid).get()
                .then((doc) => {
                    if (doc.exists) {
                        const firestoreProfile = doc.data();
                        businessProfile = { ...businessProfile, ...firestoreProfile };
                        updateBusinessProfileUI();
                    }
                })
                .catch((error) => {
                    console.error('Erro ao carregar perfil do banco de dados:', error);
                });
        }

        // Função para carregar horários da empresa do Firestore
        function loadBusinessHoursFromFirestore() {
            if (!currentUser) return;
            
            db.collection('businessHours').doc(currentUser.uid).get()
                .then((doc) => {
                    if (doc.exists) {
                        const firestoreHours = doc.data();
                        businessHours = { ...businessHours, ...firestoreHours };
                        updateBusinessHoursUI();
                    }
                })
                .catch((error) => {
                    console.error('Erro ao carregar horários do banco de dados:', error);
                });
        }

        function loadCashierStatus() {
            const today = new Date().toISOString().split('T')[0];
            
            db.collection('cashiers')
                .where('date', '==', today)
                .where('userId', '==', currentUser.uid)
                .where('status', '==', 'open')
                .get()
                .then((querySnapshot) => {
                    if (!querySnapshot.empty) {
                        currentCashier = querySnapshot.docs[0].data();
                        currentCashier.id = querySnapshot.docs[0].id;
                        updateCashierUI(true);
                    } else {
                        currentCashier = null;
                        updateCashierUI(false);
                    }
                })
                .catch((error) => {
                    console.error("Erro ao carregar status do caixa: ", error);
                });
        }

        function loadAllServices() {
            // Sem ordenação para evitar necessidade de índices
            db.collection('services')
                .where('userId', '==', currentUser.uid)
                .get()
                .then((querySnapshot) => {
                    allServices = [];
                    todayServices = [];
                    const today = new Date().toISOString().split('T')[0];
                    
                    querySnapshot.forEach((doc) => {
                        const service = {
                            id: doc.id,
                            ...doc.data()
                        };
                        allServices.push(service);
                        
                        // Separar serviços de hoje
                        if (service.date === today) {
                            todayServices.push(service);
                        }
                    });
                    
                    // Ordenar localmente por timestamp
                    allServices.sort((a, b) => {
                        const dateA = a.timestamp.toDate ? a.timestamp.toDate() : new Date(a.timestamp);
                        const dateB = b.timestamp.toDate ? b.timestamp.toDate() : new Date(b.timestamp);
                        return dateB - dateA;
                    });
                    
                    todayServices.sort((a, b) => {
                        const dateA = a.timestamp.toDate ? a.timestamp.toDate() : new Date(a.timestamp);
                        const dateB = b.timestamp.toDate ? b.timestamp.toDate() : new Date(b.timestamp);
                        return dateB - dateA;
                    });
                    
                    updateTodaySalesUI();
                    updateDashboard();
                    calculatePeriodSales();
                    updateMonthlySalesChart();
                })
                .catch((error) => {
                    console.error("Erro ao carregar serviços: ", error);
                });
        }

        function loadAllProductSales() {
            db.collection('productSales')
                .where('userId', '==', currentUser.uid)
                .get()
                .then((querySnapshot) => {
                    allProductSales = [];
                    todayProductSales = [];
                    const today = new Date().toISOString().split('T')[0];
                    
                    querySnapshot.forEach((doc) => {
                        const sale = {
                            id: doc.id,
                            ...doc.data()
                        };
                        allProductSales.push(sale);
                        
                        // Separar vendas de hoje
                        if (sale.date === today) {
                            todayProductSales.push(sale);
                        }
                    });
                    
                    updateTodaySalesUI();
                    updateDashboard();
                    updateMonthlySalesChart();
                    updateProductsSoldStats();
                })
                .catch((error) => {
                    console.error("Erro ao carregar vendas de produtos: ", error);
                });
        }

        function loadClients() {
            console.log("Carregando clientes...");
            // Sem ordenação para evitar necessidade de índices
            db.collection('clients')
                .where('userId', '==', currentUser.uid)
                .get()
                .then((querySnapshot) => {
                    clients = [];
                    querySnapshot.forEach((doc) => {
                        console.log("Cliente encontrado:", doc.data());
                        clients.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    
                    // Ordenar localmente por nome
                    clients.sort((a, b) => a.name.localeCompare(b.name, 'pt-PT'));
                    
                    console.log("Total de clientes carregados:", clients.length);
                    updateClientsUI();
                    updatePackageClientSelect();
                    document.getElementById('totalClients').textContent = clients.length;
                    
                    // NOVO: Atualizar aniversários
                    loadUpcomingBirthdays();
                })
                .catch((error) => {
                    console.error("Erro ao carregar clientes: ", error);
                    showError('Erro ao carregar clientes: ' + error.message);
                });
        }

        function loadCollaborators() {
            console.log("Carregando colaboradores...");
            // Sem ordenação para evitar necessidade de índices
            db.collection('collaborators')
                .where('userId', '==', currentUser.uid)
                .get()
                .then((querySnapshot) => {
                    collaborators = [];
                    querySnapshot.forEach((doc) => {
                        console.log("Colaborador encontrado:", doc.data());
                        collaborators.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    
                    // Ordenar localmente por nome
                    collaborators.sort((a, b) => a.name.localeCompare(b.name, 'pt-PT'));
                    
                    console.log("Total de colaboradores carregados:", collaborators.length);
                    updateCollaboratorsUI();
                    updateCollaboratorSelect();
                    updateReportCollaboratorSelect();
                    updateSalaryCollaboratorSelect();
                })
                .catch((error) => {
                    console.error("Erro ao carregar colaboradores: ", error);
                    showError('Erro ao carregar colaboradores: ' + error.message);
                });
        }

        function loadProducts() {
            console.log("Carregando produtos...");
            db.collection('products')
                .where('userId', '==', currentUser.uid)
                .get()
                .then((querySnapshot) => {
                    products = [];
                    querySnapshot.forEach((doc) => {
                        console.log("Produto encontrado:", doc.data());
                        products.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    
                    // Ordenar produtos por ordem alfabética
                    products.sort((a, b) => a.name.localeCompare(b.name, 'pt-PT'));
                    
                    updateInventoryUI();
                    checkLowStock();
                })
                .catch((error) => {
                    console.error("Erro ao carregar produtos: ", error);
                    showError('Erro ao carregar produtos: ' + error.message);
                });
        }

        function loadPackages() {
            console.log("Carregando pacotes...");
            // Sem ordenação para evitar necessidade de índices
            db.collection('packages')
                .where('userId', '==', currentUser.uid)
                .get()
                .then((querySnapshot) => {
                    packages = [];
                    querySnapshot.forEach((doc) => {
                        console.log("Pacote encontrado:", doc.data());
                        packages.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    
                    updatePackagesUI();
                })
                .catch((error) => {
                    console.error("Erro ao carregar pacotes: ", error);
                    showError('Erro ao carregar pacotes: ' + error.message);
                });
        }

        function loadClientNotes() {
            db.collection('clientNotes')
                .where('userId', '==', currentUser.uid)
                .get()
                .then((querySnapshot) => {
                    clientNotes = {};
                    querySnapshot.forEach((doc) => {
                        const noteData = doc.data();
                        clientNotes[noteData.clientId] = {
                            id: doc.id,
                            notes: noteData.notes
                        };
                    });
                })
                .catch((error) => {
                    console.error("Erro ao carregar notas dos clientes: ", error);
                });
        }

        // NOVO: Função para atualizar estatísticas de produtos vendidos
        function updateProductsSoldStats() {
            const today = new Date();
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();
            
            // Produtos vendidos este mês
            const monthProductSales = allProductSales.filter(sale => {
                const saleDate = sale.timestamp.toDate ? sale.timestamp.toDate() : new Date(sale.timestamp);
                return saleDate.getMonth() === currentMonth && saleDate.getFullYear() === currentYear;
            });
            
            const monthProductsCount = monthProductSales.reduce((sum, sale) => sum + sale.quantity, 0);
            const monthProductsValue = monthProductSales.reduce((sum, sale) => sum + parseFloat(sale.totalValue), 0);
            
            // Produtos vendidos no total
            const totalProductsCount = allProductSales.reduce((sum, sale) => sum + sale.quantity, 0);
            const totalProductsValue = allProductSales.reduce((sum, sale) => sum + parseFloat(sale.totalValue), 0);
            
            document.getElementById('monthProductsCount').textContent = monthProductsCount;
            document.getElementById('monthProductsValue').textContent = formatCurrency(monthProductsValue);
            document.getElementById('totalProductsSoldCount').textContent = totalProductsCount;
            document.getElementById('totalProductsSoldValue').textContent = formatCurrency(totalProductsValue);
        }

        // NOVO: Função para atualizar gráfico de vendas mensais
        function updateMonthlySalesChart() {
            const today = new Date();
            const currentYear = today.getFullYear();
            
            // Preparar dados para os últimos 6 meses
            const months = [];
            const servicesData = [];
            const productsData = [];
            
            for (let i = 5; i >= 0; i--) {
                const monthDate = new Date(currentYear, today.getMonth() - i, 1);
                const monthName = monthDate.toLocaleDateString('pt-PT', { month: 'short' });
                months.push(monthName);
                
                // Calcular vendas de serviços para este mês
                const monthServices = allServices.filter(service => {
                    const serviceDate = service.timestamp.toDate ? service.timestamp.toDate() : new Date(service.timestamp);
                    return serviceDate.getMonth() === monthDate.getMonth() && 
                           serviceDate.getFullYear() === monthDate.getFullYear();
                });
                
                const servicesValue = monthServices.reduce((sum, service) => sum + parseFloat(service.value), 0);
                servicesData.push(servicesValue);
                
                // Calcular vendas de produtos para este mês
                const monthProducts = allProductSales.filter(sale => {
                    const saleDate = sale.timestamp.toDate ? sale.timestamp.toDate() : new Date(sale.timestamp);
                    return saleDate.getMonth() === monthDate.getMonth() && 
                           saleDate.getFullYear() === monthDate.getFullYear();
                });
                
                const productsValue = monthProducts.reduce((sum, sale) => sum + parseFloat(sale.totalValue), 0);
                productsData.push(productsValue);
            }
            
            // Destruir gráfico anterior se existir
            const existingChart = Chart.getChart('monthlySalesChart');
            if (existingChart) {
                existingChart.destroy();
            }
            
            // Criar novo gráfico
            const ctx = document.getElementById('monthlySalesChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: months,
                    datasets: [
                        {
                            label: 'Serviços',
                            data: servicesData,
                            backgroundColor: '#26196b',
                            borderColor: '#26196b',
                            borderWidth: 1
                        },
                        {
                            label: 'Produtos',
                            data: productsData,
                            backgroundColor: '#17a2b8',
                            borderColor: '#17a2b8',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + formatCurrency(context.raw);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '€' + value;
                                }
                            }
                        }
                    }
                }
            });
        }

        function calculatePeriodSales() {
            const today = new Date();
            const startOfWeek = new Date(today);
            // CORREÇÃO: Iniciar a semana na segunda-feira
            const dayOfWeek = today.getDay();
            const diffToMonday = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
            startOfWeek.setDate(today.getDate() + diffToMonday);
            startOfWeek.setHours(0, 0, 0, 0);
            
            const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            
            let weekSales = 0;
            let weekServiceCount = 0;
            let monthSales = 0;
            let monthServiceCount = 0;
            
            allServices.forEach(service => {
                const serviceDate = service.timestamp.toDate ? service.timestamp.toDate() : new Date(service.timestamp);
                const serviceValue = parseFloat(service.value);
                
                // Vendas da semana (segunda a domingo)
                if (serviceDate >= startOfWeek) {
                    weekSales += serviceValue;
                    weekServiceCount++;
                }
                
                // Vendas do mês
                if (serviceDate >= startOfMonth) {
                    monthSales += serviceValue;
                    monthServiceCount++;
                }
            });
            
            document.getElementById('weekSales').textContent = formatCurrency(weekSales);
            document.getElementById('weekServices').textContent = `${weekServiceCount} serviços`;
            document.getElementById('monthSales').textContent = formatCurrency(monthSales);
            document.getElementById('monthServices').textContent = `${monthServiceCount} serviços`;
            document.getElementById('totalServices').textContent = allServices.length;
        }

        function updateCashierUI(isOpen) {
            const statusElement = document.getElementById('cashierStatus');
            const openBtn = document.getElementById('openCashierBtn');
            const closeBtn = document.getElementById('closeCashierBtn');
            const serviceForm = document.getElementById('serviceForm');
            const productSaleForm = document.getElementById('productSaleForm');
            
            if (isOpen) {
                statusElement.textContent = 'Aberto';
                statusElement.className = 'badge bg-success';
                openBtn.disabled = true;
                closeBtn.disabled = false;
                
                // Habilitar formulários
                serviceForm.querySelectorAll('input, select, textarea, button').forEach(element => {
                    element.disabled = false;
                });
                productSaleForm.querySelectorAll('input, select, textarea, button').forEach(element => {
                    element.disabled = false;
                });
                
                // Calcular valor atual do caixa
                const todayServicesValue = todayServices.reduce((total, service) => total + parseFloat(service.value), 0);
                const todayProductsValue = todayProductSales.reduce((total, sale) => total + parseFloat(sale.totalValue), 0);
                const currentCashValue = (currentCashier.initialValue || 0) + todayServicesValue + todayProductsValue;
                document.getElementById('currentCash').textContent = formatCurrency(currentCashValue);
            } else {
                statusElement.textContent = 'Fechado';
                statusElement.className = 'badge bg-danger';
                openBtn.disabled = false;
                closeBtn.disabled = true;
                
                // Desabilitar formulários
                serviceForm.querySelectorAll('input, select, textarea, button').forEach(element => {
                    if (element.id !== 'openCashierBtn') {
                        element.disabled = true;
                    }
                });
                productSaleForm.querySelectorAll('input, select, textarea, button').forEach(element => {
                    element.disabled = true;
                });
                
                document.getElementById('currentCash').textContent = '€ 0,00';
            }
        }

        function updateTodaySalesUI() {
            const container = document.getElementById('todaySalesList');
            
            if (todayServices.length === 0 && todayProductSales.length === 0) {
                container.innerHTML = '<p class="text-muted">Nenhuma venda registrada hoje.</p>';
                updateSummaryUI();
                return;
            }
            
            let html = '';
            let totalServicesValue = 0;
            let totalProductsValue = 0;
            let totalForCollaborators = 0;
            let collaboratorBreakdown = {};
            
            // Serviços
            todayServices.forEach(service => {
                const client = clients.find(c => c.id === service.clientId) || { name: 'Cliente não encontrado' };
                const collaborator = collaborators.find(c => c.id === service.collaboratorId) || { name: 'Colaborador não encontrado' };
                
                const serviceValue = parseFloat(service.value);
                totalServicesValue += serviceValue;
                
                let collaboratorPercent = 0;
                if (service.type === 'manual') {
                    collaboratorPercent = parseFloat(collaborator.manualPercent) || 0;
                } else if (service.type === 'product') {
                    collaboratorPercent = parseFloat(collaborator.productPercent) || 0;
                }
                
                const collaboratorValue = serviceValue * (collaboratorPercent / 100);
                totalForCollaborators += collaboratorValue;
                
                // Atualizar breakdown
                if (!collaboratorBreakdown[collaborator.id]) {
                    collaboratorBreakdown[collaborator.id] = {
                        name: collaborator.name,
                        total: 0,
                        toReceive: 0
                    };
                }
                collaboratorBreakdown[collaborator.id].total += serviceValue;
                collaboratorBreakdown[collaborator.id].toReceive += collaboratorValue;
                
                html += `
                    <div class="service-item mb-2">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="mb-1">${service.description}</h6>
                                <p class="mb-1 text-muted small">
                                    Cliente: ${client.name} | 
                                    Colaborador: ${collaborator.name} |
                                    Tipo: ${service.type === 'manual' ? 'Manual' : 'Com Produtos'}
                                </p>
                            </div>
                            <div class="text-end">
                                <strong class="text-success">${formatCurrency(serviceValue)}</strong>
                                <div>
                                    <small class="text-muted">Serviço</small>
                                    <button class="btn btn-sm btn-danger mt-1" onclick="deleteService('${service.id}')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            // Vendas de produtos
            todayProductSales.forEach(sale => {
                const product = products.find(p => p.id === sale.productId) || { name: 'Produto não encontrado' };
                const client = sale.clientId ? clients.find(c => c.id === sale.clientId) : null;
                
                const saleValue = parseFloat(sale.totalValue);
                totalProductsValue += saleValue;
                
                html += `
                    <div class="service-item mb-2">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="mb-1">${product.name}</h6>
                                <p class="mb-1 text-muted small">
                                    ${client ? `Cliente: ${client.name} | ` : ''}
                                    Quantidade: ${sale.quantity}
                                </p>
                            </div>
                            <div class="text-end">
                                <strong class="text-info">${formatCurrency(saleValue)}</strong>
                                <div>
                                    <small class="text-muted">Produto</small>
                                    <button class="btn btn-sm btn-danger mt-1" onclick="deleteProductSale('${sale.id}')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            updateSummaryUI(totalServicesValue, totalProductsValue, totalForCollaborators, collaboratorBreakdown);
            
            // Atualizar dashboard
            document.getElementById('todaySales').textContent = formatCurrency(totalServicesValue);
            document.getElementById('todayServices').textContent = `${todayServices.length} serviços`;
            document.getElementById('todayProducts').textContent = formatCurrency(totalProductsValue);
            document.getElementById('todayProductsCount').textContent = `${todayProductSales.length} produtos`;
        }

        function updateSummaryUI(totalServicesValue = 0, totalProductsValue = 0, totalForCollaborators = 0, collaboratorBreakdown = {}) {
            const totalSalesValue = totalServicesValue + totalProductsValue;
            
            document.getElementById('totalServicesCount').textContent = todayServices.length;
            document.getElementById('totalServicesValue').textContent = formatCurrency(totalServicesValue);
            document.getElementById('totalProductsCount').textContent = todayProductSales.length;
            document.getElementById('totalProductsValue').textContent = formatCurrency(totalProductsValue);
            document.getElementById('totalSalesValue').textContent = formatCurrency(totalSalesValue);
            document.getElementById('totalCollaboratorsValue').textContent = formatCurrency(totalForCollaborators);
            document.getElementById('totalCashierValue').textContent = formatCurrency(totalSalesValue - totalForCollaborators);
            
            const breakdownElement = document.getElementById('collaboratorBreakdown');
            if (Object.keys(collaboratorBreakdown).length === 0) {
                breakdownElement.innerHTML = '<p class="text-muted">Nenhum serviço registrado.</p>';
            } else {
                let html = '<strong>Detalhamento por Colaborador:</strong>';
                for (const collaboratorId in collaboratorBreakdown) {
                    const breakdown = collaboratorBreakdown[collaboratorId];
                    html += `
                        <div class="mt-2 p-2 bg-light rounded">
                            <div class="d-flex justify-content-between">
                                <span>${breakdown.name}:</span>
                                <span>${formatCurrency(breakdown.toReceive)}</span>
                            </div>
                        </div>
                    `;
                }
                breakdownElement.innerHTML = html;
            }
        }

        function updateDashboard() {
            const todayServicesValue = todayServices.reduce((total, service) => total + parseFloat(service.value), 0);
            const todayProductsValue = todayProductSales.reduce((total, sale) => total + parseFloat(sale.totalValue), 0);
            
            document.getElementById('totalCollaborators').textContent = collaborators.filter(c => c.active).length;
            
            // Atualizar serviços recentes
            const recentContainer = document.getElementById('recentServicesList');
            if (todayServices.length === 0) {
                recentContainer.innerHTML = '<p class="text-muted">Nenhum serviço hoje.</p>';
            } else {
                let html = '';
                const recentServices = todayServices.slice(0, 5);
                recentServices.forEach(service => {
                    const client = clients.find(c => c.id === service.clientId) || { name: 'Cliente não encontrado' };
                    const collaborator = collaborators.find(c => c.id === service.collaboratorId) || { name: 'Colaborador não encontrado' };
                    
                    // Verificar se todos os campos obrigatórios estão preenchidos
                    const missingFields = [];
                    if (!service.clientId) missingFields.push('cliente');
                    if (!service.collaboratorId) missingFields.push('colaborador');
                    if (!service.value) missingFields.push('valor');
                    
                    let warningHtml = '';
                    if (missingFields.length > 0) {
                        warningHtml = `<div class="alert alert-warning p-1 mt-1"><small><i class="fas fa-exclamation-triangle me-1"></i>Faltam dados: ${missingFields.join(', ')}</small></div>`;
                    }
                    
                    html += `
                        <div class="service-item mb-2">
                            <div class="d-flex justify-content-between">
                                <span>${client.name}</span>
                                <span class="text-success">${formatCurrency(service.value)}</span>
                            </div>
                            <small class="text-muted">${service.description} - ${collaborator.name}</small>
                            ${warningHtml}
                        </div>
                    `;
                });
                recentContainer.innerHTML = html;
            }
            
            // Carregar aniversários próximos (incluindo hoje)
            loadUpcomingBirthdays();
        }

        function updateInventoryUI() {
            const tbody = document.getElementById('inventoryTable');
            
            if (products.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">Nenhum produto cadastrado.</td></tr>';
                updateInventorySummary();
                return;
            }
            
            let html = '';
            let totalValue = 0;
            let totalInvestment = 0;
            let lowStockCount = 0;
            
            products.forEach(product => {
                const isLowStock = product.quantity <= product.minQuantity;
                const stockValue = product.quantity * parseFloat(product.salePrice);
                const investmentValue = product.quantity * parseFloat(product.purchasePrice);
                
                totalValue += stockValue;
                totalInvestment += investmentValue;
                
                if (isLowStock) {
                    lowStockCount++;
                }
                
                html += `
                    <tr class="${isLowStock ? 'low-stock' : ''}">
                        <td>${product.name}</td>
                        <td>${product.quantity}</td>
                        <td>${product.minQuantity}</td>
                        <td>${formatCurrency(product.purchasePrice)}</td>
                        <td>${formatCurrency(product.salePrice)}</td>
                        <td>
                            <span class="badge ${isLowStock ? 'bg-danger' : 'bg-success'}">
                                ${isLowStock ? 'Estoque Baixo' : 'Normal'}
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-primary me-1" onclick="editProduct('${product.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteProduct('${product.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
            updateInventorySummary(products.length, lowStockCount, totalValue, totalInvestment);
        }

        function updateInventorySummary(totalProducts, lowStockCount, totalValue, totalInvestment) {
            document.getElementById('totalProducts').textContent = totalProducts;
            document.getElementById('lowStockProducts').textContent = lowStockCount;
            document.getElementById('totalInventoryValue').textContent = formatCurrency(totalValue);
            document.getElementById('totalInvestment').textContent = formatCurrency(totalInvestment);
            
            // Atualizar alertas
            const alertsContainer = document.getElementById('inventoryAlerts');
            if (lowStockCount === 0) {
                alertsContainer.innerHTML = '<p class="text-muted">Nenhum alerta no momento.</p>';
            } else {
                let html = '';
                products.filter(p => p.quantity <= p.minQuantity).forEach(product => {
                    html += `
                        <div class="alert alert-warning p-2 mb-2">
                            <div class="d-flex justify-content-between align-items-center">
                                <span>${product.name}</span>
                                <span class="badge bg-danger">${product.quantity} restantes</span>
                            </div>
                        </div>
                    `;
                });
                alertsContainer.innerHTML = html;
            }
        }

        function checkLowStock() {
            const lowStockProducts = products.filter(p => p.quantity <= p.minQuantity);
            
            if (lowStockProducts.length > 0) {
                // Mostrar alerta no dashboard
                document.getElementById('lowStockAlertsContainer').style.display = 'block';
                
                // Alerta compacto - apenas contagem
                let html = `
                    <p class="mb-0"><strong>${lowStockProducts.length} produto(s) com estoque baixo</strong></p>
                    <p class="mb-0 text-muted small">Toque para ver detalhes</p>
                `;
                document.getElementById('lowStockAlerts').innerHTML = html;
                
                // Detalhes dos produtos com estoque baixo
                let detailsHtml = '';
                lowStockProducts.forEach(product => {
                    detailsHtml += `
                        <div class="alert alert-danger p-2 mb-2">
                            <div class="d-flex justify-content-between align-items-center">
                                <span><i class="fas fa-exclamation-triangle me-2"></i>${product.name}</span>
                                <span class="badge bg-dark">${product.quantity} restantes (mínimo: ${product.minQuantity})</span>
                            </div>
                        </div>
                    `;
                });
                document.getElementById('lowStockDetails').innerHTML = detailsHtml;
                
                // Mostrar alerta popup se for a primeira vez que verifica hoje
                const today = new Date().toISOString().split('T')[0];
                const lastAlert = localStorage.getItem('lastStockAlert');
                
                if (lastAlert !== today) {
                    showError(`ATENÇÃO: ${lowStockProducts.length} produto(s) com estoque baixo! Verifique a aba de Estoque.`);
                    localStorage.setItem('lastStockAlert', today);
                }
            } else {
                document.getElementById('lowStockAlertsContainer').style.display = 'none';
            }
        }

        function updateClientsUI() {
            const tbody = document.getElementById('clientsTable');
            
            if (clients.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Nenhum cliente cadastrado.</td></tr>';
                return;
            }
            
            let html = '';
            clients.forEach(client => {
                html += `
                    <tr>
                        <td>${client.name}</td>
                        <td>${formatDate(client.birthdate)}</td>
                        <td>${client.phone}</td>
                        <td>${client.email || '-'}</td>
                        <td>
                            <button class="btn btn-sm btn-primary me-1" onclick="editClient('${client.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteClient('${client.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            tbody.innerHTML = html;
        }

        function updateCollaboratorsUI() {
            const tbody = document.getElementById('collaboratorsTable');
            
            if (collaborators.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted">Nenhum colaborador cadastrado.</td></tr>';
                return;
            }
            
            let html = '';
            collaborators.forEach(collaborator => {
                const photoUrl = collaborator.photoUrl || '';
                const photoHtml = photoUrl ? 
                    `<img src="${photoUrl}" class="rounded-circle" width="40" height="40" alt="${collaborator.name}">` :
                    `<div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">${collaborator.name.charAt(0).toUpperCase()}</div>`;
                
                html += `
                    <tr>
                        <td>${photoHtml}</td>
                        <td>${collaborator.name}</td>
                        <td>${collaborator.specialty || 'Não informado'}</td>
                        <td>${collaborator.contact || 'Não informado'}</td>
                        <td>${collaborator.manualPercent}%</td>
                        <td>${collaborator.productPercent}%</td>
                        <td>${formatCurrency(collaborator.baseSalary || 0)}</td>
                        <td>
                            <span class="badge ${collaborator.active ? 'bg-success' : 'bg-secondary'}">
                                ${collaborator.active ? 'Ativo' : 'Inativo'}
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-info me-1" onclick="showCollaboratorProfile('${collaborator.id}')">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-primary me-1" onclick="editCollaborator('${collaborator.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteCollaborator('${collaborator.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
            
            document.getElementById('totalCollaborators').textContent = collaborators.filter(c => c.active).length;
        }

        function updatePackagesUI() {
            const container = document.getElementById('packagesList');
            const activePackages = packages.filter(p => p.status !== 'finished');
            const totalValue = activePackages.reduce((sum, pkg) => sum + parseFloat(pkg.value), 0);
            
            // Atualizar resumo
            document.getElementById('totalActivePackages').textContent = activePackages.length;
            document.getElementById('totalPackagesValue').textContent = formatCurrency(totalValue);
            
            // Contar próximos procedimentos (datas futuras não realizadas)
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            let nextProcedures = 0;
            
            activePackages.forEach(pkg => {
                if (pkg.procedureDates) {
                    pkg.procedureDates.forEach(dateObj => {
                        const procedureDate = new Date(dateObj.date);
                        procedureDate.setHours(0, 0, 0, 0);
                        if (!dateObj.completed && procedureDate >= today) {
                            nextProcedures++;
                        }
                    });
                }
            });
            
            document.getElementById('nextProceduresCount').textContent = nextProcedures;
            
            if (activePackages.length === 0) {
                container.innerHTML = '<p class="text-muted">Nenhum pacote ativo.</p>';
                return;
            }
            
            let html = '';
            activePackages.forEach(pkg => {
                const client = clients.find(c => c.id === pkg.clientId) || { name: 'Cliente não encontrado' };
                const completedProcedures = pkg.procedureDates ? pkg.procedureDates.filter(d => d.completed).length : 0;
                const totalProcedures = pkg.totalProcedures || 0;
                const progress = totalProcedures > 0 ? (completedProcedures / totalProcedures) * 100 : 0;
                
                let statusClass = 'package-pending';
                if (pkg.status === 'finished') {
                    statusClass = 'package-finished';
                } else if (completedProcedures === totalProcedures) {
                    statusClass = 'package-completed';
                }
                
                html += `
                    <div class="service-item ${statusClass} mb-3">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <h6 class="mb-1">${client.name} - ${pkg.description || 'Pacote'}</h6>
                                <p class="mb-1"><strong>Valor:</strong> ${formatCurrency(pkg.value)}</p>
                                <p class="mb-1"><strong>Progresso:</strong> ${completedProcedures}/${totalProcedures} procedimentos</p>
                                <div class="progress mb-2" style="height: 8px;">
                                    <div class="progress-bar" role="progressbar" style="width: ${progress}%"></div>
                                </div>
                                ${pkg.procedureDates ? `
                                    <div class="procedure-dates">
                                        <strong>Datas dos Procedimentos:</strong>
                                        <div class="mt-1">
                                            ${pkg.procedureDates.map((dateObj, index) => {
                                                const date = new Date(dateObj.date);
                                                const isCompleted = dateObj.completed;
                                                const isToday = new Date().toDateString() === date.toDateString();
                                                const statusClass = isCompleted ? 'date-status-completed' : 'date-status-pending';
                                                const statusText = isCompleted ? '✓ Realizado' : (isToday ? 'Hoje' : 'Pendente');
                                                return `
                                                    <small class="d-block ${statusClass}">
                                                        ${formatDate(dateObj.date)} - ${statusText}
                                                    </small>
                                                `;
                                            }).join('')}
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                            <div class="text-end">
                                <button class="btn btn-sm btn-success mb-1" onclick="markProcedureDone('${pkg.id}')">
                                    <i class="fas fa-check me-1"></i> Procedimento
                                </button>
                                <button class="btn btn-sm btn-warning mb-1" onclick="editPackage('${pkg.id}')">
                                    <i class="fas fa-edit me-1"></i> Editar
                                </button>
                                <button class="btn btn-sm btn-info mb-1" onclick="finishPackage('${pkg.id}', '${client.name}')">
                                    <i class="fas fa-flag-checkered me-1"></i> Finalizar
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deletePackage('${pkg.id}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function updateCollaboratorSelect() {
            const select = document.getElementById('collaboratorSelect');
            select.innerHTML = '<option value="">Selecione um colaborador</option>';
            
            collaborators.filter(c => c.active).forEach(collaborator => {
                const option = document.createElement('option');
                option.value = collaborator.id;
                option.textContent = collaborator.name;
                select.appendChild(option);
            });
        }

        function updateSalaryCollaboratorSelect() {
            const select = document.getElementById('salaryCollaborator');
            select.innerHTML = '<option value="">Selecione um colaborador</option>';
            
            collaborators.filter(c => c.active).forEach(collaborator => {
                const option = document.createElement('option');
                option.value = collaborator.id;
                option.textContent = collaborator.name;
                select.appendChild(option);
            });
        }

        function updateReportCollaboratorSelect() {
            const select = document.getElementById('reportCollaborator');
            select.innerHTML = '<option value="all">Todos</option>';
            
            collaborators.filter(c => c.active).forEach(collaborator => {
                const option = document.createElement('option');
                option.value = collaborator.id;
                option.textContent = collaborator.name;
                select.appendChild(option);
            });
        }

        // ============================================================
        // FUNÇÕES DO CONTROLE FINANCEIRO - VERSÃO 3.0 (SEPARADO POR CAIXAS)
        // ============================================================

        // Função para atualizar interface de despesas
        function updateExpensesUI() {
            // Popular seletor de meses
            updateMonthSelector('expensesMonth');
            
            // Carregar despesas do mês atual
            loadExpensesByMonth();
        }

        // Função para atualizar interface de salários
        function updateSalariesUI() {
            // Popular seletor de meses
            updateMonthSelector('salariesMonth');
            
            // Carregar salários do mês atual
            loadSalariesByMonth();
        }

        // Função para atualizar seletor de meses
        function updateMonthSelector(selectorId) {
            const select = document.getElementById(selectorId);
            select.innerHTML = '';
            
            const today = new Date();
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();
            
            // Adicionar 12 meses (6 passados e 6 futuros)
            for (let i = -6; i <= 6; i++) {
                const month = new Date(currentYear, currentMonth + i, 1);
                const monthValue = month.getFullYear() + '-' + String(month.getMonth() + 1).padStart(2, '0');
                const monthName = month.toLocaleDateString('pt-PT', { month: 'long', year: 'numeric' });
                const option = document.createElement('option');
                option.value = monthValue;
                option.textContent = monthName.charAt(0).toUpperCase() + monthName.slice(1);
                
                if (i === 0) {
                    option.selected = true;
                }
                
                select.appendChild(option);
            }
        }

        // Função para carregar despesas por mês
        function loadExpensesByMonth() {
            const monthValue = document.getElementById('expensesMonth').value;
            const [year, month] = monthValue.split('-').map(Number);
            
            const startDate = new Date(year, month - 1, 1);
            const endDate = new Date(year, month, 0);
            
            const monthExpenses = expenses.filter(expense => {
                const expenseDate = new Date(expense.dueDate);
                return expenseDate >= startDate && expenseDate <= endDate;
            });
            
            displayExpenses(monthExpenses);
        }

        // Função para carregar salários por mês
        function loadSalariesByMonth() {
            const monthValue = document.getElementById('salariesMonth').value;
            const [year, month] = monthValue.split('-').map(Number);
            
            const monthSalaries = salaryPayments.filter(salary => {
                const salaryMonth = salary.month;
                const [salaryYear, salaryMonthNum] = salaryMonth.split('-').map(Number);
                return salaryYear === year && salaryMonthNum === month;
            });
            
            displaySalaries(monthSalaries);
        }

        // Função para exibir despesas
        function displayExpenses(monthExpenses) {
            const container = document.getElementById('expensesList');
            
            if (monthExpenses.length === 0) {
                container.innerHTML = '<p class="text-muted">Nenhuma despesa registrada para este mês.</p>';
                return;
            }
            
            // Ordenar por data de vencimento
            monthExpenses.sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));
            
            let html = '';
            monthExpenses.forEach(expense => {
                const dueDate = new Date(expense.dueDate);
                const today = new Date();
                const daysDiff = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
                
                let statusClass = '';
                let statusText = '';
                
                if (expense.paid) {
                    statusClass = 'paid';
                    statusText = '<span class="status-paid">PAGO</span>';
                } else if (dueDate < today) {
                    statusClass = 'overdue';
                    statusText = '<span class="status-overdue">VENCIDO</span>';
                } else if (daysDiff <= 3) {
                    statusClass = 'due-soon';
                    statusText = '<span class="status-pending">A VENCER</span>';
                } else {
                    statusClass = '';
                    statusText = '<span class="status-pending">PENDENTE</span>';
                }
                
                html += `
                    <div class="expense-item ${statusClass} mb-2">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <h6 class="mb-1">${expense.description}</h6>
                                <p class="mb-1 text-muted small">
                                    Categoria: ${getExpenseCategoryName(expense.category)} | 
                                    Vencimento: ${formatDate(expense.dueDate)}
                                    ${expense.recurring ? ' <i class="fas fa-redo-alt expense-recurring-icon"></i> Recorrente' : ''}
                                </p>
                                ${expense.notes ? `<p class="mb-1 small">${expense.notes}</p>` : ''}
                            </div>
                            <div class="text-end">
                                <strong class="text-danger">${formatCurrency(expense.value)}</strong>
                                <div class="mt-1">
                                    ${statusText}
                                    ${!expense.paid ? `
                                        <button class="btn btn-sm btn-success ms-2" onclick="markExpenseAsPaid('${expense.id}')">
                                            <i class="fas fa-check"></i>
                                        </button>
                                    ` : ''}
                                    <button class="btn btn-sm btn-danger ms-1" onclick="deleteExpense('${expense.id}')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // Função para exibir salários
        function displaySalaries(monthSalaries) {
            const container = document.getElementById('salariesList');
            
            if (monthSalaries.length === 0) {
                container.innerHTML = '<p class="text-muted">Nenhum pagamento de salário registrado para este mês.</p>';
                return;
            }
            
            let html = '';
            let totalSalaries = 0;
            
            monthSalaries.forEach(salary => {
                const collaborator = collaborators.find(c => c.id === salary.collaboratorId) || { name: 'Colaborador não encontrado' };
                const total = (parseFloat(salary.baseValue) || 0) + (parseFloat(salary.bonus) || 0) - (parseFloat(salary.deductions) || 0);
                totalSalaries += total;
                
                html += `
                    <div class="salary-item mb-2">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <h6 class="mb-1">${collaborator.name}</h6>
                                <p class="mb-1 text-muted small">
                                    Mês: ${salary.month} | 
                                    Pagamento: ${formatDate(salary.paymentDate)} | 
                                    Método: ${getPaymentMethodName(salary.paymentMethod)}
                                </p>
                                <p class="mb-1 small">
                                    Base: ${formatCurrency(salary.baseValue)} | 
                                    Bônus: ${formatCurrency(salary.bonus || 0)} | 
                                    Descontos: ${formatCurrency(salary.deductions || 0)}
                                </p>
                                ${salary.notes ? `<p class="mb-1 small">${salary.notes}</p>` : ''}
                            </div>
                            <div class="text-end">
                                <strong class="text-warning">${formatCurrency(total)}</strong>
                                <div class="mt-1">
                                    <span class="status-paid">PAGO</span>
                                    <button class="btn btn-sm btn-danger ms-1" onclick="deleteSalaryPayment('${salary.id}')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            // Adicionar total
            html += `
                <div class="mt-3 pt-2 border-top">
                    <div class="d-flex justify-content-between">
                        <strong>Total da Folha:</strong>
                        <strong class="text-warning">${formatCurrency(totalSalaries)}</strong>
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }

        // Função para obter nome da categoria de despesa
        function getExpenseCategoryName(category) {
            const categories = {
                'aluguel': 'Aluguel',
                'energia': 'Energia',
                'agua': 'Água',
                'internet': 'Internet',
                'produtos': 'Produtos/Estoque',
                'manutencao': 'Manutenção',
                'marketing': 'Marketing',
                'impostos': 'Impostos',
                'outros': 'Outros'
            };
            return categories[category] || category;
        }

        // Função para obter nome do método de pagamento
        function getPaymentMethodName(method) {
            const methods = {
                'dinheiro': 'Dinheiro',
                'transferencia': 'Transferência',
                'cheque': 'Cheque'
            };
            return methods[method] || method;
        }

        // ============================================================
        // FUNÇÃO PRINCIPAL DO RESUMO FINANCEIRO - VERSÃO 3.0
        // ============================================================

        function updateFinancialSummary() {
            const today = new Date();
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();
            
            // 1. CALCULAR RECEITA DE SERVIÇOS (apenas serviços prestados)
            const monthServicesRevenue = allServices
                .filter(service => {
                    const serviceDate = service.timestamp.toDate ? service.timestamp.toDate() : new Date(service.timestamp);
                    return serviceDate.getMonth() === currentMonth && serviceDate.getFullYear() === currentYear;
                })
                .reduce((sum, service) => sum + parseFloat(service.value), 0);
            
            // 2. CALCULAR RECEITA DE PRODUTOS (apenas produtos vendidos)
            const monthProductsRevenue = allProductSales
                .filter(sale => {
                    const saleDate = sale.timestamp.toDate ? sale.timestamp.toDate() : new Date(sale.timestamp);
                    return saleDate.getMonth() === currentMonth && saleDate.getFullYear() === currentYear;
                })
                .reduce((sum, sale) => sum + parseFloat(sale.totalValue), 0);
            
            // 3. CALCULAR CUSTO DOS PRODUTOS VENDIDOS
            const monthProductsCost = allProductSales
                .filter(sale => {
                    const saleDate = sale.timestamp.toDate ? sale.timestamp.toDate() : new Date(sale.timestamp);
                    return saleDate.getMonth() === currentMonth && saleDate.getFullYear() === currentYear;
                })
                .reduce((sum, sale) => {
                    const product = products.find(p => p.id === sale.productId);
                    if (product) {
                        // Custo = quantidade vendida * preço de compra
                        return sum + (sale.quantity * parseFloat(product.purchasePrice));
                    }
                    return sum;
                }, 0);
            
            // 4. CALCULAR DESPESAS PAGAS (somente afetam o caixa de serviços)
            const monthServicesExpenses = expenses
                .filter(expense => {
                    const expenseDate = new Date(expense.dueDate);
                    return expenseDate.getMonth() === currentMonth && 
                           expenseDate.getFullYear() === currentYear && 
                           expense.paid;
                })
                .reduce((sum, expense) => sum + parseFloat(expense.value), 0);
            
            // 5. CALCULAR DESPESAS PENDENTES (não afetam o caixa final, apenas são mostradas como compromisso)
            const monthServicesPendingExpenses = expenses
                .filter(expense => {
                    const expenseDate = new Date(expense.dueDate);
                    return expenseDate.getMonth() === currentMonth && 
                           expenseDate.getFullYear() === currentYear && 
                           !expense.paid;
                })
                .reduce((sum, expense) => sum + parseFloat(expense.value), 0);
            
            // 6. CALCULAR FOLHA DE PAGAMENTO (afeta apenas o caixa de serviços)
            const monthServicesSalaries = salaryPayments
                .filter(salary => {
                    const [year, month] = salary.month.split('-').map(Number);
                    return month === currentMonth + 1 && year === currentYear;
                })
                .reduce((sum, salary) => {
                    const base = parseFloat(salary.baseValue) || 0;
                    const bonus = parseFloat(salary.bonus) || 0;
                    const deductions = parseFloat(salary.deductions) || 0;
                    return sum + base + bonus - deductions;
                }, 0);
            
            // 7. CALCULAR DESPESAS RECORRENTES (independente de pagamento)
            const recurringExpensesTotal = expenses
                .filter(expense => expense.recurring)
                .reduce((sum, expense) => sum + parseFloat(expense.value), 0);
            
            // 8. CALCULAR LUCRO DOS PRODUTOS (Receita - Custo)
            const monthProductsProfit = monthProductsRevenue - monthProductsCost;
            
            // 9. CALCULAR SALDO FINAL DE SERVIÇOS (Receita - Despesas Pagas - Salários)
            const servicesFinalCash = monthServicesRevenue - monthServicesExpenses - monthServicesSalaries;
            
            // 10. CALCULAR SALDO FINAL DE PRODUTOS (Lucro dos Produtos)
            const productsFinalCash = monthProductsProfit;
            
            // 11. CALCULAR TOTAL GERAL
            const totalRevenue = monthServicesRevenue + monthProductsRevenue;
            const totalExpenses = monthServicesExpenses + monthServicesSalaries;
            const totalProfit = servicesFinalCash + productsFinalCash;
            const totalFinalCash = servicesFinalCash + productsFinalCash;
            
            // ============================================================
            // ATUALIZAR A INTERFACE DO USUÁRIO
            // ============================================================
            
            // Caixa de Serviços
            document.getElementById('servicesRevenue').textContent = formatCurrency(monthServicesRevenue);
            document.getElementById('servicesExpenses').textContent = formatCurrency(monthServicesExpenses);
            document.getElementById('servicesPendingExpenses').textContent = formatCurrency(monthServicesPendingExpenses);
            document.getElementById('servicesFinalCash').textContent = formatCurrency(servicesFinalCash);
            document.getElementById('servicesFinalCash').className = servicesFinalCash >= 0 ? 'cash-box-amount positive-value' : 'cash-box-amount negative-value';
            
            // Caixa de Produtos
            document.getElementById('productsRevenue').textContent = formatCurrency(monthProductsRevenue);
            document.getElementById('productsCost').textContent = formatCurrency(monthProductsCost);
            document.getElementById('productsProfit').textContent = formatCurrency(monthProductsProfit);
            document.getElementById('productsProfit').className = monthProductsProfit >= 0 ? 'cash-box-amount positive-value' : 'cash-box-amount negative-value';
            document.getElementById('productsFinalCash').textContent = formatCurrency(productsFinalCash);
            document.getElementById('productsFinalCash').className = productsFinalCash >= 0 ? 'cash-box-amount positive-value' : 'cash-box-amount negative-value';
            
            // Resumo Geral
            document.getElementById('totalRevenue').textContent = formatCurrency(totalRevenue);
            document.getElementById('totalExpenses').textContent = formatCurrency(totalExpenses);
            document.getElementById('totalProfit').textContent = formatCurrency(totalProfit);
            document.getElementById('totalProfit').className = totalProfit >= 0 ? 'summary-value positive-value' : 'summary-value negative-value';
            document.getElementById('totalFinalCash').textContent = formatCurrency(totalFinalCash);
            document.getElementById('totalFinalCash').className = totalFinalCash >= 0 ? 'summary-value positive-value' : 'summary-value negative-value';
            
            // Cálculo Detalhado
            document.getElementById('calculationServicesRevenue').textContent = formatCurrency(monthServicesRevenue);
            document.getElementById('calculationServicesExpenses').textContent = formatCurrency(monthServicesExpenses);
            document.getElementById('calculationServicesBalance').textContent = formatCurrency(servicesFinalCash);
            document.getElementById('calculationServicesBalance').className = servicesFinalCash >= 0 ? 'positive-value' : 'negative-value';
            
            document.getElementById('calculationProductsRevenue').textContent = formatCurrency(monthProductsRevenue);
            document.getElementById('calculationProductsCost').textContent = formatCurrency(monthProductsCost);
            document.getElementById('calculationProductsBalance').textContent = formatCurrency(productsFinalCash);
            document.getElementById('calculationProductsBalance').className = productsFinalCash >= 0 ? 'positive-value' : 'negative-value';
            
            document.getElementById('calculationTotalCash').textContent = formatCurrency(totalFinalCash);
            document.getElementById('calculationTotalCash').className = totalFinalCash >= 0 ? 'positive-value' : 'negative-value';
            
            // Caixa Final Display
            document.getElementById('finalCashDisplay').textContent = `Caixa Total Final: ${formatCurrency(totalFinalCash)}`;
            document.getElementById('finalCashDisplay').className = totalFinalCash >= 0 ? 'final-cash-display positive-value' : 'final-cash-display negative-value';
            
            // Outros indicadores
            document.getElementById('pendingExpenses').textContent = formatCurrency(monthServicesPendingExpenses);
            document.getElementById('recurringExpenses').textContent = formatCurrency(recurringExpensesTotal);
            document.getElementById('netProfit').textContent = formatCurrency(totalProfit);
            document.getElementById('netProfit').className = totalProfit >= 0 ? 'summary-value positive-value' : 'summary-value negative-value';
            
            // Atualizar gráfico de despesas
            updateExpenseChart();
            
            // Atualizar próximos vencimentos
            loadUpcomingDueExpenses();
        }

        // Função para atualizar gráfico de despesas
        function updateExpenseChart() {
            const ctx = document.getElementById('expenseChart').getContext('2d');
            
            // Agrupar despesas por categoria (apenas as pagas)
            const categories = {};
            expenses.forEach(expense => {
                if (expense.paid) {
                    const category = getExpenseCategoryName(expense.category);
                    if (!categories[category]) {
                        categories[category] = 0;
                    }
                    categories[category] += parseFloat(expense.value);
                }
            });
            
            // Preparar dados para o gráfico
            const labels = Object.keys(categories);
            const data = Object.values(categories);
            
            // Cores para as categorias
            const backgroundColors = [
                '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', 
                '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF'
            ];
            
            // Destruir gráfico anterior se existir
            if (expenseChart) {
                expenseChart.destroy();
            }
            
            // Criar novo gráfico
            expenseChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: backgroundColors.slice(0, labels.length),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                boxWidth: 12,
                                padding: 15
                            }
                        }
                    }
                }
            });
        }

        // Função para carregar próximos vencimentos
        function loadUpcomingDueExpenses() {
            const container = document.getElementById('upcomingDueList');
            const today = new Date();
            const nextWeek = new Date();
            nextWeek.setDate(today.getDate() + 7);
            
            const upcomingExpenses = expenses
                .filter(expense => !expense.paid)
                .filter(expense => {
                    const dueDate = new Date(expense.dueDate);
                    return dueDate >= today && dueDate <= nextWeek;
                })
                .sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate))
                .slice(0, 5); // Limitar a 5 despesas
            
            if (upcomingExpenses.length === 0) {
                container.innerHTML = '<p class="text-muted">Nenhum vencimento próximo.</p>';
                return;
            }
            
            let html = '';
            upcomingExpenses.forEach(expense => {
                const dueDate = new Date(expense.dueDate);
                const daysDiff = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
                
                let statusClass = daysDiff <= 1 ? 'status-overdue' : 'status-pending';
                let statusText = daysDiff <= 1 ? 'AMANHÃ' : `EM ${daysDiff} DIAS`;
                
                html += `
                    <div class="mb-2 p-2 border rounded">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <small><strong>${expense.description}</strong></small><br>
                                <small class="text-muted">${formatDate(expense.dueDate)}</small>
                                ${expense.recurring ? '<br><small class="recurring-expense-note"><i class="fas fa-redo-alt"></i> Recorrente</small>' : ''}
                            </div>
                            <div class="text-end">
                                <small class="text-danger">${formatCurrency(expense.value)}</small><br>
                                <small class="${statusClass}">${statusText}</small>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // ============================================================
        // FUNÇÕES PARA SALVAR DADOS FINANCEIROS
        // ============================================================

        // Função para salvar despesa
        function saveExpense(e) {
            e.preventDefault();
            
            const description = document.getElementById('expenseDescription').value;
            const category = document.getElementById('expenseCategory').value;
            const value = parseFloat(document.getElementById('expenseValue').value);
            const dueDate = document.getElementById('expenseDueDate').value;
            const notes = document.getElementById('expenseNotes').value;
            const recurring = document.getElementById('expenseRecurring').checked;
            
            if (!description || !category || !value || !dueDate) {
                showError('Por favor, preencha todos os campos obrigatórios.');
                return;
            }
            
            const expenseData = {
                description: description,
                category: category,
                value: value,
                dueDate: dueDate,
                notes: notes,
                recurring: recurring,
                paid: false, // Sempre começa como pendente
                userId: currentUser.uid,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            showLoading('Salvando despesa...');
            
            db.collection('expenses').add(expenseData)
                .then(() => {
                    document.getElementById('expenseForm').reset();
                    loadExpenses(); // Recarregar todas as despesas
                    showSuccess('Despesa registrada com sucesso!');
                })
                .catch((error) => {
                    console.error('Erro ao salvar despesa:', error);
                    showError('Erro ao salvar despesa: ' + error.message);
                });
        }

        // Função para salvar pagamento de salário
        function saveSalaryPayment(e) {
            e.preventDefault();
            
            const collaboratorId = document.getElementById('salaryCollaborator').value;
            const month = document.getElementById('salaryMonth').value;
            const baseValue = parseFloat(document.getElementById('salaryBaseValue').value);
            const bonus = parseFloat(document.getElementById('salaryBonus').value) || 0;
            const deductions = parseFloat(document.getElementById('salaryDeductions').value) || 0;
            const paymentDate = document.getElementById('salaryPaymentDate').value;
            const paymentMethod = document.getElementById('salaryPaymentMethod').value;
            const notes = document.getElementById('salaryNotes').value;
            
            if (!collaboratorId || !month || !baseValue || !paymentDate || !paymentMethod) {
                showError('Por favor, preencha todos os campos obrigatórios.');
                return;
            }
            
            const salaryData = {
                collaboratorId: collaboratorId,
                month: month,
                baseValue: baseValue,
                bonus: bonus,
                deductions: deductions,
                paymentDate: paymentDate,
                paymentMethod: paymentMethod,
                notes: notes,
                totalValue: baseValue + bonus - deductions,
                userId: currentUser.uid,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            showLoading('Registrando pagamento de salário...');
            
            db.collection('salaryPayments').add(salaryData)
                .then(() => {
                    document.getElementById('salaryPaymentForm').reset();
                    loadSalaryPayments(); // Recarregar todos os salários
                    showSuccess('Pagamento de salário registrado com sucesso!');
                })
                .catch((error) => {
                    console.error('Erro ao salvar pagamento de salário:', error);
                    showError('Erro ao salvar pagamento de salário: ' + error.message);
                });
        }

        // Função para marcar despesa como paga (automaticamente deduz do caixa de serviços)
        function markExpenseAsPaid(expenseId) {
            db.collection('expenses').doc(expenseId).update({
                paid: true,
                paidAt: firebase.firestore.FieldValue.serverTimestamp()
            })
            .then(() => {
                loadExpenses(); // Recarregar para atualizar o resumo financeiro
                showSuccess('Despesa marcada como paga! O valor foi deduzido do caixa de serviços.');
            })
            .catch((error) => {
                console.error('Erro ao marcar despesa como paga:', error);
                showError('Erro ao marcar despesa como paga: ' + error.message);
            });
        }

        // Função para excluir despesa
        function deleteExpense(expenseId) {
            Swal.fire({
                title: 'Tem certeza?',
                text: "Esta ação não pode ser desfeita!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Sim, excluir!',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    db.collection('expenses').doc(expenseId).delete()
                        .then(() => {
                            loadExpenses();
                            showSuccess('Despesa excluída com sucesso!');
                        })
                        .catch((error) => {
                            showError('Erro ao excluir despesa: ' + error.message);
                        });
                }
            });
        }

        // Função para excluir pagamento de salário
        function deleteSalaryPayment(salaryId) {
            Swal.fire({
                title: 'Tem certeza?',
                text: "Esta ação não pode ser desfeita!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Sim, excluir!',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    db.collection('salaryPayments').doc(salaryId).delete()
                        .then(() => {
                            loadSalaryPayments();
                            showSuccess('Pagamento de salário excluído com sucesso!');
                        })
                        .catch((error) => {
                            showError('Erro ao excluir pagamento de salário: ' + error.message);
                        });
                }
            });
        }

        // ============================================================
        // FUNÇÕES AUXILIARES DO SISTEMA (PERMANECEM IGUAIS)
        // ============================================================

        function handleCollaboratorPhotoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!file.type.match('image.*')) {
                showError('Por favor, selecione uma imagem válida.');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const preview = document.getElementById('collaboratorPhotoPreview');
                const placeholder = document.getElementById('collaboratorPhotoPlaceholder');
                
                preview.src = e.target.result;
                preview.style.display = 'block';
                placeholder.style.display = 'none';
            };
            reader.readAsDataURL(file);
        }

        function showCollaboratorProfile(collaboratorId) {
            const collaborator = collaborators.find(c => c.id === collaboratorId);
            if (!collaborator) return;
            
            document.getElementById('collaboratorProfileName').textContent = collaborator.name;
            document.getElementById('collaboratorProfileSpecialty').textContent = collaborator.specialty || 'Sem especialidade definida';
            document.getElementById('collaboratorProfileDescription').textContent = collaborator.description || 'Sem descrição';
            document.getElementById('collaboratorProfileContact').textContent = collaborator.contact || 'Não informado';
            document.getElementById('collaboratorProfileManualPercent').textContent = collaborator.manualPercent;
            document.getElementById('collaboratorProfileProductPercent').textContent = collaborator.productPercent;
            document.getElementById('collaboratorProfileBaseSalary').textContent = formatCurrency(collaborator.baseSalary || 0);
            
            const statusElement = document.getElementById('collaboratorProfileStatus');
            statusElement.textContent = collaborator.active ? 'Ativo' : 'Inativo';
            statusElement.className = collaborator.active ? 'badge bg-success' : 'badge bg-secondary';
            
            const profileImage = document.getElementById('collaboratorProfileImage');
            if (collaborator.photoUrl) {
                profileImage.src = collaborator.photoUrl;
                profileImage.style.display = 'block';
            } else {
                profileImage.style.display = 'none';
            }
            
            const modal = new bootstrap.Modal(document.getElementById('collaboratorProfileModal'));
            modal.show();
        }

        function editPackage(packageId) {
            const pkg = packages.find(p => p.id === packageId);
            if (!pkg) return;
            
            document.getElementById('packageId').value = pkg.id;
            document.getElementById('packageClientSelect').value = pkg.clientId;
            document.getElementById('packageProcedures').value = pkg.totalProcedures;
            document.getElementById('packageFrequency').value = pkg.frequency;
            document.getElementById('packageStartDate').value = pkg.startDate;
            document.getElementById('packageValue').value = pkg.value;
            document.getElementById('packageDescription').value = pkg.description || '';
            
            // Configurar seleção de dias
            if (pkg.frequency > 1 && pkg.selectedDays) {
                document.getElementById('daysSelection').style.display = 'block';
                pkg.selectedDays.forEach(day => {
                    const checkbox = document.getElementById(`${day}Check`);
                    if (checkbox) {
                        checkbox.checked = true;
                    }
                });
            } else {
                document.getElementById('daysSelection').style.display = 'none';
            }
            
            // Atualizar botão
            document.getElementById('savePackageBtn').textContent = 'Atualizar Pacote';
            document.getElementById('cancelPackageEditBtn').style.display = 'block';
            
            showSuccess('Preencha os campos que deseja alterar e clique em "Atualizar Pacote"');
        }

        function cancelPackageEdit() {
            document.getElementById('packageForm').reset();
            document.getElementById('packageId').value = '';
            document.getElementById('daysSelection').style.display = 'none';
            document.getElementById('savePackageBtn').textContent = 'Criar Pacote';
            document.getElementById('cancelPackageEditBtn').style.display = 'none';
        }

        function savePackage(e) {
            e.preventDefault();
            
            const packageId = document.getElementById('packageId').value;
            const clientId = document.getElementById('packageClientSelect').value;
            const totalProcedures = parseInt(document.getElementById('packageProcedures').value);
            const frequency = parseInt(document.getElementById('packageFrequency').value);
            const startDate = document.getElementById('packageStartDate').value;
            const value = parseFloat(document.getElementById('packageValue').value);
            const description = document.getElementById('packageDescription').value;
            
            if (!clientId || !totalProcedures || !startDate || !value) {
                showError('Por favor, preencha todos os campos obrigatórios.');
                return;
            }
            
            // Verificar seleção de dias se frequência for maior que 1
            let selectedDays = [];
            if (frequency > 1) {
                const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
                selectedDays = days.filter(day => document.getElementById(`${day}Check`).checked);
                
                if (selectedDays.length !== frequency) {
                    showError(`Selecione exatamente ${frequency} dias da semana.`);
                    return;
                }
            }
            
            let promise;
            
            if (packageId) {
                // Atualizar pacote existente
                const packageData = {
                    clientId: clientId,
                    totalProcedures: totalProcedures,
                    frequency: frequency,
                    selectedDays: selectedDays,
                    startDate: startDate,
                    value: value,
                    description: description,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                promise = db.collection('packages').doc(packageId).update(packageData);
            } else {
                // Criar novo pacote
                // Gerar datas dos procedimentos
                const procedureDates = [];
                const start = new Date(startDate);
                
                if (frequency === 1) {
                    // Uma vez por semana
                    for (let i = 0; i < totalProcedures; i++) {
                        const procedureDate = new Date(start);
                        procedureDate.setDate(start.getDate() + (i * 7)); // Adiciona 7 dias para cada procedimento
                        procedureDates.push({
                            date: procedureDate.toISOString().split('T')[0],
                            completed: false
                        });
                    }
                } else {
                    // Múltiplas vezes por semana
                    let procedureCount = 0;
                    let currentDate = new Date(start);
                    
                    while (procedureCount < totalProcedures) {
                        const dayOfWeek = currentDate.getDay();
                        const dayNames = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
                        const currentDayName = dayNames[dayOfWeek];
                        
                        if (selectedDays.includes(currentDayName)) {
                            procedureDates.push({
                                date: currentDate.toISOString().split('T')[0],
                                completed: false
                            });
                            procedureCount++;
                        }
                        
                        currentDate.setDate(currentDate.getDate() + 1);
                        
                        // Limitar a um máximo de 365 dias para evitar loops infinitos
                        if (procedureCount >= totalProcedures || (currentDate - start) / (1000 * 60 * 60 * 24) > 365) {
                            break;
                        }
                    }
                }
                
                const packageData = {
                    clientId: clientId,
                    totalProcedures: totalProcedures,
                    frequency: frequency,
                    selectedDays: selectedDays,
                    startDate: startDate,
                    value: value,
                    description: description,
                    procedureDates: procedureDates,
                    status: 'active',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    userId: currentUser.uid
                };
                
                promise = db.collection('packages').add(packageData);
            }
            
            showLoading(packageId ? 'Atualizando pacote...' : 'Criando pacote...');
            
            promise
                .then(() => {
                    document.getElementById('packageForm').reset();
                    document.getElementById('daysSelection').style.display = 'none';
                    document.getElementById('packageId').value = '';
                    document.getElementById('savePackageBtn').textContent = 'Criar Pacote';
                    document.getElementById('cancelPackageEditBtn').style.display = 'none';
                    loadPackages();
                    showSuccess(packageId ? 'Pacote atualizado com sucesso!' : 'Pacote criado com sucesso!');
                })
                .catch((error) => {
                    console.error('Erro ao salvar pacote:', error);
                    showError('Erro ao salvar pacote: ' + error.message);
                });
        }

        function openCashier() {
            Swal.fire({
                title: 'Abrir Caixa',
                html: `
                    <input type="number" id="initialValue" class="swal2-input" placeholder="Valor inicial (€)" step="0.01" min="0" value="0">
                `,
                showCancelButton: true,
                confirmButtonText: 'Abrir',
                cancelButtonText: 'Cancelar',
                preConfirm: () => {
                    const initialValue = parseFloat(document.getElementById('initialValue').value);
                    if (isNaN(initialValue) || initialValue < 0) {
                        Swal.showValidationMessage('Digite um valor válido');
                    }
                    return initialValue;
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    const initialValue = result.value;
                    
                    const cashierData = {
                        date: new Date().toISOString().split('T')[0],
                        initialValue: initialValue,
                        openedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        userId: currentUser.uid,
                        status: 'open'
                    };
                    
                    db.collection('cashiers').add(cashierData)
                        .then((docRef) => {
                            currentCashier = {
                                id: docRef.id,
                                ...cashierData
                            };
                            updateCashierUI(true);
                            showSuccess('Caixa aberto com sucesso!');
                        })
                        .catch((error) => {
                            showError('Erro ao abrir caixa: ' + error.message);
                        });
                }
            });
        }

        function closeCashier() {
            if (!currentCashier) return;
            
            const totalServicesValue = todayServices.reduce((total, service) => total + parseFloat(service.value), 0);
            const totalProductsValue = todayProductSales.reduce((total, sale) => total + parseFloat(sale.totalValue), 0);
            const totalSales = totalServicesValue + totalProductsValue;
            const finalValue = currentCashier.initialValue + totalSales;
            
            db.collection('cashiers').doc(currentCashier.id).update({
                closedAt: firebase.firestore.FieldValue.serverTimestamp(),
                finalValue: finalValue,
                totalServices: totalServicesValue,
                totalProducts: totalProductsValue,
                servicesCount: todayServices.length,
                productsCount: todayProductSales.length,
                status: 'closed'
            })
            .then(() => {
                showSuccess('Caixa fechado com sucesso!');
                currentCashier = null;
                updateCashierUI(false);
            })
            .catch((error) => {
                showError('Erro ao fechar caixa: ' + error.message);
            });
        }

        function addService(e) {
            e.preventDefault();
            saveService(true);
        }

        function addAnotherService() {
            saveService(false);
        }

        function saveService(clearForm = true) {
            if (!currentCashier) {
                showError('É necessário abrir o caixa antes de adicionar serviços.');
                return;
            }
            
            const clientId = document.getElementById('selectedClientId').value;
            const collaboratorId = document.getElementById('collaboratorSelect').value;
            const serviceType = document.getElementById('serviceType').value;
            const serviceValue = parseFloat(document.getElementById('serviceValue').value);
            const serviceDescription = document.getElementById('serviceDescription').value;
            
            if (!clientId || !collaboratorId || !serviceType || !serviceValue) {
                showError('Por favor, preencha todos os campos obrigatórios.');
                return;
            }
            
            const serviceData = {
                clientId: clientId,
                collaboratorId: collaboratorId,
                type: serviceType,
                value: serviceValue,
                description: serviceDescription,
                date: new Date().toISOString().split('T')[0],
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                userId: currentUser.uid
            };
            
            db.collection('services').add(serviceData)
                .then(() => {
                    if (clearForm) {
                        document.getElementById('serviceForm').reset();
                        document.getElementById('selectedClientId').value = '';
                    }
                    loadAllServices();
                    showSuccess('Serviço adicionado com sucesso!');
                })
                .catch((error) => {
                    showError('Erro ao adicionar serviço: ' + error.message);
                });
        }

        function addProductSale(e) {
            e.preventDefault();
            
            if (!currentCashier) {
                showError('É necessário abrir o caixa antes de adicionar vendas de produtos.');
                return;
            }
            
            const productId = document.getElementById('selectedProductId').value;
            const quantity = parseInt(document.getElementById('productSaleQuantity').value);
            const clientId = document.getElementById('selectedProductClientId').value || null;
            
            if (!productId || !quantity) {
                showError('Por favor, preencha todos os campos obrigatórios.');
                return;
            }
            
            const product = products.find(p => p.id === productId);
            if (!product) {
                showError('Produto não encontrado.');
                return;
            }
            
            if (product.quantity < quantity) {
                showError(`Quantidade insuficiente em estoque. Disponível: ${product.quantity}`);
                return;
            }
            
            const totalValue = quantity * parseFloat(product.salePrice);
            
            const saleData = {
                productId: productId,
                productName: product.name,
                quantity: quantity,
                unitPrice: product.salePrice,
                totalValue: totalValue,
                clientId: clientId,
                date: new Date().toISOString().split('T')[0],
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                userId: currentUser.uid
            };
            
            // Atualizar estoque
            const newQuantity = product.quantity - quantity;
            
            db.collection('products').doc(productId).update({
                quantity: newQuantity
            })
            .then(() => {
                return db.collection('productSales').add(saleData);
            })
            .then(() => {
                document.getElementById('productSaleForm').reset();
                document.getElementById('selectedProductId').value = '';
                document.getElementById('selectedProductClientId').value = '';
                loadProducts();
                loadAllProductSales();
                showSuccess('Venda de produto registrada com sucesso!');
            })
            .catch((error) => {
                showError('Erro ao registrar venda de produto: ' + error.message);
            });
        }

        function deleteService(serviceId) {
            Swal.fire({
                title: 'Tem certeza?',
                text: "Esta ação não pode ser desfeita!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Sim, excluir!',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    db.collection('services').doc(serviceId).delete()
                        .then(() => {
                            loadAllServices();
                            showSuccess('Serviço excluído com sucesso!');
                        })
                        .catch((error) => {
                            showError('Erro ao excluir serviço: ' + error.message);
                        });
                }
            });
        }

        function deleteProductSale(saleId) {
            Swal.fire({
                title: 'Tem certeza?',
                text: "Esta ação não pode ser desfeita!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Sim, excluir!',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    // Primeiro, buscar os dados da venda para restaurar o estoque
                    db.collection('productSales').doc(saleId).get()
                        .then((doc) => {
                            if (doc.exists) {
                                const saleData = doc.data();
                                const productId = saleData.productId;
                                const quantity = saleData.quantity;
                                
                                // Restaurar estoque
                                return db.collection('products').doc(productId).get()
                                    .then((productDoc) => {
                                        if (productDoc.exists) {
                                            const currentQuantity = productDoc.data().quantity;
                                            return db.collection('products').doc(productId).update({
                                                quantity: currentQuantity + quantity
                                            });
                                        }
                                    })
                                    .then(() => {
                                        // Agora excluir a venda
                                        return db.collection('productSales').doc(saleId).delete();
                                    });
                            }
                        })
                        .then(() => {
                            loadProducts();
                            loadAllProductSales();
                            showSuccess('Venda de produto excluída com sucesso!');
                        })
                        .catch((error) => {
                            showError('Erro ao excluir venda de produto: ' + error.message);
                        });
                }
            });
        }

        // Funções para Produtos
        function showAddProductModal() {
            document.getElementById('productModalTitle').textContent = 'Adicionar Produto';
            document.getElementById('productForm').reset();
            document.getElementById('productId').value = '';
            
            const modal = new bootstrap.Modal(document.getElementById('productModal'));
            modal.show();
        }

        function editProduct(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;
            
            document.getElementById('productModalTitle').textContent = 'Editar Produto';
            document.getElementById('productId').value = product.id;
            document.getElementById('productName').value = product.name;
            document.getElementById('productQuantity').value = product.quantity;
            document.getElementById('productMinQuantity').value = product.minQuantity;
            document.getElementById('productPurchasePrice').value = product.purchasePrice;
            document.getElementById('productSalePrice').value = product.salePrice;
            document.getElementById('productDescription').value = product.description || '';
            document.getElementById('productCategory').value = product.category || 'outros';
            
            const modal = new bootstrap.Modal(document.getElementById('productModal'));
            modal.show();
        }

        function saveProduct() {
            const productId = document.getElementById('productId').value;
            const name = document.getElementById('productName').value;
            const quantity = parseInt(document.getElementById('productQuantity').value);
            const minQuantity = parseInt(document.getElementById('productMinQuantity').value);
            const purchasePrice = parseFloat(document.getElementById('productPurchasePrice').value);
            const salePrice = parseFloat(document.getElementById('productSalePrice').value);
            const description = document.getElementById('productDescription').value;
            const category = document.getElementById('productCategory').value;
            
            const productData = {
                name: name,
                quantity: quantity,
                minQuantity: minQuantity,
                purchasePrice: purchasePrice,
                salePrice: salePrice,
                description: description,
                category: category,
                userId: currentUser.uid,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            let promise;
            
            if (productId) {
                // Atualizar produto existente
                promise = db.collection('products').doc(productId).update(productData);
            } else {
                // Adicionar novo produto
                productData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                promise = db.collection('products').add(productData);
            }
            
            showLoading('Salvando produto...');
            
            promise
                .then(() => {
                    const modal = bootstrap.Modal.getInstance(document.getElementById('productModal'));
                    modal.hide();
                    loadProducts();
                    showSuccess(productId ? 'Produto atualizado com sucesso!' : 'Produto adicionado com sucesso!');
                })
                .catch((error) => {
                    console.error('Erro ao salvar produto:', error);
                    showError('Erro ao salvar produto: ' + error.message);
                });
        }

        function deleteProduct(productId) {
            Swal.fire({
                title: 'Tem certeza?',
                text: "Esta ação não pode ser desfeita!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Sim, excluir!',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    db.collection('products').doc(productId).delete()
                        .then(() => {
                            loadProducts();
                            showSuccess('Produto excluído com sucesso!');
                        })
                        .catch((error) => {
                            showError('Erro ao excluir produto: ' + error.message);
                        });
                }
            });
        }

        function markProcedureDone(packageId) {
            const pkg = packages.find(p => p.id === packageId);
            if (!pkg || !pkg.procedureDates) return;
            
            // Encontrar o próximo procedimento pendente
            const today = new Date().toISOString().split('T')[0];
            let procedureToMark = null;
            
            for (let i = 0; i < pkg.procedureDates.length; i++) {
                if (!pkg.procedureDates[i].completed) {
                    procedureToMark = i;
                    break;
                }
            }
            
            if (procedureToMark === null) {
                showError('Todos os procedimentos já foram realizados!');
                return;
            }
            
            // Marcar como realizado
            const updatedProcedureDates = [...pkg.procedureDates];
            updatedProcedureDates[procedureToMark].completed = true;
            updatedProcedureDates[procedureToMark].completedDate = today;
            
            db.collection('packages').doc(packageId).update({
                procedureDates: updatedProcedureDates
            })
            .then(() => {
                loadPackages();
                showSuccess('Procedimento marcado como realizado!');
            })
            .catch((error) => {
                showError('Erro ao marcar procedimento: ' + error.message);
            });
        }

        function finishPackage(packageId, clientName) {
            Swal.fire({
                title: 'Finalizar Pacote',
                html: `Deseja finalizar o pacote de <strong>${clientName}</strong>?`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Renovar Pacote',
                cancelButtonText: 'Cancelar',
                showDenyButton: true,
                denyButtonText: 'Apenas Finalizar'
            }).then((result) => {
                if (result.isConfirmed) {
                    // Renovar pacote - manter os dados mas resetar as datas
                    renewPackage(packageId);
                } else if (result.dismiss === Swal.DismissReason.deny) {
                    // Apenas finalizar
                    db.collection('packages').doc(packageId).update({
                        status: 'finished',
                        finishedAt: firebase.firestore.FieldValue.serverTimestamp()
                    })
                    .then(() => {
                        loadPackages();
                        showSuccess('Pacote finalizado com sucesso!');
                    })
                    .catch((error) => {
                        showError('Erro ao finalizar pacote: ' + error.message);
                    });
                }
            });
        }

        function renewPackage(packageId) {
            const pkg = packages.find(p => p.id === packageId);
            if (!pkg) return;
            
            // Criar novas datas a partir de hoje
            const newProcedureDates = [];
            const start = new Date();
            
            if (pkg.frequency === 1) {
                // Uma vez por semana
                for (let i = 0; i < pkg.totalProcedures; i++) {
                    const procedureDate = new Date(start);
                    procedureDate.setDate(start.getDate() + (i * 7));
                    newProcedureDates.push({
                        date: procedureDate.toISOString().split('T')[0],
                        completed: false
                    });
                }
            } else {
                // Múltiplas vezes por semana
                let procedureCount = 0;
                let currentDate = new Date(start);
                
                while (procedureCount < pkg.totalProcedures) {
                    const dayOfWeek = currentDate.getDay();
                    const dayNames = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
                    const currentDayName = dayNames[dayOfWeek];
                    
                    if (pkg.selectedDays.includes(currentDayName)) {
                        newProcedureDates.push({
                            date: currentDate.toISOString().split('T')[0],
                            completed: false
                        });
                        procedureCount++;
                    }
                    
                    currentDate.setDate(currentDate.getDate() + 1);
                    
                    // Limitar a um máximo de 365 dias para evitar loops infinitos
                    if (procedureCount >= pkg.totalProcedures || (currentDate - start) / (1000 * 60 * 60 * 24) > 365) {
                        break;
                    }
                }
            }
            
            db.collection('packages').doc(packageId).update({
                procedureDates: newProcedureDates,
                startDate: start.toISOString().split('T')[0],
                status: 'active',
                renewedAt: firebase.firestore.FieldValue.serverTimestamp()
            })
            .then(() => {
                loadPackages();
                showSuccess('Pacote renovado com sucesso!');
            })
            .catch((error) => {
                showError('Erro ao renovar pacote: ' + error.message);
            });
        }

        function deletePackage(packageId) {
            Swal.fire({
                title: 'Tem certeza?',
                text: "Esta ação não pode ser desfeita!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Sim, excluir!',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    db.collection('packages').doc(packageId).delete()
                        .then(() => {
                            loadPackages();
                            showSuccess('Pacote excluído com sucesso!');
                        })
                        .catch((error) => {
                            showError('Erro ao excluir pacote: ' + error.message);
                        });
                }
            });
        }

        // Funções para Clientes
        function showAddClientModal() {
            document.getElementById('clientModalTitle').textContent = 'Adicionar Cliente';
            document.getElementById('clientForm').reset();
            document.getElementById('clientId').value = '';
            
            const modal = new bootstrap.Modal(document.getElementById('clientModal'));
            modal.show();
        }

        function editClient(clientId) {
            const client = clients.find(c => c.id === clientId);
            if (!client) return;
            
            document.getElementById('clientModalTitle').textContent = 'Editar Cliente';
            document.getElementById('clientId').value = client.id;
            document.getElementById('clientName').value = client.name;
            document.getElementById('clientBirthdate').value = client.birthdate;
            document.getElementById('clientPhone').value = client.phone;
            document.getElementById('clientEmail').value = client.email || '';
            
            const modal = new bootstrap.Modal(document.getElementById('clientModal'));
            modal.show();
        }

        function saveClient() {
            const clientId = document.getElementById('clientId').value;
            const name = document.getElementById('clientName').value;
            const birthdate = document.getElementById('clientBirthdate').value;
            const phone = document.getElementById('clientPhone').value;
            const email = document.getElementById('clientEmail').value;
            
            // Adicionar prefixo +351 se não tiver
            let formattedPhone = phone;
            if (!phone.startsWith('+351') && phone.trim() !== '') {
                formattedPhone = '+351' + phone.replace(/\D/g, '');
            }
            
            const clientData = {
                name: name,
                birthdate: birthdate,
                phone: formattedPhone,
                email: email,
                userId: currentUser.uid,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            let promise;
            
            if (clientId) {
                // Atualizar cliente existente
                promise = db.collection('clients').doc(clientId).update(clientData);
            } else {
                // Adicionar novo cliente
                clientData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                promise = db.collection('clients').add(clientData);
            }
            
            showLoading('Salvando cliente...');
            
            promise
                .then(() => {
                    const modal = bootstrap.Modal.getInstance(document.getElementById('clientModal'));
                    modal.hide();
                    loadClients();
                    showSuccess(clientId ? 'Cliente atualizado com sucesso!' : 'Cliente adicionado com sucesso!');
                })
                .catch((error) => {
                    console.error('Erro ao salvar cliente:', error);
                    showError('Erro ao salvar cliente: ' + error.message);
                });
        }

        function deleteClient(clientId) {
            Swal.fire({
                title: 'Tem certeza?',
                text: "Esta ação não pode ser desfeita!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Sim, excluir!',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    db.collection('clients').doc(clientId).delete()
                        .then(() => {
                            loadClients();
                            showSuccess('Cliente excluído com sucesso!');
                        })
                        .catch((error) => {
                            showError('Erro ao excluir cliente: ' + error.message);
                        });
                }
            });
        }

        // ============================================================
        // FUNÇÕES AUXILIARES (PERMANECEM IGUAIS)
        // ============================================================

        function formatCurrency(value) {
            if (isNaN(value)) value = 0;
            return new Intl.NumberFormat('pt-PT', {
                style: 'currency',
                currency: 'EUR'
            }).format(value);
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('pt-PT');
        }

        function showLoading(message) {
            Swal.fire({
                title: 'Aguarde...',
                text: message,
                allowOutsideClick: false,
                showConfirmButton: false,
                willOpen: () => {
                    Swal.showLoading();
                }
            });
        }

        function showSuccess(message) {
            Swal.fire({
                icon: 'success',
                title: 'Sucesso!',
                text: message,
                confirmButtonColor: '#3085d6',
                timer: 2000
            });
        }

        function showError(message) {
            Swal.fire({
                icon: 'error',
                title: 'Erro!',
                text: message,
                confirmButtonColor: '#d33'
            });
        }

        // Restante das funções auxiliares permanecem iguais...

        // Função para atualizar seletor de clientes nos pacotes
        function updatePackageClientSelect() {
            const select = document.getElementById('packageClientSelect');
            select.innerHTML = '<option value="">Selecione um cliente</option>';
            
            clients.forEach(client => {
                const option = document.createElement('option');
                option.value = client.id;
                option.textContent = client.name;
                select.appendChild(option);
            });
        }

        function toggleDaysSelection() {
            const frequency = parseInt(document.getElementById('packageFrequency').value);
            const daysSelection = document.getElementById('daysSelection');
            
            if (frequency > 1) {
                daysSelection.style.display = 'block';
            } else {
                daysSelection.style.display = 'none';
            }
        }

        // Função para mostrar/ocultar seções
        function showSection(sectionId) {
            // Esconder todas as seções
            document.querySelectorAll('.section').forEach(section => {
                section.style.display = 'none';
                section.classList.remove('active');
            });
            
            // Esconder cards mobile
            document.getElementById('mobileCards').classList.remove('active');
            
            // Mostrar a seção selecionada
            const section = document.getElementById(sectionId);
            if (section) {
                section.style.display = 'block';
                section.classList.add('active');
                
                // Se for mobile, mostrar botão de voltar
                if (window.innerWidth <= 768) {
                    document.getElementById('floatingMobileBtn').style.display = 'flex';
                    document.getElementById('floatingHomeBtn').style.display = 'flex';
                }
            }
        }

        // Função para verificar se é dispositivo móvel
        function checkMobileDevice() {
            isMobileView = window.innerWidth <= 768;
            
            if (isMobileView) {
                // Mostrar cards mobile por padrão
                showMobileCards();
                document.getElementById('floatingMobileBtn').style.display = 'flex';
                document.getElementById('floatingHomeBtn').style.display = 'flex';
            } else {
                // Em desktop, mostrar dashboard por padrão
                showSection('dashboard');
                document.getElementById('floatingMobileBtn').style.display = 'none';
                document.getElementById('floatingHomeBtn').style.display = 'none';
            }
        }

        // Função para mostrar botão flutuante mobile
        function showMobileCards() {
            if (window.innerWidth <= 768) {
                // Esconder todas as seções
                document.querySelectorAll('.section').forEach(section => {
                    section.style.display = 'none';
                    section.classList.remove('active');
                });
                
                // Mostrar cards mobile
                document.getElementById('mobileCards').classList.add('active');
                document.getElementById('floatingMobileBtn').style.display = 'none';
                document.getElementById('floatingHomeBtn').style.display = 'none';
            }
        }

        // Funções para funcionalidades adicionadas
        function toggleLowStockDetails() {
            const details = document.getElementById('lowStockDetails');
            const icon = document.getElementById('lowStockToggleIcon');
            
            if (details.classList.contains('active')) {
                details.classList.remove('active');
                icon.classList.remove('fa-chevron-up');
                icon.classList.add('fa-chevron-down');
            } else {
                details.classList.add('active');
                icon.classList.remove('fa-chevron-down');
                icon.classList.add('fa-chevron-up');
            }
        }

        function refreshTodaySales() {
            loadAllServices();
            loadAllProductSales();
            showSuccess('Vendas atualizadas com sucesso!');
        }

        function filterTodaySales() {
            const searchTerm = document.getElementById('todaySalesSearch').value.toLowerCase();
            const container = document.getElementById('todaySalesList');
            
            // Esta função precisaria ser implementada conforme necessário
            // Por enquanto, apenas recarregamos as vendas
            updateTodaySalesUI();
        }

        function filterInventory() {
            const searchTerm = document.getElementById('inventorySearch').value.toLowerCase();
            const tbody = document.getElementById('inventoryTable');
            
            if (!searchTerm) {
                updateInventoryUI();
                return;
            }
            
            const filteredProducts = products.filter(product => 
                product.name.toLowerCase().includes(searchTerm) ||
                product.description.toLowerCase().includes(searchTerm)
            );
            
            if (filteredProducts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">Nenhum produto encontrado.</td></tr>';
                return;
            }
            
            let html = '';
            filteredProducts.forEach(product => {
                const isLowStock = product.quantity <= product.minQuantity;
                
                html += `
                    <tr class="${isLowStock ? 'low-stock' : ''}">
                        <td>${product.name}</td>
                        <td>${product.quantity}</td>
                        <td>${product.minQuantity}</td>
                        <td>${formatCurrency(product.purchasePrice)}</td>
                                            <td>${formatCurrency(product.salePrice)}</td>
                        <td>
                            <span class="badge ${isLowStock ? 'bg-danger' : 'bg-success'}">
                                ${isLowStock ? 'Estoque Baixo' : 'Normal'}
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-primary me-1" onclick="editProduct('${product.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteProduct('${product.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }

        function searchClients() {
            const searchTerm = document.getElementById('clientSearch').value.toLowerCase();
            const tbody = document.getElementById('clientsTable');
            
            if (!searchTerm) {
                updateClientsUI();
                return;
            }
            
            const filteredClients = clients.filter(client => 
                client.name.toLowerCase().includes(searchTerm) ||
                (client.email && client.email.toLowerCase().includes(searchTerm)) ||
                client.phone.includes(searchTerm)
            );
            
            if (filteredClients.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Nenhum cliente encontrado.</td></tr>';
                return;
            }
            
            let html = '';
            filteredClients.forEach(client => {
                html += `
                    <tr>
                        <td>${client.name}</td>
                        <td>${formatDate(client.birthdate)}</td>
                        <td>${client.phone}</td>
                        <td>${client.email || '-'}</td>
                        <td>
                            <button class="btn btn-sm btn-primary me-1" onclick="editClient('${client.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteClient('${client.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            tbody.innerHTML = html;
        }

        function searchClientRecords() {
            const searchTerm = document.getElementById('clientRecordsSearch').value.toLowerCase();
            const container = document.getElementById('clientCardsList');
            
            if (!searchTerm) {
                loadClientCards();
                return;
            }
            
            const filteredClients = clients.filter(client => 
                client.name.toLowerCase().includes(searchTerm) ||
                (client.email && client.email.toLowerCase().includes(searchTerm)) ||
                client.phone.includes(searchTerm)
            );
            
            if (filteredClients.length === 0) {
                container.innerHTML = '<p class="text-muted text-center">Nenhum cliente encontrado.</p>';
                return;
            }
            
            loadClientCards(filteredClients);
        }

        function loadClientCards(filteredClients = null) {
            const clientsToShow = filteredClients || clients;
            const container = document.getElementById('clientCardsList');
            
            if (clientsToShow.length === 0) {
                container.innerHTML = '<p class="text-muted text-center">Nenhum cliente cadastrado.</p>';
                return;
            }
            
            let html = '';
            clientsToShow.forEach(client => {
                const initials = client.name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
                const clientServices = allServices.filter(s => s.clientId === client.id);
                const totalSpent = clientServices.reduce((sum, service) => sum + parseFloat(service.value), 0);
                const lastService = clientServices.length > 0 ? 
                    clientServices[0].timestamp.toDate ? 
                        clientServices[0].timestamp.toDate() : 
                        new Date(clientServices[0].timestamp) : 
                    null;
                
                html += `
                    <div class="card client-card mb-2" onclick="showClientRecord('${client.id}')" data-client-id="${client.id}">
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col-2">
                                    <div class="client-avatar">
                                        ${initials}
                                    </div>
                                </div>
                                <div class="col-10">
                                    <h6 class="mb-1">${client.name}</h6>
                                    <p class="text-muted small mb-1">
                                        <i class="fas fa-phone me-1"></i>${client.phone}
                                    </p>
                                    <p class="text-muted small mb-1">
                                        <i class="fas fa-euro-sign me-1"></i>Total Gasto: ${formatCurrency(totalSpent)}
                                    </p>
                                    <p class="text-muted small mb-0">
                                        <i class="fas fa-calendar me-1"></i>${clientServices.length} serviços
                                        ${lastService ? `| Último: ${formatDate(lastService)}` : ''}
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function showClientRecord(clientId) {
            const client = clients.find(c => c.id === clientId);
            if (!client) return;
            
            const clientServices = allServices.filter(s => s.clientId === client.id);
            const clientProductSales = allProductSales.filter(s => s.clientId === client.id);
            const clientPackages = packages.filter(p => p.clientId === client.id && p.status === 'active');
            
            // Calcular estatísticas
            const totalSpentServices = clientServices.reduce((sum, service) => sum + parseFloat(service.value), 0);
            const totalSpentProducts = clientProductSales.reduce((sum, sale) => sum + parseFloat(sale.totalValue), 0);
            const totalSpent = totalSpentServices + totalSpentProducts;
            const averageService = clientServices.length > 0 ? totalSpentServices / clientServices.length : 0;
            
            // Verificar se é mobile ou desktop
            if (window.innerWidth <= 768) {
                // Mobile
                document.getElementById('clientRecordMobileTitle').textContent = `Ficha de ${client.name}`;
                const mobileContent = document.getElementById('clientRecordMobileContent');
                
                let html = `
                    <div class="client-info mb-4">
                        <div class="text-center mb-3">
                            <div class="client-avatar mx-auto mb-2">
                                ${client.name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2)}
                            </div>
                            <h5>${client.name}</h5>
                            <p class="text-muted">${client.email || 'Sem e-mail'}</p>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-6">
                                <div class="card p-2 text-center">
                                    <small class="text-muted">Telefone</small>
                                    <div><strong>${client.phone}</strong></div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="card p-2 text-center">
                                    <small class="text-muted">Nascimento</small>
                                    <div><strong>${formatDate(client.birthdate)}</strong></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card mb-3">
                            <div class="card-header">
                                <h6 class="mb-0">Estatísticas</h6>
                            </div>
                            <div class="card-body">
                                <div class="row text-center">
                                    <div class="col-6">
                                        <div class="stats-number text-primary">${clientServices.length}</div>
                                        <small class="stats-label">Serviços</small>
                                    </div>
                                    <div class="col-6">
                                        <div class="stats-number text-success">${formatCurrency(totalSpent)}</div>
                                        <small class="stats-label">Total Gasto</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                `;
                
                // Serviços realizados
                if (clientServices.length > 0) {
                    html += `
                        <div class="card mb-3">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">Serviços Realizados</h6>
                                <small>${clientServices.length} serviços</small>
                            </div>
                            <div class="card-body">
                    `;
                    
                    const recentServices = clientServices.slice(0, 5);
                    recentServices.forEach(service => {
                        const collaborator = collaborators.find(c => c.id === service.collaboratorId) || { name: 'Não informado' };
                        const date = service.timestamp.toDate ? 
                            service.timestamp.toDate() : 
                            new Date(service.timestamp);
                        
                        html += `
                            <div class="service-item mb-2">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <strong>${service.description}</strong>
                                        <div class="small text-muted">
                                            ${formatDate(date.toISOString())} - ${collaborator.name}
                                        </div>
                                    </div>
                                    <div class="text-end">
                                        <div class="text-success">${formatCurrency(service.value)}</div>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    
                    if (clientServices.length > 5) {
                        html += `<p class="text-center text-muted mt-2">... e mais ${clientServices.length - 5} serviços</p>`;
                    }
                    
                    html += `</div></div>`;
                }
                
                // Pacotes ativos
                if (clientPackages.length > 0) {
                    html += `
                        <div class="card mb-3">
                            <div class="card-header">
                                <h6 class="mb-0">Pacotes Ativos</h6>
                            </div>
                            <div class="card-body">
                    `;
                    
                    clientPackages.forEach(pkg => {
                        const completedProcedures = pkg.procedureDates ? pkg.procedureDates.filter(d => d.completed).length : 0;
                        const totalProcedures = pkg.totalProcedures || 0;
                        const progress = totalProcedures > 0 ? (completedProcedures / totalProcedures) * 100 : 0;
                        
                        html += `
                            <div class="mb-2 p-2 border rounded">
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <strong>${pkg.description || 'Pacote'}</strong>
                                    <span class="badge bg-primary">${formatCurrency(pkg.value)}</span>
                                </div>
                                <div class="progress mb-1" style="height: 5px;">
                                    <div class="progress-bar" role="progressbar" style="width: ${progress}%"></div>
                                </div>
                                <small class="text-muted">${completedProcedures}/${totalProcedures} procedimentos</small>
                            </div>
                        `;
                    });
                    
                    html += `</div></div>`;
                }
                
                // Botões de ação
                html += `
                    <div class="row mb-3">
                        <div class="col-6">
                            <button class="btn btn-primary w-100" onclick="showClientSummary('${client.id}')">
                                <i class="fas fa-chart-bar me-1"></i> Resumo
                            </button>
                        </div>
                        <div class="col-6">
                            <button class="btn btn-warning w-100" onclick="showClientNotesModal('${client.id}')">
                                <i class="fas fa-sticky-note me-1"></i> Notas
                            </button>
                        </div>
                    </div>
                `;
                
                mobileContent.innerHTML = html;
                document.getElementById('clientRecordOverlay').classList.add('active');
                document.getElementById('clientRecordMobile').classList.add('active');
            } else {
                // Desktop
                document.getElementById('clientRecordTitle').textContent = `Ficha de ${client.name}`;
                const desktopContent = document.getElementById('clientRecordContent');
                
                let html = `
                    <div class="row">
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-body text-center">
                                    <div class="client-avatar mx-auto mb-3">
                                        ${client.name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2)}
                                    </div>
                                    <h4>${client.name}</h4>
                                    <p class="text-muted">${client.email || 'Sem e-mail'}</p>
                                    
                                    <div class="mt-4">
                                        <p><strong><i class="fas fa-phone me-2"></i>Telefone:</strong><br>${client.phone}</p>
                                        <p><strong><i class="fas fa-birthday-cake me-2"></i>Nascimento:</strong><br>${formatDate(client.birthdate)}</p>
                                    </div>
                                    
                                    <div class="mt-4">
                                        <button class="btn btn-primary mb-2" onclick="showClientSummary('${client.id}')">
                                            <i class="fas fa-chart-bar me-1"></i> Ver Resumo
                                        </button>
                                        <button class="btn btn-warning" onclick="showClientNotesModal('${client.id}')">
                                            <i class="fas fa-sticky-note me-1"></i> Editar Notas
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-8">
                `;
                
                // Estatísticas
                html += `
                    <div class="card mb-3">
                        <div class="card-header">
                            <h5 class="mb-0">Estatísticas</h5>
                        </div>
                        <div class="card-body">
                            <div class="row text-center">
                                <div class="col-md-3 mb-3">
                                    <div class="stats-number text-primary">${clientServices.length}</div>
                                    <div class="stats-label">Serviços Realizados</div>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <div class="stats-number text-info">${clientProductSales.length}</div>
                                    <div class="stats-label">Produtos Comprados</div>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <div class="stats-number text-success">${formatCurrency(totalSpent)}</div>
                                    <div class="stats-label">Total Gasto</div>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <div class="stats-number text-warning">${formatCurrency(averageService)}</div>
                                    <div class="stats-label">Média por Serviço</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Histórico de Serviços (apenas últimos 10)
                if (clientServices.length > 0) {
                    html += `
                        <div class="card mb-3">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">Últimos Serviços</h5>
                                <span class="badge bg-primary">${clientServices.length} serviços</span>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Data</th>
                                                <th>Descrição</th>
                                                <th>Colaborador</th>
                                                <th>Tipo</th>
                                                <th>Valor</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                    `;
                    
                    const recentServices = clientServices.slice(0, 10);
                    recentServices.forEach(service => {
                        const collaborator = collaborators.find(c => c.id === service.collaboratorId) || { name: 'Não informado' };
                        const date = service.timestamp.toDate ? 
                            service.timestamp.toDate() : 
                            new Date(service.timestamp);
                        
                        html += `
                            <tr>
                                <td>${formatDate(date.toISOString())}</td>
                                <td>${service.description}</td>
                                <td>${collaborator.name}</td>
                                <td>${service.type === 'manual' ? 'Manual' : 'Com Produtos'}</td>
                                <td class="text-success">${formatCurrency(service.value)}</td>
                            </tr>
                        `;
                    });
                    
                    html += `
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                // Pacotes Ativos
                if (clientPackages.length > 0) {
                    html += `
                        <div class="card">
                            <div class="card-header">
                            <h5 class="mb-0">Pacotes Ativos</h5>
                            </div>
                            <div class="card-body">
                    `;
                    
                    clientPackages.forEach(pkg => {
                        const completedProcedures = pkg.procedureDates ? pkg.procedureDates.filter(d => d.completed).length : 0;
                        const totalProcedures = pkg.totalProcedures || 0;
                        const progress = totalProcedures > 0 ? (completedProcedures / totalProcedures) * 100 : 0;
                        
                        html += `
                            <div class="service-item mb-3">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="flex-grow-1">
                                        <h6 class="mb-1">${pkg.description || 'Pacote'}</h6>
                                        <p class="mb-1"><strong>Valor:</strong> ${formatCurrency(pkg.value)}</p>
                                        <p class="mb-1"><strong>Progresso:</strong> ${completedProcedures}/${totalProcedures} procedimentos</p>
                                        <div class="progress mb-2" style="height: 8px;">
                                            <div class="progress-bar" role="progressbar" style="width: ${progress}%"></div>
                                        </div>
                                        <div class="procedure-dates">
                                            <strong>Próximos Procedimentos:</strong><br>
                                            ${pkg.procedureDates ? pkg.procedureDates.filter(d => !d.completed).slice(0, 3).map(dateObj => `
                                                <small class="d-block date-status-pending">${formatDate(dateObj.date)} - Pendente</small>
                                            `).join('') : ''}
                                        </div>
                                    </div>
                                    <div class="text-end">
                                        <button class="btn btn-sm btn-success mb-1" onclick="markProcedureDone('${pkg.id}')">
                                            <i class="fas fa-check me-1"></i> Realizar
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += `
                            </div>
                        </div>
                    `;
                }
                
                html += `
                        </div>
                    </div>
                `;
                
                desktopContent.innerHTML = html;
            }
            
            selectedClientId = clientId;
        }

        function closeMobileClientRecord() {
            document.getElementById('clientRecordOverlay').classList.remove('active');
            document.getElementById('clientRecordMobile').classList.remove('active');
        }

        function showClientSummary(clientId) {
            const client = clients.find(c => c.id === clientId);
            if (!client) return;
            
            const clientServices = allServices.filter(s => s.clientId === client.id);
            const clientProductSales = allProductSales.filter(s => s.clientId === client.id);
            
            // Calcular estatísticas avançadas
            const totalSpentServices = clientServices.reduce((sum, service) => sum + parseFloat(service.value), 0);
            const totalSpentProducts = clientProductSales.reduce((sum, sale) => sum + parseFloat(sale.totalValue), 0);
            const totalSpent = totalSpentServices + totalSpentProducts;
            const averageService = clientServices.length > 0 ? totalSpentServices / clientServices.length : 0;
            
            // Agrupar serviços por colaborador
            const servicesByCollaborator = {};
            clientServices.forEach(service => {
                const collaborator = collaborators.find(c => c.id === service.collaboratorId) || { name: 'Não informado' };
                if (!servicesByCollaborator[collaborator.name]) {
                    servicesByCollaborator[collaborator.name] = {
                        count: 0,
                        total: 0
                    };
                }
                servicesByCollaborator[collaborator.name].count++;
                servicesByCollaborator[collaborator.name].total += parseFloat(service.value);
            });
            
            // Agrupar por tipo de serviço
            const servicesByType = {
                manual: { count: 0, total: 0 },
                product: { count: 0, total: 0 }
            };
            clientServices.forEach(service => {
                if (service.type === 'manual') {
                    servicesByType.manual.count++;
                    servicesByType.manual.total += parseFloat(service.value);
                } else if (service.type === 'product') {
                    servicesByType.product.count++;
                    servicesByType.product.total += parseFloat(service.value);
                }
            });
            
            // Calcular frequência de visitas (dias entre serviços)
            let visitFrequency = 'N/A';
            if (clientServices.length >= 2) {
                const dates = clientServices.map(s => {
                    const d = s.timestamp.toDate ? s.timestamp.toDate() : new Date(s.timestamp);
                    return d.getTime();
                }).sort((a, b) => a - b);
                
                const totalDays = (dates[dates.length - 1] - dates[0]) / (1000 * 60 * 60 * 24);
                visitFrequency = Math.round(totalDays / (clientServices.length - 1)) + ' dias';
            }
            
            let html = `
                <div class="client-summary">
                    <h4>Resumo de ${client.name}</h4>
                    
                    <div class="row mt-4">
                        <div class="col-md-6">
                            <div class="card mb-3">
                                <div class="card-header">
                                    <h5 class="mb-0">Estatísticas Gerais</h5>
                                </div>
                                <div class="card-body">
                                    <table class="table table-sm">
                                        <tr>
                                            <td><strong>Total de Serviços:</strong></td>
                                            <td>${clientServices.length}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Total de Produtos Comprados:</strong></td>
                                            <td>${clientProductSales.length}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Total Gasto:</strong></td>
                                            <td class="text-success">${formatCurrency(totalSpent)}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Média por Serviço:</strong></td>
                                            <td>${formatCurrency(averageService)}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Frequência de Visitas:</strong></td>
                                            <td>${visitFrequency}</td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card mb-3">
                                <div class="card-header">
                                    <h5 class="mb-0">Distribuição de Gastos</h5>
                                </div>
                                <div class="card-body">
                                    <table class="table table-sm">
                                        <tr>
                                            <td><strong>Serviços Manuais:</strong></td>
                                            <td>${servicesByType.manual.count} serviços</td>
                                            <td class="text-success">${formatCurrency(servicesByType.manual.total)}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Serviços com Produtos:</strong></td>
                                            <td>${servicesByType.product.count} serviços</td>
                                            <td class="text-success">${formatCurrency(servicesByType.product.total)}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Produtos:</strong></td>
                                            <td>${clientProductSales.length} compras</td>
                                            <td class="text-success">${formatCurrency(totalSpentProducts)}</td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card mb-3">
                        <div class="card-header">
                            <h5 class="mb-0">Serviços por Colaborador</h5>
                        </div>
                        <div class="card-body">
                            ${Object.keys(servicesByCollaborator).length === 0 ? 
                                '<p class="text-muted">Nenhum serviço registrado.</p>' : 
                                Object.keys(servicesByCollaborator).map(collaborator => `
                                    <div class="mb-2">
                                        <strong>${collaborator}:</strong>
                                        ${servicesByCollaborator[collaborator].count} serviços - 
                                        <span class="text-success">${formatCurrency(servicesByCollaborator[collaborator].total)}</span>
                                    </div>
                                `).join('')
                            }
                        </div>
                    </div>
                    
                    <div class="text-end">
                        <button class="btn btn-primary" onclick="generateClientReport('${client.id}')">
                            <i class="fas fa-download me-1"></i> Gerar Relatório PDF
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('clientSummaryModalTitle').textContent = `Resumo de ${client.name}`;
            document.getElementById('clientSummaryContent').innerHTML = html;
            
            const modal = new bootstrap.Modal(document.getElementById('clientSummaryModal'));
            modal.show();
        }

        function generateClientReport(clientId) {
            const client = clients.find(c => c.id === clientId);
            if (!client) return;
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Configurações do documento
            doc.setFontSize(20);
            doc.text('Relatório do Cliente', 105, 15, { align: 'center' });
            
            doc.setFontSize(12);
            doc.text(`Nome: ${client.name}`, 20, 30);
            doc.text(`Telefone: ${client.phone}`, 20, 40);
            doc.text(`E-mail: ${client.email || 'Não informado'}`, 20, 50);
            doc.text(`Data de Nascimento: ${formatDate(client.birthdate)}`, 20, 60);
            
            // Adicionar estatísticas
            const clientServices = allServices.filter(s => s.clientId === client.id);
            const clientProductSales = allProductSales.filter(s => s.clientId === client.id);
            const totalSpent = clientServices.reduce((sum, s) => sum + parseFloat(s.value), 0) + 
                              clientProductSales.reduce((sum, p) => sum + parseFloat(p.totalValue), 0);
            
            doc.setFontSize(14);
            doc.text('Estatísticas:', 20, 80);
            doc.setFontSize(12);
            doc.text(`Total de Serviços: ${clientServices.length}`, 30, 90);
            doc.text(`Total de Produtos Comprados: ${clientProductSales.length}`, 30, 100);
            doc.text(`Total Gasto: ${formatCurrency(totalSpent)}`, 30, 110);
            
            // Adicionar histórico de serviços (limitado)
            if (clientServices.length > 0) {
                doc.setFontSize(14);
                doc.text('Últimos Serviços:', 20, 130);
                doc.setFontSize(10);
                
                let y = 140;
                clientServices.slice(0, 10).forEach((service, index) => {
                    const collaborator = collaborators.find(c => c.id === service.collaboratorId) || { name: 'Não informado' };
                    const date = service.timestamp.toDate ? service.timestamp.toDate() : new Date(service.timestamp);
                    
                    if (y > 280) {
                        doc.addPage();
                        y = 20;
                    }
                    
                    doc.text(`${index + 1}. ${formatDate(date.toISOString())} - ${service.description}`, 30, y);
                    doc.text(`   ${collaborator.name} - ${formatCurrency(service.value)}`, 30, y + 5);
                    y += 12;
                });
            }
            
            // Salvar o PDF
            doc.save(`relatorio_${client.name.replace(/\s+/g, '_')}.pdf`);
            
            showSuccess('Relatório gerado com sucesso!');
        }

        function showClientNotesModal(clientId) {
            const client = clients.find(c => c.id === clientId);
            if (!client) return;
            
            document.getElementById('clientNotesModalTitle').textContent = `Notas de ${client.name}`;
            document.getElementById('clientNotesId').value = clientId;
            
            // Carregar notas existentes
            const notes = clientNotes[clientId];
            document.getElementById('clientNotes').value = notes ? notes.notes : '';
            
            const modal = new bootstrap.Modal(document.getElementById('clientNotesModal'));
            modal.show();
        }

        function saveClientNotes() {
            const clientId = document.getElementById('clientNotesId').value;
            const notes = document.getElementById('clientNotes').value;
            
            if (!clientId) return;
            
            const noteData = {
                clientId: clientId,
                notes: notes,
                userId: currentUser.uid,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            let promise;
            
            if (clientNotes[clientId] && clientNotes[clientId].id) {
                // Atualizar notas existentes
                promise = db.collection('clientNotes').doc(clientNotes[clientId].id).update(noteData);
            } else {
                // Criar novas notas
                noteData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                promise = db.collection('clientNotes').add(noteData);
            }
            
            showLoading('Salvando notas...');
            
            promise
                .then(() => {
                    const modal = bootstrap.Modal.getInstance(document.getElementById('clientNotesModal'));
                    modal.hide();
                    loadClientNotes(); // Recarregar notas
                    showSuccess('Notas salvas com sucesso!');
                })
                .catch((error) => {
                    console.error('Erro ao salvar notas:', error);
                    showError('Erro ao salvar notas: ' + error.message);
                });
        }

       function loadUpcomingBirthdays() {
    const today = new Date();
    today.setHours(0, 0, 0, 0); // ⭐⭐ IMPORTANTE: Zerar as horas para comparar apenas datas!
    const upcomingDays = 7; // Próximos 7 dias (incluindo hoje)
    
    const upcomingBirthdays = clients.filter(client => {
        if (!client.birthdate) return false;
        
        const birthdate = new Date(client.birthdate);
        const currentYear = today.getFullYear();
        
        // Data de aniversário este ano
        const birthdayThisYear = new Date(currentYear, birthdate.getMonth(), birthdate.getDate());
        birthdayThisYear.setHours(0, 0, 0, 0); // ⭐ Zerar horas também!
        
        // Se já passou, considerar próximo ano
        let nextBirthday;
        if (birthdayThisYear < today) {
            nextBirthday = new Date(currentYear + 1, birthdate.getMonth(), birthdate.getDate());
        } else {
            nextBirthday = birthdayThisYear;
        }
        nextBirthday.setHours(0, 0, 0, 0); // ⭐ Zerar horas da próxima data também!
        
        // Calcular diferença em dias
        const daysUntilBirthday = Math.ceil((nextBirthday - today) / (1000 * 60 * 60 * 24));
        
        // ⭐⭐ CORREÇÃO PRINCIPAL: Incluir hoje (0) e os próximos 7 dias
        return daysUntilBirthday >= 0 && daysUntilBirthday <= upcomingDays;
    });
    
    // Ordenar por proximidade (hoje primeiro, depois por dias)
    upcomingBirthdays.sort((a, b) => {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        const birthdateA = new Date(a.birthdate);
        const birthdateB = new Date(b.birthdate);
        const currentYear = today.getFullYear();
        
        // Calcular próximo aniversário de A
        let nextA = new Date(currentYear, birthdateA.getMonth(), birthdateA.getDate());
        nextA.setHours(0, 0, 0, 0);
        if (nextA < today) {
            nextA = new Date(currentYear + 1, birthdateA.getMonth(), birthdateA.getDate());
            nextA.setHours(0, 0, 0, 0);
        }
        
        // Calcular próximo aniversário de B
        let nextB = new Date(currentYear, birthdateB.getMonth(), birthdateB.getDate());
        nextB.setHours(0, 0, 0, 0);
        if (nextB < today) {
            nextB = new Date(currentYear + 1, birthdateB.getMonth(), birthdateB.getDate());
            nextB.setHours(0, 0, 0, 0);
        }
        
        // Ordenar: hoje primeiro (0 dias), depois por proximidade
        const daysA = Math.ceil((nextA - today) / (1000 * 60 * 60 * 24));
        const daysB = Math.ceil((nextB - today) / (1000 * 60 * 60 * 24));
        
        return daysA - daysB;
    });
    
    updateBirthdaysUI(upcomingBirthdays);
}

function updateBirthdaysUI(upcomingBirthdays) {
    const dashboardList = document.getElementById('upcomingBirthdaysList');
    const birthdaysList = document.getElementById('birthdaysList');
    const countElement = document.getElementById('upcomingBirthdays');
    
    // Contar aniversários (separar hoje vs futuros)
    const todayBirthdays = upcomingBirthdays.filter(client => {
        const birthdate = new Date(client.birthdate);
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        const currentYear = today.getFullYear();
        let nextBirthday = new Date(currentYear, birthdate.getMonth(), birthdate.getDate());
        nextBirthday.setHours(0, 0, 0, 0);
        
        if (nextBirthday < today) {
            nextBirthday = new Date(currentYear + 1, birthdate.getMonth(), birthdate.getDate());
            nextBirthday.setHours(0, 0, 0, 0);
        }
        
        const daysUntil = Math.ceil((nextBirthday - today) / (1000 * 60 * 60 * 24));
        return daysUntil === 0;
    });
    
    countElement.textContent = upcomingBirthdays.length;
    
    // ⭐⭐ NOVO: Mostrar contagem separada de aniversários de HOJE
    if (todayBirthdays.length > 0) {
        countElement.innerHTML = `${upcomingBirthdays.length} <small class="text-warning">(${todayBirthdays.length} hoje!)</small>`;
    }
    
    if (upcomingBirthdays.length === 0) {
        dashboardList.innerHTML = '<p class="text-muted">Nenhum aniversário próximo.</p>';
        birthdaysList.innerHTML = '<p class="text-muted">Nenhum aniversário próximo encontrado.</p>';
        return;
    }
    
    // Dashboard (apenas próximos 5)
    let dashboardHtml = '';
    const dashboardBirthdays = upcomingBirthdays.slice(0, 5);
    
    dashboardBirthdays.forEach(client => {
        const birthdate = new Date(client.birthdate);
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        const currentYear = today.getFullYear();
        
        // Calcular próxima data de aniversário
        let nextBirthday = new Date(currentYear, birthdate.getMonth(), birthdate.getDate());
        nextBirthday.setHours(0, 0, 0, 0);
        
        if (nextBirthday < today) {
            nextBirthday.setFullYear(currentYear + 1);
            nextBirthday.setHours(0, 0, 0, 0);
        }
        
        const daysUntil = Math.ceil((nextBirthday - today) / (1000 * 60 * 60 * 24));
        const age = nextBirthday.getFullYear() - birthdate.getFullYear();
        
        let badgeClass = 'bg-secondary';
        let badgeText = `em ${daysUntil} dias`;
        
        if (daysUntil === 0) {
            badgeClass = 'birthday-today-badge';
            badgeText = 'HOJE 🎂';
        } else if (daysUntil === 1) {
            badgeClass = 'bg-danger';
            badgeText = 'AMANHÃ!';
        } else if (daysUntil <= 3) {
            badgeClass = 'bg-warning';
            badgeText = `em ${daysUntil} dias`;
        }
        
        dashboardHtml += `
            <div class="birthday-item ${daysUntil === 0 ? 'birthday-today' : ''}">
                <div>
                    <strong>${client.name}</strong>
                    <div class="small text-muted">
                        ${formatDate(client.birthdate)} (${age} anos)
                        ${client.phone ? `<br><i class="fas fa-phone"></i> ${client.phone}` : ''}
                    </div>
                </div>
                <span class="badge ${badgeClass}">
                    ${badgeText}
                </span>
            </div>
        `;
    });
    
    if (upcomingBirthdays.length > 5) {
        dashboardHtml += `<p class="text-center text-muted mt-2">... e mais ${upcomingBirthdays.length - 5} aniversários</p>`;
    }
    
    dashboardList.innerHTML = dashboardHtml;
    
    // ⭐⭐ NOVO: Título especial para a página de aniversários
    let pageTitle = 'Próximos Aniversários';
    if (todayBirthdays.length > 0) {
        pageTitle += ` <span class="badge birthday-today-badge">${todayBirthdays.length} HOJE!</span>`;
    }
    
    // Página de aniversários (todos)
    let birthdaysHtml = `
        <div class="mb-3">
            <h5 class="d-inline">${pageTitle}</h5>
            <button class="btn btn-sm btn-outline-primary float-end" onclick="refreshBirthdays()">
                <i class="fas fa-sync-alt"></i> Atualizar
            </button>
        </div>
    `;
    
    if (todayBirthdays.length > 0) {
        birthdaysHtml += `
            <div class="card border-warning mb-3">
                <div class="card-header bg-warning text-dark">
                    <i class="fas fa-birthday-cake me-2"></i>
                    <strong>ANIVERSARIANTES DE HOJE! (${todayBirthdays.length})</strong>
                </div>
                <div class="card-body">
        `;
        
        todayBirthdays.forEach(client => {
            const birthdate = new Date(client.birthdate);
            const age = new Date().getFullYear() - birthdate.getFullYear();
            
            birthdaysHtml += `
                <div class="row align-items-center mb-2 birthday-today p-2 rounded">
                    <div class="col-md-8">
                        <h6 class="mb-1"><i class="fas fa-user me-2"></i>${client.name}</h6>
                        <p class="mb-1">
                            <i class="fas fa-birthday-cake me-1"></i>
                            ${formatDate(client.birthdate)} (${age} anos hoje!)
                        </p>
                        <p class="mb-0 text-muted small">
                            <i class="fas fa-phone me-1"></i>${client.phone}
                            ${client.email ? `<br><i class="fas fa-envelope me-1"></i>${client.email}` : ''}
                        </p>
                    </div>
                    <div class="col-md-4 text-end">
                        <button class="btn btn-sm btn-warning mb-1" onclick="sendBirthdayMessage('${client.id}')">
                            <i class="fas fa-sms me-1"></i> Parabéns!
                        </button>
                        <button class="btn btn-sm btn-outline-primary" onclick="editClient('${client.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                    </div>
                </div>
            `;
        });
        
        birthdaysHtml += `</div></div>`;
    }
    
    // Separar aniversários futuros (apenas se houver)
    const futureBirthdays = upcomingBirthdays.filter(client => !todayBirthdays.includes(client));
    
    if (futureBirthdays.length > 0) {
        birthdaysHtml += `<h6 class="mt-3 mb-2">Próximos Aniversários:</h6>`;
        
        futureBirthdays.forEach(client => {
            const birthdate = new Date(client.birthdate);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const currentYear = today.getFullYear();
            
            // Calcular próxima data de aniversário
            let nextBirthday = new Date(currentYear, birthdate.getMonth(), birthdate.getDate());
            nextBirthday.setHours(0, 0, 0, 0);
            
            if (nextBirthday < today) {
                nextBirthday.setFullYear(currentYear + 1);
                nextBirthday.setHours(0, 0, 0, 0);
            }
            
            const daysUntil = Math.ceil((nextBirthday - today) / (1000 * 60 * 60 * 24));
            const age = nextBirthday.getFullYear() - birthdate.getFullYear();
            const nextBirthdayStr = formatDate(nextBirthday.toISOString());
            
            let badgeClass = 'bg-primary';
            let badgeText = `Faltam ${daysUntil} dias`;
            
            if (daysUntil === 1) {
                badgeClass = 'bg-danger';
                badgeText = 'AMANHÃ!';
            } else if (daysUntil <= 3) {
                badgeClass = 'bg-warning text-dark';
                badgeText = `Em ${daysUntil} dias`;
            }
            
            birthdaysHtml += `
                <div class="card mb-2">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <h6 class="mb-1">${client.name}</h6>
                                <p class="text-muted mb-1">
                                    <i class="fas fa-phone me-1"></i>${client.phone}
                                    ${client.email ? `<br><i class="fas fa-envelope me-1"></i>${client.email}` : ''}
                                </p>
                                <p class="mb-0">
                                    <small><i class="fas fa-birthday-cake me-1"></i>
                                    Nascimento: ${formatDate(client.birthdate)} | 
                                    Aniversário: ${nextBirthdayStr} (${age} anos)
                                    </small>
                                </p>
                            </div>
                            <div class="col-md-4 text-end">
                                <span class="badge ${badgeClass}">
                                    ${badgeText}
                                </span>
                                <div class="mt-2">
                                    <button class="btn btn-sm btn-outline-primary" onclick="editClient('${client.id}')">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-success ms-1" onclick="sendBirthdayMessage('${client.id}')">
                                        <i class="fas fa-sms"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
    }
    
    birthdaysList.innerHTML = birthdaysHtml;
}

// ⭐⭐ NOVA FUNÇÃO: Atualizar aniversários
function refreshBirthdays() {
    loadUpcomingBirthdays();
    showSuccess('Lista de aniversários atualizada!');
}

// Adicione este CSS extra para melhor visualização:
const style = document.createElement('style');
style.textContent = `
    .birthday-today {
        background: linear-gradient(135deg, #fff9c4, #ffecb3) !important;
        border-left: 4px solid #ff9800 !important;
        animation: pulse 2s infinite;
    }
    
    .birthday-today-badge {
        background: linear-gradient(135deg, #ff9800, #f57c00) !important;
        color: white !important;
        font-weight: bold;
        animation: pulse 1.5s infinite;
    }
    
    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }
    
    .birthday-item {
        transition: all 0.3s ease;
    }
    
    .birthday-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
`;
document.head.appendChild(style);

        function sendBirthdayMessage(clientId) {
            const client = clients.find(c => c.id === clientId);
            if (!client) return;
            
            const birthdate = new Date(client.birthdate);
            const today = new Date();
            const age = today.getFullYear() - birthdate.getFullYear();
            
            const message = `Olá ${client.name.split(' ')[0]}! 🎉\n\n` +
                           `O Studio DeVitto deseja a você um Feliz Aniversário! 🎂\n` +
                           `Que este novo ano de vida seja repleto de alegrias e conquistas!\n\n` +
                           `Com carinho,\nEquipe Studio DeVitto`;
            
            // Criar link para WhatsApp
            const phoneNumber = client.phone.replace(/\D/g, '');
            const whatsappLink = `https://wa.me/${phoneNumber}?text=${encodeURIComponent(message)}`;
            
            Swal.fire({
                title: 'Enviar Mensagem de Aniversário',
                html: `
                    <div class="text-start">
                        <p><strong>Para:</strong> ${client.name}</p>
                        <p><strong>Telefone:</strong> ${client.phone}</p>
                        <p><strong>Idade:</strong> ${age} anos</p>
                        <hr>
                        <p><strong>Mensagem:</strong></p>
                        <div class="border p-2 rounded bg-light">
                            ${message.replace(/\n/g, '<br>')}
                        </div>
                    </div>
                `,
                icon: 'info',
                showCancelButton: true,
                confirmButtonText: 'Abrir WhatsApp',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    window.open(whatsappLink, '_blank');
                }
            });
        }

        // ============================================================
        // FUNÇÕES COMPLETAS PARA RELATÓRIOS
        // ============================================================

        function generateReport() {
            const reportType = document.getElementById('reportType').value;
            const reportDate = document.getElementById('reportDate').value;
            const reportCollaborator = document.getElementById('reportCollaborator').value;
            
            // Validações
            if (!reportDate && (reportType === 'daily' || reportType === 'weekly' || reportType === 'monthly' || reportType === 'yearly' || reportType === 'financial')) {
                showError('Por favor, selecione uma data para o relatório.');
                return;
            }
            
            if (reportType === 'collaborator' && reportCollaborator === 'all') {
                // Se for "todos", gerar relatório geral de colaboradores
            } else if (reportType === 'collaborator' && !reportCollaborator) {
                showError('Por favor, selecione um colaborador.');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Cabeçalho do documento
            doc.setFontSize(22);
            doc.setTextColor(38, 25, 107); // Cor primária
            doc.text(businessSettings.name || 'Studio DeVitto', 105, 15, { align: 'center' });
            
            doc.setFontSize(16);
            doc.setTextColor(0, 0, 0);
            doc.text(`Relatório ${getReportTypeName(reportType)}`, 105, 25, { align: 'center' });
            
            doc.setFontSize(10);
            doc.setTextColor(100, 100, 100);
            doc.text(`Gerado em: ${new Date().toLocaleDateString('pt-PT')} às ${new Date().toLocaleTimeString('pt-PT')}`, 105, 32, { align: 'center' });
            
            // Linha separadora
            doc.setDrawColor(38, 25, 107);
            doc.setLineWidth(0.5);
            doc.line(20, 36, 190, 36);
            
            // Gerar relatório baseado no tipo
            switch(reportType) {
                case 'daily':
                    generateDailyReport(doc, reportDate);
                    break;
                case 'weekly':
                    generateWeeklyReport(doc, reportDate);
                    break;
                case 'monthly':
                    generateMonthlyReport(doc, reportDate);
                    break;
                case 'yearly':
                    generateYearlyReport(doc, reportDate);
                    break;
                case 'collaborator':
                    generateCollaboratorReport(doc, reportCollaborator, reportDate);
                    break;
                case 'inventory':
                    generateInventoryReport(doc);
                    break;
                case 'financial':
                    generateFinancialReport(doc, reportDate);
                    break;
                default:
                    generateDefaultReport(doc);
            }
            
            // Rodapé em todas as páginas
            const totalPages = doc.internal.getNumberOfPages();
            for (let i = 1; i <= totalPages; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.setTextColor(150, 150, 150);
                doc.text(`Página ${i} de ${totalPages}`, 105, 290, { align: 'center' });
                doc.text(businessSettings.name || 'Studio DeVitto', 20, 290);
            }
            
            // Salvar o PDF
            const fileName = `relatorio_${reportType}_${new Date().toISOString().split('T')[0]}.pdf`;
            doc.save(fileName);
            
            showSuccess('Relatório gerado com sucesso!');
        }

        function getReportTypeName(type) {
            const types = {
                'daily': 'Diário',
                'weekly': 'Semanal',
                'monthly': 'Mensal',
                'yearly': 'Anual',
                'collaborator': 'Por Colaborador',
                'inventory': 'Estoque',
                'financial': 'Financeiro'
            };
            return types[type] || type;
        }

        // RELATÓRIO DIÁRIO - COMPLETO
        function generateDailyReport(doc, date) {
            const targetDate = date || new Date().toISOString().split('T')[0];
            const dailyServices = allServices.filter(s => s.date === targetDate);
            const dailyProductSales = allProductSales.filter(s => s.date === targetDate);
            
            let y = 45;
            
            // Título do período
            doc.setFontSize(14);
            doc.setTextColor(38, 25, 107);
            doc.text(`Data: ${formatDate(targetDate)}`, 20, y);
            y += 12;
            
            // Resumo do dia
            doc.setFontSize(12);
            doc.setTextColor(0, 0, 0);
            doc.setFillColor(240, 240, 240);
            doc.rect(20, y - 5, 170, 35, 'F');
            
            const totalServicesValue = dailyServices.reduce((sum, s) => sum + parseFloat(s.value || 0), 0);
            const totalProductsValue = dailyProductSales.reduce((sum, p) => sum + parseFloat(p.totalValue || 0), 0);
            const totalValue = totalServicesValue + totalProductsValue;
            
            doc.setFont(undefined, 'bold');
            doc.text('RESUMO DO DIA', 25, y + 3);
            doc.setFont(undefined, 'normal');
            y += 10;
            doc.text(`Serviços Realizados: ${dailyServices.length}`, 25, y);
            doc.text(`Valor Serviços: ${formatCurrency(totalServicesValue)}`, 110, y);
            y += 7;
            doc.text(`Produtos Vendidos: ${dailyProductSales.length}`, 25, y);
            doc.text(`Valor Produtos: ${formatCurrency(totalProductsValue)}`, 110, y);
            y += 7;
            doc.setFont(undefined, 'bold');
            doc.text(`TOTAL DO DIA: ${formatCurrency(totalValue)}`, 25, y);
            doc.setFont(undefined, 'normal');
            y += 15;
            
            // Tabela de Serviços
            if (dailyServices.length > 0) {
                doc.setFontSize(12);
                doc.setTextColor(38, 25, 107);
                doc.text('Serviços Realizados', 20, y);
                y += 8;
                
                const serviceData = dailyServices.map((service, index) => {
                    const client = clients.find(c => c.id === service.clientId) || { name: 'Não informado' };
                    const collaborator = collaborators.find(c => c.id === service.collaboratorId) || { name: 'Não informado' };
                    return [
                        (index + 1).toString(),
                        client.name,
                        service.description || 'Serviço',
                        collaborator.name,
                        formatCurrency(service.value || 0)
                    ];
                });
                
                doc.autoTable({
                    startY: y,
                    head: [['#', 'Cliente', 'Serviço', 'Colaborador', 'Valor']],
                    body: serviceData,
                    theme: 'striped',
                    headStyles: { fillColor: [38, 25, 107] },
                    margin: { left: 20, right: 20 }
                });
                
                y = doc.lastAutoTable.finalY + 10;
            }
            
            // Tabela de Produtos
            if (dailyProductSales.length > 0) {
                if (y > 240) {
                    doc.addPage();
                    y = 20;
                }
                
                doc.setFontSize(12);
                doc.setTextColor(38, 25, 107);
                doc.text('Produtos Vendidos', 20, y);
                y += 8;
                
                const productData = dailyProductSales.map((sale, index) => {
                    const product = products.find(p => p.id === sale.productId) || { name: sale.productName || 'Produto' };
                    const client = clients.find(c => c.id === sale.clientId) || { name: 'Venda Avulsa' };
                    return [
                        (index + 1).toString(),
                        product.name,
                        client.name,
                        (sale.quantity || 1).toString(),
                        formatCurrency(sale.totalValue || 0)
                    ];
                });
                
                doc.autoTable({
                    startY: y,
                    head: [['#', 'Produto', 'Cliente', 'Qtd', 'Valor']],
                    body: productData,
                    theme: 'striped',
                    headStyles: { fillColor: [38, 25, 107] },
                    margin: { left: 20, right: 20 }
                });
            }
            
            // Se não houver dados
            if (dailyServices.length === 0 && dailyProductSales.length === 0) {
                doc.setFontSize(12);
                doc.setTextColor(100, 100, 100);
                doc.text('Nenhum serviço ou venda registrado nesta data.', 20, y);
            }
        }

        // RELATÓRIO SEMANAL - COMPLETO
        function generateWeeklyReport(doc, date) {
            const targetDate = new Date(date || new Date());
            
            // Calcular início e fim da semana
            const dayOfWeek = targetDate.getDay();
            const startOfWeek = new Date(targetDate);
            startOfWeek.setDate(targetDate.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1)); // Segunda
            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(startOfWeek.getDate() + 6); // Domingo
            
            const startDateStr = startOfWeek.toISOString().split('T')[0];
            const endDateStr = endOfWeek.toISOString().split('T')[0];
            
            // Filtrar serviços e vendas da semana
            const weeklyServices = allServices.filter(s => s.date >= startDateStr && s.date <= endDateStr);
            const weeklyProductSales = allProductSales.filter(s => s.date >= startDateStr && s.date <= endDateStr);
            
            let y = 45;
            
            // Título do período
            doc.setFontSize(14);
            doc.setTextColor(38, 25, 107);
            doc.text(`Período: ${formatDate(startDateStr)} a ${formatDate(endDateStr)}`, 20, y);
            y += 12;
            
            // Resumo da semana
            const totalServicesValue = weeklyServices.reduce((sum, s) => sum + parseFloat(s.value || 0), 0);
            const totalProductsValue = weeklyProductSales.reduce((sum, p) => sum + parseFloat(p.totalValue || 0), 0);
            const totalValue = totalServicesValue + totalProductsValue;
            
            doc.setFontSize(12);
            doc.setFillColor(240, 240, 240);
            doc.rect(20, y - 5, 170, 35, 'F');
            
            doc.setFont(undefined, 'bold');
            doc.text('RESUMO DA SEMANA', 25, y + 3);
            doc.setFont(undefined, 'normal');
            y += 10;
            doc.text(`Serviços Realizados: ${weeklyServices.length}`, 25, y);
            doc.text(`Valor Serviços: ${formatCurrency(totalServicesValue)}`, 110, y);
            y += 7;
            doc.text(`Produtos Vendidos: ${weeklyProductSales.length}`, 25, y);
            doc.text(`Valor Produtos: ${formatCurrency(totalProductsValue)}`, 110, y);
            y += 7;
            doc.setFont(undefined, 'bold');
            doc.text(`TOTAL DA SEMANA: ${formatCurrency(totalValue)}`, 25, y);
            doc.setFont(undefined, 'normal');
            y += 15;
            
            // Resumo por dia da semana
            doc.setFontSize(12);
            doc.setTextColor(38, 25, 107);
            doc.text('Resumo por Dia', 20, y);
            y += 8;
            
            const dayNames = ['Segunda', 'Terça', 'Quarta', 'Quinta', 'Sexta', 'Sábado', 'Domingo'];
            const dayData = [];
            
            for (let i = 0; i < 7; i++) {
                const currentDay = new Date(startOfWeek);
                currentDay.setDate(startOfWeek.getDate() + i);
                const dayStr = currentDay.toISOString().split('T')[0];
                
                const dayServices = weeklyServices.filter(s => s.date === dayStr);
                const dayProducts = weeklyProductSales.filter(p => p.date === dayStr);
                const dayServicesValue = dayServices.reduce((sum, s) => sum + parseFloat(s.value || 0), 0);
                const dayProductsValue = dayProducts.reduce((sum, p) => sum + parseFloat(p.totalValue || 0), 0);
                
                dayData.push([
                    dayNames[i],
                    formatDate(dayStr),
                    dayServices.length.toString(),
                    dayProducts.length.toString(),
                    formatCurrency(dayServicesValue + dayProductsValue)
                ]);
            }
            
            doc.autoTable({
                startY: y,
                head: [['Dia', 'Data', 'Serviços', 'Produtos', 'Total']],
                body: dayData,
                theme: 'striped',
                headStyles: { fillColor: [38, 25, 107] },
                margin: { left: 20, right: 20 }
            });
            
            y = doc.lastAutoTable.finalY + 15;
            
            // Resumo por colaborador
            if (weeklyServices.length > 0) {
                if (y > 220) {
                    doc.addPage();
                    y = 20;
                }
                
                doc.setFontSize(12);
                doc.setTextColor(38, 25, 107);
                doc.text('Desempenho por Colaborador', 20, y);
                y += 8;
                
                const collaboratorStats = {};
                weeklyServices.forEach(service => {
                    const collab = collaborators.find(c => c.id === service.collaboratorId);
                    const collabName = collab ? collab.name : 'Não informado';
                    
                    if (!collaboratorStats[collabName]) {
                        collaboratorStats[collabName] = { services: 0, value: 0 };
                    }
                    collaboratorStats[collabName].services++;
                    collaboratorStats[collabName].value += parseFloat(service.value || 0);
                });
                
                const collabData = Object.entries(collaboratorStats).map(([name, stats]) => [
                    name,
                    stats.services.toString(),
                    formatCurrency(stats.value),
                    formatCurrency(stats.value / stats.services)
                ]);
                
                doc.autoTable({
                    startY: y,
                    head: [['Colaborador', 'Serviços', 'Total', 'Média']],
                    body: collabData,
                    theme: 'striped',
                    headStyles: { fillColor: [38, 25, 107] },
                    margin: { left: 20, right: 20 }
                });
            }
        }

        // RELATÓRIO MENSAL - COMPLETO
        function generateMonthlyReport(doc, date) {
            const targetDate = new Date(date || new Date());
            const year = targetDate.getFullYear();
            const month = targetDate.getMonth();
            
            const startOfMonth = new Date(year, month, 1);
            const endOfMonth = new Date(year, month + 1, 0);
            
            const startDateStr = startOfMonth.toISOString().split('T')[0];
            const endDateStr = endOfMonth.toISOString().split('T')[0];
            
            // Filtrar dados do mês
            const monthlyServices = allServices.filter(s => s.date >= startDateStr && s.date <= endDateStr);
            const monthlyProductSales = allProductSales.filter(s => s.date >= startDateStr && s.date <= endDateStr);
            const monthlyExpenses = expenses.filter(e => {
                const expDate = e.date || e.dueDate;
                return expDate >= startDateStr && expDate <= endDateStr;
            });
            
            const monthNames = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
                               'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
            
            let y = 45;
            
            // Título do período
            doc.setFontSize(14);
            doc.setTextColor(38, 25, 107);
            doc.text(`Mês: ${monthNames[month]} de ${year}`, 20, y);
            y += 12;
            
            // Cálculos
            const totalServicesValue = monthlyServices.reduce((sum, s) => sum + parseFloat(s.value || 0), 0);
            const totalProductsValue = monthlyProductSales.reduce((sum, p) => sum + parseFloat(p.totalValue || 0), 0);
            const totalExpensesValue = monthlyExpenses.filter(e => e.paid).reduce((sum, e) => sum + parseFloat(e.value || 0), 0);
            const totalRevenue = totalServicesValue + totalProductsValue;
            const netProfit = totalRevenue - totalExpensesValue;
            
            // Resumo do mês
            doc.setFontSize(12);
            doc.setFillColor(240, 240, 240);
            doc.rect(20, y - 5, 170, 45, 'F');
            
            doc.setFont(undefined, 'bold');
            doc.text('RESUMO DO MÊS', 25, y + 3);
            doc.setFont(undefined, 'normal');
            y += 10;
            doc.text(`Serviços Realizados: ${monthlyServices.length}`, 25, y);
            doc.text(`Valor Serviços: ${formatCurrency(totalServicesValue)}`, 110, y);
            y += 7;
            doc.text(`Produtos Vendidos: ${monthlyProductSales.length}`, 25, y);
            doc.text(`Valor Produtos: ${formatCurrency(totalProductsValue)}`, 110, y);
            y += 7;
            doc.text(`Receita Total: ${formatCurrency(totalRevenue)}`, 25, y);
            doc.text(`Despesas Pagas: ${formatCurrency(totalExpensesValue)}`, 110, y);
            y += 7;
            doc.setFont(undefined, 'bold');
            const profitColor = netProfit >= 0 ? [0, 128, 0] : [255, 0, 0];
            doc.setTextColor(...profitColor);
            doc.text(`LUCRO LÍQUIDO: ${formatCurrency(netProfit)}`, 25, y);
            doc.setTextColor(0, 0, 0);
            doc.setFont(undefined, 'normal');
            y += 15;
            
            // Resumo por semana
            doc.setFontSize(12);
            doc.setTextColor(38, 25, 107);
            doc.text('Resumo por Semana', 20, y);
            y += 8;
            
            const weekData = [];
            let currentWeekStart = new Date(startOfMonth);
            let weekNum = 1;
            
            while (currentWeekStart <= endOfMonth) {
                const weekEnd = new Date(currentWeekStart);
                weekEnd.setDate(weekEnd.getDate() + 6);
                if (weekEnd > endOfMonth) weekEnd.setTime(endOfMonth.getTime());
                
                const weekStartStr = currentWeekStart.toISOString().split('T')[0];
                const weekEndStr = weekEnd.toISOString().split('T')[0];
                
                const weekServices = monthlyServices.filter(s => s.date >= weekStartStr && s.date <= weekEndStr);
                const weekProducts = monthlyProductSales.filter(p => p.date >= weekStartStr && p.date <= weekEndStr);
                const weekServicesValue = weekServices.reduce((sum, s) => sum + parseFloat(s.value || 0), 0);
                const weekProductsValue = weekProducts.reduce((sum, p) => sum + parseFloat(p.totalValue || 0), 0);
                
                weekData.push([
                    `Semana ${weekNum}`,
                    `${formatDate(weekStartStr)} - ${formatDate(weekEndStr)}`,
                    weekServices.length.toString(),
                    weekProducts.length.toString(),
                    formatCurrency(weekServicesValue + weekProductsValue)
                ]);
                
                currentWeekStart.setDate(currentWeekStart.getDate() + 7);
                weekNum++;
            }
            
            doc.autoTable({
                startY: y,
                head: [['Semana', 'Período', 'Serviços', 'Produtos', 'Total']],
                body: weekData,
                theme: 'striped',
                headStyles: { fillColor: [38, 25, 107] },
                margin: { left: 20, right: 20 }
            });
            
            y = doc.lastAutoTable.finalY + 15;
            
            // Top 5 serviços mais realizados
            if (monthlyServices.length > 0) {
                if (y > 220) {
                    doc.addPage();
                    y = 20;
                }
                
                doc.setFontSize(12);
                doc.setTextColor(38, 25, 107);
                doc.text('Top Serviços do Mês', 20, y);
                y += 8;
                
                const serviceTypes = {};
                monthlyServices.forEach(service => {
                    const desc = service.description || 'Serviço';
                    if (!serviceTypes[desc]) {
                        serviceTypes[desc] = { count: 0, value: 0 };
                    }
                    serviceTypes[desc].count++;
                    serviceTypes[desc].value += parseFloat(service.value || 0);
                });
                
                const topServices = Object.entries(serviceTypes)
                    .sort((a, b) => b[1].count - a[1].count)
                    .slice(0, 5)
                    .map(([name, stats]) => [name, stats.count.toString(), formatCurrency(stats.value)]);
                
                doc.autoTable({
                    startY: y,
                    head: [['Serviço', 'Quantidade', 'Valor Total']],
                    body: topServices,
                    theme: 'striped',
                    headStyles: { fillColor: [38, 25, 107] },
                    margin: { left: 20, right: 20 }
                });
            }
        }

        // RELATÓRIO ANUAL - COMPLETO
        function generateYearlyReport(doc, date) {
            const targetDate = new Date(date || new Date());
            const year = targetDate.getFullYear();
            
            const startOfYear = `${year}-01-01`;
            const endOfYear = `${year}-12-31`;
            
            // Filtrar dados do ano
            const yearlyServices = allServices.filter(s => s.date >= startOfYear && s.date <= endOfYear);
            const yearlyProductSales = allProductSales.filter(s => s.date >= startOfYear && s.date <= endOfYear);
            const yearlyExpenses = expenses.filter(e => {
                const expDate = e.date || e.dueDate;
                return expDate >= startOfYear && expDate <= endOfYear;
            });
            
            let y = 45;
            
            // Título do período
            doc.setFontSize(14);
            doc.setTextColor(38, 25, 107);
            doc.text(`Ano: ${year}`, 20, y);
            y += 12;
            
            // Cálculos
            const totalServicesValue = yearlyServices.reduce((sum, s) => sum + parseFloat(s.value || 0), 0);
            const totalProductsValue = yearlyProductSales.reduce((sum, p) => sum + parseFloat(p.totalValue || 0), 0);
            const totalExpensesValue = yearlyExpenses.filter(e => e.paid).reduce((sum, e) => sum + parseFloat(e.value || 0), 0);
            const totalRevenue = totalServicesValue + totalProductsValue;
            const netProfit = totalRevenue - totalExpensesValue;
            
            // Resumo do ano
            doc.setFontSize(12);
            doc.setFillColor(240, 240, 240);
            doc.rect(20, y - 5, 170, 45, 'F');
            
            doc.setFont(undefined, 'bold');
            doc.text('RESUMO ANUAL', 25, y + 3);
            doc.setFont(undefined, 'normal');
            y += 10;
            doc.text(`Serviços Realizados: ${yearlyServices.length}`, 25, y);
            doc.text(`Valor Serviços: ${formatCurrency(totalServicesValue)}`, 110, y);
            y += 7;
            doc.text(`Produtos Vendidos: ${yearlyProductSales.length}`, 25, y);
            doc.text(`Valor Produtos: ${formatCurrency(totalProductsValue)}`, 110, y);
            y += 7;
            doc.text(`Receita Total: ${formatCurrency(totalRevenue)}`, 25, y);
            doc.text(`Despesas Totais: ${formatCurrency(totalExpensesValue)}`, 110, y);
            y += 7;
            doc.setFont(undefined, 'bold');
            const profitColor = netProfit >= 0 ? [0, 128, 0] : [255, 0, 0];
            doc.setTextColor(...profitColor);
            doc.text(`LUCRO LÍQUIDO ANUAL: ${formatCurrency(netProfit)}`, 25, y);
            doc.setTextColor(0, 0, 0);
            doc.setFont(undefined, 'normal');
            y += 15;
            
            // Resumo por mês
            doc.setFontSize(12);
            doc.setTextColor(38, 25, 107);
            doc.text('Resumo Mensal', 20, y);
            y += 8;
            
            const monthNames = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
            const monthData = [];
            
            for (let m = 0; m < 12; m++) {
                const monthStart = `${year}-${String(m + 1).padStart(2, '0')}-01`;
                const lastDay = new Date(year, m + 1, 0).getDate();
                const monthEnd = `${year}-${String(m + 1).padStart(2, '0')}-${lastDay}`;
                
                const monthServices = yearlyServices.filter(s => s.date >= monthStart && s.date <= monthEnd);
                const monthProducts = yearlyProductSales.filter(p => p.date >= monthStart && p.date <= monthEnd);
                const monthServicesValue = monthServices.reduce((sum, s) => sum + parseFloat(s.value || 0), 0);
                const monthProductsValue = monthProducts.reduce((sum, p) => sum + parseFloat(p.totalValue || 0), 0);
                
                monthData.push([
                    monthNames[m],
                    monthServices.length.toString(),
                    monthProducts.length.toString(),
                    formatCurrency(monthServicesValue),
                    formatCurrency(monthProductsValue),
                    formatCurrency(monthServicesValue + monthProductsValue)
                ]);
            }
            
            doc.autoTable({
                startY: y,
                head: [['Mês', 'Serv.', 'Prod.', 'Valor Serv.', 'Valor Prod.', 'Total']],
                body: monthData,
                theme: 'striped',
                headStyles: { fillColor: [38, 25, 107] },
                margin: { left: 20, right: 20 },
                styles: { fontSize: 9 }
            });
            
            y = doc.lastAutoTable.finalY + 15;
            
            // Top colaboradores do ano
            if (yearlyServices.length > 0) {
                doc.addPage();
                y = 20;
                
                doc.setFontSize(12);
                doc.setTextColor(38, 25, 107);
                doc.text('Ranking de Colaboradores - Ano', 20, y);
                y += 8;
                
                const collaboratorStats = {};
                yearlyServices.forEach(service => {
                    const collab = collaborators.find(c => c.id === service.collaboratorId);
                    const collabName = collab ? collab.name : 'Não informado';
                    
                    if (!collaboratorStats[collabName]) {
                        collaboratorStats[collabName] = { services: 0, value: 0 };
                    }
                    collaboratorStats[collabName].services++;
                    collaboratorStats[collabName].value += parseFloat(service.value || 0);
                });
                
                const collabData = Object.entries(collaboratorStats)
                    .sort((a, b) => b[1].value - a[1].value)
                    .map(([name, stats], index) => [
                        `${index + 1}º`,
                        name,
                        stats.services.toString(),
                        formatCurrency(stats.value),
                        formatCurrency(stats.value / stats.services)
                    ]);
                
                doc.autoTable({
                    startY: y,
                    head: [['Pos.', 'Colaborador', 'Serviços', 'Total', 'Média']],
                    body: collabData,
                    theme: 'striped',
                    headStyles: { fillColor: [38, 25, 107] },
                    margin: { left: 20, right: 20 }
                });
            }
        }

        // RELATÓRIO POR COLABORADOR - COMPLETO
        function generateCollaboratorReport(doc, collaboratorId, date) {
            const targetDate = new Date(date || new Date());
            const year = targetDate.getFullYear();
            const month = targetDate.getMonth();
            
            const startOfMonth = `${year}-${String(month + 1).padStart(2, '0')}-01`;
            const lastDay = new Date(year, month + 1, 0).getDate();
            const endOfMonth = `${year}-${String(month + 1).padStart(2, '0')}-${lastDay}`;
            
            let y = 45;
            
            if (collaboratorId === 'all') {
                // Relatório de todos os colaboradores
                doc.setFontSize(14);
                doc.setTextColor(38, 25, 107);
                doc.text('Relatório de Todos os Colaboradores', 20, y);
                y += 8;
                
                const monthNames = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
                                   'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
                doc.setFontSize(11);
                doc.setTextColor(0, 0, 0);
                doc.text(`Período: ${monthNames[month]} de ${year}`, 20, y);
                y += 12;
                
                const collabData = [];
                collaborators.forEach(collab => {
                    const collabServices = allServices.filter(s => 
                        s.collaboratorId === collab.id && 
                        s.date >= startOfMonth && 
                        s.date <= endOfMonth
                    );
                    
                    const totalValue = collabServices.reduce((sum, s) => sum + parseFloat(s.value || 0), 0);
                    const commission = totalValue * (collab.manualPercent / 100);
                    
                    collabData.push([
                        collab.name,
                        collab.specialty || '-',
                        collabServices.length.toString(),
                        formatCurrency(totalValue),
                        `${collab.manualPercent}%`,
                        formatCurrency(commission)
                    ]);
                });
                
                doc.autoTable({
                    startY: y,
                    head: [['Colaborador', 'Especialidade', 'Serviços', 'Total', 'Comissão %', 'Valor Comissão']],
                    body: collabData,
                    theme: 'striped',
                    headStyles: { fillColor: [38, 25, 107] },
                    margin: { left: 20, right: 20 },
                    styles: { fontSize: 9 }
                });
                
            } else {
                // Relatório de um colaborador específico
                const collaborator = collaborators.find(c => c.id === collaboratorId);
                
                if (!collaborator) {
                    doc.text('Colaborador não encontrado.', 20, y);
                    return;
                }
                
                // Serviços do colaborador no mês
                const collabServices = allServices.filter(s => 
                    s.collaboratorId === collaboratorId && 
                    s.date >= startOfMonth && 
                    s.date <= endOfMonth
                );
                
                const totalValue = collabServices.reduce((sum, s) => sum + parseFloat(s.value || 0), 0);
                const commission = totalValue * (collaborator.manualPercent / 100);
                
                // Cabeçalho do colaborador
                doc.setFontSize(14);
                doc.setTextColor(38, 25, 107);
                doc.text(`Colaborador: ${collaborator.name}`, 20, y);
                y += 8;
                
                const monthNames = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
                                   'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
                doc.setFontSize(11);
                doc.setTextColor(0, 0, 0);
                doc.text(`Período: ${monthNames[month]} de ${year}`, 20, y);
                y += 12;
                
                // Informações do colaborador
                doc.setFillColor(240, 240, 240);
                doc.rect(20, y - 5, 170, 40, 'F');
                
                doc.setFont(undefined, 'bold');
                doc.text('DADOS DO COLABORADOR', 25, y + 3);
                doc.setFont(undefined, 'normal');
                y += 10;
                doc.text(`Especialidade: ${collaborator.specialty || 'Não informada'}`, 25, y);
                doc.text(`Contato: ${collaborator.contact || 'Não informado'}`, 110, y);
                y += 7;
                doc.text(`Comissão Serviços: ${collaborator.manualPercent}%`, 25, y);
                doc.text(`Comissão Produtos: ${collaborator.productPercent}%`, 110, y);
                y += 7;
                doc.text(`Salário Base: ${formatCurrency(collaborator.baseSalary || 0)}`, 25, y);
                doc.text(`Status: ${collaborator.active ? 'Ativo' : 'Inativo'}`, 110, y);
                y += 15;
                
                // Resumo do período
                doc.setFillColor(38, 25, 107);
                doc.setTextColor(255, 255, 255);
                doc.rect(20, y - 5, 170, 25, 'F');
                
                doc.setFont(undefined, 'bold');
                doc.text('RESUMO DO PERÍODO', 25, y + 3);
                doc.setFont(undefined, 'normal');
                y += 10;
                doc.text(`Serviços Realizados: ${collabServices.length}`, 25, y);
                doc.text(`Valor Total: ${formatCurrency(totalValue)}`, 90, y);
                doc.text(`Comissão a Receber: ${formatCurrency(commission)}`, 140, y);
                y += 15;
                
                doc.setTextColor(0, 0, 0);
                
                // Lista de serviços
                if (collabServices.length > 0) {
                    doc.setFontSize(12);
                    doc.setTextColor(38, 25, 107);
                    doc.text('Serviços Realizados', 20, y);
                    y += 8;
                    
                    const serviceData = collabServices.map((service, index) => {
                        const client = clients.find(c => c.id === service.clientId) || { name: 'Não informado' };
                        return [
                            formatDate(service.date),
                            client.name,
                            service.description || 'Serviço',
                            formatCurrency(service.value || 0),
                            formatCurrency((service.value || 0) * collaborator.manualPercent / 100)
                        ];
                    });
                    
                    doc.autoTable({
                        startY: y,
                        head: [['Data', 'Cliente', 'Serviço', 'Valor', 'Comissão']],
                        body: serviceData,
                        theme: 'striped',
                        headStyles: { fillColor: [38, 25, 107] },
                        margin: { left: 20, right: 20 },
                        styles: { fontSize: 9 }
                    });
                } else {
                    doc.setFontSize(11);
                    doc.setTextColor(100, 100, 100);
                    doc.text('Nenhum serviço realizado neste período.', 20, y);
                }
            }
        }

        // RELATÓRIO DE ESTOQUE - COMPLETO
        function generateInventoryReport(doc) {
            let y = 45;
            
            // Título
            doc.setFontSize(14);
            doc.setTextColor(38, 25, 107);
            doc.text('Relatório de Estoque', 20, y);
            y += 12;
            
            // Cálculos
            const totalProducts = products.length;
            const lowStockProducts = products.filter(p => p.quantity <= p.minQuantity);
            const outOfStockProducts = products.filter(p => p.quantity === 0);
            const totalInventoryValue = products.reduce((sum, p) => sum + (p.quantity * parseFloat(p.salePrice || 0)), 0);
            const totalInvestment = products.reduce((sum, p) => sum + (p.quantity * parseFloat(p.purchasePrice || 0)), 0);
            const potentialProfit = totalInventoryValue - totalInvestment;
            
            // Resumo
            doc.setFontSize(12);
            doc.setFillColor(240, 240, 240);
            doc.rect(20, y - 5, 170, 45, 'F');
            
            doc.setFont(undefined, 'bold');
            doc.text('RESUMO DO ESTOQUE', 25, y + 3);
            doc.setFont(undefined, 'normal');
            y += 10;
            doc.text(`Total de Produtos: ${totalProducts}`, 25, y);
            doc.text(`Valor de Venda: ${formatCurrency(totalInventoryValue)}`, 110, y);
            y += 7;
            doc.text(`Produtos com Estoque Baixo: ${lowStockProducts.length}`, 25, y);
            doc.text(`Valor de Custo: ${formatCurrency(totalInvestment)}`, 110, y);
            y += 7;
            doc.text(`Produtos Esgotados: ${outOfStockProducts.length}`, 25, y);
            doc.setTextColor(0, 128, 0);
            doc.text(`Lucro Potencial: ${formatCurrency(potentialProfit)}`, 110, y);
            doc.setTextColor(0, 0, 0);
            y += 15;
            
            // Alertas de estoque baixo
            if (lowStockProducts.length > 0) {
                doc.setFontSize(12);
                doc.setTextColor(220, 53, 69); // Cor vermelha
                doc.text('⚠ Alertas de Estoque Baixo', 20, y);
                y += 8;
                
                const alertData = lowStockProducts.map(p => [
                    p.name,
                    p.quantity.toString(),
                    p.minQuantity.toString(),
                    (p.minQuantity - p.quantity).toString()
                ]);
                
                doc.autoTable({
                    startY: y,
                    head: [['Produto', 'Estoque Atual', 'Mínimo', 'Faltam']],
                    body: alertData,
                    theme: 'striped',
                    headStyles: { fillColor: [220, 53, 69] },
                    margin: { left: 20, right: 20 }
                });
                
                y = doc.lastAutoTable.finalY + 15;
            }
            
            // Lista completa de produtos
            if (products.length > 0) {
                if (y > 200) {
                    doc.addPage();
                    y = 20;
                }
                
                doc.setFontSize(12);
                doc.setTextColor(38, 25, 107);
                doc.text('Lista Completa de Produtos', 20, y);
                y += 8;
                
                const productData = products.map(p => {
                    const isLowStock = p.quantity <= p.minQuantity;
                    return [
                        p.name,
                        p.quantity.toString(),
                        formatCurrency(p.purchasePrice || 0),
                        formatCurrency(p.salePrice || 0),
                        formatCurrency(p.quantity * parseFloat(p.salePrice || 0)),
                        isLowStock ? 'BAIXO' : 'OK'
                    ];
                });
                
                doc.autoTable({
                    startY: y,
                    head: [['Produto', 'Qtd', 'Custo', 'Venda', 'Valor Total', 'Status']],
                    body: productData,
                    theme: 'striped',
                    headStyles: { fillColor: [38, 25, 107] },
                    margin: { left: 20, right: 20 },
                    styles: { fontSize: 9 },
                    didParseCell: function(data) {
                        if (data.column.index === 5 && data.cell.raw === 'BAIXO') {
                            data.cell.styles.textColor = [220, 53, 69];
                            data.cell.styles.fontStyle = 'bold';
                        }
                    }
                });
            } else {
                doc.setFontSize(11);
                doc.setTextColor(100, 100, 100);
                doc.text('Nenhum produto cadastrado.', 20, y);
            }
        }

        // RELATÓRIO FINANCEIRO - COMPLETO
        function generateFinancialReport(doc, date) {
            const targetDate = new Date(date || new Date());
            const year = targetDate.getFullYear();
            const month = targetDate.getMonth();
            
            const startOfMonth = `${year}-${String(month + 1).padStart(2, '0')}-01`;
            const lastDay = new Date(year, month + 1, 0).getDate();
            const endOfMonth = `${year}-${String(month + 1).padStart(2, '0')}-${lastDay}`;
            
            const monthNames = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
                               'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
            
            // Filtrar dados
            const monthlyServices = allServices.filter(s => s.date >= startOfMonth && s.date <= endOfMonth);
            const monthlyProductSales = allProductSales.filter(s => s.date >= startOfMonth && s.date <= endOfMonth);
            const monthlyExpenses = expenses.filter(e => {
                const expDate = e.date || e.dueDate;
                return expDate >= startOfMonth && expDate <= endOfMonth;
            });
            
            let y = 45;
            
            // Título
            doc.setFontSize(14);
            doc.setTextColor(38, 25, 107);
            doc.text(`Relatório Financeiro - ${monthNames[month]} de ${year}`, 20, y);
            y += 15;
            
            // Cálculos
            const servicesRevenue = monthlyServices.reduce((sum, s) => sum + parseFloat(s.value || 0), 0);
            const productsRevenue = monthlyProductSales.reduce((sum, p) => sum + parseFloat(p.totalValue || 0), 0);
            const productsCost = monthlyProductSales.reduce((sum, p) => {
                const product = products.find(pr => pr.id === p.productId);
                const cost = product ? parseFloat(product.purchasePrice || 0) : 0;
                return sum + (cost * (p.quantity || 1));
            }, 0);
            
            const totalRevenue = servicesRevenue + productsRevenue;
            const paidExpenses = monthlyExpenses.filter(e => e.paid).reduce((sum, e) => sum + parseFloat(e.value || 0), 0);
            const pendingExpenses = monthlyExpenses.filter(e => !e.paid).reduce((sum, e) => sum + parseFloat(e.value || 0), 0);
            const netProfit = totalRevenue - paidExpenses - productsCost;
            
            // Resumo Financeiro
            doc.setFontSize(12);
            doc.setFillColor(40, 167, 69); // Verde
            doc.rect(20, y - 5, 80, 35, 'F');
            doc.setFillColor(220, 53, 69); // Vermelho
            doc.rect(105, y - 5, 85, 35, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFont(undefined, 'bold');
            doc.text('RECEITAS', 25, y + 3);
            doc.text('DESPESAS', 110, y + 3);
            doc.setFont(undefined, 'normal');
            y += 10;
            doc.text(`Serviços: ${formatCurrency(servicesRevenue)}`, 25, y);
            doc.text(`Pagas: ${formatCurrency(paidExpenses)}`, 110, y);
            y += 7;
            doc.text(`Produtos: ${formatCurrency(productsRevenue)}`, 25, y);
            doc.text(`Pendentes: ${formatCurrency(pendingExpenses)}`, 110, y);
            y += 7;
            doc.text(`Total: ${formatCurrency(totalRevenue)}`, 25, y);
            doc.text(`Total: ${formatCurrency(paidExpenses + pendingExpenses)}`, 110, y);
            y += 15;
            
            doc.setTextColor(0, 0, 0);
            
            // Resultado
            doc.setFillColor(netProfit >= 0 ? [40, 167, 69] : [220, 53, 69]);
            doc.rect(20, y - 5, 170, 20, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFont(undefined, 'bold');
            doc.setFontSize(14);
            doc.text(`RESULTADO DO MÊS: ${formatCurrency(netProfit)}`, 105, y + 7, { align: 'center' });
            doc.setFont(undefined, 'normal');
            doc.setFontSize(12);
            doc.setTextColor(0, 0, 0);
            y += 25;
            
            // Detalhamento de Despesas
            if (monthlyExpenses.length > 0) {
                doc.setFontSize(12);
                doc.setTextColor(38, 25, 107);
                doc.text('Detalhamento de Despesas', 20, y);
                y += 8;
                
                // Agrupar por categoria
                const expensesByCategory = {};
                monthlyExpenses.forEach(exp => {
                    const cat = exp.category || 'Outros';
                    if (!expensesByCategory[cat]) {
                        expensesByCategory[cat] = { paid: 0, pending: 0, total: 0 };
                    }
                    const value = parseFloat(exp.value || 0);
                    if (exp.paid) {
                        expensesByCategory[cat].paid += value;
                    } else {
                        expensesByCategory[cat].pending += value;
                    }
                    expensesByCategory[cat].total += value;
                });
                
                const categoryData = Object.entries(expensesByCategory).map(([cat, values]) => [
                    cat.charAt(0).toUpperCase() + cat.slice(1),
                    formatCurrency(values.paid),
                    formatCurrency(values.pending),
                    formatCurrency(values.total)
                ]);
                
                doc.autoTable({
                    startY: y,
                    head: [['Categoria', 'Pagas', 'Pendentes', 'Total']],
                    body: categoryData,
                    theme: 'striped',
                    headStyles: { fillColor: [38, 25, 107] },
                    margin: { left: 20, right: 20 }
                });
                
                y = doc.lastAutoTable.finalY + 15;
            }
            
            // Lista de Despesas Pendentes
            const pendingExpensesList = monthlyExpenses.filter(e => !e.paid);
            if (pendingExpensesList.length > 0) {
                if (y > 220) {
                    doc.addPage();
                    y = 20;
                }
                
                doc.setFontSize(12);
                doc.setTextColor(220, 53, 69);
                doc.text('⚠ Despesas Pendentes', 20, y);
                y += 8;
                
                const pendingData = pendingExpensesList.map(exp => [
                    exp.description,
                    exp.category || 'Outros',
                    formatDate(exp.dueDate),
                    formatCurrency(exp.value || 0)
                ]);
                
                doc.autoTable({
                    startY: y,
                    head: [['Descrição', 'Categoria', 'Vencimento', 'Valor']],
                    body: pendingData,
                    theme: 'striped',
                    headStyles: { fillColor: [220, 53, 69] },
                    margin: { left: 20, right: 20 }
                });
                
                y = doc.lastAutoTable.finalY + 15;
            }
            
            // Comissões dos Colaboradores
            if (monthlyServices.length > 0) {
                if (y > 220) {
                    doc.addPage();
                    y = 20;
                }
                
                doc.setFontSize(12);
                doc.setTextColor(38, 25, 107);
                doc.text('Comissões a Pagar', 20, y);
                y += 8;
                
                const commissionData = [];
                collaborators.forEach(collab => {
                    const collabServices = monthlyServices.filter(s => s.collaboratorId === collab.id);
                    const totalValue = collabServices.reduce((sum, s) => sum + parseFloat(s.value || 0), 0);
                    const commission = totalValue * (collab.manualPercent / 100);
                    
                    if (collabServices.length > 0) {
                        commissionData.push([
                            collab.name,
                            collabServices.length.toString(),
                            formatCurrency(totalValue),
                            `${collab.manualPercent}%`,
                            formatCurrency(commission)
                        ]);
                    }
                });
                
                if (commissionData.length > 0) {
                    const totalCommission = commissionData.reduce((sum, row) => {
                        const value = parseFloat(row[4].replace('€', '').replace('.', '').replace(',', '.').trim());
                        return sum + (isNaN(value) ? 0 : value);
                    }, 0);
                    
                    doc.autoTable({
                        startY: y,
                        head: [['Colaborador', 'Serviços', 'Total', '% Comissão', 'Valor']],
                        body: commissionData,
                        theme: 'striped',
                        headStyles: { fillColor: [38, 25, 107] },
                        margin: { left: 20, right: 20 }
                    });
                }
            }
        }

        // RELATÓRIO PADRÃO
        function generateDefaultReport(doc) {
            let y = 50;
            
            doc.setFontSize(14);
            doc.setTextColor(38, 25, 107);
            doc.text('Relatório Geral do Sistema', 20, y);
            y += 15;
            
            doc.setFontSize(12);
            doc.setTextColor(0, 0, 0);
            
            const data = [
                ['Total de Clientes', clients.length.toString()],
                ['Total de Colaboradores', collaborators.length.toString()],
                ['Colaboradores Ativos', collaborators.filter(c => c.active).length.toString()],
                ['Total de Serviços Registrados', allServices.length.toString()],
                ['Total de Vendas de Produtos', allProductSales.length.toString()],
                ['Produtos em Estoque', products.length.toString()],
                ['Pacotes Ativos', packages.filter(p => p.status === 'active').length.toString()]
            ];
            
            doc.autoTable({
                startY: y,
                head: [['Informação', 'Quantidade']],
                body: data,
                theme: 'striped',
                headStyles: { fillColor: [38, 25, 107] },
                margin: { left: 20, right: 20 }
            });
        }

        // Função para atualizar seletor de colaboradores nos relatórios
        function updateReportCollaboratorSelect() {
            const select = document.getElementById('reportCollaborator');
            if (!select) return;
            
            // Manter a opção "Todos"
            let html = '<option value="all">Todos</option>';
            
            collaborators.forEach(collab => {
                html += `<option value="${collab.id}">${collab.name}</option>`;
            });
            
            select.innerHTML = html;
        }

        // Evento para mostrar/ocultar seletor de colaborador
        document.getElementById('reportType').addEventListener('change', function() {
            const collaboratorContainer = document.getElementById('reportCollaborator').parentElement;
            if (this.value === 'collaborator') {
                collaboratorContainer.style.display = 'block';
                updateReportCollaboratorSelect();
            } else {
                collaboratorContainer.style.display = 'none';
            }
        });

        // ============================================================
        // FUNÇÕES PARA CONFIGURAÇÕES DO ESTABELECIMENTO
        // ============================================================

        function loadBusinessSettings() {
            const savedSettings = localStorage.getItem('studioDevitto_businessSettings');
            if (savedSettings) {
                try {
                    businessSettings = JSON.parse(savedSettings);
                    updateBusinessLogo();
                } catch (e) {
                    console.error('Erro ao carregar configurações:', e);
                }
            }
        }

        function saveBusinessSettings() {
            const businessName = document.getElementById('businessNameInput').value.trim();
            const logoType = document.getElementById('businessLogoType').value;
            
            if (!businessName) {
                showError('Por favor, informe o nome do estabelecimento.');
                return;
            }
            
            const newSettings = {
                name: businessName,
                logoType: logoType,
                customLogo: businessSettings.customLogo
            };
            
            // Salvar customLogo se houver
            const logoUpload = document.getElementById('logoUpload');
            if (logoUpload.files.length > 0 && logoType === 'custom') {
                const file = logoUpload.files[0];
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    newSettings.customLogo = e.target.result;
                    completeSaveBusinessSettings(newSettings);
                };
                
                reader.readAsDataURL(file);
            } else {
                completeSaveBusinessSettings(newSettings);
            }
        }

        function completeSaveBusinessSettings(newSettings) {
            businessSettings = newSettings;
            localStorage.setItem('studioDevitto_businessSettings', JSON.stringify(businessSettings));
            
            updateBusinessLogo();
            
            const modal = bootstrap.Modal.getInstance(document.getElementById('businessSettingsModal'));
            modal.hide();
            
            showSuccess('Configurações salvas com sucesso!');
        }

        function showBusinessSettingsModal() {
            document.getElementById('businessNameInput').value = businessSettings.name;
            document.getElementById('businessLogoType').value = businessSettings.logoType;
            
            toggleLogoUpload();
            
            if (businessSettings.customLogo && businessSettings.logoType === 'custom') {
                document.getElementById('logoPreview').src = businessSettings.customLogo;
                document.getElementById('logoPreview').style.display = 'block';
                document.getElementById('logoPlaceholder').style.display = 'none';
            }
            
            const modal = new bootstrap.Modal(document.getElementById('businessSettingsModal'));
            modal.show();
        }

        function toggleLogoUpload() {
            const logoType = document.getElementById('businessLogoType').value;
            const uploadContainer = document.getElementById('logoUploadContainer');
            
            if (logoType === 'custom') {
                uploadContainer.style.display = 'block';
            } else {
                uploadContainer.style.display = 'none';
            }
        }

        function handleLogoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!file.type.match('image.*')) {
                showError('Por favor, selecione uma imagem válida.');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('logoPreview').src = e.target.result;
                document.getElementById('logoPreview').style.display = 'block';
                document.getElementById('logoPlaceholder').style.display = 'none';
            };
            reader.readAsDataURL(file);
        }

        function updateBusinessLogo() {
            const businessNameElement = document.getElementById('businessName');
            const businessLogoIcon = document.getElementById('businessLogoIcon');
            
            businessNameElement.textContent = businessSettings.name;
            
            // Definir ícone baseado no tipo de logo
            let iconClass = 'fas fa-scissors';
            switch(businessSettings.logoType) {
                case 'store':
                    iconClass = 'fas fa-store';
                    break;
                case 'spa':
                    iconClass = 'fas fa-spa';
                    break;
                case 'salon':
                    iconClass = 'fas fa-cut';
                    break;
                case 'barber':
                    iconClass = 'fas fa-user-tie';
                    break;
                case 'custom':
                    iconClass = 'fas fa-image';
                    // Se tiver logo customizado, poderia mostrar a imagem
                    // Por enquanto, mantemos o ícone
                    break;
            }
            
            businessLogoIcon.className = iconClass + ' me-2';
        }

        // ============================================================
        // FUNÇÕES PARA PERFIL DA EMPRESA
        // ============================================================

        function loadBusinessProfile() {
            const savedProfile = localStorage.getItem('studioDevitto_businessProfile');
            if (savedProfile) {
                try {
                    businessProfile = JSON.parse(savedProfile);
                    updateBusinessProfileUI();
                } catch (e) {
                    console.error('Erro ao carregar perfil da empresa:', e);
                }
            }
        }

        function loadBusinessHours() {
            const savedHours = localStorage.getItem('studioDevitto_businessHours');
            if (savedHours) {
                try {
                    businessHours = JSON.parse(savedHours);
                    updateBusinessHoursUI();
                } catch (e) {
                    console.error('Erro ao carregar horários:', e);
                }
            }
        }

        function saveBusinessProfile(e) {
            if (e) e.preventDefault();
            
            const name = document.getElementById('businessName').value;
            const email = document.getElementById('businessEmail').value;
            const phone = document.getElementById('businessPhone').value;
            const address = document.getElementById('businessAddress').value;
            const description = document.getElementById('businessDescription').value;
            
            businessProfile = {
                name: name,
                email: email,
                phone: phone,
                address: address,
                description: description
            };
            
            // Salvar no Firestore também
            if (currentUser) {
                db.collection('businessProfile').doc(currentUser.uid).set(businessProfile, { merge: true })
                    .then(() => {
                        console.log('Perfil da empresa salvo no Firestore');
                    })
                    .catch(error => {
                        console.error('Erro ao salvar perfil no Firestore:', error);
                    });
            }
            
            localStorage.setItem('studioDevitto_businessProfile', JSON.stringify(businessProfile));
            updateBusinessProfileUI();
            
            showSuccess('Perfil da empresa salvo com sucesso!');
        }

        function saveBusinessHours() {
            const hours = {
                monday: {
                    open: document.getElementById('mondayOpen').value,
                    close: document.getElementById('mondayClose').value
                },
                tuesday: {
                    open: document.getElementById('tuesdayOpen').value,
                    close: document.getElementById('tuesdayClose').value
                },
                wednesday: {
                    open: document.getElementById('wednesdayOpen').value,
                    close: document.getElementById('wednesdayClose').value
                },
                thursday: {
                    open: document.getElementById('thursdayOpen').value,
                    close: document.getElementById('thursdayClose').value
                },
                friday: {
                    open: document.getElementById('fridayOpen').value,
                    close: document.getElementById('fridayClose').value
                },
                saturday: {
                    open: document.getElementById('saturdayOpen').value,
                    close: document.getElementById('saturdayClose').value
                },
                sunday: {
                    open: null,
                    close: null
                }
            };
            
            businessHours = hours;
            
            // Salvar no Firestore também
            if (currentUser) {
                db.collection('businessHours').doc(currentUser.uid).set(businessHours, { merge: true })
                    .then(() => {
                        console.log('Horários salvos no Firestore');
                    })
                    .catch(error => {
                        console.error('Erro ao salvar horários no Firestore:', error);
                    });
            }
            
            localStorage.setItem('studioDevitto_businessHours', JSON.stringify(businessHours));
            updateBusinessHoursUI();
            
            showSuccess('Horários de funcionamento salvos com sucesso!');
        }

        function updateBusinessProfileUI() {
            document.getElementById('businessName').value = businessProfile.name || '';
            document.getElementById('businessEmail').value = businessProfile.email || '';
            document.getElementById('businessPhone').value = businessProfile.phone || '';
            document.getElementById('businessAddress').value = businessProfile.address || '';
            document.getElementById('businessDescription').value = businessProfile.description || '';
            
            // Atualizar também no navbar se for diferente das configurações
            if (businessProfile.name && businessProfile.name !== businessSettings.name) {
                document.getElementById('businessName').textContent = businessProfile.name;
            }
        }

        function updateBusinessHoursUI() {
            if (!businessHours) return;
            
            // Segunda
            if (businessHours.monday) {
                document.getElementById('mondayOpen').value = businessHours.monday.open || '09:00';
                document.getElementById('mondayClose').value = businessHours.monday.close || '18:00';
            }
            
            // Terça
            if (businessHours.tuesday) {
                document.getElementById('tuesdayOpen').value = businessHours.tuesday.open || '09:00';
                document.getElementById('tuesdayClose').value = businessHours.tuesday.close || '18:00';
            }
            
            // Quarta
            if (businessHours.wednesday) {
                document.getElementById('wednesdayOpen').value = businessHours.wednesday.open || '09:00';
                document.getElementById('wednesdayClose').value = businessHours.wednesday.close || '18:00';
            }
            
            // Quinta
            if (businessHours.thursday) {
                document.getElementById('thursdayOpen').value = businessHours.thursday.open || '09:00';
                document.getElementById('thursdayClose').value = businessHours.thursday.close || '18:00';
            }
            
            // Sexta
            if (businessHours.friday) {
                document.getElementById('fridayOpen').value = businessHours.friday.open || '09:00';
                document.getElementById('fridayClose').value = businessHours.friday.close || '18:00';
            }
            
            // Sábado
            if (businessHours.saturday) {
                document.getElementById('saturdayOpen').value = businessHours.saturday.open || '09:00';
                document.getElementById('saturdayClose').value = businessHours.saturday.close || '13:00';
            }
        }

        // ============================================================
        // FUNÇÕES PARA COLABORADORES (EXISTENTES)
        // ============================================================

        function showAddCollaboratorModal() {
            document.getElementById('collaboratorModalTitle').textContent = 'Adicionar Colaborador';
            document.getElementById('collaboratorForm').reset();
            document.getElementById('collaboratorId').value = '';
            document.getElementById('collaboratorManualPercent').value = '50';
            document.getElementById('collaboratorProductPercent').value = '50';
            document.getElementById('collaboratorBaseSalary').value = '0';
            
            // Resetar foto
            document.getElementById('collaboratorPhotoPreview').style.display = 'none';
            document.getElementById('collaboratorPhotoPlaceholder').style.display = 'flex';
            
            const modal = new bootstrap.Modal(document.getElementById('collaboratorModal'));
            modal.show();
        }

        function editCollaborator(collaboratorId) {
            const collaborator = collaborators.find(c => c.id === collaboratorId);
            if (!collaborator) return;
            
            document.getElementById('collaboratorModalTitle').textContent = 'Editar Colaborador';
            document.getElementById('collaboratorId').value = collaborator.id;
            document.getElementById('collaboratorName').value = collaborator.name;
            document.getElementById('collaboratorContact').value = collaborator.contact || '';
            document.getElementById('collaboratorManualPercent').value = collaborator.manualPercent;
            document.getElementById('collaboratorProductPercent').value = collaborator.productPercent;
            document.getElementById('collaboratorBaseSalary').value = collaborator.baseSalary || 0;
            document.getElementById('collaboratorPaymentDay').value = collaborator.paymentDay || 5;
            document.getElementById('collaboratorSpecialty').value = collaborator.specialty || '';
            document.getElementById('collaboratorDescription').value = collaborator.description || '';
            document.getElementById('collaboratorActive').checked = collaborator.active !== false;
            
            // Foto
            if (collaborator.photoUrl) {
                document.getElementById('collaboratorPhotoPreview').src = collaborator.photoUrl;
                document.getElementById('collaboratorPhotoPreview').style.display = 'block';
                document.getElementById('collaboratorPhotoPlaceholder').style.display = 'none';
            } else {
                document.getElementById('collaboratorPhotoPreview').style.display = 'none';
                document.getElementById('collaboratorPhotoPlaceholder').style.display = 'flex';
            }
            
            const modal = new bootstrap.Modal(document.getElementById('collaboratorModal'));
            modal.show();
        }

        function saveCollaborator() {
            const collaboratorId = document.getElementById('collaboratorId').value;
            const name = document.getElementById('collaboratorName').value;
            const contact = document.getElementById('collaboratorContact').value;
            const manualPercent = parseFloat(document.getElementById('collaboratorManualPercent').value);
            const productPercent = parseFloat(document.getElementById('collaboratorProductPercent').value);
            const baseSalary = parseFloat(document.getElementById('collaboratorBaseSalary').value) || 0;
            const paymentDay = parseInt(document.getElementById('collaboratorPaymentDay').value) || 5;
            const specialty = document.getElementById('collaboratorSpecialty').value;
            const description = document.getElementById('collaboratorDescription').value;
            const active = document.getElementById('collaboratorActive').checked;
            
            if (!name || isNaN(manualPercent) || isNaN(productPercent) || !specialty) {
                showError('Por favor, preencha todos os campos obrigatórios.');
                return;
            }
            
            const collaboratorData = {
                name: name,
                contact: contact,
                manualPercent: manualPercent,
                productPercent: productPercent,
                baseSalary: baseSalary,
                paymentDay: paymentDay,
                specialty: specialty,
                description: description,
                active: active,
                userId: currentUser.uid,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            // Processar upload de foto se houver
            const photoFile = document.getElementById('collaboratorPhotoUpload').files[0];
            
            let promise;
            
            if (photoFile) {
                // Upload da foto
                const storageRef = storage.ref(`collaborators/${currentUser.uid}/${collaboratorId || Date.now()}_${photoFile.name}`);
                promise = storageRef.put(photoFile)
                    .then(snapshot => snapshot.ref.getDownloadURL())
                    .then(photoUrl => {
                        collaboratorData.photoUrl = photoUrl;
                        
                        if (collaboratorId) {
                            return db.collection('collaborators').doc(collaboratorId).update(collaboratorData);
                        } else {
                            collaboratorData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                            return db.collection('collaborators').add(collaboratorData);
                        }
                    });
            } else {
                // Sem foto, apenas salvar dados
                if (collaboratorId) {
                    promise = db.collection('collaborators').doc(collaboratorId).update(collaboratorData);
                } else {
                    collaboratorData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                    promise = db.collection('collaborators').add(collaboratorData);
                }
            }
            
            showLoading('Salvando colaborador...');
            
            promise
                .then(() => {
                    const modal = bootstrap.Modal.getInstance(document.getElementById('collaboratorModal'));
                    modal.hide();
                    loadCollaborators();
                    showSuccess(collaboratorId ? 'Colaborador atualizado com sucesso!' : 'Colaborador adicionado com sucesso!');
                })
                .catch((error) => {
                    console.error('Erro ao salvar colaborador:', error);
                    showError('Erro ao salvar colaborador: ' + error.message);
                });
        }

        function deleteCollaborator(collaboratorId) {
            Swal.fire({
                title: 'Tem certeza?',
                text: "Esta ação não pode ser desfeita!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Sim, excluir!',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    db.collection('collaborators').doc(collaboratorId).delete()
                        .then(() => {
                            loadCollaborators();
                            showSuccess('Colaborador excluído com sucesso!');
                        })
                        .catch((error) => {
                            showError('Erro ao excluir colaborador: ' + error.message);
                        });
                }
            });
        }
    </script>
</body>
</html>
